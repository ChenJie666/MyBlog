---
title: 火粉商城电商大数据业务
categories:
- 大数据建模
---
# 总结
①ODS层进行建模后得到DWD层，ODS层和DWD层分为`增量/全量/增量和变化/特殊表`。
②DWD层到DWS层的每日行为宽表(`设备/会员/商品/活动/地区 行为`)，需要从DWD层表中获取需要的字段进行聚合。
③DWS层到DWT层，计算 `首次末次时间/当天/累积/7天/30天/60天 ` 等统计数据；DWT层表不需要进行分区，因为会把旧数据和新数据合成一张表overwrite到表中。
④按主题进行聚合得到ads表(`设备/会员/商品/营销 主题`)，而每个主题都会有不同的指标进行统计，如果`设备包括活跃/新增/沉默/留存/连续登陆等信息`；ADS层表不需要分区，新数据计算后union查出来的旧数据(去重)，再overwrite插入，可以防止数据重复，减少小文件。

# 一、总览
## 1.1 关系模型
![电商数据库表关系图.png](火粉商城电商大数据业务.assets\5ae1d0862c06460e852957fdfa1b4d02.png)

## 1.2 维度模型(业务总线矩阵)：
![image.png](火粉商城电商大数据业务.assets\134712b59223421dafefc7941981e7f1.png)

**建模流程：** `选择业务过程->声明粒度->确认维度->确认事实`
![业务总线矩阵](火粉商城电商大数据业务.assets\67e213722b634ef0980985d182a13fd5.png)

1. `建宽表以维度为基准，每个维度对应一个主题宽表，宽表中的统计字段就是关联的事实表聚合后的度量值；`
2. 一般统计结果可以从主题宽表中直接获取或再进行简单的统计，如用户宽表如果需要根据性别统计，那么再关联一张用户性别表，进行简单统计即可。如果无法从宽表中获取的指标，就得从最细粒度的dwd层中进行统计。
3. DWS层存放的所有的主题对象当天的汇总行为，如每个地区当天的下单次数、下单金额等；  DWT层存放的是所有主题对象的累积行为，如每个地区最近7天的下单次数和金额。

<br>
**关系建模：**
- 优点：减少数据冗余，同时保证一次修改无需修改多个表，保证数据一致性。
- 缺点：获取数据需要join多张表，降低性能。

**维度建模：**
- 优点：1. 业务清晰 2. 减少join产生的shuffle过程，提高效率。

<br>
## 1.3 确定全量/增量/特殊表
![image.png](火粉商城电商大数据业务.assets\d1908005dd884f8f8b448668b455ef25.png)
全量表：分区表，每天全量数据导入一个分区中；
增量表：分区表，每天增量数据导入一个分区中；
增量更新表：分区表，每天增量和更新数据导入一个分区中；  
用户表：`需要使用拉链表`，第一天导入全量数据，之后每天导入新增及变化数据；
特殊表：省份表、地区表、时间表等不会变动的表；
购物车表和收藏表数据量很大，但是为了方便维度建模，采用全量表形式导入。

## 1.4 事实表分类
1）事务型快照事实表(订单明细事实表/支付事实表/退款事实表/评价事实表)
以每个事务或事件为单位，例如一个销售订单记录，一笔支付记录等，作为事实表里的一行数据。一旦事务被提交，事实表数据被插入，数据就不再进行更改，其更新方式为增量更新。  
2）周期型快照事实表(加购事实表/收藏事实表)
周期型快照事实表中不会保留所有数据，只保留固定时间间隔的数据，例如每天或者每月的销售额，或每月的账户余额等。
3）累积型快照事实表(优惠券领用表/订单表)
累计快照事实表用于跟踪业务事实的变化。例如，数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单声明周期的进展情况。当这个业务过程进行时，事实表的记录也要不断更新。

# 二、业务
## 2.1 分层结构
- ODS（operation data store）：存放原始数据。保持数据原貌不变；创建分区表，防止后续的全表扫描；`时间分区`，采用`LZO压缩`，`指定输入输出格式`；创建外部表；导入表中用OUTPUTFORMAT，读取表用INPUTFORMAT。
- DWD（data warehouse detail）：结构粒度与ODS层保持一致，对ODS层数据进行清洗（去除无效数据、脏数据，数据脱敏，`维度退化`，`数据转换`等）。ETL数据清洗，用hive sql、MR、Python、Kettle、SparkSQL；`时间分区`，采用`LZO压缩`，采用`parquet格式`存储；创建外部表；
DWD层主要就是确定事实表和维度表dim。
- DWS（data warehouse service）：在DWD基础上，整合所有的维度和度量字段，按天进行轻度汇总。`时间分区`，采用`LZO压缩`，采用`parquet格式`存储；创建外部表；
DWS层主要就是以某一个维度轻度统计在业务总线矩阵中显示的与其关联的所有的事实表的度量值。DWS层存放的所有主题对象当天的汇总行为，例如每个地区当天的下单次数，下单金额等。
- DWT（data warehouse topic）：在DWS基础上，按主题进行汇总。`时间分区`，采用`LZO压缩`，采用`parquet格式`存储；创建外部表；
DWT层主要就是对DWS层的宽表的累积行为，例如每个地区最近7天（15天、30天、60天）的下单次数、下单金额等。
- ADS（Application Data Store）：为统计报表提供数据。`明确字段分割符`，与sqoop对应；创建外部表。

在ODS层对原始数据进行存储，需要采用压缩（一般lzo为10倍压缩），创建分区表，防止后续的全表扫描。

## 2.2 维度建模（ods->dwd）
历史数据取数 逻辑梳理：通过接口运行十小时获取edb所有的电商数据，以get_time为获取字段，该字段比更新时间的优势在于，get_time只会在支付等重大动作时变动，而非edb_updatetime经常变动，导致在取数的10小时候中有数据变动导致无法获取最新数据。
历史数据取数 方式：通过get_time字段从最早取到最近，而且要取到预估的结束时间为止，然后日更新数据还需要与当天的数据整合去重，防止数据丢失。

### 2.2.1 日志表：
#### 2.2.1.1 日志结构
ODS层分为启动表、行为表和异常表：

![启动日志](火粉商城电商大数据业务.assets\29d7f8b108b245c5b933e8821bc864b4.png)

![页面日志](火粉商城电商大数据业务.assets\9d66a12eb2a14f3f83fa8b0d2a402534.png)

#### 2.2.1.2 日志解析
解析为五张表：启动日志表、页面日志表(用户访问的所有页面)、动作日志表(用户在每张页面上进行的操作)、曝光日志表()、错误日志表()。

![启动日志表](火粉商城电商大数据业务.assets\21f0c4b79cce474087b9411a2d06be1e.png)

![页面日志表](火粉商城电商大数据业务.assets\2e98dd1fad1249498314fe55981ce3fa.png)

![动作日志表](火粉商城电商大数据业务.assets\895efeaa45bc4ff6b14704b73913549e.png)

![曝光日志表](火粉商城电商大数据业务.assets8824766c8024df7af4c9ada2d42e350.png)

![错误日志表](火粉商城电商大数据业务.assets\891533bafa0d4770b62c941395415803.png)
>错误日志表将启动日志和页面日志的异常信息都写入了表中，如果是启动日志异常，则只有启动日志的字段；如果是页面日志异常，则只有页面日志的字段。

<br>
### 2.2.2 业务表
**事务型事实表：**每个事务或事件为单位，数据就不再进行更改。
**周期型快照事实表：**不会保留所有数据，只保留固定时间间隔的数据
**累积型快照事实表：**累计快照事实表用于跟踪业务事实的变化。
#### 2.2.2.1 维度表
##### 2.2.2.1.1 特殊表合并：
`地区维度表：`将省份表和地区表合并作为地区维度表。

![地区维度表](火粉商城电商大数据业务.assets