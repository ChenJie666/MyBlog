---
title: 内网穿透-自建FRP
categories:
- 系统安全
---
#一、概念
- ipv4：IP(Internet Protocol，互联网协议)是网络层的一个被路由协议，是一个封装协议或标识协议，它封装了一个非常重要的标识信息就是IP地址，IP地址用来标识网络中的主机。

| 类型          | 地址块                                             | 地址范围                                                     |
| ------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| 默认路由      | 224.0.0.0/4                                        | 224.0.0.0-239.255.255.255                                    |
| 有限广播地址  | -                                                  | 255.255.255.255                                              |
| 环回地址      | 127.0.0.0/8                                        | 127.0.0.0-127.255.255.255                                    |
| Test-Nest地址 | 190.0.2.0/24                                       | 190.0.2.0-192.255.255.255                                    |
| 链路本地地址  | 169.254.0.0/16                                     | 169.254.0.0-169.254.255.255                                  |
| 私有地址空间  | 10.0.0.0/18<br />172.16.0.0/12<br />192.168.0.0/16 | 10.0.0.0-10.255.255.255<br />172.16.0.0-172.31.255.255<br />192.168.0.0-192.168.255.255 |
| 多播          | 224.0.0.0/4                                        | 224.0.0.0-239.255.255.255                                    |
| 实验地址      | 240.0.0.0/4                                        | 224.0.0.0-255.255.255.254                                    |

- 端口：在Internet上，各主机间通过TCP/IP协议发送和接收数据包，各个数据包根据其目的主机的ip地址来进行互联网络中的路由选择。为了把数据包发送到目的主机的指定进程中，引入了端口机制。当目的主机接收到数据包后，将根据报文首部的目的端口号，把数据发送到相应端口，而与此端口相对应的那个进程将会领取数据并等待下一组数据的到来。
　
![image.png](内网穿透-自建FRP.assets\43b2520a8c454287b9317ab3aa3de1b0.png)

**简单理解内网机与外网通讯过程：**
1. 路由器实现了网关的功能，其wan口连接外网，获得了公网ip，其lan口连接的是内网，分配了私有ip。
2. 计算机接入到局域网中，路由器如果开启了DHCP，会自动为该计算机分配一个内网地址。
3. 当该内网机的某一个进程与外网机通讯时，会携带自己的ip:port信息。当数据包进入路由器后，路由器会修改该数据包的源地址为自己的外网地址，并分配一个端口。同时将端口映射信息记录到NAT表中。
4. 外网机收到数据包，并向修改后的地址(即路由器地址)返回数据。数据到达路由器后，查询NAT表再将地址改为内网机地址和端口，并转发到指定的内网机端口上。
5. 相反的，**外网机无法主动与内网机进行连接**。因为无法通过私有地址在公网上定位这个内网机。



<br>
# 二、解决方案
##2.1 端口映射
添加路由器端口与内网IP和端口的映射，当外网请求该端口时，会根据配置的映射规则将数据包路由到指定的内网机中。这样外部可以通过公网IP和端口号，来访问内网的设备。


**但是国内环境很难做到通过端口映射访问内网机：** 获取的IP并不是真正的公网IP，而是上层路由器的私有地址。层层嵌套，而我们无法对上层路由器进行端口映射。

![image.png](内网穿透-自建FRP.assets24203380f374b9ba753a54888725918.png)

DDNS：因为是动态IP，会经常变动。需要在你的主路由上设置DDNS，每隔几分钟扫描一次，并把变化传递到域名服务器，让域名也时时刻刻和动态IP绑定。

## 2.2 内网穿透
NAT可以分为锥型和对称型，其中锥型又可以分为完全锥型和限制型锥型，限制型锥型又可分为ip限制型锥型和端口限制型锥型。

- 锥型：锥型NAT的特点是，主动使用同样的端口去和不同的服务器或和相同的服务器，不同的端口建立连接时，NAT的映射也会使用同样的端口；
  - 完全锥型：如果在NAT网关已经建立了一个NAT映射，那么任何外网的机器都可以通过这个映射来访问内网的电脑；
  - ip限制型锥型：如果在NAT网关已经建立了一个NAT映射，那么只有与其建立映射的ip才能通过NAT访问内网的电脑。
  - 端口限制型锥型：在ip限制型锥型的基础上，对端口同样有限制。即如果在NAT网关已经建立了一个NAT映射，那么只有与其建立映射的ip和端口才能通过NAT访问内网的电脑。
- 对称型：对称型特点是，每次内网机访问外网NAT都会随机映射端口。只有和内网机建立连接的ip和端口向其发送数据才不会被丢弃。对称型NAT和端口限制型锥型是一样的，对ip和端口都有限制。

### 2.2.1 UDP打洞
UDP打洞是使两个处于NAT中的内网机通过服务端的协调直接建立连接。

两个NAT中的内网机需要进行UDP打洞，下图展示了不同NAT类型是否可以实现打洞。
| 类型       | 类型       | 是否支持打洞   |
| ------------ | ------------ | -------- |
| 全锥型       | 全锥型       | 全锥型   
| 全锥型       | 受限锥型     | 支持     |
| 全锥型       | 端口受限锥型 | 支持     |
| 全锥型       | 对称型       | 支持     |
| 受限锥型     | 受限锥型     | 支持     |
| 受限锥型     | 端口受限锥型 | 支持     |
| 受限锥型     | 对称型       | 支持     |
| 端口受限锥型 | 端口受限锥型 | 支持     |
| 端口受限锥型 | 对称型       | 无法打通   |
| 对称型       | 对称型       | 无法打通 |

**第一种：完全锥型NAT和完全锥型NAT进行穿透**
A和B是两个完全锥型的NAT，其穿透流程如下：
1. A和B都连接到服务端后，服务端知道了A和B的外网ip和端口。
2. 服务端通知A向B发送消息，因为B已经和服务端建立了连接，所以NAT映射是存在的（消息到达NAT后会转发到对应的内网机)且完全锥型NAT允许任何外网的机器通过这个映射来访问内网的电脑。
3. 这样A就可以与B建立UDP连接。同理B与A也可以建立UDP连接。

**第二种：ip限制型NAT和ip限制型NAT进行穿透**
A和B是两个完全锥型的NAT，其穿透流程如下：
1. 任何外网的机器都可以通过这个映射来访问内网的电脑
2. 服务端通知A向B发送消息，因为B已经和服务端建立了连接，所以NAT映射是存在的（消息到达NAT后会转发到对应的内网机)，但是ip限制型NAT只允许与其建立连接的ip才能通过NAT访问内网的电脑。A发送给B的数据包都被B丢弃了。
3. 服务端通知B向A发送消息，因为A已经建立了与B通讯的映射(锥型NAT的同一内网机会复用已有的映射)，那么A就可以收到B的消息，接着A会给B发送一个同意建立连接的请求，最终二者建立了一个稳定的UDP连接。

**第三种：端口限制型NAT和端口限制型NAT进行穿透**
原理和第二种差不多。


**优点：**服务端可以理解为红娘，只是为两个NAT进行牵线，当两个NAT建立连接后即可直接进行通讯，服务端不参与通讯，即服务端的带宽不影响通讯。

**缺点：**家里的路由器（包括办宽带时送的光猫），使用的都是完全锥型NAT，但是上层的机房为了公共安全，使用的一般都是对称NAT，也就说是我们绝大多数人使用的都是对称NAT，所以想要进行UDP打洞还是非常困难的。

### 2.2.2 中继
![](内网穿透-自建FRP.assets\798134956e1e4507922dd9fb84df603b.png)

中继最可靠但也是最低效的一种P2P通信实现，其原理是通过一个有公网IP的服务器中间人对两个内网客户端的通信数据进行中继和转发，当服务端连接的客户端比较少，且网络流量不大时，效果还不错。但是如果有很多客户端连接并且网络流量很多，服务端的压力就会很大。


<br>
#三、自建FRP实现
![image.png](内网穿透-自建FRP.assets