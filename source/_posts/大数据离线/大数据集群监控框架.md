---
title: å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶
categories:
- å¤§æ•°æ®ç¦»çº¿
---
# ä¸€ã€ç›‘æ§æ¡†æ¶

|            | Bigdata1                                                 | Bigdata2                                        | Bigdata3                        |
| ---------- | -------------------------------------------------------- | ----------------------------------------------- | ------------------------------- |
| Zabbix     | zabbix-server<br />zabbix-agent                          | zabbix-agent                                    | zabbix-agent                    |
| Ganglia    |                                                          | ganglia                                         |                                 |



<br>
# äºŒã€Zabbix 4.2.8
## 2.1 æ¦‚å¿µ
Zabbixæ˜¯ä¸€æ¬¾èƒ½å¤Ÿç›‘æ§å„ç§ç½‘ç»œå‚æ•°ä»¥åŠæœåŠ¡å™¨å¥åº·æ€§å’Œå®Œæ•´æ€§çš„è½¯ä»¶ã€‚Zabbixä½¿ç”¨çµæ´»çš„é€šçŸ¥æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·ä¸ºå‡ ä¹ä»»ä½•äº‹ä»¶é…ç½®åŸºäºé‚®ä»¶çš„å‘Šè­¦ã€‚è¿™æ ·å¯ä»¥å¿«é€Ÿåé¦ˆæœåŠ¡å™¨çš„é—®é¢˜ã€‚åŸºäºå·²å­˜å‚¨çš„æ•°æ®ï¼ŒZabbixæä¾›äº†å‡ºè‰²çš„æŠ¥å‘Šå’Œæ•°æ®å¯è§†åŒ–åŠŸèƒ½ã€‚

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets7c06525d4d9496ebf7e49ce625200e8.png)

## 2.2 ç»„ä»¶
- ä¸»æœºï¼ˆHostï¼‰
ä¸€å°ä½ æƒ³ç›‘æ§çš„ç½‘ç»œè®¾å¤‡ï¼Œç”¨IPæˆ–åŸŸåè¡¨ç¤ºã€‚
- ç›‘æ§é¡¹ï¼ˆItemï¼‰
ä½ æƒ³è¦æ¥æ”¶çš„ä¸»æœºçš„ç‰¹å®šæ•°æ®ï¼Œä¸€ä¸ªåº¦é‡æ•°æ®ã€‚
- è§¦å‘å™¨ï¼ˆTriggerï¼‰
ä¸€ä¸ªè¢«ç”¨äºå®šä¹‰é—®é¢˜é˜ˆå€¼å’Œâ€œè¯„ä¼°â€ç›‘æ§é¡¹æ¥æ”¶åˆ°çš„æ•°æ®çš„é€»è¾‘è¡¨è¾¾å¼ã€‚
- åŠ¨ä½œï¼ˆActionï¼‰
ä¸€ä¸ªå¯¹äº‹ä»¶åšå‡ºååº”çš„é¢„å®šä¹‰çš„æ“ä½œï¼Œæ¯”å¦‚é‚®ä»¶é€šçŸ¥ã€‚

## 2.3 éƒ¨ç½²
1. æ¯å°å®‰è£…yumçš„repoæ–‡ä»¶

   ```
   sudo rpm -Uvh https://mirrors.aliyun.com/zabbix/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
   ```

2. å°†æ–‡ä»¶ä¸­çš„é•œåƒåŸŸåæ›¿æ¢ä¸ºé˜¿é‡Œäº‘

   ```
   sudo sed -i 's/http:\/\/repo.zabbix.com/https:\/\/mirrors.aliyun.com\/zabbix/g' /etc/yum.repos.d/zabbix.repo
   ```

3. å®‰è£…

   - bigdata1ï¼š

     ```
     sudo yum install -y zabbix-server-mysql zabbix-web-mysql zabbix-agent
     ```

   - bigdata2å’Œbigdata3

     ```
     bigdata2ï¼š sudo yum install -y zabbix-agent
     bigdata3ï¼š sudo yum install -y zabbix-agent
     ```

4. MySQLåˆ›å»ºæ•°æ®åº“

   ```
   mysql -h 192.168.32.244 -uroot -phxr -e"create database zabbix charset utf8 collate utf8_bin";
   ```

   ä½¿ç”¨zabbixçš„å»ºè¡¨è„šæœ¬å»ºè¡¨

   ```
   zcat /usr/share/doc/zabbix-server-mysql-4.0.29/create.sql.gz | mysql -h 192.168.32.244 -uroot -phxr zabbix
   ```

5. é…ç½®Zabbix_Server
   åœ¨bigdata1ä¸­çš„/etc/zabbix/zabbix_server.confé…ç½®æ–‡ä»¶ä¸­æ·»åŠ 

   ```
   DBHost=bigdata3
   DBName=zabbix
   DBUser=root
   DBPassword=hxr
   ```

   åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„/etc/zabbix/zabbix_server.confé…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹

   ```
   # ä¿®æ”¹
   Server=bigdata1
   # æ³¨é”€
   # ServerActive=127.0.0.1
   # Hostname=Zabbix server
   ```

6. é…ç½®Zabbix Webæ—¶åŒº
   åœ¨/etc/httpd/conf.d/zabbix.confæ–‡ä»¶ä¸­æ·»åŠ 

   ```
   php_value date.timezone Asia/Shanghai
   ```

   

7. å¯åŠ¨Zabbix

   - bigdata1å¯åŠ¨ï¼š

     ```
     sudo systemctl start/stop zabbix-server zabbix-agent httpd     (httpdæ˜¯è®¿é—®htmlç­‰é¡µé¢çš„å…¥å£)
     ```

     bigdata1è®¾ç½®å¼€æœºè‡ªå¯ï¼š

     ```
     sudo systemctl enable/disable zabbix-server zabbix-agent httpd
     ```

   - bigdata2/3å¯åŠ¨ï¼š

     ```
     sudo systemctl start/stop zabbix-agent 
     ```

     è®¾ç½®å¼€æœºè‡ªå¯ï¼š

     ```
     sudo systemctl enable/disable zabbix-agent
     ```

      

8. è®¿é—®é¡µé¢
   http://192.168.32.242/zabbix  (é»˜è®¤è´¦å·å¯†ç ä¸º Admin/zabbix)
   åœ¨é¡µé¢ä¸­å®Œæˆå¯¹Zabbix_Webçš„æ•°æ®åº“ç­‰é…ç½®
   å¦‚æœé…ç½®å‡ºç°é”™è¯¯ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶/etc/zabbix/web/zabbix.conf.phpä¸­è¿›è¡Œä¿®æ”¹
   å¼‚å¸¸æ—¥å¿—å¯ä»¥æŸ¥çœ‹  cat /var/log/zabbix/zabbix_server.log

## 2.4 å®ç°è¿›ç¨‹ç›‘æ§
1. é…ç½®ä¸»æœº
   åœ¨é…ç½®-> ä¸»æœº-> åˆ›å»ºä¸»æœº ä¸­æ·»åŠ éœ€è¦ç›‘æ§çš„ä¸»æœº

2. é…ç½®ç›‘æ§é¡¹
åˆ›å»ºå®Œä¸»æœºåï¼Œç‚¹å‡»ç›‘æ§é¡¹è¿›è¡Œç›‘æ§é¡¹çš„åˆ›å»º
å¦‚ç›‘æ§datanodeè¿›è¡Œæ˜¯å¦æ­£å¸¸è¿è¡Œ
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets4997bd394d44648a19f54cb267480ad.png)

3. é…ç½®è§¦å‘å™¨
ç‚¹å‡»è§¦å‘å™¨è¿›è¡Œåˆ›å»º
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\2716f32c51a8488183bb8ee060bc1ed3.png)

4. é€šçŸ¥æ–¹å¼è®¾ç½®
åœ¨ç®¡ç†-> æŠ¥è­¦åª’ä»‹ç±»å‹ ä¸­è¿›è¡Œé€šçŸ¥æŠ¥è­¦çš„é…ç½®
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\75566c9bca394548b57ed91a3d809e1a.png)

5. åˆ›å»ºåŠ¨ä½œ
åœ¨é…ç½®-> åŠ¨ä½œä¸­åˆ›å»ºåŠ¨ä½œï¼Œä¸ºè§¦å‘å™¨è®¾ç½®åŠ¨ä½œ(å‘é‚®ä»¶)ã€‚
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\546294ceaf654820a89cd2edee92e50a.png)

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\42c9c612705d4926a076eb14324ab042.png)

6. ä¸ºç”¨æˆ·é…ç½®é‚®ç®±
åœ¨ç”¨æˆ·çš„åŸºæœ¬èµ„æ–™ä¸­é…ç½®
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\591a0490a1104318bbfff9f580e7d0fa.png)

7. ä½¿ç”¨æ¨¡ç‰ˆä¸ºæ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œé…ç½®
é»˜è®¤æœ‰å¾ˆå¤šæ¡†æ¶çš„æ¨¡æ¿å¯ä»¥é€‰æ‹©ï¼Œå¦‚MySQLã€redisç­‰ã€‚ä½†æ˜¯æ²¡æœ‰hadoopçš„æ¨¡æ¿ï¼Œéœ€è¦è‡ªå·±é…ç½®ã€‚
åœ¨é…ç½®-> æ¨¡æ¿ ä¸­è¿›è¡Œæ¨¡æ¿é…ç½®ï¼Œåˆ›å»ºç›‘æ§é¡¹ã€è§¦å‘å™¨ï¼Œç„¶ååº”ç”¨åˆ°ä¸»æœºä¸Šã€‚
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\46d94a38d669456dbf8b9eeb65ba3079.png)
æ³¨æ„éœ€è¦ä¿®æ”¹åŠ¨ä½œæ¥ä¸ºæ¨¡æ¿çš„è§¦å‘å™¨ç»‘å®šåŠ¨ä½œã€‚



<br>
# ä¸‰ã€Prometheus
## 3.1 ç‰¹ç‚¹
&ensp;&ensp; Prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œå…¶å¯¹ä¼ ç»Ÿç›‘æ§ç³»ç»Ÿçš„æµ‹è¯•å’Œå‘Šè­¦æ¨¡å‹è¿›è¡Œäº†å½»åº•çš„é¢ è¦†ï¼Œå½¢æˆäº†åŸºäºä¸­å¤®åŒ–çš„è§„åˆ™è®¡ç®—ã€ç»Ÿä¸€åˆ†æå’Œå‘Šè­¦çš„æ–°æ¨¡å‹ã€‚ ç›¸æ¯”äºä¼ ç»Ÿç›‘æ§ç³»ç»Ÿï¼ŒPrometheuså…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

### 3.1.1 æ˜“äºç®¡ç†
- Prometheusæ ¸å¿ƒéƒ¨åˆ†åªæœ‰ä¸€ä¸ªå•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸å­˜åœ¨ä»»ä½•çš„ç¬¬ä¸‰æ–¹ä¾èµ–(æ•°æ®åº“ï¼Œç¼“å­˜ç­‰ç­‰)ã€‚å”¯ä¸€éœ€è¦çš„å°±æ˜¯æœ¬åœ°ç£ç›˜ï¼Œå› æ­¤ä¸ä¼šæœ‰æ½œåœ¨çº§è”æ•…éšœçš„é£é™©ã€‚
- PrometheusåŸºäºPullæ¨¡å‹çš„æ¶æ„æ–¹å¼ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ï¼ˆæœ¬åœ°ç”µè„‘ï¼Œå¼€å‘ç¯å¢ƒï¼Œæµ‹è¯•ç¯å¢ƒï¼‰æ­å»ºæˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿã€‚
- å¯¹äºä¸€äº›å¤æ‚çš„æƒ…å†µï¼Œè¿˜å¯ä»¥ä½¿ç”¨PrometheusæœåŠ¡å‘ç°(Service Discovery)çš„èƒ½åŠ›åŠ¨æ€ç®¡ç†ç›‘æ§ç›®æ ‡ã€‚

### 3.1.2 ç›‘æ§æœåŠ¡çš„å†…éƒ¨è¿è¡ŒçŠ¶æ€
&ensp;&ensp; Pometheusé¼“åŠ±ç”¨æˆ·ç›‘æ§æœåŠ¡çš„å†…éƒ¨çŠ¶æ€ï¼ŒåŸºäºPrometheusä¸°å¯Œçš„Clientåº“ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾çš„åœ¨åº”ç”¨ç¨‹åºä¸­æ·»åŠ å¯¹Prometheusçš„æ”¯æŒï¼Œä»è€Œè®©ç”¨æˆ·å¯ä»¥è·å–æœåŠ¡å’Œåº”ç”¨å†…éƒ¨çœŸæ­£çš„è¿è¡ŒçŠ¶æ€ã€‚

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\154808c363ad41d1b4c85dc0dca2a3da.png)


### 3.1.3 å¼ºå¤§çš„æ•°æ®æ¨¡å‹
&ensp;&ensp; æ‰€æœ‰é‡‡é›†çš„ç›‘æ§æ•°æ®å‡ä»¥æŒ‡æ ‡(metric)çš„å½¢å¼ä¿å­˜åœ¨å†…ç½®çš„æ—¶é—´åºåˆ—æ•°æ®åº“å½“ä¸­(TSDB)ã€‚æ‰€æœ‰çš„æ ·æœ¬é™¤äº†åŸºæœ¬çš„æŒ‡æ ‡åç§°ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ç»„ç”¨äºæè¿°è¯¥æ ·æœ¬ç‰¹å¾çš„æ ‡ç­¾ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
```
http_request_status{code='200',content_path='/api/path',environment='produment'} => [value1@timestamp1,value2@timestamp2...] 
http_request_status{code='200',content_path='/api/path2',environment='produment'} => [value1@timestamp1,value2@timestamp2...]
```
æ¯ä¸€æ¡æ—¶é—´åºåˆ—ç”±æŒ‡æ ‡åç§°(Metrics Name)ä»¥åŠä¸€ç»„æ ‡ç­¾(Labels)å”¯ä¸€æ ‡è¯†ã€‚æ¯æ¡æ—¶é—´åºåˆ—æŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåºå­˜å‚¨ä¸€ç³»åˆ—çš„æ ·æœ¬å€¼ã€‚
- http_request_statusï¼šæŒ‡æ ‡åç§°(Metrics Name)
- {code='200',content_path='/api/path',environment='produment'}ï¼šè¡¨ç¤ºç»´åº¦çš„æ ‡ç­¾ï¼ŒåŸºäºè¿™äº›Labelsæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å¯¹ç›‘æ§æ•°æ®è¿›è¡Œèšåˆï¼Œè¿‡æ»¤ï¼Œè£å‰ªã€‚
- [value1@timestamp1,value2@timestamp2...]ï¼šæŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåº å­˜å‚¨çš„æ ·æœ¬å€¼ã€‚

### 3.1.4 å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€PromQL
&ensp;&ensp; Prometheuså†…ç½®äº†ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®æŸ¥è¯¢è¯­è¨€PromQLã€‚ é€šè¿‡PromQLå¯ä»¥å®ç°å¯¹ç›‘æ§æ•°æ®çš„æŸ¥è¯¢ã€èšåˆã€‚åŒæ—¶PromQLä¹Ÿè¢«åº”ç”¨äºæ•°æ®å¯è§†åŒ–(å¦‚Grafana)ä»¥åŠå‘Šè­¦å½“ä¸­ã€‚
é€šè¿‡PromQLå¯ä»¥è½»æ¾å›ç­”ç±»ä¼¼äºä»¥ä¸‹é—®é¢˜ï¼š
- åœ¨è¿‡å»ä¸€æ®µæ—¶é—´ä¸­95%åº”ç”¨å»¶è¿Ÿæ—¶é—´çš„åˆ†å¸ƒèŒƒå›´ï¼Ÿ
- é¢„æµ‹åœ¨4å°æ—¶åï¼Œç£ç›˜ç©ºé—´å ç”¨å¤§è‡´ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ
- CPUå ç”¨ç‡å‰5ä½çš„æœåŠ¡æœ‰å“ªäº›ï¼Ÿ(è¿‡æ»¤)

### 3.1.5 é«˜æ•ˆ
&ensp;&ensp; å¯¹äºç›‘æ§ç³»ç»Ÿè€Œè¨€ï¼Œå¤§é‡çš„ç›‘æ§ä»»åŠ¡å¿…ç„¶å¯¼è‡´æœ‰å¤§é‡çš„æ•°æ®äº§ç”Ÿã€‚è€ŒPrometheuså¯ä»¥é«˜æ•ˆåœ°å¤„ç†è¿™äº›æ•°æ®ï¼Œå¯¹äºå•ä¸€Prometheus Serverå®ä¾‹è€Œè¨€å®ƒå¯ä»¥å¤„ç†ï¼š
- æ•°ä»¥ç™¾ä¸‡çš„ç›‘æ§æŒ‡æ ‡ 
- æ¯ç§’å¤„ç†æ•°åä¸‡çš„æ•°æ®ç‚¹

### 3.1.6 å¯æ‰©å±•
å¯ä»¥åœ¨æ¯ä¸ªæ•°æ®ä¸­å¿ƒã€æ¯ä¸ªå›¢é˜Ÿè¿è¡Œç‹¬ç«‹çš„Prometheus Sevrerã€‚Prometheuså¯¹äºè”é‚¦é›†ç¾¤çš„æ”¯æŒï¼Œå¯ä»¥è®©å¤šä¸ªPrometheuså®ä¾‹äº§ç”Ÿä¸€ä¸ªé€»è¾‘é›†ç¾¤ï¼Œå½“å•å®ä¾‹Prometheus Serverå¤„ç†çš„ä»»åŠ¡é‡è¿‡å¤§æ—¶ï¼Œé€šè¿‡ä½¿ç”¨åŠŸèƒ½åˆ†åŒº(sharding)+è”é‚¦é›†ç¾¤(federation)å¯ä»¥å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚

### 3.1.7 æ˜“äºé›†æˆ
&ensp;&ensp; ä½¿ç”¨Prometheuså¯ä»¥å¿«é€Ÿæ­å»ºç›‘æ§æœåŠ¡ï¼Œå¹¶ä¸”å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åœ¨åº”ç”¨ç¨‹åºä¸­è¿›è¡Œé›†æˆã€‚ç›®å‰æ”¯æŒï¼šJavaï¼ŒJMXï¼ŒPythonï¼ŒGoï¼ŒRubyï¼Œ.Netï¼ŒNode.jsç­‰ç­‰è¯­è¨€çš„å®¢æˆ·ç«¯SDKï¼ŒåŸºäºè¿™äº›SDKå¯ä»¥å¿«é€Ÿè®©åº”ç”¨ç¨‹åºçº³å…¥åˆ° Prometheusçš„ç›‘æ§å½“ä¸­ï¼Œæˆ–è€…å¼€å‘è‡ªå·±çš„ç›‘æ§æ•°æ®æ”¶é›†ç¨‹åºã€‚
&ensp;&ensp; åŒæ—¶è¿™äº›å®¢æˆ·ç«¯æ”¶é›†çš„ç›‘æ§æ•°æ®ï¼Œä¸ä»…ä»…æ”¯æŒ Prometheusï¼Œè¿˜èƒ½æ”¯æŒGraphiteè¿™äº›å…¶ä»–çš„ç›‘æ§å·¥å…·ã€‚ 
&ensp;&ensp; åŒæ—¶Prometheusè¿˜æ”¯æŒä¸å…¶ä»–çš„ç›‘æ§ç³»ç»Ÿè¿›è¡Œé›†æˆï¼šGraphiteï¼Œ Statsdï¼Œ Collectedï¼Œ Scollectorï¼Œ muiniï¼Œ Nagiosç­‰ã€‚ Prometheusç¤¾åŒºè¿˜æä¾›äº†å¤§é‡ç¬¬ä¸‰æ–¹å®ç°çš„ç›‘æ§æ•°æ®é‡‡é›†æ”¯æŒï¼šJMXï¼ŒCloudWatchï¼ŒEC2ï¼ŒMySQLï¼ŒPostgresSQLï¼ŒHaskellï¼ŒBashï¼ŒSNMPï¼ŒConsulï¼ŒHaproxyï¼ŒMesosï¼ŒBindï¼ŒCouchDBï¼ŒDjangoï¼ŒMemcachedï¼ŒRabbitMQï¼ŒRedisï¼ŒRethinkDBï¼ŒRsyslogç­‰ç­‰ã€‚

### 3.1.8 å¯è§†åŒ–
- Prometheus Serverä¸­è‡ªå¸¦çš„Prometheus UIï¼Œå¯ä»¥æ–¹ä¾¿åœ°ç›´æ¥å¯¹æ•°æ®è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä¸”æ”¯æŒç›´æ¥ä»¥å›¾å½¢åŒ–çš„å½¢å¼å±•ç¤ºæ•°æ®ã€‚åŒæ—¶Prometheusè¿˜æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„åŸºäºRuby On Railsçš„Dashboardè§£å†³æ–¹æ¡ˆ Promdashã€‚
- æœ€æ–°çš„Grafanaå¯è§†åŒ–å·¥å…·ä¹Ÿå·²ç»æä¾›äº†å®Œæ•´çš„Prometheusæ”¯æŒï¼ŒåŸºäºGrafanaå¯ä»¥åˆ›å»ºæ›´åŠ ç²¾ç¾çš„ç›‘æ§å›¾æ ‡ã€‚
- åŸºäºPrometheusæä¾›çš„APIè¿˜å¯ä»¥å®ç°è‡ªå·±çš„ç›‘æ§å¯è§†åŒ–UIã€‚

### 3.1.9 å¼€æ”¾æ€§
&ensp;&ensp; é€šå¸¸æ¥è¯´å½“æˆ‘ä»¬éœ€è¦ç›‘æ§ä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œä¸€èˆ¬éœ€è¦è¯¥åº”ç”¨ç¨‹åºæä¾›å¯¹ç›¸åº”ç›‘æ§ç³»ç»Ÿåè®®çš„æ”¯æŒï¼Œå› æ­¤åº”ç”¨ç¨‹åºä¼šä¸æ‰€é€‰æ‹©çš„ç›‘æ§ç³»ç»Ÿè¿›è¡Œç»‘å®šã€‚ä¸ºäº†å‡å°‘è¿™ç§ç»‘å®šæ‰€å¸¦æ¥çš„é™åˆ¶ï¼Œå¯¹äºå†³ç­–è€…è€Œè¨€è¦ä¹ˆä½ å°±ç›´æ¥åœ¨åº”ç”¨ä¸­é›†æˆè¯¥ç›‘æ§ç³»ç»Ÿçš„æ”¯æŒï¼Œè¦ä¹ˆå°±åœ¨å¤–éƒ¨åˆ›å»ºå•ç‹¬çš„æœåŠ¡æ¥é€‚é…ä¸åŒçš„ç›‘æ§ç³»ç»Ÿã€‚
&ensp;&ensp; è€Œå¯¹äºPrometheusæ¥è¯´ï¼Œä½¿ç”¨Prometheusçš„client libraryçš„è¾“å‡ºæ ¼å¼ä¸æ­¢æ”¯æŒPrometheusçš„æ ¼å¼åŒ–æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¾“å‡ºæ”¯æŒå…¶å®ƒç›‘æ§ç³»ç»Ÿçš„æ ¼å¼åŒ–æ•°æ®ï¼Œæ¯”å¦‚Graphiteã€‚ å› æ­¤ä½ ç”šè‡³å¯ä»¥åœ¨ä¸ä½¿ç”¨Prometheusçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨Prometheusçš„client libraryæ¥è®©ä½ çš„åº”ç”¨ç¨‹åºæ”¯æŒç›‘æ§æ•°æ®é‡‡é›†ã€‚

<br>
## 3.2 Prometheusçš„æ¶æ„
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\480ae2195f9a411babb82d21e168a4eb.png)

### 3.2.1 Prometheusç”Ÿæ€åœˆç»„ä»¶
- Prometheus Serverï¼šä¸»æœåŠ¡å™¨ï¼Œè´Ÿè´£æ”¶é›†å’Œå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®
- client libraiesï¼šåº”ç”¨ç¨‹åºä»£ç æ’æ¡©ï¼Œå°†ç›‘æ§æŒ‡æ ‡åµŒå…¥åˆ°è¢«ç›‘æ§åº”ç”¨ç¨‹åºä¸­
- Pushgatewayï¼šæ¨é€ç½‘å…³ï¼Œä¸ºæ”¯æŒshort-livedä½œä¸šæä¾›ä¸€ä¸ªæ¨é€ç½‘å…³
- exporterï¼šä¸“é—¨ä¸ºä¸€äº›åº”ç”¨å¼€å‘çš„æ•°æ®æ‘„å–ç»„ä»¶â€”exporterï¼Œä¾‹å¦‚ï¼šHAProxyã€StatsDã€Graphiteç­‰ç­‰ã€‚
- Alertmanagerï¼šä¸“é—¨ç”¨äºå¤„ç†alertçš„ç»„ä»¶

### 3.2.2 æ¶æ„ç†è§£
#### 1. å­˜å‚¨è®¡ç®—å±‚
- Prometheus Serverï¼Œé‡Œé¢åŒ…å«äº†å­˜å‚¨å¼•æ“å’Œè®¡ç®—å¼•æ“ã€‚
- Retrievalç»„ä»¶ä¸ºå–æ•°ç»„ä»¶ï¼Œå®ƒä¼šä¸»åŠ¨ä»Pushgatewayæˆ–è€…Exporteræ‹‰å–æŒ‡æ ‡æ•°æ®ã€‚
- Service discoveryï¼Œå¯ä»¥åŠ¨æ€å‘ç°è¦ç›‘æ§çš„ç›®æ ‡ã€‚
- TSDBï¼Œæ•°æ®æ ¸å¿ƒå­˜å‚¨ä¸æŸ¥è¯¢ã€‚
- HTTP serverï¼Œå¯¹å¤–æä¾›HTTPæœåŠ¡ã€‚

#### 2. é‡‡é›†å±‚
é‡‡é›†å±‚åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ä½œä¸šï¼Œè¿˜æœ‰ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„ä½œä¸šã€‚
- çŸ­ä½œä¸šï¼šç›´æ¥é€šè¿‡APIï¼Œåœ¨é€€å‡ºæ—¶é—´æŒ‡æ ‡æ¨é€ç»™Pushgatewayã€‚å¦‚Flinkä»»åŠ¡æ¯æ¬¡åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šå¯åŠ¨ä¸€ä¸ªexecutoræ‰§è¡ŒçŸ­ä½œä¸šï¼Œç»“æŸæ—¶æ¨é€ç»™Pushgatewayï¼ŒPrometheusä»Pushgatewayè·å–æ•°æ®ã€‚
- é•¿ä½œä¸šï¼šRetrievalç»„ä»¶ç›´æ¥ä»Jobæˆ–è€…Exporteræ‹‰å–æ•°æ®ã€‚

#### 3. åº”ç”¨å±‚
åº”ç”¨å±‚ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯AlertManagerï¼Œå¦ä¸€ç§æ˜¯æ•°æ®å¯è§†åŒ–ã€‚
- AlertManager
å¯¹æ¥Pagerdutyï¼Œæ˜¯ä¸€å¥—ä»˜è´¹çš„ç›‘æ§æŠ¥è­¦ç³»ç»Ÿã€‚å¯å®ç°çŸ­ä¿¡æŠ¥è­¦ã€5åˆ†é’Ÿæ— äººackæ‰“ç”µè¯é€šçŸ¥ã€ä»ç„¶æ— äººackï¼Œé€šçŸ¥å€¼ç­äººå‘˜Manager...
Emialï¼Œå‘é€é‚®ä»¶
... ...
- æ•°æ®å¯è§†åŒ–
Prometheus build-in WebUI
Grafana

å…¶ä»–åŸºäºAPIå¼€å‘çš„å®¢æˆ·ç«¯

<br>
## 3.3 å®‰è£…
### 3.3.1 å®‰è£…Prometheus Server
PrometheusåŸºäºGolangç¼–å†™ï¼Œç¼–è¯‘åçš„è½¯ä»¶åŒ…ï¼Œä¸ä¾èµ–äºä»»ä½•çš„ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚åªéœ€è¦[ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶åŒ…](https://prometheus.io/download/)ï¼Œè§£å‹å¹¶ä¸”æ·»åŠ åŸºæœ¬çš„é…ç½®å³å¯æ­£å¸¸å¯åŠ¨Prometheus Serverã€‚

1. è§£å‹å‹ç¼©åŒ… prometheus-2.30.3.linux-amd64.tar.gz
2. ä¿®æ”¹é…ç½®æ–‡ä»¶ prometheus.yml
```
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["192.168.101.174:9090"]

  - job_name: "pushgateway"
    static_configs:
      - targets: ['192.168.101.174:9091']
        labels: 
          instance: pushgateway

  - job_name: "node exporter"
    static_configs:
      - targets: ['192.168.101.179:9100','192.168.101.180:9100','192.168.101.181:9100']


  - job_name: "process exporter"
    static_configs:
      - targets: ['192.168.101.179:9256','192.168.101.180:9256','192.168.101.181:9256','192.168.101.176:9256']
```

3. å¯åŠ¨æœåŠ¡
`nohup ./prometheus --config.file=./prometheus.yml 1>./prometheus.log 2>&1 &`

>**prometheuså¯åŠ¨å‘½ä»¤æ·»åŠ å‚æ•°** `--web.enable-lifecycle` **ç„¶åçƒ­é‡å¯ï¼š**`curl -XPOST http://localhost:9090/-/reload`
>**alertmanagerçƒ­é‡å¯:** `curl -XPOST http://localhost:9093/-/reload`

### 3.3.2 å®‰è£…Pushgateway
1. è§£å‹å‹ç¼©åŒ… pushgateway-1.4.2.linux-amd64.tar.gz
2. å¯åŠ¨æœåŠ¡ `nohup ./pushgateway 1>/opt/module/pushgateway-1.4.2/pushgateway.log 2>&1 &`
>å¯ä»¥æ·»åŠ  --web.enable-admin-api å‚æ•°ï¼Œå¯ä»¥é€šè¿‡apiåˆ é™¤pushgatewayçš„æ•°æ®

### 3.3.3 å®‰è£…Node Exporterï¼ˆé€‰æ‹©æ€§å®‰è£…ï¼‰
1. è§£å‹å‹ç¼©åŒ…node_exporter-1.2.2.linux-amd64.tar.gz
2. å¯åŠ¨æœåŠ¡ `./node_exporter`

### 3.3.4 å®‰è£…process-exporter
[process-exporter](https://github.com/ncabatoff/process-exporter/releases/tag/v0.5.0) å¯ä»¥ç›‘æ§åº”ç”¨çš„è¿è¡ŒçŠ¶æ€ï¼ˆè­¬å¦‚ç›‘æ§redisã€mysqlçš„è¿›ç¨‹èµ„æºç­‰ï¼‰ã€‚


1. è§£å‹å‹ç¼©åŒ… process-exporter-0.7.8.linux-amd64

2. é…ç½®éœ€è¦ç›‘æ§çš„è¿›ç¨‹çš„åç§°ï¼Œä»–ä¼šå»æœç´¢è¯¥è¿›ç¨‹ä»è€Œå¾—åˆ°å…¶éœ€è¦çš„ç›‘æ§ä¿¡æ¯ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸åšçš„â€œps -efl | grep xxxâ€å‘½ä»¤æ¥æŸ¥çœ‹å¯¹åº”çš„è¿›ç¨‹ã€‚åœ¨å„è‡ªèŠ‚ç‚¹åˆ›å»ºé…ç½®æ–‡ä»¶process_config.ymlï¼Œå¹¶é…ç½®å¦‚ä¸‹ï¼Œç”¨äºç›‘æµ‹å¤§æ•°æ®æ¡†æ¶ä¸­ä¸»è¦è¿›ç¨‹çš„çŠ¶å†µï¼š
**bigdata1èŠ‚ç‚¹**
```
process_names:
  - name: "{{.Matches}}"
    cmdline:
    - 'NameNode'
  - name: "{{.Matches}}"
    cmdline:
    - 'DataNode'
  - name: "{{.Matches}}"
    cmdline:
    - 'NodeManager'
  - name: "{{.Matches}}"
    cmdline:
    - 'QuorumPeerMain'
  - name: "{{.Matches}}"
    cmdline:
    - 'Kafka'
  - name: "{{.Matches}}"
    cmdline:
    - 'flume'
    - 'edb_order_kafka2hdfs.job'
  - name: "{{.Matches}}"
    cmdline:
    - 'AzkabanExecutorServer'
  - name: "{{.Matches}}"
    cmdline:
    - 'HiveServer2'
  - name: "{{.Matches}}"
    cmdline:
    - 'node_exporter'
  - name: "{{.Matches}}"
    cmdline:
    - 'rangerusersync'
  - name: "{{.Matches}}"
    cmdline:
    - 'rangeradmin'
```
**bigdata2èŠ‚ç‚¹**
```
process_names:
  - name: "{{.Matches}}"
    cmdline:
    - 'ResourceManager'
  - name: "{{.Matches}}"
    cmdline:
    - 'DataNode'
  - name: "{{.Matches}}"
    cmdline:
    - 'NodeManager'
  - name: "{{.Matches}}"
    cmdline:
    - 'QuorumPeerMain'
  - name: "{{.Matches}}"
    cmdline:
    - 'Kafka'
  - name: "{{.Matches}}"
    cmdline:
    - 'flume-1.7.0/job/youmeng_order_kafka2hdfs.job'
  - name: "{{.Matches}}"
    cmdline:
    - 'flume-1.7.0/job/youmeng_active_kafka2hdfs.job'
  - name: "{{.Matches}}"
    cmdline:
    - 'AzkabanExecutorServer'
  - name: "{{.Matches}}"
    cmdline:
    - 'AzkabanWebServer'
  - name: "{{.Matches}}"
    cmdline:
    - 'node_exporter'
```
**bigdata3èŠ‚ç‚¹**
```
process_names:
  - name: "{{.Matches}}"
    cmdline:
    - 'SecondaryNameNode'
  - name: "{{.Matches}}"
    cmdline:
    - 'DataNode'
  - name: "{{.Matches}}"
    cmdline:
    - 'NodeManager'
  - name: "{{.Matches}}"
    cmdline:
    - 'JobHistoryServer'
  - name: "{{.Matches}}"
    cmdline:
    - 'QuorumPeerMain'
  - name: "{{.Matches}}"
    cmdline:
    - 'Kafka'
  - name: "{{.Matches}}"
    cmdline:
    - 'AzkabanExecutorServer'
  - name: "{{.Matches}}"
    cmdline:
    - 'node_exporter'
```

| nameå‚æ•° | è¯´æ˜ |
|---|---|
| `{{.Comm}}` | åŒ…å«åŸå§‹å¯æ‰§è¡Œæ–‡ä»¶çš„åŸºæœ¬åç§°ï¼Œå³ç¬¬äºŒä¸ªå­—æ®µ /proc/<pid>/stat | 
| `{{.ExeBase}}` | åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„åŸºå | 
| `{{.ExeFull}}` | åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œå…¨é™å®šè·¯å¾„ | 
| `{{.Username}}` | åŒ…å«æœ‰æ•ˆç”¨æˆ·çš„ç”¨æˆ·å | 
| `{{.Matches}}` | mapåŒ…å«åº”ç”¨cmdline regexpsäº§ç”Ÿçš„æ‰€æœ‰åŒ¹é…é¡¹ | 

ä¾‹ï¼š
```
[root@izx7dvghztbiorz process-exporter]# ps -ef | grep redis
redis 771 1 0 Jun05 ? 00:45:49 /usr/bin/redis-server *:6379
```
| nameå‚æ•° | åŒ¹é…å…³é”®è¯ | è¯´æ˜ | 
|---|---|---|
| `{{.Comm}}`  | groupname="redis-server" | exeæˆ–è€…shæ–‡ä»¶åç§° |
| `{{.ExeBase}}` | groupname="redis-server *:6379" | / |
| `{{.ExeFull}}` | groupname="/usr/bin/redis-server *:6379" | psä¸­çš„è¿›ç¨‹å®Œæˆä¿¡æ¯ |
| `{{.Username}}` | groupname="redis" | ä½¿ç”¨è¿›ç¨‹æ‰€å±çš„ç”¨æˆ·è¿›è¡Œåˆ†ç»„ |
| `{{.Matches}}` | groupname="map[:redis]" | è¡¨ç¤ºé…ç½®åˆ°å…³é”®å­—â€œredisâ€ |

3. å¯åŠ¨è¿›ç¨‹ `process-exporter  -config.path process_config.yml`
å¯åŠ¨åå¯ä»¥é€šè¿‡æ‰§è¡Œå‘½ä»¤ `curl 192.168.101.79:9256/metrics` æ¥è·å–ç›‘æ§æ•°æ®ã€‚

4. å°†process-exporteræ·»åŠ åˆ°prometheusä¸­ã€‚åœ¨prometheus.ymlä¸­æ·»åŠ 
```
  - job_name: "process exporter"
    static_configs:
      - targets: ['192.168.101.179:9256','192.168.101.180:9256','192.168.101.181:9256']
```
é‡å¯prometheusã€‚

### 3.3.5 å®‰è£…alertmanager

### 3.3.6 è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
**ä»¥node_exporterå’Œprocess_exporterä¸ºä¾‹ï¼š**

1. ç¼–è¾‘è„šæœ¬
â‘ node_exporterè„šæœ¬
```
[Unit]
Description=node_export
Documentation=https://github.com/prometheus/node_exporter
After=network.target
 
[Service]
Type=simple
User=hxr
ExecStart=/opt/module/node_exporter-1.2.2/node_exporter
Restart=on-failure

[Install]
WantedBy=multi-user.target
```
æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹Serviceä¸­çš„Userå’ŒExecStartçš„å±æ€§ï¼Œç„¶åå°†å°†æœ¬æ”¾åˆ° `/usr/lib/systemd/system/node_exporter.service` è·¯å¾„ä¸‹ã€‚

â‘¡process_exporterè„šæœ¬
```
[Unit]
Description=process_exporter
Documentation=https://github.com/ncabatoff/process-exporter
After=network.target

[Service]
Type=simple
User=root
EnvironmentFile="CONFIG=-config.path /opt/module/process-exporter-0.5.0/process_config.yml"
ExecStart=/opt/module/process-exporter-0.5.0/process-exporter ${CONFIG}
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

2. è®¾ä¸ºå¼€æœºè‡ªå¯åŠ¨
`systemctl enable node_exporter.service`

3. å¯åŠ¨æœåŠ¡
`systemctl start node_exporter.service`


<br>
### 3.3.7 å®‰è£…Flume-exporter(ç›‘æ§Flume)

[ä¸‹è½½Flume_exporter](https://github.com/woozhijun/flume_exporter/releases/tag/v0.0.2)ï¼Œè§£å‹åè¿›è¡Œå®‰è£…
```
# é¦–å…ˆå®‰è£…Golang
yum -y install epel-release
yum -y install golang
# è§£å‹flume_exporter
tar -zxvf flume_exporter-0.0.2.tar.gz  -C /opt/module
cd /opt/module/flume_exporter-0.0.2/
# ç¼–è¯‘
make build
```
**é…ç½®config.yml**
```
# Example usage:
# Flume JSON Reporting metrics
agents:
- name: "flume-agents"
  enabled: true
# multiple urls can be separated by ,
  urls: ["http://localhost:36001/metrics","http://localhost:36002/metrics"]
```
>éœ€è¦ä¿è¯flumeå¯åŠ¨äº†**JSON Reporting**ï¼Œå¦‚`sudo -i -u hxr bash -c 'nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a2 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/feiyan_model_kafka2hdfs.job  -Dflume.root.logger=INFO,LOGFILE  -Dflume.log.file=feiyan_model_kafka2hdfs.log  -Xms512m -Xmx512m -Dflume.monitoring.type=http -Dflume.monitoring.port=36001 1>/dev/null 2>&1 &'`ï¼› 

**å¯åŠ¨flume_exporter**
```
nohup /opt/module/flume_exporter-master/flume_exporter-master --metric-file /opt/module/flume_exporter-master/metrics.yml --config-file=/opt/module/flume_exporter-master/config.yml 1>/opt/module/flume_exporter-master/flume_exporter-master.log 2>&1 &
```
>å¯åŠ¨åå¯ä»¥æŸ¥çœ‹Flumeçš„[JSON Reporting](http://192.168.101.181:9360/metrics)ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹[Flume_exporterçš„æ—¥å¿—](http://192.168.101.181:9360/metrics)

**é…ç½®Prometheusæ‹‰å–Flume_exporteræ—¥å¿—ä¿¡æ¯**
```
  - job_name: "flume exporter"
    static_configs:
      - targets: ['192.168.101.181:9360']
      - labels:
          job: flume
          alias: flume_feiyan_model
```
>çƒ­é‡å¯Prometheus `curl -X POST http://localhost:9090/-/reload`ï¼Œç„¶åè®¿é—®[Prometheus UI](http://192.168.101.174:9090/graph?g0.expr=&g0.tab=1&g0.stacked=0&g0.show_exemplars=0&g0.range_input=1h)ï¼Œè¾“å…¥FlumeæŸä¸€å‚æ•°æŸ¥è¯¢æ¡ä»¶**FLUME_CHANNEL_ChannelSize**å¯ä»¥å¾—åˆ°ç›‘æ§åˆ°çš„å€¼ã€‚

**é…ç½®Grafana**



<br>
## 3.4 PromQL
Prometheusé€šè¿‡æŒ‡æ ‡åç§°ï¼ˆmetrics nameï¼‰ä»¥åŠå¯¹åº”çš„ä¸€ç»„æ ‡ç­¾ï¼ˆlabelsetï¼‰å”¯ä¸€å®šä¹‰ä¸€æ¡æ—¶é—´åºåˆ—ã€‚æŒ‡æ ‡åç§°åæ˜ äº†ç›‘æ§æ ·æœ¬çš„åŸºæœ¬æ ‡è¯†ï¼Œè€Œlabelåˆ™åœ¨è¿™ä¸ªåŸºæœ¬ç‰¹å¾ä¸Šä¸ºé‡‡é›†åˆ°çš„æ•°æ®æä¾›äº†å¤šç§ç‰¹å¾ç»´åº¦ã€‚ç”¨æˆ·å¯ä»¥åŸºäºè¿™äº›ç‰¹å¾ç»´åº¦è¿‡æ»¤ï¼Œèšåˆï¼Œç»Ÿè®¡ä»è€Œäº§ç”Ÿæ–°çš„è®¡ç®—åçš„ä¸€æ¡æ—¶é—´åºåˆ—ã€‚PromQLæ˜¯Prometheuså†…ç½®çš„æ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œå…¶æä¾›å¯¹æ—¶é—´åºåˆ—æ•°æ®ä¸°å¯Œçš„æŸ¥è¯¢ï¼Œèšåˆä»¥åŠé€»è¾‘è¿ç®—èƒ½åŠ›çš„æ”¯æŒã€‚å¹¶ä¸”è¢«å¹¿æ³›åº”ç”¨åœ¨Prometheusçš„æ—¥å¸¸åº”ç”¨å½“ä¸­ï¼ŒåŒ…æ‹¬å¯¹æ•°æ®æŸ¥è¯¢ã€å¯è§†åŒ–ã€å‘Šè­¦å¤„ç†å½“ä¸­ã€‚

### 3.4.1åŸºæœ¬ç”¨æ³•
#### 3.4.1.1æŸ¥è¯¢æ—¶é—´åºåˆ—
å½“Prometheusé€šè¿‡Exporteré‡‡é›†åˆ°ç›¸åº”çš„ç›‘æ§æŒ‡æ ‡æ ·æœ¬æ•°æ®åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡PromQLå¯¹ç›‘æ§æ ·æœ¬æ•°æ®è¿›è¡ŒæŸ¥è¯¢ã€‚

å½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ç›‘æ§æŒ‡æ ‡åç§°æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥æŸ¥è¯¢è¯¥æŒ‡æ ‡ä¸‹çš„æ‰€æœ‰æ—¶é—´åºåˆ—ã€‚å¦‚ï¼š
```
prometheus_http_requests_total
```
ç­‰åŒäºï¼š
```
prometheus_http_requests_total{}
```
è¯¥è¡¨è¾¾å¼ä¼šè¿”å›æŒ‡æ ‡åç§°ä¸ºprometheus_http_requests_totalçš„æ‰€æœ‰æ—¶é—´åºåˆ—ï¼š
```
prometheus_http_requests_total{code="200",handler="alerts",instance="localhost:9090",job="prometheus",method="get"}= (20889@1518096812.326)

prometheus_http_requests_total{code="200",handler="graph",instance="localhost:9090",job="prometheus",method="get"}= ([21287@1518096812.326](mailto:21287@1518096812.326))
```
PromQLè¿˜æ”¯æŒç”¨æˆ·æ ¹æ®æ—¶é—´åºåˆ—çš„æ ‡ç­¾åŒ¹é…æ¨¡å¼æ¥å¯¹æ—¶é—´åºåˆ—è¿›è¡Œè¿‡æ»¤ï¼Œç›®å‰ä¸»è¦æ”¯æŒä¸¤ç§åŒ¹é…æ¨¡å¼ï¼šå®Œå…¨åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ã€‚

<br>
**PromQLæ”¯æŒä½¿ç”¨ = å’Œ != ä¸¤ç§å®Œå…¨åŒ¹é…æ¨¡å¼ï¼š**

- é€šè¿‡ä½¿ç”¨ label=value å¯ä»¥é€‰æ‹©é‚£äº›Â æ ‡ç­¾æ»¡è¶³è¡¨è¾¾å¼å®šä¹‰çš„æ—¶é—´åºåˆ—ï¼›
- åä¹‹ä½¿ç”¨ label!=value åˆ™å¯ä»¥æ ¹æ®æ ‡ç­¾åŒ¹é…æ’é™¤æ—¶é—´åºåˆ—ï¼›

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åªéœ€è¦æŸ¥è¯¢æ‰€æœ‰prometheus_http_requests_totalæ—¶é—´åºåˆ—ä¸­æ»¡è¶³æ ‡ç­¾instanceä¸ºlocalhost:9090çš„æ—¶é—´ åºåˆ—ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¡¨è¾¾å¼ï¼š
```
prometheus_http_requests_total{instance="localhost:9090"}
```
åä¹‹ä½¿ç”¨ instance!="localhost:9090" åˆ™å¯ä»¥æ’é™¤è¿™äº›æ—¶é—´åºåˆ—ï¼š
```
prometheus_http_requests_total{instance!="localhost:9090"}
```

<br>
**PromQLè¿˜å¯ä»¥æ”¯æŒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä½œä¸ºåŒ¹é…æ¡ä»¶ï¼Œå¤šä¸ªè¡¨è¾¾å¼ä¹‹é—´ä½¿ç”¨ | è¿›è¡Œåˆ†ç¦»ï¼š**

- ä½¿ç”¨ label=~regx è¡¨ç¤ºé€‰æ‹©é‚£äº›æ ‡ç­¾ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼å®šä¹‰çš„æ—¶é—´åºåˆ—ï¼›
- åä¹‹ä½¿ç”¨ label!~regx è¿›è¡Œæ’é™¤ï¼›

ä¾‹å¦‚ï¼Œå¦‚æœæƒ³æŸ¥è¯¢å¤šä¸ªç¯èŠ‚ä¸‹çš„æ—¶é—´åºåˆ—åºåˆ—å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¡¨è¾¾å¼ï¼š
```
prometheus_http_requests_total{environment=~"staging|testing|development",method!="GET"}
```
æ’é™¤ç”¨æ³•
```
prometheus_http_requests_total{environment!~"staging|testing|development",method!="GET"}
```

#### 3.4.1.2 èŒƒå›´æŸ¥è¯¢
ç›´æ¥é€šè¿‡ç±»ä¼¼äºPromQLè¡¨è¾¾å¼httprequeststotalæŸ¥è¯¢æ—¶é—´åºåˆ—æ—¶ï¼Œè¿”å›å€¼ä¸­åªä¼šåŒ…å«è¯¥æ—¶é—´åºåˆ—ä¸­çš„æœ€æ–°çš„ä¸€ä¸ªæ ·æœ¬å€¼ï¼Œè¿™æ ·çš„è¿”å›ç»“æœæˆ‘ä»¬ç§°ä¹‹ä¸ºç¬æ—¶å‘é‡ã€‚è€Œç›¸åº”çš„è¿™æ ·çš„è¡¨è¾¾å¼ç§°ä¹‹ä¸º__**ç¬æ—¶å‘é‡è¡¨è¾¾å¼**ã€‚

è€Œå¦‚æœæˆ‘ä»¬æƒ³è¿‡å»ä¸€æ®µæ—¶é—´èŒƒå›´å†…çš„æ ·æœ¬æ•°æ®æ—¶ï¼Œæˆ‘ä»¬åˆ™éœ€è¦ä½¿ç”¨**åŒºé—´å‘é‡è¡¨è¾¾å¼**ã€‚åŒºé—´å‘é‡è¡¨è¾¾å¼å’Œç¬æ—¶å‘é‡è¡¨è¾¾å¼ä¹‹é—´çš„å·®å¼‚åœ¨äºåœ¨åŒºé—´å‘é‡è¡¨è¾¾å¼ä¸­æˆ‘ä»¬éœ€è¦å®šä¹‰æ—¶é—´é€‰æ‹©çš„èŒƒå›´ï¼Œæ—¶é—´èŒƒå›´é€šè¿‡**æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ []** è¿›è¡Œå®šä¹‰ã€‚ ä¾‹å¦‚ï¼Œé€šè¿‡ä»¥ä¸‹è¡¨è¾¾å¼å¯ä»¥é€‰æ‹©æœ€è¿‘5åˆ†é’Ÿå†…çš„æ‰€æœ‰æ ·æœ¬æ•°æ®ï¼š
```
prometheus_http_request_total{}[5m]
```
è¯¥è¡¨è¾¾å¼å°†ä¼šè¿”å›æŸ¥è¯¢åˆ°çš„æ—¶é—´åºåˆ—ä¸­æœ€è¿‘5åˆ†é’Ÿçš„æ‰€æœ‰æ ·æœ¬æ•°æ®ï¼š
```
prometheus_http_requests_total{code="200",handler="alerts",instance="localhost:9090",job="prometheus",method="get"}=[ 
	1@1518096812.326
	1@1518096817.326
	1@1518096822.326
	1@1518096827.326
	1@1518096832.326
	1@1518096837.325
] 9. prometheus_http_requests_total{code="200",handler="graph",instance="localhost:9090",job="prometheus",method="get"}=[ 
	4@1518096812.326
	4@1518096817.326
	4@1518096822.326
	4@1518096827.326 
	4@1518096832.326
	4@1518096837.325
]
```
é€šè¿‡åŒºé—´å‘é‡è¡¨è¾¾å¼æŸ¥è¯¢åˆ°çš„ç»“æœæˆ‘ä»¬ç§°ä¸ºåŒºé—´å‘é‡ã€‚ é™¤äº†ä½¿ç”¨mè¡¨ç¤ºåˆ†é’Ÿä»¥å¤–ï¼ŒPromQLçš„æ—¶é—´èŒƒå›´é€‰æ‹©å™¨æ”¯æŒå…¶å®ƒæ—¶é—´å•ä½ï¼š
- s - ç§’ 
- m - åˆ†é’Ÿ
- h - å°æ—¶ 
- d - å¤© 
- w - å‘¨ 
- y - å¹´

#### 3.4.1.3 æ—¶é—´ä½ç§»æ“ä½œ
åœ¨ç¬æ—¶å‘é‡è¡¨è¾¾å¼æˆ–è€…åŒºé—´å‘é‡è¡¨è¾¾å¼ä¸­ï¼Œéƒ½æ˜¯ä»¥å½“å‰æ—¶é—´ä¸ºåŸºå‡†ï¼š
http_request_total{} # ç¬æ—¶å‘é‡è¡¨è¾¾å¼ï¼Œé€‰æ‹©å½“å‰æœ€æ–°çš„æ•°æ®
http_request_total{}[5m] # åŒºé—´å‘é‡è¡¨è¾¾å¼ï¼Œé€‰æ‹©ä»¥å½“å‰æ—¶é—´ä¸ºåŸºå‡†ï¼Œ5åˆ†é’Ÿå†…çš„æ•°æ®ã€‚
è€Œå¦‚æœæˆ‘ä»¬æƒ³æŸ¥è¯¢ï¼Œ5åˆ†é’Ÿå‰çš„ç¬æ—¶æ ·æœ¬æ•°æ®ï¼Œæˆ–æ˜¨å¤©ä¸€å¤©çš„åŒºé—´å†…çš„æ ·æœ¬æ•°æ®å‘¢? è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä½ç§»æ“ä½œï¼Œä½ç§»æ“ä½œçš„å…³é”®å­—ä¸ºoffsetã€‚ å¯ä»¥ä½¿ç”¨offsetæ—¶é—´ä½ç§»æ“ä½œï¼š
```
prometheus_http_request_total{} offset 5m
prometheus_http_request_total{}[1d] offset 1d
```

#### 3.4.1.4 ä½¿ç”¨èšåˆæ“ä½œ
ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæè¿°æ ·æœ¬ç‰¹å¾çš„æ ‡ç­¾(label)åœ¨å¹¶éå”¯ä¸€çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡PromQLæŸ¥è¯¢æ•°æ®ï¼Œä¼šè¿”å›å¤šæ¡æ»¡è¶³è¿™äº›ç‰¹å¾ç»´åº¦çš„æ—¶é—´åºåˆ—ã€‚è€ŒPromQLæä¾›çš„èšåˆæ“ä½œå¯ä»¥ç”¨æ¥å¯¹è¿™äº›æ—¶é—´åºåˆ—è¿›è¡Œå¤„ç†ï¼Œå½¢æˆä¸€æ¡æ–°çš„æ—¶é—´åºåˆ—ï¼š 
```
# æŸ¥è¯¢ç³»ç»Ÿæ‰€æœ‰httpè¯·æ±‚çš„æ€»é‡
sum(prometheus_http_request_total)

# æŒ‰ç…§modeè®¡ç®—ä¸»æœºCPUçš„å¹³å‡ä½¿ç”¨æ—¶é—´
avg(node_cpu_seconds_total) by (mode)

# æŒ‰ç…§ä¸»æœºæŸ¥è¯¢å„ä¸ªä¸»æœºçš„CPUä½¿ç”¨ç‡
sum(sum(irate(node_cpu_seconds_total{mode!='idle'}[5m])) / sum(irate(node_cpu _ seconds_total [5m]))) by (instance) 
```

#### 3.4.1.5 æ ‡é‡å’Œå­—ç¬¦ä¸²
é™¤äº†ä½¿ç”¨ç¬æ—¶å‘é‡è¡¨è¾¾å¼å’ŒåŒºé—´å‘é‡è¡¨è¾¾å¼ä»¥å¤–ï¼ŒPromQLè¿˜ç›´æ¥æ”¯æŒç”¨æˆ·ä½¿ç”¨æ ‡é‡(Scalar)å’Œå­—ç¬¦ä¸²(String)ã€‚ 

- æ ‡é‡ï¼ˆScalarï¼‰ï¼šä¸€ä¸ªæµ®ç‚¹å‹çš„æ•°å­—å€¼
æ ‡é‡åªæœ‰ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰æ—¶åºã€‚ ä¾‹å¦‚ï¼š
10 
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½¿ç”¨è¡¨è¾¾å¼count(prometheus_http_requests_total)ï¼Œè¿”å›çš„æ•°æ®ç±»å‹ï¼Œä¾ç„¶æ˜¯ç¬æ—¶å‘é‡ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡å†…ç½®å‡½æ•°scalar()å°†å•ä¸ªç¬æ—¶å‘é‡è½¬æ¢ä¸ºæ ‡é‡ã€‚
- å­—ç¬¦ä¸²ï¼ˆStringï¼‰ï¼šä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²å€¼
ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä½œä¸ºPromQLè¡¨è¾¾å¼ï¼Œåˆ™ä¼šç›´æ¥è¿”å›å­—ç¬¦ä¸²ã€‚
   ``` 
   "this is a string" 
   'these are unescaped: 
 \ 	' 
   `these are not unescaped: 
 ' " 	` 
   ```

#### 3.4.1.6 åˆæ³•çš„PromQLè¡¨è¾¾å¼
æ‰€æœ‰çš„PromQLè¡¨è¾¾å¼éƒ½å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªæŒ‡æ ‡åç§°(ä¾‹å¦‚http_request_total)ï¼Œæˆ–è€…ä¸€ä¸ªä¸ä¼šåŒ¹é…åˆ°ç©ºå­—ç¬¦ä¸²çš„æ ‡ç­¾è¿‡æ»¤å™¨(ä¾‹å¦‚{code=â€200â€})ã€‚ 
å› æ­¤ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼Œå‡ä¸ºåˆæ³•çš„è¡¨è¾¾å¼ï¼š
```
prometheus_http_request_total # åˆæ³•
prometheus_http_request_total{} # åˆæ³•
{method="get"} # åˆæ³• 
```
è€Œå¦‚ä¸‹è¡¨è¾¾å¼ï¼Œåˆ™ä¸åˆæ³•ï¼š
```
{job=~".*"} # ä¸åˆæ³• 
```
åŒæ—¶ï¼Œé™¤äº†ä½¿ç”¨ {label=value} çš„å½¢å¼ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å†…ç½®çš„ __name__ æ ‡ç­¾æ¥æŒ‡å®šç›‘æ§æŒ‡æ ‡åç§°ï¼š
```
{__name__=~"prometheus_http_request_total"} # åˆæ³•
{__name__=~"node_disk_bytes_read|node_disk_bytes_written"} # åˆæ³•
```

### 3.4.2 PromQLæ“ä½œç¬¦
ä½¿ç”¨PromQLé™¤äº†èƒ½å¤Ÿæ–¹ä¾¿çš„æŒ‰ç…§æŸ¥è¯¢å’Œè¿‡æ»¤æ—¶é—´åºåˆ—ä»¥å¤–ï¼ŒPromQLè¿˜æ”¯æŒä¸°å¯Œçš„æ“ä½œç¬¦ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿™äº›æ“ä½œç¬¦å¯¹è¿›ä¸€æ­¥çš„å¯¹äº‹ä»¶åºåˆ—è¿›è¡ŒäºŒæ¬¡åŠ å·¥ã€‚è¿™äº›æ“ä½œç¬¦åŒ…æ‹¬ï¼šæ•°å­¦è¿ç®—ç¬¦ï¼Œé€»è¾‘è¿ç®—ç¬¦ï¼Œå¸ƒå°”è¿ç®—ç¬¦ç­‰ç­‰ã€‚

#### 3.4.2.1 æ•°å­¦è¿ç®—
PromQLæ”¯æŒçš„æ‰€æœ‰æ•°å­¦è¿ç®—ç¬¦å¦‚ä¸‹æ‰€ç¤ºï¼š
- **+ (åŠ æ³•)**
- **- (å‡æ³•)**
- **\* (ä¹˜æ³•)**
- **/ (é™¤æ³•)**
- **% (æ±‚ä½™)**
- **^ (å¹‚è¿ç®—)**

#### 3.4.2.2
**Prometheusæ”¯æŒä»¥ä¸‹å¸ƒå°”è¿ç®—ç¬¦å¦‚ä¸‹ï¼š**
- **== (ç›¸ç­‰)**
- **!= (ä¸ç›¸ç­‰)**
- **>(å¤§äº)**
- **< (å°äº)**
- **>= (å¤§äºç­‰äº)**
- **<= (å°äºç­‰äº)**

**ä½¿ç”¨boolä¿®é¥°ç¬¦æ”¹å˜å¸ƒå°”è¿ç®—ç¬¦çš„è¡Œä¸º**
å¸ƒå°”è¿ç®—ç¬¦çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹æ—¶åºæ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚è€Œåœ¨å…¶å®ƒçš„æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½éœ€è¦çš„æ˜¯çœŸæ­£çš„å¸ƒå°”ç»“æœã€‚ä¾‹å¦‚ï¼Œåªéœ€è¦ çŸ¥é“å½“å‰æ¨¡å—çš„HTTPè¯·æ±‚é‡æ˜¯å¦>=1000ï¼Œå¦‚æœå¤§äºç­‰äº1000åˆ™è¿”å›1ï¼ˆtrueï¼‰å¦åˆ™è¿”å›0ï¼ˆfalseï¼‰ã€‚è¿™æ—¶å¯ä»¥ä½¿ ç”¨boolä¿®é¥°ç¬¦æ”¹å˜å¸ƒå°”è¿ç®—çš„é»˜è®¤è¡Œä¸ºã€‚ ä¾‹å¦‚ï¼š 
```
prometheus_http_requests_total > bool 1000 
```
ä½¿ç”¨boolä¿®æ”¹ç¬¦åï¼Œå¸ƒå°”è¿ç®—ä¸ä¼šå¯¹æ—¶é—´åºåˆ—è¿›è¡Œè¿‡æ»¤ï¼Œè€Œæ˜¯ç›´æ¥ä¾æ¬¡ç¬æ—¶å‘é‡ä¸­çš„å„ä¸ªæ ·æœ¬æ•°æ®ä¸æ ‡é‡çš„æ¯”è¾ƒç»“æœ 0æˆ–è€…1ã€‚ä»è€Œå½¢æˆä¸€æ¡æ–°çš„æ—¶é—´åºåˆ—ã€‚
```
prometheus_http_requests_total{code="200",handler="query",instance="localhost:9090",job="prometheus",method="get"} 	1 
prometheus_http_requests_total{code="200",handler="query_range",instance="localhost:9090",job="prometheus",method="get"} 	0 
```
åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯åœ¨ä¸¤ä¸ªæ ‡é‡ä¹‹é—´ä½¿ç”¨å¸ƒå°”è¿ç®—ï¼Œåˆ™å¿…é¡»ä½¿ç”¨boolä¿®é¥°ç¬¦
```
2 == bool 2 # ç»“æœä¸º1
```

#### 3.4.2.3 ä½¿ç”¨é›†åˆè¿ç®—ç¬¦
ä½¿ç”¨ç¬æ—¶å‘é‡è¡¨è¾¾å¼èƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ªåŒ…å«å¤šä¸ªæ—¶é—´åºåˆ—çš„é›†åˆï¼Œæˆ‘ä»¬ç§°ä¸ºç¬æ—¶å‘é‡ã€‚ é€šè¿‡é›†åˆè¿ç®—ï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªç¬æ—¶å‘é‡ä¸ç¬æ—¶å‘é‡ä¹‹é—´è¿›è¡Œç›¸åº”çš„é›†åˆæ“ä½œã€‚
ç›®å‰ï¼ŒPrometheusæ”¯æŒä»¥ä¸‹é›†åˆè¿ç®—ç¬¦ï¼š 
- and (å¹¶ä¸”) 
- or (æˆ–è€…) 
- unless (æ’é™¤) 

vector1 and vector2 ä¼šäº§ç”Ÿä¸€ä¸ªç”±vector1çš„å…ƒç´ ç»„æˆçš„æ–°çš„å‘é‡ã€‚è¯¥å‘é‡åŒ…å«vector1ä¸­å®Œå…¨åŒ¹é…vector2 ä¸­çš„å…ƒç´ ç»„æˆã€‚ 
vector1 or vector2 ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ï¼Œè¯¥å‘é‡åŒ…å«vector1ä¸­æ‰€æœ‰çš„æ ·æœ¬æ•°æ®ï¼Œä»¥åŠvector2ä¸­æ²¡æœ‰ä¸ vector1åŒ¹é…åˆ°çš„æ ·æœ¬æ•°æ®ã€‚ 
vector1 unless vector2 ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ï¼Œæ–°å‘é‡ä¸­çš„å…ƒç´ ç”±vector1ä¸­æ²¡æœ‰ä¸vector2åŒ¹é…çš„å…ƒç´ ç»„æˆã€‚

#### 3.4.2.4 æ“ä½œç¬¦ä¼˜å…ˆçº§
å¯¹äºå¤æ‚ç±»å‹çš„è¡¨è¾¾å¼ï¼Œéœ€è¦äº†è§£è¿ç®—æ“ä½œçš„è¿è¡Œä¼˜å…ˆçº§ã€‚ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ä¸»æœºçš„CPUä½¿ç”¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼ï¼š
```
100 * (1 - avg (irate(node_cpu_seconds_total{mode='idle'}[5m])) by(job) ) 
```
å…¶ä¸­irateæ˜¯PromQLä¸­çš„å†…ç½®å‡½æ•°ï¼Œç”¨äºè®¡ç®—åŒºé—´å‘é‡ä¸­æ—¶é—´åºåˆ—æ¯ç§’çš„å³æ—¶å¢é•¿ç‡ã€‚åœ¨PromQLæ“ä½œç¬¦ä¸­ä¼˜å…ˆçº§ç”±é«˜åˆ°ä½ä¾æ¬¡ä¸ºï¼š 
- **^**
- **\*, /, %**
- **+, -**
- **==, !=, <=, =, >**
- **and, unless**
- **or**

#### 3.4.2.5 PromQLèšåˆæ“ä½œ
Prometheusè¿˜æä¾›äº†ä¸‹åˆ—å†…ç½®çš„èšåˆæ“ä½œç¬¦ï¼Œè¿™äº›æ“ä½œç¬¦ä½œç”¨åŸŸç¬æ—¶å‘é‡ã€‚å¯ä»¥å°†ç¬æ—¶è¡¨è¾¾å¼è¿”å›çš„æ ·æœ¬æ•°æ®è¿›è¡Œ èšåˆï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ã€‚ 
- sum (æ±‚å’Œ) 
- min (æœ€å°å€¼) 
- max (æœ€å¤§å€¼) 
- avg (å¹³å‡å€¼) 
- stddev (æ ‡å‡†å·®) 
- stdvar (æ ‡å‡†å·®å¼‚) 
- count (è®¡æ•°) 
- count_values (å¯¹valueè¿›è¡Œè®¡æ•°) 
- bottomk (ånæ¡æ—¶åº) 
- topk (å‰næ¡æ—¶åº) 
- quantile (åˆ†å¸ƒç»Ÿè®¡) 
ä½¿ç”¨èšåˆæ“ä½œçš„è¯­æ³•å¦‚ä¸‹ï¼š 
```
<aggr-op>([parameter,] <vector expression>) [without|by (<label list>)] 
```
å…¶ä¸­åªæœ‰ count_values , quantile , topk , bottomk æ”¯æŒå‚æ•°(parameter)ã€‚

 withoutç”¨äºä»è®¡ç®—ç»“æœä¸­ç§»é™¤åˆ—ä¸¾çš„æ ‡ç­¾ï¼Œè€Œä¿ç•™å…¶å®ƒæ ‡ç­¾ã€‚byåˆ™æ­£å¥½ç›¸åï¼Œç»“æœå‘é‡ä¸­åªä¿ç•™åˆ—å‡ºçš„æ ‡ç­¾ï¼Œå…¶ä½™æ ‡ç­¾åˆ™ç§»é™¤ã€‚é€šè¿‡withoutå’Œbyå¯ä»¥æŒ‰ç…§æ ·æœ¬çš„é—®é¢˜å¯¹æ•°æ®è¿›è¡Œèšåˆã€‚ 
ä¾‹å¦‚ï¼š 
```
sum(prometheus_http_requests_total) without (instance) 
```
ç­‰ä»·äº 
```
sum(prometheus_http_requests_total) by (code,handler,job,method) 
```
å¦‚æœåªéœ€è¦è®¡ç®—æ•´ä¸ªåº”ç”¨çš„HTTPè¯·æ±‚æ€»é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¡¨è¾¾å¼ï¼š
```
sum(prometheus_http_requests_total) 
```
count_valuesç”¨äºæ—¶é—´åºåˆ—ä¸­æ¯ä¸€ä¸ªæ ·æœ¬å€¼å‡ºç°çš„æ¬¡æ•°ã€‚count_valuesä¼š
ä¸ºæ¯ä¸€ä¸ªå”¯ä¸€çš„æ ·æœ¬å€¼è¾“å‡ºä¸€ä¸ªæ—¶é—´åºåˆ—ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªæ—¶é—´åºåˆ—åŒ…å«ä¸€ä¸ªé¢å¤–çš„æ ‡ç­¾ã€‚ ä¾‹å¦‚ï¼š 
```
count_values("count", prometheus_http_requests_total) 
```
topkå’Œbottomkåˆ™ç”¨äºå¯¹æ ·æœ¬å€¼è¿›è¡Œæ’åºï¼Œè¿”å›å½“å‰æ ·æœ¬å€¼å‰nä½ï¼Œæˆ–è€…ånä½çš„æ—¶é—´åºåˆ—ã€‚
è·å–HTTPè¯·æ±‚æ•°å‰5ä½çš„æ—¶åºæ ·æœ¬æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼ï¼š
```
topk(5, prometheus_http_requests_total)
```
quantileç”¨äºè®¡ç®—å½“å‰æ ·æœ¬æ•°æ®å€¼çš„åˆ†å¸ƒæƒ…å†µquantile(Ï†, express)å…¶ä¸­0 â‰¤ Ï† â‰¤ 1ã€‚ 
ä¾‹å¦‚ï¼Œå½“Ï†ä¸º0.5æ—¶ï¼Œå³è¡¨ç¤ºæ‰¾åˆ°å½“å‰æ ·æœ¬æ•°æ®ä¸­çš„ä¸­ä½æ•°ï¼š
```
quantile(0.5, prometheus_http_requests_total)
```

<br>
## 3.5 Flinkçš„é›†æˆ
Flink æä¾›çš„ Metrics å¯ä»¥åœ¨ Flink å†…éƒ¨æ”¶é›†ä¸€äº›æŒ‡æ ‡ï¼Œé€šè¿‡è¿™äº›æŒ‡æ ‡è®©å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£ä½œä¸šæˆ–é›†ç¾¤çš„çŠ¶æ€ã€‚ç”±äºé›†ç¾¤è¿è¡Œåå¾ˆéš¾å‘ç°å†…éƒ¨çš„å®é™…çŠ¶å†µï¼Œè·‘å¾—æ…¢æˆ–å¿«ï¼Œæ˜¯å¦å¼‚å¸¸ç­‰ï¼Œå¼€å‘äººå‘˜æ— æ³•å®æ—¶æŸ¥çœ‹æ‰€æœ‰çš„ Task æ—¥å¿—ã€‚æ¯”å¦‚ä½œä¸šå¾ˆå¤§æˆ–è€…æœ‰å¾ˆå¤šä½œä¸šçš„æƒ…å†µä¸‹ï¼Œè¯¥å¦‚ä½•å¤„ç†ï¼Ÿæ­¤æ—¶ Metrics å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©å¼€å‘äººå‘˜äº†è§£ä½œä¸šçš„å½“å‰çŠ¶å†µã€‚

Flinkå®˜æ–¹æ”¯æŒPrometheusï¼Œå¹¶ä¸”æä¾›äº†å¯¹æ¥Prometheusçš„jaråŒ…ï¼Œå¾ˆæ–¹ä¾¿å°±å¯ä»¥é›†æˆã€‚
```
drwxr-xr-x. 2 hxr hxr 114 7æœˆ  23 11:53 external-resource-gpu
drwxr-xr-x. 2 hxr hxr  46 12æœˆ  2 2020 metrics-datadog
drwxr-xr-x. 2 hxr hxr  47 7æœˆ  23 11:53 metrics-graphite
drwxr-xr-x. 2 hxr hxr  47 7æœˆ  23 11:53 metrics-influx
drwxr-xr-x. 2 hxr hxr  42 7æœˆ  23 11:53 metrics-jmx
drwxr-xr-x. 2 hxr hxr  49 7æœˆ  23 11:53 metrics-prometheus
drwxr-xr-x. 2 hxr hxr  44 7æœˆ  23 11:53 metrics-slf4j
drwxr-xr-x. 2 hxr hxr  45 7æœˆ  23 11:53 metrics-statsd
-rwxr-xr-x. 1 hxr hxr 654 6æœˆ  18 2020 README.txt
```

### 3.5.1 æ‹·è´jaråŒ…
å°†flink-metrics-prometheus-1.12.0.jaræ‹·è´åˆ° <flink_home>/libç›®å½•ä¸‹
```
[root@bigdata1 metrics-prometheus]$ cp /opt/module/flink-1.12.0/plugins/metrics-prometheus/flink-metrics-prometheus-1.12.0.jar /opt/module/flink-1.12.0/lib/
```
Flink çš„ Classpath ä½äºlibç›®å½•ä¸‹ï¼Œæ‰€ä»¥æ’ä»¶çš„jaråŒ…éœ€è¦æ”¾åˆ°è¯¥ç›®å½•ä¸‹.

### 3.5.2 ä¿®æ”¹Flinké…ç½®
**æ–¹å¼ä¸€**
è¿›å…¥åˆ°Flinkçš„confç›®å½•ï¼Œä¿®æ”¹flink-conf.yaml
```
[root@bigdata1 conf]$ vim flink-conf.yaml
```
æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š
```
##### ä¸Prometheusé›†æˆé…ç½® #####
metrics.reporter.promgateway.class: org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporter
# PushGatewayçš„ä¸»æœºåä¸ç«¯å£å·
metrics.reporter.promgateway.host: hadoop1
metrics.reporter.promgateway.port: 9091
# Flink metricåœ¨å‰ç«¯å±•ç¤ºçš„æ ‡ç­¾ï¼ˆå‰ç¼€ï¼‰ä¸éšæœºåç¼€
metrics.reporter.promgateway.instance: flink-metrics-
metrics.reporter.promgateway.randomJobNameSuffix: true
metrics.reporter.promgateway.deleteOnShutdown: false
metrics.reporter.promgateway.interval: 30 SECONDS
```


**æ–¹å¼äºŒ**
åœ¨å¯åŠ¨Flinkæ—¶æŒ‡å®š
```
./flink run \
-s hdfs://192.168.101.193:8020/flink/checkpoint/msas/msas_device_exceptions/b6621ef2ee9414d04c0ce2abbfda7490/chk-7356/_metadata --allowNonRestoredState \
-m yarn-cluster -ynm ADS_DEVICE_MSAS_EXCEPTIONS_test -p 2 -ys 2 -yjm 1024 -ytm 2048m \
-d -c com.iotmars.compass.MsasDeviceExceptionsApp -yqu default \
-yD metrics.reporter.promgateway.class=org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporter \
-yD metrics.reporter.promgateway.host=192.168.101.174 -yD metrics.reporter.promgateway.port=9091 \
-yD metrics.reporter.promgateway.instance=flink-metrics \
-yD metrics.reporter.promgateway.randomJobNameSuffix=true \
-yD metrics.reporter.promgateway.deleteOnShutdown=false \
-yD metrics.reporter.promgateway.groupingKey=instance=ADS_DEVICE_MSAS_EXCEPTIONS_test \
/opt/jar/ADS_DEVICE_MSAS_EXCEPTIONS-1.0-SNAPSHOT.jar
```

>pushgatewayä¸Šçš„æ•°æ®ä¼šä¸€ç›´å­˜åœ¨é™¤éæ‰‹åŠ¨åˆ é™¤ï¼›è¿™æ„å‘³ç€å¦‚æœflinkç¨‹åºå®•æœºäº†ï¼Œé‚£ä¹ˆprometheusè¿˜æ˜¯å¯ä»¥ä»pushgatewayä¸Špullåˆ°flinkå®•æœºå‰çš„æ•°æ®ï¼Œä½†æ˜¯prometheusä¸Šè¯¥æ•°æ®çš„æ—¶é—´å´æ˜¯æœ€æ–°çš„æ—¶é—´ã€‚flinkå¯ä»¥é€šè¿‡è®¾ç½®metrics.reporter.promgateway.deleteOnShutdown=trueæ¥ä¸»åŠ¨åˆ é™¤pushgatewayä¸Šçš„æ•°æ®ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯ä¸€å®šèƒ½åˆ é™¤æˆåŠŸã€‚
>è¿™é‡Œå¯ä»¥æ‰§è¡Œä¸€ä¸ªè„šæœ¬åœ¨pushgatewayä¸­å®ç°TTLåŠŸèƒ½ï¼Œåªéœ€è¦ä¿®æ”¹
>```
>trap 'echo "got sigterm" ; exit 0' SIGTERM
>
>EXPIRATION_SECONDS=${EXPIRATION_SECONDS:-900}
>PGW_URL=${PGW_URL:-http://192.168.1.1:9091}
>
>#function convert_to_standardnotation(){
>#    # convert number from scientific notation to standar d( ie  '1.5383780136826127e+09' )
>#    printf '%.0f' $1
>#}
>
>function convert_to_standardnotation() {
>    # convert number from scientific notation to standard( ie  '1.5383780136826127e+09' )
>    echo $1 | awk '{printf("%.0f", $1)}'
>}
>
>function extract_pushgateway_variable(){
> local -r _METRIC=$1
> local -r _VARNAME=$2
> #echo 'push_time_seconds{instance="10.32.32.7",job="bk_jenkins"} 1.5383802210997093e+09' | sed -r 's/.*instance="([^"]*).*/\1/g'
> echo $_METRIC | sed -r "s/.*${_VARNAME}=\"([^\"]*).*/\1/g"
> # sample usage :
> # extract_pushgateway_variable 'push_time_seconds{instance="10.32.32.7",job="bk_jenkins"} 1.5383802210997093e+09' 'instance'
>}
>
>function check_metric_line(){
>    local -r _line=$1
>    METRIC_TIME=$(echo $_line | awk '{print $2}' )
>    #echo "mtime = $_line -> $METRIC_TIME "
>    METRIC_TIME=$(convert_to_standardnotation $METRIC_TIME)
>    #echo "$CURRENT_TIME - $METRIC_TIME "
>    METRIC_AGE_SECONDS=$((CURRENT_TIME-METRIC_TIME))
>
>    if [ "$METRIC_AGE_SECONDS" -gt "$EXPIRATION_SECONDS" ]; then
>
>        metricInstance=$(extract_pushgateway_variable "$_line" 'instance')
>        metricJob=$(extract_pushgateway_variable "$_line" 'job')
>    
>        echo "[INFO] job should be deleted $metricJob  - $metricInstance  age: $METRIC_AGE_SECONDS "
>        curl -s -X DELETE "$PGW_URL/metrics/job/${metricJob}/instance/${metricInstance}"
>        curl -s -X DELETE "$PGW_URL/metrics/job/${metricJob}"
>    fi
>
>
>}
>
>
>function check_expired_metric_loop(){
>
>    export CURRENT_TIME=$(date +%s)
>    METRICS_LIST=$(curl -s  $PGW_URL/metrics | egrep "^push_time_seconds")
>    echo "$METRICS_LIST" | while  read -r line || [[ -n "$line" ]]; do
>        check_metric_line "$line"
>    done
>    sleep $((EXPIRATION_SECONDS / 3 ))
>
>}
>while : ; do
>check_expired_metric_loop
>done 
>```
>åªéœ€è¦æ±‚æ”¹è„šæœ¬ä¸­çš„pushgatewayåœ°å€PGW_URLå’Œttlæ—¶é—´EXPIRATION_SECONDSå³å¯ã€‚åˆ é™¤æ˜¯é€šè¿‡`curl -s -X DELETE "$PGW_URL/metrics/job/${metricJob}"`å®ç°çš„ã€‚è·¯å¾„éœ€è¦è½¬ç¼ºåŒ¹é…æ•°æ®çš„æ ‡ç­¾ï¼Œå¦‚å­˜åœ¨instanceï¼Œåˆ™è¯·æ±‚`curl -s -X DELETE "$PGW_URL/metrics/job/${metricJob}/instance/${metricInstance}"`è¿›è¡Œåˆ é™¤ã€‚

>é™¤äº†é€šè¿‡org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporterä¸»åŠ¨æ¨é€metricsåˆ°pushgatewayä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨org.apache.flink.metrics.prometheus.PrometheusReporterå¼€æ”¾ä¸€ä¸ªç«¯å£ä¾›prometheusä¸»åŠ¨è®¿é—®å¹¶æ‹‰å–metricsï¼Œè¿™ç§æ–¹å¼ä¸å¥½ç»´æŠ¤ç«¯å£ï¼Œæ¨èä½¿ç”¨ä¸Šè¿°PrometheusPushGatewayReporteræ–¹å¼å®ç°ã€‚

<br>
# å››ã€Grafana
Zabbixå’ŒPrometheuséƒ½å¯ä»¥é›†æˆGrafanaã€‚

## 4.1 éƒ¨ç½²
1. ä¸‹è½½Grafanaå®‰è£…åŒ…
```
wget https://dl.grafana.com/enterprise/release/grafana-enterprise-8.5.24.linux-amd64.tar.gz
```

2. ä½¿ç”¨rpmå®‰è£…Grafana
```
[hxr@bigdata3 software]$ tar -zxvf grafana-enterprise-8.5.24.linux-amd64.tar.gz -C /opt/module/
```
å¯åŠ¨å‘½ä»¤ä¸º
`/opt/module/grafana-8.5.24/bin/grafana-server web 1>/opt/module/grafana-8.5.24/grafana.log 2>&1`

3. è®¾ç½®ä¸ºæœåŠ¡å¹¶å¼€æœºè‡ªå¯
ç¼–è¾‘è„šæœ¬ **grafana.service** å¦‚ä¸‹ï¼Œå¹¶å°†å…¶æ”¾åˆ°ç›®å½•/usr/lib/systemd/system/ä¸‹
```
[Unit]
Description=grafana
Documentation=https://github.com/grafana/grafana
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/module/grafana-8.5.24
ExecStart=/opt/module/grafana-8.5.24/bin/grafana-server web 1>/opt/module/grafana-8.5.24/grafana.log 2>&1
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡`systemctl start grafana`

å¼€æœºè‡ªå¯`systemctl enable grafana`

## 4.2 é›†æˆ
### 4.2.1 é›†æˆPrometheus
#### 4.2.1.1 é…ç½®æ•°æ®æº
ç‚¹å‡» Configuration->Data Sources->Add data sourceï¼Œæ‰¾åˆ°Prometheuså¹¶ç‚¹å‡»Selectã€‚

æ·»åŠ Prometheusæ•°æ®æºå±æ€§å¦‚ä¸‹
URLï¼šhttp://192.168.101.174:9090

ç‚¹å‡»ä¸‹æ–¹çš„Save&Testï¼Œå¦‚æœæ˜¾ç¤ºæˆåŠŸåˆ™æ·»åŠ æ•°æ®æºæˆåŠŸã€‚

#### 4.2.1.2 æ‰‹åŠ¨åˆ›å»ºä»ªè¡¨ç›˜
ç‚¹å‡»å·¦è¾¹æ   Create -> Dashboard -> Add an empty panel å³å¯è¿›å…¥ä»ªè¡¨ç›˜ç¼–è¾‘é¡µé¢ã€‚
ç‚¹å‡»Metrics browserå³å¯åœ¨å…¶ä¸­é€‰æ‹©æˆ–ç¼–è¾‘ PromQLè¯­å¥ï¼Œå°†æ•°æ®ä»¥å›¾è¡¨çš„å½¢å¼æ˜¾ç¤ºã€‚å¯ä»¥é…ç½®å¤šä¸ªç›‘æ§é¡¹ã€‚

##### ä»»åŠ¡å¤±è´¥ç›‘æ§
ä»¥Flinkç›‘æ§ä¸ºä¾‹ï¼š
è¿™ä¸€ä¸ªæŒ‡æ ‡ç›‘æ§ä¸»è¦æ˜¯åŸºäºflink_jobmanager_job_uptime è¿™ä¸ªæŒ‡æ ‡è¿›è¡Œäº†ç›‘æ§ã€‚åŸç†æ˜¯åœ¨jobä»»åŠ¡å­˜æ´»æ—¶ï¼Œä¼šæŒ‰ç…§é…ç½®metrics.reporter.promgateway.intervalä¸ŠæŠ¥é¢‘ç‡é€’å¢ã€‚åŸºäºè¿™ä¸ªç‰¹ç‚¹ï¼Œå½“ä»»åŠ¡å¤±è´¥åè¿™ä¸ªæ•°å€¼å°±ä¸ä¼šæ”¹å˜ï¼Œå°±èƒ½ç›‘æ§åˆ°ä»»åŠ¡å¤±è´¥ã€‚

**æ·»åŠ ç›‘æ§é¡¹ï¼š**
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assetsc482e5396214851bf4cc95d95d24d43.png)

30ç§’ä¸ºæ•°æ®ä¸ŠæŠ¥åˆ° promgateway é¢‘ç‡ï¼Œé™¤ä»¥100ä¸ºäº†æ•°æ®å¥½çœ‹ï¼Œå½“jobä»»åŠ¡å¤±è´¥åæ•° flinkä¸ŠæŠ¥çš„promgateway çš„ flink_jobmanager_job_uptimeæŒ‡æ ‡å€¼ä¸ä¼šå˜åŒ–ã€‚((flink_jobmanager_job_uptime)-(flink_jobmanager_job_uptime offset 30s))/100 å€¼å°±ä¼šæ˜¯0ï¼Œå¯ä»¥é…ç½®å‘Šè­¦ã€‚

**é…ç½®å‘Šè­¦ï¼š**
åœ¨Panelé¡µé¢ä¸­ç‚¹å‡» Alert -> Create Alert å³å¯è¿›å…¥å‘Šè­¦é…ç½®é¡µé¢

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets 971ebb27822457c9edcfd08b5735f00.png)

åœ¨å‘Šè­¦é€šçŸ¥ä¸­å¯ä»¥é‚®ä»¶å’Œwebhook,webhookå¯ä»¥è°ƒç”¨ç›¸å…³æ¥å£ï¼Œæ‰§è¡Œä¸€äº›åŠ¨ä½œã€‚webhookéœ€è¦æå‰é…ç½®ï¼Œåœ¨è¿™é‡Œé…ç½®å‘Šè­¦æ—¶å°±å¯ä»¥ç›´æ¥å¼•å…¥ã€‚

##### ç½‘ç»œå»¶æ—¶æˆ–ä»»åŠ¡é‡å¯ç›‘æ§
è¿™ä¸ªå‘Šè­¦ä¹Ÿæ˜¯åŸºäºflink_jobmanager_job_uptime æŒ‡æ ‡ï¼Œåœ¨å‡ºç°ç½‘ç»œå»¶æ—¶æˆ–è€…é‡å¯åè¿›è¡Œç›‘æ§é€šçŸ¥ï¼Œç›‘æ§æŒ‡æ ‡å¦‚ä¸‹ï¼š
((flink_jobmanager_job_uptime offset 30s)-(flink_jobmanager_job_uptime))/1000
1ï¼‰å»¶æ—¶ä¼šå¯¼è‡´å€¼çªç„¶å°äº-30ï¼ˆæ­£å¸¸æƒ…å†µä¸º-30ï¼‰
2ï¼‰é‡å¯ä¼šå¯¼è‡´flink_jobmanager_job_uptimeæŒ‡æ ‡æ¸…é›¶ä»æ–°ä»0å€¼ä¸ŠæŠ¥ï¼Œå¯¼è‡´æŸ¥è¯¢å…¬å¼å€¼çªç„¶å¤§äº0ï¼ˆæ­£å¸¸æƒ…å†µä¸º-30ï¼‰

**æ·»åŠ ç›‘æ§é¡¹ï¼š**
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assetsdd2e635551d4e5bb8d78bd2dd1e9e13.png)


**é…ç½®å‘Šè­¦è§„åˆ™ï¼š**
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assetse8f65cd0fb040c5985c433294ee39de.png)

##### é‡å¯æ¬¡æ•°
åŸºäºflink_jobmanager_job_numRestarts æŒ‡æ ‡ï¼Œè¡¨ç¤ºflink jobçš„é‡å¯æ¬¡æ•°ã€‚ä¸€èˆ¬è®¾ç½®é‡å¯ç­–ç•¥åï¼Œåœ¨ä»»åŠ¡å¼‚å¸¸é‡å¯åè¿™ä¸ªæ•°å€¼ä¼šé€’å¢+1ã€‚å¯ä»¥å•çº¯çš„ç›‘æ§é‡å¯æ¬¡æ•°ï¼Œä¹Ÿå¯ä»¥æ¯æ¬¡é‡å¯éƒ½è¿›è¡Œå‘Šè­¦ï¼ˆå·®å€¼ï¼‰ã€‚

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets625b06cedaf419fa653e335665ccd98.png)

åˆ©ç”¨å½“å‰å€¼å‡å»30ç§’å‰çš„å€¼ï¼Œå¦‚æœç­‰äº1è¯æ˜é‡å¯äº†ä¸€æ¬¡ã€‚

**æ·»åŠ å‘Šè­¦è§„åˆ™ï¼š**

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets\9df5873d8eed45a6a7d98490523d28c7.png)


#### 4.2.1.3 æ·»åŠ æ¨¡æ¿
æ‰‹åŠ¨ä¸€ä¸ªä¸ªæ·»åŠ Dashboardæ¯”è¾ƒç¹çï¼ŒGrafanaç¤¾åŒºé¼“åŠ±ç”¨æˆ·åˆ†äº«Dashboardï¼Œé€šè¿‡[https://grafana.com/dashboards](https://grafana.com/dashboards)ç½‘ç«™ï¼Œå¯ä»¥æ‰¾åˆ°å¤§é‡å¯ç›´æ¥ä½¿ç”¨çš„Dashboardæ¨¡æ¿ã€‚

Grafanaä¸­æ‰€æœ‰çš„Dashboardé€šè¿‡JSONè¿›è¡Œå…±äº«ï¼Œä¸‹è½½å¹¶ä¸”å¯¼å…¥è¿™äº›JSONæ–‡ä»¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å·²ç»å®šä¹‰å¥½çš„Dashboardã€‚

##### æ·»åŠ Node_exportæ¨¡æ¿
æœç´¢ä¸€ä¸ªé«˜èµï¼Œæ›´æ–°æ—¶é—´æ¯”è¾ƒæ–°ä¸”é€‚åˆé¡¹ç›®éœ€æ±‚çš„æ¨¡æ¿ï¼Œç‚¹å‡»Download JSONå°†jsonè„šæœ¬ä¸‹è½½åˆ°æœ¬åœ°ã€‚

ç„¶åè¿›å…¥Grafana UI ï¼Œç‚¹å‡» Create -> Import -> Upload JSON file ï¼Œé€‰æ‹©ä¸‹è½½çš„jsonè„šæœ¬è¿›è¡Œå¯¼å…¥ã€‚

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assetsccae8ec39ae41f69940f07ac7892e07.png)

å¯ä»¥ä¿®æ”¹è¯¥Panelçš„åç§°å’Œæ‰€å±ç»„ï¼Œé€‰æ‹©æ•°æ®æºä¸ºPrometheusï¼Œç‚¹å‡»Importå³å¯åˆ›å»ºå®Œæˆã€‚

##### æ·»åŠ Flinkæ¨¡æ¿
åŒç†ï¼Œæœç´¢å¹¶é€‰æ‹©åˆé€‚çš„Flinkæ¨¡æ¿ï¼Œå°†JSONè„šæœ¬ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¯¼å…¥åˆ°Grafanaä¸­ã€‚

##### æ·»åŠ Process Exporteræ¨¡ç‰ˆ
å®˜ç½‘æ¨èçš„æ¨¡ç‰ˆä¸º[https://grafana.net/dashboards/249](https://grafana.net/dashboards/249)

##### æ·»åŠ Flume Exporteræ¨¡æ¿
Flume Exporteræ¨èä½¿ç”¨ **Grafana Dashboard ID: 10736**

å¯¼å…¥Grafana Dashboard IDä¸º10736çš„æ¨¡æ¿
![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets60a941eda7b4e9d9f6c8c662cb83ed4.png)
ç„¶åé…ç½®æ•°æ®æºä¸ºPrometheusã€‚



### 4.2.2 é›†æˆZabbix
éœ€è¦å…ˆåœ¨grafanaçš„UIç•Œé¢ä¸­å®‰è£…zabbixï¼š
åœ¨ Configuration -> plugins ä¸­æœç´¢zabbixæ’ä»¶ï¼Œéšåinstallæ’ä»¶ï¼Œå®‰è£…å®Œæˆååœ¨configä¸­ç‚¹å‡»enableæ¿€æ´»æ’ä»¶ã€‚
éšåå°±å¯ä»¥åœ¨Add Data Sourceä¸­æ‰¾åˆ°zabbixæ’ä»¶ã€‚

æ·»åŠ Zabbixæ•°æ®æºå±æ€§å¦‚ä¸‹
Urlï¼šhttp://192.168.32.242/zabbix/api_jsonrpc.php
Usernameï¼š Admin
Passwordï¼šzabbix

ç‚¹å‡» Save&test å³å¯æ·»åŠ æ•°æ®æºã€‚


## 4.3 å‘Šè­¦é€šçŸ¥
Granfanaä»Prometheusè·å–æ•°æ®å¹¶æŒ‰ç”¨æˆ·é…ç½®çš„å‘Šè­¦è§„åˆ™å‘å‘Šè­¦æ¨¡å—å‘é€å‘Šè­¦ä¿¡æ¯ï¼Œç„¶åç”±è¿™äº›æ¨¡å—å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œç®¡ç†ï¼ŒåŒ…æ‹¬å»é‡ã€åˆ†ç»„ã€é™éŸ³ã€æŠ‘åˆ¶ã€èšåˆï¼Œæœ€ç»ˆé€šè¿‡ç”µå­é‚®ä»¶ã€webhookç­‰æ–¹å¼å°†å‘Šè­¦ä¿¡æ¯é€šçŸ¥è·¯ç”±ç»™å¯¹åº”çš„è”ç³»äººã€‚

### 4.3.1 ç›´æ¥ä½¿ç”¨Grafanaå‘é€å‘Šè­¦ä¿¡æ¯
Grafanaæ”¯æŒå¤šç§å‘Šè­¦æ¨¡å¼ã€‚
å¦‚æœå¸Œæœ›é€šè¿‡é‚®ç®±å‘é€å‘Šè­¦ä¿¡æ¯ï¼Œåˆ™é…ç½®å¦‚ä¸‹ï¼š
1. ä¿®æ”¹é…ç½®æ–‡ä»¶custom.iniï¼Œæ·»åŠ smtpä¿¡æ¯
```
[smtp]
enabled = true
host = smtp.163.com:25 #smtpæœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£
user = 188****3029@163.com  #ä½ ç™»å½•é‚®ç®±çš„è´¦å·
password =  NUJPIDR*********  #ä½ é‚®ç®±è´¦å·çš„å¯†ç 
from_address = 188****3029@163.com   #å‘é‚®ä»¶çš„è´¦å·
from_name = Grafana #è‡ªå®šä¹‰çš„åå­—
```

2. é…ç½®Notification channels 
åœ¨ Alerting->Notification channels ä¸­é€‰æ‹© add channelï¼Œtypeé€‰æ‹©Emailï¼Œ
é…ç½®å®Œæˆåç‚¹å‡»ä¿å­˜Channelã€‚

3. é…ç½®å‘é€å‘Šè­¦
æˆ‘éœ€è¦ç›‘æ§å¤§æ•°æ®æ¡†æ¶çš„è¿›ç¨‹æœ‰æ²¡æœ‰æ‰ï¼Œå¯ä»¥å…ˆåˆ›å»ºæŸ¥è¯¢(é€šè¿‡PromQLè¿›è¡ŒæŸ¥è¯¢)

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets1066a9679274d05be02831ce2cc471c.png)

ç„¶åæ·»åŠ Alert

![image.png](å¤§æ•°æ®é›†ç¾¤ç›‘æ§æ¡†æ¶.assets918becd7b2d4682ab73de5700f601d8.png)

å¯ä»¥é€šè¿‡Test ruleæ¥æµ‹è¯•å½“å‰æ¡ä»¶ä¸‹æ˜¯å¦ä¼šå‘é€æŠ¥è­¦ä¿¡æ¯ã€‚

ä¿å­˜åå°±ä¼šå°†å‘Šè­¦ä¿¡æ¯å‘é€åˆ°é…ç½®çš„channelä¸­ï¼Œä¿¡æ¯å¦‚ä¸‹

>å¦‚æœéœ€è¦é…ç½®é‡å¤æŠ¥è­¦repeat_intervalé—´éš”ï¼Œå¯ä»¥åœ¨channelä¸­è®¾ç½®ã€‚
å¦‚æœæ— æ³•æ˜¾ç¤ºå›¾ç‰‡ï¼Œéœ€è¦å®‰è£…æ’ä»¶Grafana Image Rendererã€‚å®‰è£…å®Œæˆä¹‹åé€šè¿‡å‘½ä»¤`ldd grafana-8.5.24/data/plugins/grafana-image-renderer/chrome-linux/chrome`æŸ¥çœ‹ç¼ºå¤±çš„ç¯å¢ƒä¾èµ–å¹¶å®‰è£…ã€‚


### 4.3.2 é›†æˆAlterManagerç»„ä»¶å®ç°å‘Šè­¦
1. è§£å‹ç»„ä»¶çš„å‹ç¼©åŒ… alertmanager-0.23.0.linux-amd64.tar.gz

2. ç¼–è¾‘é…ç½®æ–‡ä»¶ alertmanager.yml
```
global: #å…¨å±€é…ç½®ï¼Œä¸»è¦é…ç½®å‘Šè­¦æ–¹å¼ï¼Œå¦‚é‚®ä»¶ç­‰
  resolve_timeout: 5m #è§£æçš„è¶…æ—¶æ—¶é—´
  smtp_smarthost: 'smtp.163.com' #é‚®ç®±smtpåœ°å€
  smtp_from: '188****3029@163.com' #æ¥è‡ªå“ªä¸ªé‚®ç®±å‘å‡ºçš„
  smtp_auth_username: '188****3029@163.com' #é‚®ç®±çš„ç”¨æˆ·å
  smtp_auth_password: 'NUJPID**********'  #è¿™é‡Œæ˜¯é‚®ç®±çš„æˆæƒå¯†ç ï¼Œä¸æ˜¯ç™»å½•å¯†ç 
  smtp_require_tls: false #æ˜¯å¦å¯ç”¨tls
route: #è®¾ç½®æŠ¥è­¦çš„åˆ†å‘ç­–ç•¥ï¼Œé€šè¿‡routeå®ç°å‘Šè­¦çš„åˆ†é…ï¼Œæ‰€æœ‰çš„æŠ¥è­¦éƒ½ä¼šå‘é€åˆ°receiverå‚æ•°é…ç½®çš„æ¥æ”¶å™¨ä¸­
  group_by: ['alertname'] #é‡‡ç”¨å“ªä¸ªæ ‡ç­¾è¿›è¡Œåˆ†ç»„ï¼Œå¯¹å‘Šè­¦é€šçŸ¥æŒ‰æ ‡ç­¾ï¼ˆlabelè¿›è¡Œåˆ†ç»„ï¼‰ï¼Œå°†å…·æœ‰ç›¸åŒæ ‡ç­¾æˆ–ç›¸åŒè­¦å‘Šåç§°ï¼ˆalertnameï¼‰çš„å‘Šè­¦é€šçŸ¥èšåˆåœ¨ä¸€ä¸ªç»„ï¼Œç„¶åä½œä¸ºä¸€ä¸ªé€šçŸ¥å‘é€
  group_wait: 30s #åˆ†ç»„ç­‰å¾…çš„æ—¶é—´ï¼Œæ”¶åˆ°æŠ¥è­¦åå¹¶ä¸æ˜¯é©¬ä¸Šå‘é€å‡ºå»ï¼Œçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰alertnameè¿™ä¸ªæ ‡ç­¾çš„æŠ¥è­¦å‘è¿‡æ¥ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œä¸€èµ·å‘å‡ºæŠ¥è­¦
  group_interval: 5m #ä¸Šä¸€ç»„æŠ¥è­¦ä¸ä¸‹ä¸€ç»„æŠ¥è­¦çš„é—´éš”æ—¶é—´
  repeat_interval: 1h #å‘Šè­¦é€šçŸ¥æˆåŠŸå‘é€åï¼Œè‹¥é—®é¢˜ä¸€ç›´æœªæ¢å¤ï¼Œéœ€è¦å†æ¬¡å‘é€çš„é—´éš”
  receiver: 'email' #æŠ¥è­¦æ¥æ”¶äºº
receivers:
- name: 'email' #è°æ¥æ¥æ”¶è¿™ä¸ªæŠ¥è­¦
  email_configs: #emailçš„é…ç½®
  - to: '792965772@qq.com' #æŠ¥è­¦æ¥æ”¶äººçš„é‚®ä»¶åœ°å€
  - to: 'chenjie.sg@outlook.com' #å¯ä»¥å†™å¤šä¸ªé‚®ä»¶åœ°å€
    send_resolved: true  #å‘é€æ¢å¤é€šçŸ¥
inhibit_rules: #æŠ‘åˆ¶è§„åˆ™,æŠ¥è­¦æŠ‘åˆ¶è§’è‰²ï¼Œç”¨äºæŠ¥è­¦æ”¶æ•›ï¼Œå‘é€å…³é”®æŠ¥è­¦
  - source_match: #åŒ¹é…åˆ°è¿™ä¸ªæŠ¥è­¦å‘ç”Ÿåï¼Œå…¶å®ƒæŠ¥è­¦è¢«æŠ‘åˆ¶æ‰ï¼Œ
      severity: 'critical' #æŠ¥è­¦çº§åˆ«ä¸ºcritical
    target_match: #å…¶å®ƒæŠ¥è­¦
      severity: 'warning' #æŠ¥è­¦çº§åˆ«ä¸ºwarning
    equal: ['alertname', 'dev', 'instance'] #å¯¹æ­¤å¤„é…ç½®çš„æ ‡ç­¾è¿›è¡ŒæŠ¥è­¦æŠ‘åˆ¶
```
**é…ç½®å‚æ•°routeè¯´æ˜ï¼š**Prometheusçš„å‘Šè­¦æœ€å…ˆåˆ°è¾¾æ ¹è·¯ç”±ï¼ˆrouteï¼‰ï¼Œæ˜¯æ‰€æœ‰å‘Šè­¦çš„å…¥å£ç‚¹ï¼Œä¸èƒ½åŒ…å«ä»»ä½•åŒ¹é…é¡¹ã€‚å¦å¤–ï¼Œæ ¹è·¯ç”±éœ€è¦é…ç½®ä¸€ä¸ªæ¥æ”¶å™¨ï¼ˆreceiverï¼‰ï¼Œç”¨æ¥å¤„ç†å“ªäº›æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å­è·¯ç”±çš„å‘Šè­¦ï¼ˆå¦‚æœæ²¡æœ‰å­è·¯ç”±ï¼Œåˆ™å…¨éƒ¨ç”±æ ¹è·¯ç”±å‘é€å‘Šè­¦ï¼‰

**Receiveræ”¯æŒçš„å‘Šè­¦æ¨¡å¼ï¼š**
- email_configï¼šå‘é€å‘Šè­¦é‚®ä»¶
- slack_configï¼šå‘é€å‘Šè­¦ä¿¡æ¯åˆ°slack
- webhook_configï¼šè®¿é—®é…ç½®çš„url
- pagerduty_configï¼šå‘é€å‘Šè­¦ä¿¡æ¯åˆ°pagerduty
- wechat_configsï¼šå‘é€å‘Šè­¦ä¿¡æ¯åˆ°é’‰é’‰ã€‚Alertmanger ä» v0.12 å¼€å§‹å·²ç»é»˜è®¤æ”¯æŒä¼ä¸šå¾®ä¿¡äº†.
   ```
   receivers:
   - name: 'wechat'
     wechat_configs:
     - corp_id: 'xxx' #ä¼ä¸šå¾®ä¿¡è´¦å·å”¯ä¸€ IDï¼Œ å¯ä»¥åœ¨æˆ‘çš„ä¼ä¸šä¸­æŸ¥çœ‹
       to_party: '1' #éœ€è¦å‘é€çš„ç»„
       agent_id: '1000002' #ç¬¬ä¸‰æ–¹ä¼ä¸šåº”ç”¨çš„ IDï¼Œå¯ä»¥åœ¨è‡ªå·±åˆ›å»ºçš„ç¬¬ä¸‰æ–¹ä¼ä¸šåº”ç”¨è¯¦æƒ…é¡µé¢æŸ¥çœ‹
       api_secret: 'xxxx' #ç¬¬ä¸‰æ–¹ä¼ä¸šåº”ç”¨çš„å¯†é’¥ï¼Œå¯ä»¥åœ¨è‡ªå·±åˆ›å»ºçš„ç¬¬ä¸‰æ–¹ä¼ä¸šåº”ç”¨è¯¦æƒ…é¡µé¢æŸ¥çœ‹
       send_resolved: true  #å‘é€æ¢å¤é€šçŸ¥
   ```

3. å¯åŠ¨alertmanager
```
alertmanager/alertmanager --config.file=/usr/local/alertmanager/grafana.yml --storage.path=/usr/local/alertmanager/data/  --log.level=debug
```

4. é…ç½®Grafanaçš„Notification Channel
åœ¨ Alerting->Notification channels ä¸­é€‰æ‹© add channelï¼Œtypeé€‰æ‹©Prometheus Alertmanagerï¼ŒUrlå†™alertmanageræ‰€åœ¨èŠ‚ç‚¹ï¼Œå¦‚192.168.101.174:9093ã€‚
é…ç½®å®Œæˆåç‚¹å‡»ä¿å­˜Channelã€‚

   **æ³¨æ„ï¼š prometheus é»˜è®¤æ—¶åŒºä¸ºUTCä¸”æ— æ³•æ”¹å˜æ—¶åŒºï¼Œå®˜æ–¹å»ºè®®åœ¨ç”¨æˆ·çš„web ui ä¸­é‡æ–°è®¾ç½®æ—¶åŒºï¼Œå› æ­¤æˆ‘ä»¬çš„æŠ¥è­¦æ—¶é—´åº”è¯¥+8:00**

5. é…ç½®Grafanaçš„å‘é€æŠ¥è­¦ä¿¡æ¯
åŒç†ï¼Œåªéœ€è¦å°†Alertä¸­çš„Send toæ·»åŠ ä¸ºé…ç½®çš„alertmanager channelå³å¯ã€‚


### 4.3.3 é›†æˆç¬¬ä¸‰æ–¹å¹³å°ç¿è±¡äº‘å®ç°å‘Šè­¦
1. æ³¨å†Œ[ç¿è±¡äº‘](https://newuser.aiops.com/#/overview)è´¦æˆ·å¹¶ç™»å½•

2. ç‚¹å‡»  æ™ºèƒ½å‘Šè­¦å¹³å° -> é›†æˆï¼Œåœ¨å…¶ä¸­åˆ›å»ºGrafanaåº”ç”¨ï¼Œåˆ›å»ºå®Œæˆåå¾—åˆ°ä¸€ä¸ªAppKeyï¼Œå¯ä»¥æ‹¼æ¥å¾—åˆ°ä¸€ä¸ªUrlï¼šhttp://api.aiops.com/alert/api/event/grafana/v1/${AppKey}

3. Grafanaæ·»åŠ æ–°çš„channelï¼Œchannelç±»å‹ä¸ºWebhookï¼ŒUrlå¤„å¡«å†™ä¸Šä¸€æ­¥å¾—åˆ°çš„urlã€‚

4. åœ¨ç¿è±¡äº‘ [æ™ºèƒ½å‘Šè­¦å¹³å°] çš„ [é…ç½®] ä¸­ç‚¹å‡»æ–°å»ºåˆ†æ´¾ï¼Œå’Œé€šçŸ¥ç­–ç•¥ï¼Œä¿å­˜å®Œæˆåå³å¯æ¥æ”¶Grafanaå‘é€çš„å‘Šè­¦ä¿¡æ¯ï¼Œå¹¶é€šè¿‡é…ç½®çš„æ–¹å¼å°†ä¿¡æ¯è½¬å‘åˆ°æŒ‡å®šçš„ç”¨æˆ·ã€‚



<br>
# äº”ã€é™„
## 5.1 UIç•Œé¢
[http://192.168.32.242/zabbix](http://192.168.32.242/zabbix) Zabbix(Admin:zabbixï¼ŒæŠ¥è­¦é‚®ç®±[792965772@qq.com](mailto:792965772@qq.com))

## 5.2 ç«¯å£
| ç»„ä»¶ | ç«¯å£å· | è¯´æ˜ |
| --- | --- | --- |
| Zabbix | 10051ï¼šZabbix_Serveré€šè®¯ç«¯å£ |  |
| Prometheus | 9090ï¼šprometheus  9100ï¼šnode-productor  9104ï¼šmysqld-exporter  3000ï¼šGrafana |  |

## 5.3 å„jpsè¿›ç¨‹åå¯¹åº”çš„ç»„ä»¶
zabbixä½œä¸ºæœåŠ¡è¿è¡Œï¼Œä¸æ˜¯javaç¨‹åºã€‚
Prometheuså’ŒGrafanaä»¥dockerå®¹å™¨å½¢å¼å¯åŠ¨ã€‚
GanliaåŒæ ·ä»¥dockerå®¹å™¨å½¢å¼å¯åŠ¨ã€‚

## 5.4 å‘½ä»¤ç›¸å…³
#### Zabbix
- bigdata1å¯åŠ¨ï¼š
   ```
   sudo systemctl start/stop zabbix-server zabbix-agent httpd     (httpdæ˜¯è®¿é—®htmlç­‰é¡µé¢çš„å…¥å£)
   ```
   bigdata1è®¾ç½®å¼€æœºè‡ªå¯ï¼š
   ```
   sudo systemctl enable/disable zabbix-server zabbix-agent httpd
   ```

- bigdata2/3å¯åŠ¨ï¼š
   ```
   sudo systemctl start/stop zabbix-agent 
   ```
   è®¾ç½®å¼€æœºè‡ªå¯ï¼š
   ```
   sudo systemctl enable/disable zabbix-agent
   ```

## 5.5 ç»„ä»¶å¯åœè„šæœ¬
```
#!/bin/bash
case $1 in
"start"){
  echo '----- å¯åŠ¨ prometheus -----'
  nohup /opt/module/prometheus-2.30.3/prometheus --web.enable-admin-api --config.file=/opt/module/prometheus-2.30.3/prometheus.yml > /opt/module/prometheus-2.30.3/prometheus.log 2>&1 &
  echo '----- å¯åŠ¨ pushgateway -----'
  nohup /opt/module/pushgateway-1.4.2/pushgateway --web.listen-address :9091 > /opt/module/pushgateway-1.4.2/pushgateway.log 2>&1 &
  echo '----- å¯åŠ¨ grafana -----'
  nohup /opt/module/grafana-8.5.24/bin/grafana-server --homepath /opt/module/grafana-8.5.24 web > /opt/module/grafana-8.5.24/grafana.log 2>&1 &
};;
"stop"){
  echo '----- åœæ­¢ grafana -----'
  pgrep -f grafana | xargs kill
  echo '----- åœæ­¢ pushgateway -----'
  pgrep -f pushgateway | xargs kill
  echo '----- åœæ­¢ prometheus -----'
  pgrep -f prometheus | xargs kill
};;
esac
```
