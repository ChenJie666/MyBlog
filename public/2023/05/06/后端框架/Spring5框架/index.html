<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spring5框架 | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="摘要  Spring框架概述   轻量级开源JavaEE框架，为了减少企业中项目复杂性，两个核心组成：IOC和AOP   IOC容器   IOC底层原理（工厂，反射等） IOC接口（BeanFactory） IOC操作Bean管理（基于xml） IOC操作Bean管理（基于注解）   AOP   AOP底层原理：动态代理(有接口使用JDK动态代理、无接口使用CGLIB动态代理) 术语：连接点">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring5框架">
<meta property="og:url" content="http://example.com/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/Spring5%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="摘要  Spring框架概述   轻量级开源JavaEE框架，为了减少企业中项目复杂性，两个核心组成：IOC和AOP   IOC容器   IOC底层原理（工厂，反射等） IOC接口（BeanFactory） IOC操作Bean管理（基于xml） IOC操作Bean管理（基于注解）   AOP   AOP底层原理：动态代理(有接口使用JDK动态代理、无接口使用CGLIB动态代理) 术语：连接点">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.047Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.047Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/Spring5%E6%A1%86%E6%9E%B6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring5框架',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring5框架</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.047Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.047Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/">后端框架</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring5框架"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><!-- 
1. 循环依赖
2. 事务
3. 生命周期：从Bean的实例化到初始化的过程
4. IOC（控制反转）：重载Bean对象
5. AOP（面向切面编程）：实现一些事务和日志处理
6. 设计模式
7. 传播特性
8. 源码
9. 动态代理(JDK动态代理、CGLIB动态代理)
-->
<br>

<p><strong>摘要</strong></p>
<ol>
<li>Spring框架概述</li>
</ol>
<ul>
<li>轻量级开源JavaEE框架，为了减少企业中项目复杂性，两个核心组成：IOC和AOP</li>
</ul>
<ol start="2">
<li>IOC容器</li>
</ol>
<ul>
<li>IOC底层原理（工厂，反射等）</li>
<li>IOC接口（BeanFactory）</li>
<li>IOC操作Bean管理（基于xml）</li>
<li>IOC操作Bean管理（基于注解）</li>
</ul>
<ol start="3">
<li>AOP</li>
</ol>
<ul>
<li>AOP底层原理：动态代理(有接口使用JDK动态代理、无接口使用CGLIB动态代理)</li>
<li>术语：连接点、切入点、增强(通知)、切面</li>
<li>基于AspectJ实现AOP相关操作</li>
</ul>
<ol start="4">
<li>JdbcTemplate</li>
</ol>
<ul>
<li>使用JdbcTemplate实现CRUD和批量操作</li>
</ul>
<ol start="5">
<li>事务管理</li>
</ol>
<ul>
<li>事务概念（传播行为和隔离级别）</li>
<li>基于注解&#x2F;配置文件方式实现事务管理</li>
</ul>
<ol start="6">
<li>Spring5新功能</li>
</ol>
<ul>
<li>整合日志框架</li>
<li>@Nullable注解</li>
<li>函数式注册对象</li>
<li>整合JUnit5单元测试框架</li>
<li>SpringWebflux使用</li>
</ul>
<p>#一、Spring</p>
<h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p>Spring是一个轻量级控制反转(IOC)和面向切面(AOP)的容器框架。<br>Spring理念：使现有的技术更加容易使用。本身是一个大杂烩。</p>
<p>![image.png](Spring5框架.assets7333b17cd524d7ebe99072f7d4c508c.png)</p>
<p><strong>SSH：</strong>Struct2 + Spring + Hibernate(全自动持久化框架)<br><strong>SSM：</strong>SpringMVC + Spring + Mybatis(半自动持久化框架)</p>
<h2 id="1-2-优点"><a href="#1-2-优点" class="headerlink" title="1.2 优点"></a>1.2 优点</h2><ul>
<li>Spring是一个开源免费的框架（容器）；</li>
<li>Spring是一个轻量级的、非入侵式的框架；</li>
<li><strong>控制反转（IOC），面向切面编程（AOP）；</strong></li>
<li>支持事务的处理，对框架整合的支持。</li>
</ul>
<h2 id="1-3-入门案例"><a href="#1-3-入门案例" class="headerlink" title="1.3 入门案例"></a>1.3 入门案例</h2><p>需要依赖的jar包为</p>
<ul>
<li>commons-logging-1.1.1.jar</li>
<li>spring-beans-5.3.7.RELEASE.jar</li>
<li>spring-context-5.3.7.RELEASE.jar</li>
<li>spring-core-5.3.7.RELEASE.jar</li>
<li>spring-expression-5.3.7.RELEASE.jar</li>
</ul>
<p><strong>依赖</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;spring-version&gt;5.3.7&lt;/spring-version&gt;</span><br><span class="line">        &lt;logging-version&gt;1.1.1&lt;/logging-version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-expression&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;logging-version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.10&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<p><strong>创建Bean文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;user&quot; class=&quot;com.cj.spring5.User&quot;&gt;&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class UserTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testAdd()&#123;</span><br><span class="line">        // 1.加载spring配置文件</span><br><span class="line">        ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);// 如果在src下可以使用该类获取,即默认在classpath路径下</span><br><span class="line">//        BeanFactory context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;); // ClassPathXmlApplicationContext实现了BeanFactory</span><br><span class="line">//       ClassPathXmlApplicationContext context = new FileSystemXmlApplicationContext(&quot;bean1.xml&quot;);  // 1.没有盘符的是项目工作路径,即项目的根目录;2.有盘符表示的是文件绝对路径.  如果要使用classpath路径,需要前缀classpath:</span><br><span class="line"></span><br><span class="line">        // 2.获取配置创建的对象</span><br><span class="line">        User user = context.getBean(&quot;user&quot;, User.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(user);</span><br><span class="line">        user.add();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<br>
# 二、IOC容器
## 2.1 IOC底层原理
控制反转(Inversion of Control)是面向对象编程中的一种设计原则，可以用来减低计算机之间的耦合度。通过控制反转，把对象的创建和对象之间的调用过程，交给Spring进行管理。

<p>第一步：通过xml文件配置需要创建的对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;dao&quot; class=&quot;com.cj.UserDao&quot;&gt;&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>第二步：有service类和dao类，创建工厂类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class UserFactory &#123;</span><br><span class="line">  public static UserDao getDao()&#123;</span><br><span class="line">    String classValue = class的属性值;  // 解析xml得到</span><br><span class="line">    Class clazz = Class.forName(classValue);</span><br><span class="line">    return (UserDao)clazz.newInstance();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>步骤：工厂模式+xml解析+反射创建<br>优点：进一步降低耦合度，只需要修改xml文件中的属性，就可以创建不同的对象。</p>
<br>
## 2.2 IOC接口(BeanFactory)
1. IOC思想基于IOC容器完成，IOC容器底层就是**对象工厂**
2. Spring提供IOC容器实现的两种方式： （两个接口）
- BeanFactory：IOC容器基本实现方式，是Spring内部使用的接口，不提供开发人员进行使用。
**特点：**加载配置文件时，不会创建对象，在获取对象（使用）时才去创建对象。
- ApplicationContext：是BeanFactory接口的子接口，提供了更多更强大的功能，一般由开发人员进行使用。
**特点：**加载配置文件时就会把配置文件对象进行创建。
**分析：**在服务器启动时对对象进行创建，将费时耗资源的操作在启动时完成来的更好。
3. ApplicationContext接口实现类介绍

<p><img src="/Spring5%E6%A1%86%E6%9E%B6.assets%5C3008a502cdaa49d18130aac7ef24eb12.png" alt="image.png"></p>
<p>有两个常用的实现类</p>
<ul>
<li>FileSystemXmlApplicationContext：文件所在的盘符路径，即系统的绝对路径。</li>
<li>ClassPathXmlApplicationContext：src下的类路径</li>
</ul>
<br>
## 2.3 IOC操作Bean管理
**Bean管理指的是两个操作：**
- Spring创建对象
- Spring属性注入

<p><strong>Bean管理操作有两种方式：</strong></p>
<ul>
<li>基于xml方式管理操作</li>
<li>基于注解方式管理操作</li>
</ul>
<h3 id="2-3-1-基于xml方式创建对象"><a href="#2-3-1-基于xml方式创建对象" class="headerlink" title="2.3.1 基于xml方式创建对象"></a>2.3.1 基于xml方式创建对象</h3><ul>
<li>在bean中标签有很多属性，介绍常用的属性：id（唯一标识）、class属性（包类路径）、name（同id，但是不支持特殊符号）</li>
<li>创建对象时，默认也是执行无参构造方法完成对象创建(通过反射创建)。</li>
<li>DI依赖注入：就是注入属性。</li>
</ul>
<p><strong>第一种注入方式：set方法注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;book&quot; class=&quot;com.cj.spring5.Book&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;深入理解java虚拟机&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;author&quot; value=&quot;周志明&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class Book &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private String author;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAuthor(String author) &#123;</span><br><span class="line">        this.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Book&#123;&quot; +</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, author=&#x27;&quot; + author + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第二种注入方式：有参构造注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;book2&quot; class=&quot;com.cj.spring5.Book2&quot;&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;name&quot; value=&quot;深入理解java虚拟机&quot;/&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;author&quot; value=&quot;周志明&quot;/&gt;</span><br><span class="line">        &lt;!--&lt;constructor-arg index=&quot;0&quot; value=&quot;深入理解java虚拟机&quot;/&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;constructor-arg index=&quot;1&quot; value=&quot;周志明&quot;/&gt;--&gt; &lt;!--使用参数位置赋值--&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class Book2 &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private String author;</span><br><span class="line"></span><br><span class="line">    public Book2(String name, String author) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.author = author;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Book&#123;&quot; +</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, author=&#x27;&quot; + author + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第三种注入方式：p名称空间注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;book&quot; class=&quot;com.cj.spring5.Book&quot; p:name=&quot;深入理解java虚拟机&quot; p:author=&quot;周志明&quot;/&gt; &lt;!--p这个名字可以随意更换--&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<br>
### 2.3.2 基于xml方式注入不同类型属性
1. 注入字面量
1）null值
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;book&quot; class=&quot;com.cj.spring5.Book&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;name&quot; value=&quot;深入理解java虚拟机&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;author&quot; value=&quot;周志明&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;address&quot;&gt;</span><br><span class="line">         &lt;null/&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
   2）属性值包含特殊符号
如需要正确赋值如下语句
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;address&quot; value=&quot;&lt;&lt;南京&gt;&gt;&quot;/&gt;</span><br></pre></td></tr></table></figure>
   - 把<>进行转义：使用&lt;和&gt;代替
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;address&quot; value=&quot;&amp;lt;&amp;lt;南京&amp;gt;&amp;gt;&quot;/&gt;</span><br></pre></td></tr></table></figure>
   - 把带特殊符号内容写到CDATA
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;property name=&quot;address&quot;&gt;</span><br><span class="line">    &lt;value&gt;&quot;&lt;![CDATA[&lt;&lt;南京&gt;&gt;]]&gt;&quot;&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>注入属性-外部bean<br>创建两个类service类和dao类，通过ref属性注入外部的bean。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cj.spring5.service.ServiceImpl&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;userDao&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.cj.spring5.dao.UserDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注入属性-内部bean和级联赋值<br>1）一对多关系：部门和员工<br>2）在实体类之间表示一对多的关系<br>使用内部bean赋值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;emp&quot; class=&quot;com.cj.spring5.entity.Emp&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;ename&quot; value=&quot;zhangsan&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;gender&quot; value=&quot;男&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;dep&quot;&gt;</span><br><span class="line">         &lt;bean class=&quot;com.cj.spring5.entity.Dep&quot;&gt;</span><br><span class="line">             &lt;property name=&quot;dname&quot; value=&quot;开发部&quot;/&gt;</span><br><span class="line">         &lt;/bean&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>外部bean赋值，获取bean的属性值并修改(级联赋值)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;emp&quot; class=&quot;com.cj.spring5.entity.Emp&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;ename&quot; value=&quot;zhangsan&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;gender&quot; value=&quot;&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;dep&quot; ref=&quot;dep&quot;/&gt;</span><br><span class="line">     &lt;!--级联赋值--&gt;</span><br><span class="line">     &lt;property name=&quot;dep.dname&quot; value=&quot;人事部&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"> &lt;bean id=&quot;dep&quot; class=&quot;com.cj.spring5.entity.Dep&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;dname&quot; value=&quot;财务部&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注入集合属性<br>①String类型集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;stu&quot; class=&quot;com.cj.spring5.entity.Stu&quot;&gt;</span><br><span class="line">     &lt;!--注入数组类型属性--&gt;</span><br><span class="line">     &lt;property name=&quot;strings&quot;&gt;</span><br><span class="line">         &lt;array&gt;</span><br><span class="line">             &lt;value&gt;java&lt;/value&gt;</span><br><span class="line">             &lt;value&gt;python&lt;/value&gt;</span><br><span class="line">         &lt;/array&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">     &lt;!--注入List集合类型属性--&gt;</span><br><span class="line">     &lt;property name=&quot;list&quot;&gt;</span><br><span class="line">         &lt;list&gt;</span><br><span class="line">             &lt;value&gt;scala&lt;/value&gt;</span><br><span class="line">             &lt;value&gt;c++&lt;/value&gt;</span><br><span class="line">         &lt;/list&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">     &lt;!--注入Set集合类型属性--&gt;</span><br><span class="line">     &lt;property name=&quot;set&quot;&gt;</span><br><span class="line">         &lt;set&gt;</span><br><span class="line">             &lt;value&gt;c&lt;/value&gt;</span><br><span class="line">             &lt;value&gt;go&lt;/value&gt;</span><br><span class="line">         &lt;/set&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">     &lt;!--注入Map集合类型属性--&gt;</span><br><span class="line">     &lt;property name=&quot;map&quot;&gt;</span><br><span class="line">         &lt;map&gt;</span><br><span class="line">             &lt;entry key=&quot;name&quot; value=&quot;flink&quot;/&gt;</span><br><span class="line">             &lt;entry key=&quot;desc&quot; value=&quot;实时处理框架&quot;/&gt;</span><br><span class="line">         &lt;/map&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>②集合属性是自定义类的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;stu&quot; class=&quot;com.cj.spring5.entity.Stu&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;courseList&quot;&gt;</span><br><span class="line">         &lt;list&gt;</span><br><span class="line">             &lt;ref bean=&quot;course1&quot;/&gt;</span><br><span class="line">             &lt;ref bean=&quot;course2&quot;/&gt;</span><br><span class="line">         &lt;/list&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"> &lt;bean id=&quot;course1&quot; class=&quot;com.cj.spring5.entity.Course&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;cname&quot; value=&quot;math&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"> &lt;bean id=&quot;course2&quot; class=&quot;com.cj.spring5.entity.Course&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;cname&quot; value=&quot;chinese&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>③把集合注入部分提取出来<br>首先需要创建名称空间util，使用util保存集合，然后其他bean中就可以应用这个公共集合。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:util=&quot;http://www.springframework.org/schema/util&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                        http://www.springframework.org/schema/util  http://www.springframework.org/schema/util/spring-util.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;util:list id=&quot;courseList&quot;&gt;</span><br><span class="line">     &lt;ref bean=&quot;course1&quot;/&gt;</span><br><span class="line">     &lt;ref bean=&quot;course2&quot;/&gt;</span><br><span class="line"> &lt;/util:list&gt;</span><br><span class="line"> &lt;bean id=&quot;course1&quot; class=&quot;com.cj.spring5.entity.Course&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;cname&quot; value=&quot;math&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"> &lt;bean id=&quot;course2&quot; class=&quot;com.cj.spring5.entity.Course&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;cname&quot; value=&quot;chinese&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;stu&quot; class=&quot;com.cj.spring5.entity.Stu&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;courseList&quot; ref=&quot;courseList&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<br>
### 2.3.3 Bean类型
Spring有两种类型bean，普通bean和工厂bean(FactoryBean)
- 普通bean：在配置文件中定义bean类型就是返回类型
- 工厂bean：在配置文件定义bean类型可以和返回类型不同
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;mybean&quot; class=&quot;com.cj.spring5.entity.MyBean&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test9()&#123;</span><br><span class="line">    ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean8.xml&quot;);</span><br><span class="line">    Course course = context.getBean(&quot;mybean&quot;, Course.class);</span><br><span class="line">    System.out.println(course);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
### 2.3.4 bean作用域
在Spring中，默认创建的bean是单实例的，即获取的同类bean的地址相同。
如何设置bean为多实例呢？可以在xml文件中指定其作用域scope。
- **singleton：**表示单实例(默认)，会在加载xml文件时创建实例。
- **prototype：**表示多实例，加载spring配置文件时不创建实例，而是在getBean时创建实例。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;user&quot; class=&quot;com.cj.spring5.User&quot; scope=&quot;prototype&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
>在Web中，scope还可以填写request和session两个值。request表示一次请求，创建的对象会放到请求中；session表示一次会话，创建的对象会放到会话中。

<br>
### 2.3.5 bean生命周期
**不加bean的后置处理器，bean的生命周期有五步：**
1. 通过构造器创建bean实例（无参数构造）
2. 为bean的属性设置值和对其他bean应用（调用set方法）
3. 调用bean的初始化的方法（配置init-method）
4. 获取bean（getBean获取对象）
5. 当容器关闭时，调用bean的销毁方法（需要调用close方法，就会调用配置的destroy-method方法）

<p><strong>如果加了bean的后置处理器，bean的生命周期就会有七步：</strong></p>
<ol>
<li>通过构造器创建bean实例（无参数构造）</li>
<li>为bean的属性设置值和对其他bean应用（调用set方法）</li>
<li>把bean实例传递给bean后置处理器，调用postProcessBeforeInitialization方法</li>
<li>调用bean的初始化的方法（配置init-method）</li>
<li>把bean实例传递给bean后置处理器，调用postProcessAfterInitialization方法</li>
<li>获取bean（getBean获取对象）</li>
<li>当容器关闭时，调用bean的销毁方法（需要调用close方法，就会调用配置的destroy-method方法）</li>
</ol>
<p><strong>添加后置处理器步骤：</strong></p>
<ol>
<li>创建类，实现接口BeanPostProcessor</li>
<li>创建后置处理器类</li>
<li>xml文件中配置后置处理器，为所有实现接口BeanPostProcessor的bean添加后置处理器</li>
<li>加载xml文件，获取bean，最后close。</li>
</ol>
<p>①创建bean类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class Teacher &#123;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public Teacher()&#123;</span><br><span class="line">        System.out.println(&quot;第一步：执行无参构造&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        System.out.println(&quot;第二步：set设置属性&quot;);</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;第六步：Teacher&#123;&quot; +</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void initMethod() &#123;</span><br><span class="line">        System.out.println(&quot;第四部：执行初始化方法&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void destroyMethod() &#123;</span><br><span class="line">        System.out.println(&quot;第七步：执行销毁方法&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>②创建后置处理器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class MyBeanPostProcessor implements BeanPostProcessor &#123;</span><br><span class="line"></span><br><span class="line">    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">        System.out.println(&quot;第三步：执行postProcessBeforeInitialization&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">        System.out.println(&quot;第五步：执行postProcessAfterInitialization&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③配置bean类和后置过滤器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;teacher&quot; class=&quot;com.cj.spring5.entity.Teacher&quot; init-method=&quot;initMethod&quot; destroy-method=&quot;destroyMethod&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;name&quot; value=&quot;zhangsan&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;myBeanPost&quot; class=&quot;com.cj.spring5.entity.MyBeanPostProcessor&quot;/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>④加载xml文件，获取bean，最后close</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test10()&#123;</span><br><span class="line">    ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean9.xml&quot;);</span><br><span class="line">    Teacher teacher = context.getBean(&quot;teacher&quot;, Teacher.class);</span><br><span class="line">    System.out.println(teacher);</span><br><span class="line">    context.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一步：执行无参构造</span><br><span class="line">第二步：set设置属性</span><br><span class="line">第三步：执行postProcessBeforeInitialization</span><br><span class="line">第四部：执行初始化方法</span><br><span class="line">第五步：执行postProcessAfterInitialization</span><br><span class="line">第六步：Teacher&#123;name=&#x27;zhangsan&#x27;&#125;</span><br><span class="line">第七步：执行销毁方法</span><br></pre></td></tr></table></figure>

<br>
### 2.3.6 bean自动装配
- 手动装配：通过<property/>标签手动对bean的属性进行赋值；

<ul>
<li>自动装配：通过bean标签属性autowire配置自动装配<ul>
<li>byName根据属性名称注入，注入值bean的id值和类属性名称一样</li>
<li>byType根据属性类型注入，注入值类属性名称一样<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; </span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; </span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;userService&quot; class=&quot;com.cj.spring5.service.ServiceImpl&quot; autowire=&quot;byName&quot;&gt;</span><br><span class="line">&lt;!--        &lt;property name=&quot;userDao&quot; ref=&quot;userDao&quot;/&gt;--&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;userDao&quot; class=&quot;com.cj.spring5.dao.UserDaoImpl&quot;/&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<br>
### 2.3.7 外部属性文件
对于如数据库连接等配置，可以写在xml文件中，也可以写在外部属性文件中，进行集中管理，然后引入到xml文件中。

<p>引入druid依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.9&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>内部配置数据库连接 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;  destroy-method=&quot;close&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://chenjie.asia:3306/test&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;password&quot; value=&quot;cj&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></li>
<li>外部属性文件配置数据库连接 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prop.driverClass=com.mysql.jdbc.Driver</span><br><span class="line">prop.url=jdbc:mysql://chenjie.asia:3306/test</span><br><span class="line">prop.username=root</span><br><span class="line">prop.password=cj</span><br></pre></td></tr></table></figure>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"> &lt;!--引入外部属性文件--&gt;</span><br><span class="line"> &lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt;</span><br><span class="line"> &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">     &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;prop.driverClass&#125;&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;url&quot; value=&quot;$&#123;prop.url&#125;&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;username&quot; value=&quot;$&#123;prop.username&#125;&quot;/&gt;</span><br><span class="line">     &lt;property name=&quot;password&quot; value=&quot;$&#123;prop.password&#125;&quot;/&gt;</span><br><span class="line"> &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<br>
## 2.3.8 基于注解方式实现bean创建
创建对象时使用的四个注解如下，四个注解功能是一样的，都可以用来创建bean实例。
- @Component
- @Service
- @Controller
- @Repository

<p>使用注解方式需要额外引入依赖</p>
<ul>
<li>spring-aop-5.3.7.RELEASE.jar</li>
</ul>
<p>在xml文件中指定需要扫描的包，开启组件扫描(如果扫描多个包，多个包使用逗号隔开；也可以直接扫描包上层目录)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5.service&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>添加@Service注解（@Component&#x2F;@Controller&#x2F;@Repository效果相同），value缺省值为类名首字母小写。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Service(value = &quot;userService&quot;)</span><br><span class="line">public class UserService &#123;</span><br><span class="line">    public void add()&#123;</span><br><span class="line">        System.out.println(&quot;userService add...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test11()&#123;</span><br><span class="line">    ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean12.xml&quot;);</span><br><span class="line">    UserService userService = context.getBean(&quot;userService&quot;, UserService.class);</span><br><span class="line">    userService.add();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要扫描包下指定注解，则可以舍弃默认的过滤器，使用自己配置的过滤器。<br>如扫描指定的注解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5.service&quot; use-default-filters=&quot;false&quot;&gt;</span><br><span class="line">        &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;</span><br><span class="line">    &lt;/context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>不扫描指定的注解（如下不但会扫描@Controller的bean，还会扫描@Component、@Service、@Repository的bean）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5.service&quot; use-default-filters=&quot;false&quot;&gt;</span><br><span class="line">        &lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt;</span><br><span class="line">    &lt;/context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<br>
### 2.3.9 基于注解方式实现属性注入
**注入属性的三个注解**
- @Autowired：根据属性类型进行自动装配；
- @Qualifier：根据属性名称进行注入。需要和@Autowired一起使用；
- @Resource：可以根据类型注入，也可以根据名称注入；
- @Value：注入普通类型属性；

<p>NOTE：Resource包路径为javax.annotation.Resource，而其他三个注解都是org.springframework包下的类。</p>
<p><strong>使用@Autowired和@Qualifier完成注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5&quot; use-default-filters=&quot;false&quot;&gt;</span><br><span class="line">        &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Service&quot;/&gt;</span><br><span class="line">        &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Component&quot;/&gt;</span><br><span class="line">    &lt;/context:component-scan&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>@Qualifier(value &#x3D; “userDaoImpl1”) 指定属性名称进行注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Service(value = &quot;userService&quot;)</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(value = &quot;userDaoImpl1&quot;)</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    public void add()&#123;</span><br><span class="line">        System.out.println(&quot;add...&quot;);</span><br><span class="line">        userDao.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line">    void add();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>向容器中注入UserDao对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Component(value = &quot;userDaoImpl1&quot;)</span><br><span class="line">public class UserDaoImpl implements UserDao &#123;</span><br><span class="line"></span><br><span class="line">    public void add() &#123;</span><br><span class="line">        System.out.println(&quot;dao add...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用@Resource完成注入</strong><br>将@Autowired和@Qualifier(value &#x3D; “userDaoImpl1”)替换为@Resource(name &#x3D; “userDaoImpl1”)完成相同效果，实现根据属性名称进行注入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Service(value = &quot;userService&quot;)</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Resource(name = &quot;userDaoImpl1&quot;)</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    public void add()&#123;</span><br><span class="line">        System.out.println(&quot;add...&quot;);</span><br><span class="line">        userDao.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果@Resource注解缺省name属性，则默认根据类型进行注入。</p>
<p><strong>使用@Value完成普通类型注入</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Service(value = &quot;userService&quot;)</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Value(value = &quot;zhangsan&quot;)</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public String getName()&#123;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
### 2.3.10 纯注解开发
1. 创建配置类，替代xml配置文件
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages = &#123;&quot;com.cj.spring5&quot;&#125;)</span><br><span class="line">public class SpringConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
2. 使用AnnotationConfigApplicationContext类来加载配置类
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test13()&#123;</span><br><span class="line">    AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line">    UserService userService = context.getBean(&quot;userService&quot;, UserService.class);</span><br><span class="line">    userService.add();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
# 三、AOP
**概念：**面向切面编程，利用AOP可以对业务逻辑的各个部分进行隔离，从而使业务逻辑各部分之间的耦合度降低，提高程序的可重用性，提高开发效率。
**通俗理解：**不通过修改源代码方式，在主干功能里添加新功能。
**使用场景：**日志记录、性能统计、安全控制、事务处理、异常处理等代码从业务逻辑代码中划分出来。
**AOP原理：**底层使用动态代理。

<h2 id="3-1-两种情况的动态代理"><a href="#3-1-两种情况的动态代理" class="headerlink" title="3.1 两种情况的动态代理"></a>3.1 两种情况的动态代理</h2><ul>
<li>有接口的情况，使用JDK动态代理：创建接口实现类的代理对象</li>
<li>没有接口情况，使用CGLIB动态代理：创建当前类子类的代理对象</li>
</ul>
<h3 id="3-1-1-JDK动态代理"><a href="#3-1-1-JDK动态代理" class="headerlink" title="3.1.1 JDK动态代理"></a>3.1.1 JDK动态代理</h3><ol>
<li><p>创建接口和实现类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line">    int add(int a, int b);</span><br><span class="line">    String update(String id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class UserDaoImpl implements UserDao &#123;</span><br><span class="line">    public int add(int a, int b) &#123;</span><br><span class="line">        return a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String update(String id) &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用newProxyInstance方法对实现类进行代理，在调用原方法之前和之后可以添加处理逻辑，实现对原方法的逻辑增强。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class UserJDKProxy &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        Class[] interfaces = &#123;UserDao.class&#125;;</span><br><span class="line">        UserDaoImpl userDaoImpl = new UserDaoImpl();</span><br><span class="line">        UserDao userDao = (UserDao)Proxy.newProxyInstance(UserJDKProxy.class.getClassLoader(), interfaces, new MyInvocationHandler(userDaoImpl));</span><br><span class="line">        int add = userDao.add(1, 2);</span><br><span class="line">        System.out.println(add);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyInvocationHandler implements InvocationHandler &#123;</span><br><span class="line"></span><br><span class="line">    private Object obj;</span><br><span class="line"></span><br><span class="line">    public MyInvocationHandler(Object obj) &#123;</span><br><span class="line">        this.obj = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object invoke(Object o, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;方法名：&quot; + method.getName() + &quot; --- 参数：&quot; + Arrays.toString(args));</span><br><span class="line"></span><br><span class="line">        Object res = method.invoke(obj, args);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;方法执行后...&quot;);</span><br><span class="line"></span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<br>
### 3.1.2 CGLIB动态代理


<br>
## 3.2 AOP术语
1. 连接点：类中的哪些方法可以被增强，这些方法称为连接点；
2. 切入点：实际真正被增强的方法，称为切入点；
3. 通知(增强)：实际增强的逻辑部分称为通知；通知有多种类型
   - 前置通知：
   - 后置通知：
   - 环绕通知：
   - 异常通知：
   - 最终通知：
4. 切面：是动作，把通知应用到切入点的过程。

<br>
## 3.3 AspectJ
Spring框架一般都是基于AspectJ实现AOP操作。

<p>什么是AspectJ ? AspectJ不是Spring组成部分，是一个独立AOP框架，一般把AspectJ和Spring框架一起使用，进行AOP操作。</p>
<p><strong>需要引入新的包</strong></p>
<ul>
<li>spring-aspects-5.3.7.RELEASE.jar</li>
<li>com.springsource.net.sf.cglib-2.2.0.jar</li>
<li>com.springsource.org.aopalliance-1.0.0.jar</li>
<li>com.springsource.org.aspectj.weaver-1.6.8.RELEASE.jar</li>
</ul>
<p><strong>切入点表达式</strong><br>execution([权限修饰符] [返回类型] [类全路径] [方法名称] ([参数列表]) )</p>
<p>例1：对com.cj.dao.UserDao类中的add方法进行增强<br>execution(* com.cj.dao.UserDao.add(..))<br>例2：对com.cj.dao.UserDao类中的所有public修饰的方法进行增强<br>execution(public com.cj.dao.UserDao.<em>(..))<br>例3：对com.cj.dao包中的所有类的方法进行增强<br>execution(</em> com.cj.dao.<em>.</em>(..))</p>
<h3 id="3-3-1-AspectJ注解实现"><a href="#3-3-1-AspectJ注解实现" class="headerlink" title="3.3.1 AspectJ注解实现"></a>3.3.1 AspectJ注解实现</h3><p><strong>注解：</strong></p>
<ul>
<li>@Aspect  注解在增强类上，开启动态代理，生成代理对象</li>
<li>@Around  环绕通知(在@Before之前和@After之前环绕)</li>
<li>@Before  前置通知(方法前执行)</li>
<li>@After  最终通知(无论是否异常，都会执行)</li>
<li>@AfterThrowing  异常通知(发生异常执行)</li>
<li>@AfterReturning  后置通知(发生异常不执行)</li>
</ul>
<h4 id="3-3-1-1-实现"><a href="#3-3-1-1-实现" class="headerlink" title="3.3.1.1 实现"></a>3.3.1.1 实现</h4><ol>
<li>xml文件配置注解扫描和生成代理对象<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">                        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line">    &lt;!--开启注解扫描--&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5&quot;/&gt;</span><br><span class="line">    &lt;!--开启Aspect生成代理对象--&gt;</span><br><span class="line">    &lt;aop:aspectj-autoproxy/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
也可以不使用如上xml配置，直接用配置类实现，使用@ComponentScan和@EnableAspectJAutoProxy注解。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages = &quot;com.cj.spring5&quot;)</span><br><span class="line">@EnableAspectJAutoProxy(proxyTargetClass = true)</span><br><span class="line">public class SpringConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>@ComponentScan注解不要扫描默认被扫描的包，会导致访问404问题。如在Application类上用@ComponentScan注解扫描子包，导致重复扫描，发生404问题。</p>
</blockquote>
</li>
<li>创建被增强类(被代理类)和增强类(代理类)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class User &#123;</span><br><span class="line">    public void add()&#123;</span><br><span class="line">        System.out.println(&quot;add......&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">public class UserProxy &#123;</span><br><span class="line"></span><br><span class="line">    @Around(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line">    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123;</span><br><span class="line">        System.out.println(&quot;环绕前...&quot;);</span><br><span class="line">        proceedingJoinPoint.proceed();</span><br><span class="line">        System.out.println(&quot;环绕后...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Before(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line">    public void before()&#123;</span><br><span class="line">        System.out.println(&quot;before...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line">    public void after()&#123;</span><br><span class="line">        System.out.println(&quot;after...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @AfterThrowing(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line">    public void afterThrowing() &#123;</span><br><span class="line">        System.out.println(&quot;afterThrowing...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @AfterReturning(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line">    public void afterReturning()&#123;</span><br><span class="line">        System.out.println(&quot;afterReturning...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test()&#123;</span><br><span class="line">    // ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">    AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line"></span><br><span class="line">    User user = context.getBean(&quot;user&quot;, User.class);</span><br><span class="line">    user.add();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<strong>结果：</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">环绕前...</span><br><span class="line">before...</span><br><span class="line">add......</span><br><span class="line">afterReturning...</span><br><span class="line">after...</span><br><span class="line">环绕后...</span><br></pre></td></tr></table></figure>
<strong>如果被增强方法中抛出异常，结果如下：</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">环绕前...</span><br><span class="line">before...</span><br><span class="line">afterThrowing...</span><br><span class="line">after...</span><br></pre></td></tr></table></figure>
抛出异常后，@AfterThrowing执行，@AfterReturning和@Round环绕后方法不执行，@After不管抛不抛异常都正常执行。</li>
</ol>
<h4 id="3-3-1-2-优化"><a href="#3-3-1-2-优化" class="headerlink" title="3.3.1.2 优化"></a>3.3.1.2 优化</h4><ol>
<li><p><strong>抽取相同切入点</strong><br>注解 <code>@Pointcut(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot; )</code>  用于相同切入点抽取</p>
<p>优化后代理类如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">public class UserProxy &#123;</span><br><span class="line"></span><br><span class="line"> @Pointcut(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line"> public void point()&#123;&#125;;</span><br><span class="line"></span><br><span class="line"> @Around(value = &quot;point()&quot;)</span><br><span class="line"> public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123;</span><br><span class="line">     System.out.println(&quot;环绕前...&quot;);</span><br><span class="line">     proceedingJoinPoint.proceed();</span><br><span class="line">     System.out.println(&quot;环绕后...&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> @Before(value = &quot;point()&quot;)</span><br><span class="line"> public void before()&#123;</span><br><span class="line">     System.out.println(&quot;before...&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> @After(value = &quot;point()&quot;)</span><br><span class="line"> public void after()&#123;</span><br><span class="line">     System.out.println(&quot;after...&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> @AfterThrowing(value = &quot;point()&quot;)</span><br><span class="line"> public void afterThrowing() &#123;</span><br><span class="line">     System.out.println(&quot;afterThrowing...&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> @AfterReturning(value = &quot;point()&quot;)</span><br><span class="line"> public void afterReturning()&#123;</span><br><span class="line">     System.out.println(&quot;afterReturning...&quot;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<br>
2. **同一个方法有多个增强类，设置增强类的优先级**
注解 @Order(数字类型值)  实现优先级设置，数字类型值越小优先级越高。
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">@Order(3)</span><br><span class="line">public class PersonProxy &#123;</span><br><span class="line"></span><br><span class="line"> @Before(value = &quot;execution(* com.cj.spring5.entity.User.add(..))&quot;)</span><br><span class="line"> public void before()&#123;</span><br><span class="line">     System.out.println(&quot;personProxy before......&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
### 3.3.2 AspectJ配置文件实现
1. 创建被增强类(被代理类)和增强类(代理类)
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class Book &#123;</span><br><span class="line"> public void buy()&#123;</span><br><span class="line">     System.out.println(&quot;buy......&quot;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class BookProxy &#123;</span><br><span class="line"> public void before()&#123;</span><br><span class="line">     System.out.println(&quot;before......&quot;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>xml文件配置切入点<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                     http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line"> &lt;bean id=&quot;book&quot; class=&quot;com.cj.spring5.entity.Book&quot;/&gt;</span><br><span class="line"> &lt;bean id=&quot;bookProxy&quot; class=&quot;com.cj.spring5.entity.BookProxy&quot;/&gt;</span><br><span class="line"></span><br><span class="line"> &lt;aop:config&gt;</span><br><span class="line">     &lt;!--提取切入点方法--&gt;</span><br><span class="line">     &lt;aop:pointcut id=&quot;p&quot; expression=&quot;execution(* com.cj.spring5.entity.Book.buy(..))&quot;/&gt;</span><br><span class="line"></span><br><span class="line">     &lt;aop:aspect ref=&quot;bookProxy&quot;&gt;</span><br><span class="line">         &lt;!--method是增强类中的前置执行方法,pointcut-ref是提取的切入点,pointcut是切入点方法--&gt;</span><br><span class="line">         &lt;aop:before method=&quot;before&quot; pointcut-ref=&quot;p&quot;/&gt;</span><br><span class="line">     &lt;/aop:aspect&gt;</span><br><span class="line"> &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<br>
# 四、JdbcTemplate
**引入依赖**
- mysql-connector-java-5.1.7
- druid-1.1.9
- spring-jdbc-5.3.7.RELEASE
- spring-orm-5.3.7.RELEASE
- spring-tx-5.3.7.RELEASE

<p><strong>配置数据库连接池，配置jdbcTemplate对象，注入DataSource</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;datasource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot; destroy-method=&quot;close&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://chenjie.asia:3306/test?characterEncoding=utf8&amp;amp;useUnicode=true&amp;amp;useSSL=false&amp;amp;serverTimezone=UTC&amp;amp;allowMultiQueries=true&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;cj&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;</span><br><span class="line">&lt;!--        &lt;constructor-arg name=&quot;dataSource&quot; ref=&quot;datasource&quot;/&gt;--&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;datasource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：注入DataSource时，可以使用有参构造注入，也可以通过set方法注入，所以使用property或constructor-arg标签都可以。</p>
</blockquote>
<br>
**创建BookDaoImpl类，注入JdbcTemplate对象。通过JdbcTemplate对数据库进行操作。用到的方法如下：**
- update(String sql, Object[] args) 进行增删改操作；
- queryForObject(String sql, Class<Integer> requiredType) 返回制定类型的单个值；
- queryForObject(String sql, RowMapper<?> RowMapper, Object... args)  查询并返回单个对象(RowMapper是接口，使用该接口的实现类BeanPropertyRowMapper完成返回数据的对象封装)；
- query(String sql, RowMapper<?> RowMapper, Object... args)  查询并返回对象集合；
- batchUpdate(String sql, List<Object[]> batchArgs)  批量操作，原理是对List中的每个元素都执行一次操作（是否会有效率问题和事务问题？？？）

<p><strong>代码如下</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class BookDaoImpl implements BookDao &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    public int addBook(Book book) &#123;</span><br><span class="line">        String sql = &quot;insert into t_book values(?,?,?)&quot;;</span><br><span class="line">        int rows = jdbcTemplate.update(sql, book.getBookId(), book.getBookName(), book.getBstatus());</span><br><span class="line"></span><br><span class="line">        return rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int updateBook(Book book) &#123;</span><br><span class="line">        String sql = &quot;update t_book set book_name=?,bstatus=? where book_id=?&quot;;</span><br><span class="line">        int rows = jdbcTemplate.update(sql, book.getBookName(), book.getBstatus(), book.getBookId());</span><br><span class="line"></span><br><span class="line">        return rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int deleteBook(String bookId) &#123;</span><br><span class="line">        String sql = &quot;delete from t_book where book_id=?&quot;;</span><br><span class="line">        int rows = jdbcTemplate.update(sql, bookId);</span><br><span class="line"></span><br><span class="line">        return rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 查询并返回单个值</span><br><span class="line">    public int selectCount() &#123;</span><br><span class="line">        String sql = &quot;select count(*) from t_book&quot;;</span><br><span class="line">        return jdbcTemplate.queryForObject(sql, Integer.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 查询并返回对象</span><br><span class="line">    public Book selectBook(String bookId) &#123;</span><br><span class="line">        String sql = &quot;select * from t_book where book_id=?&quot;;</span><br><span class="line">        return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper&lt;Book&gt;(Book.class), bookId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 查询并返回对象集合</span><br><span class="line">    public List&lt;Book&gt; selectBooks() &#123;</span><br><span class="line">        String sql = &quot;select * from t_book&quot;;</span><br><span class="line">        return jdbcTemplate.query(sql, new BeanPropertyRowMapper&lt;Book&gt;(Book.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 批量添加</span><br><span class="line">    public int[] batchAddBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        String sql = &quot;insert into t_book values(?,?,?)&quot;;</span><br><span class="line">        return jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 批量修改</span><br><span class="line">    public int[] batchUpdateBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        String sql = &quot;update t_book set book_name=?,bstatus=? where book_id=?&quot;;</span><br><span class="line">        return jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 批量删除</span><br><span class="line">    public int[] batchDeleteBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        String sql = &quot;delete from t_book where book_id=?&quot;;</span><br><span class="line">        return jdbcTemplate.batchUpdate(sql, batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public interface BookDao &#123;</span><br><span class="line">    int addBook(Book book);</span><br><span class="line"></span><br><span class="line">    int updateBook(Book book);</span><br><span class="line"></span><br><span class="line">    int deleteBook(String bookId);</span><br><span class="line"></span><br><span class="line">    int selectCount();</span><br><span class="line"></span><br><span class="line">    Book selectBook(String bookId);</span><br><span class="line"></span><br><span class="line">    List&lt;Book&gt; selectBooks();</span><br><span class="line"></span><br><span class="line">    int[] batchAddBook(List&lt;Object[]&gt; batchArgs);</span><br><span class="line"></span><br><span class="line">    int[] batchUpdateBook(List&lt;Object[]&gt; batchArgs);</span><br><span class="line"></span><br><span class="line">    int[] batchDeleteBook(List&lt;Object[]&gt; batchArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class BookService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    public int addBook(Book book)&#123;</span><br><span class="line">        return bookDao.addBook(book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int updateBook(Book book) &#123;</span><br><span class="line">        return bookDao.updateBook(book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int deleteBook(String bookId) &#123;</span><br><span class="line">        return bookDao.deleteBook(bookId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int selectCount()&#123;</span><br><span class="line">        return bookDao.selectCount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Book selectBook(String bookId)&#123;</span><br><span class="line">        return bookDao.selectBook(bookId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Book&gt; selectBooks() &#123;</span><br><span class="line">        return bookDao.selectBooks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int[] batchAddBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        return bookDao.batchAddBook(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int[] batchUpdateBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        return bookDao.batchUpdateBook(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int[] batchDeleteBook(List&lt;Object[]&gt; batchArgs) &#123;</span><br><span class="line">        return bookDao.batchDeleteBook(batchArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">public class JdbcTemplateTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void addBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Book book = new Book();</span><br><span class="line">//        book.setBookId(&quot;1&quot;);</span><br><span class="line">        book.setBookId(&quot;2&quot;);</span><br><span class="line">//        book.setBookName(&quot;java开发手册&quot;);</span><br><span class="line">        book.setBookName(&quot;深入理解Java虚拟机&quot;);</span><br><span class="line">        book.setBstatus(&quot;1&quot;);</span><br><span class="line"></span><br><span class="line">        int rows = bookService.addBook(book);</span><br><span class="line">        System.out.println(rows);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void updateBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Book book = new Book();</span><br><span class="line">        book.setBookId(&quot;1&quot;);</span><br><span class="line">        book.setBookName(&quot;深入理解Java虚拟机&quot;);</span><br><span class="line">        book.setBstatus(&quot;2&quot;);</span><br><span class="line"></span><br><span class="line">        int rows = bookService.updateBook(book);</span><br><span class="line">        System.out.println(rows);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void deleteBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        int rows = bookService.deleteBook(&quot;1&quot;);</span><br><span class="line">        System.out.println(rows);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void selectCount()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        int count = bookService.selectCount();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void selectBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Book book = bookService.selectBook(&quot;1&quot;);</span><br><span class="line">        System.out.println(book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void selectBooks()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        List&lt;Book&gt; books = bookService.selectBooks();</span><br><span class="line">        System.out.println(books);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void batchAddBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Object[] o1 = &#123;&quot;3&quot;, &quot;数据结构&quot;, &quot;3&quot;&#125;;</span><br><span class="line">        Object[] o2 = &#123;&quot;4&quot;, &quot;计算机操作系统&quot;, &quot;3&quot;&#125;;</span><br><span class="line">        Object[] o3 = &#123;&quot;5&quot;, &quot;计算机网络&quot;, &quot;3&quot;&#125;;</span><br><span class="line">        List&lt;Object[]&gt; batchArgs = Arrays.asList(o1, o2, o3);</span><br><span class="line"></span><br><span class="line">        int[] ints = bookService.batchAddBook(batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void batchUpdateBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Object[] o1 = &#123;&quot;hive调优&quot;, &quot;a&quot;, &quot;3&quot;&#125;;</span><br><span class="line">        Object[] o2 = &#123;&quot;计算机组成&quot;, &quot;b&quot;, &quot;4&quot;&#125;;</span><br><span class="line">        Object[] o3 = &#123;&quot;C语言程序设计&quot;, &quot;c&quot;, &quot;5&quot;&#125;;</span><br><span class="line">        List&lt;Object[]&gt; batchArgs = Arrays.asList(o1, o2, o3);</span><br><span class="line"></span><br><span class="line">        int[] ints = bookService.batchUpdateBook(batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void batchDeleteBook()&#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">        BookService bookService = context.getBean(&quot;bookService&quot;, BookService.class);</span><br><span class="line"></span><br><span class="line">        Object[] o1 = &#123;&quot;3&quot;&#125;;</span><br><span class="line">        Object[] o2 = &#123;&quot;4&quot;&#125;;</span><br><span class="line">        Object[] o3 = &#123;&quot;5&quot;&#125;;</span><br><span class="line">        List&lt;Object[]&gt; batchArgs = Arrays.asList(o1, o2, o3);</span><br><span class="line"></span><br><span class="line">        int[] ints = bookService.batchDeleteBook(batchArgs);</span><br><span class="line">        System.out.println(Arrays.toString(ints));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
# 五、事务
在转账等场景中需要引入事务，通过代码实现事务的开启、提交或回滚。
而在Spring中是如何进行事务操作的呢?
有两种方式

<ul>
<li><p>编程式事务管理：需要为每个事务都添加事务操作代码。<br>手动回滚的方法：<code>currentTransactionStatus().setRollbackOnly();</code></p>
</li>
<li><p>声明式事务管理（推荐使用）</p>
<ul>
<li>基于注解方式（推荐使用）</li>
<li>基于xml配置文件方式</li>
</ul>
</li>
</ul>
<h2 id="5-1-声明式事务管理"><a href="#5-1-声明式事务管理" class="headerlink" title="5.1 声明式事务管理"></a>5.1 声明式事务管理</h2><p>在Spring进行声明式事务管理，底层使用AOP原理。</p>
<h3 id="5-1-1-Spring事务管理API"><a href="#5-1-1-Spring事务管理API" class="headerlink" title="5.1.1 Spring事务管理API"></a>5.1.1 Spring事务管理API</h3><ol>
<li>提供一个接口，代表事务管理器，这个接口针对不同的框架提供不用的实现类。如下图所示，使用mybatis框架时使用DataSourceTransactionManager实现类。![image.png](Spring5框架.assetsf0964c7a4ff40b6b2a8b9cd51b48202.png)</li>
</ol>
<br>
### 5.1.2 事务操作（注解方式实现）
#### 代码
配置文件配置。为DataSourceTransactionManager配置DataSource，添加tx命名空间并为事务注解配置事务管理器。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5&quot;/&gt;</span><br><span class="line">    &lt;context:property-placeholder location=&quot;mysql.properties&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;datasource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;prop.driver&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;$&#123;prop.url&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;$&#123;prop.username&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;$&#123;prop.password&#125;&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;</span><br><span class="line">&lt;!--        &lt;property name=&quot;dataSource&quot; ref=&quot;datasource&quot;/&gt;--&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;dataSource&quot; ref=&quot;datasource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--创建事务管理器--&gt;</span><br><span class="line">    &lt;bean id=&quot;dataSourceTransactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;!--注入数据源--&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;datasource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--开启事务注解--&gt;</span><br><span class="line">    &lt;tx:annotation-driven transaction-manager=&quot;dataSourceTransactionManager&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
在需要开启事务的类或方法上添加事务注解`@Transactional`。
如果把注解添加到类上面，这个类里面的所有方法都会开启事务。
如果把注解添加到方法上，那么只有这个方法会开启事务。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    public Long getBalance(String userId) &#123;</span><br><span class="line">        return userDao.getBalance(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Transactional</span><br><span class="line">    public void transfer(String aUserID, String bUserId, Long money) &#123;</span><br><span class="line">        userDao.subBalance(aUserID, money);</span><br><span class="line">        int i = 1/0;</span><br><span class="line">        userDao.addBalance(bUserId, money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class UserDaoImpl implements UserDao &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    public Long getBalance(String userId) &#123;</span><br><span class="line">        String sql = &quot;select balance from t_bank where user_id=?&quot;;</span><br><span class="line">        return jdbcTemplate.queryForObject(sql, Long.class, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int addBalance(String userId, Long money) &#123;</span><br><span class="line">        String sql = &quot;update t_bank set balance=balance+? where user_id = ?&quot;;</span><br><span class="line">        return jdbcTemplate.update(sql, money, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int subBalance(String userId, Long money) &#123;</span><br><span class="line">        String sql = &quot;update t_bank set balance=balance-? where user_id = ?&quot;;</span><br><span class="line">        return jdbcTemplate.update(sql, money, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test2()&#123;</span><br><span class="line">    ApplicationContext context = new ClassPathXmlApplicationContext(&quot;bean1.xml&quot;);</span><br><span class="line">    UserService useService = context.getBean(&quot;userService&quot;, UserService.class);</span><br><span class="line">    // 由用户1向用户2转账200元</span><br><span class="line">    useService.transfer(&quot;1&quot;, &quot;2&quot; ,200L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
结果：用户1账户扣钱后发生了异常，然后发生了回滚。最终结果是转账失败，保持原样。

<br>
#### @Transactional注解
@Transactional属性
- @AliasFor("transactionManager")
    String value() default "";
- @AliasFor("value")
    String transactionManager() default "";
- String[] label() default {};
- Propagation propagation() default Propagation.REQUIRED;  
解释：事务的传播行为
- Isolation isolation() default Isolation.DEFAULT;
解释：事务的隔离级别
- int timeout() default -1;
解释：事务的超时时间
- String timeoutString() default "";
- boolean readOnly() default false;
解释：是否只读
- Class<? extends Throwable>[] rollbackFor() default {};
解释：回滚
- String[] rollbackForClassName() default {};
- Class<? extends Throwable>[] noRollbackFor() default {};
解释：不回滚
- String[] noRollbackForClassName() default {};

<br>
**事务的传播行为**
事务方法：对数据库表数据进行变化的操作，如添加/修改/删除。
传播行为用于解决多事务方法之间进行调用的管理，如事务方法调用非事务方法，或非事务方法调用事务方法应该怎么做。

<table>
<thead>
<tr>
<th>事务传播行为类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>PROPAGATION.REQUIRED</strong></td>
<td>调用另一个事务方法时，如果当前没有事务，就新建一个事务，如果已经存在一个事务中，则加入到这个事务中。这是最常见的选择。</td>
</tr>
<tr>
<td>PROPAGATION.SUPPORTS</td>
<td>支持当前事务，如果当前没有事务，就以非事务方式执行。</td>
</tr>
<tr>
<td>PROPAGATION.MANDATORY</td>
<td>使用当前的事务，如果当前没有事务，就抛出异常。</td>
</tr>
<tr>
<td><strong>PROPAGATION.REQUIRES_NEW</strong></td>
<td>调用另一个事务方法时，会新建事务，如果当前存在事务，把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION.NOT_SUPPORTED</td>
<td>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION.NEVER</td>
<td>以非事务方式执行，如果当前存在事务，则抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION.NESTED</td>
<td>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION.REQUIRED类似的操作。</td>
</tr>
</tbody></table>
<br>
**事务的隔离级别**
脏读：一个未提交事务读取到另一个未提交事务的数据；通过MVCC快照解决。
不可重复读：一个未提交的事务读取到了另一个提交事务修改数据；可通过加共享读锁实现。
幻读：一个未提交的事务读取到了另一个提交事务添加的数据。通过间隙锁或串行化实现。

<p>可以通过设置事务隔离级别，解决读的问题。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DEFAULT</td>
<td>使用数据库的隔离级别</td>
</tr>
<tr>
<td>READ_UNCOMMITTED</td>
<td>读未提交</td>
</tr>
<tr>
<td>READ_COMMITTED</td>
<td>读已提交</td>
</tr>
<tr>
<td>REPEATABLE_READ</td>
<td>可重复读</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>串行化</td>
</tr>
</tbody></table>
<p><strong>事务的超时时间</strong><br>事务需要在一定时间内提交，如果不提交进行回滚。默认值是-1，设置时间单位是秒。</p>
<p><strong>readOnly</strong><br>是否只读。默认为false，即可以执行查询和增删改。如果设置为true，则只能查询。</p>
<p><strong>rollbackFor</strong><br>设置出现哪些异常，进行回滚。</p>
<p><strong>noRollbackFor</strong><br>设置出现哪些异常，不进行回滚</p>
<br>
### 5.1.3 事务操作（xml方式实现）
步骤：
1. 配置jdbcTemplate和事务管理器，开启注解扫描
2. 先配置通知，描述切面时需要进行的操作
3. 提取切入点，配置切面，即在切入点上需要进行的操作。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">                           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:property-placeholder location=&quot;mysql.properties&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;prop.driver&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;$&#123;prop.url&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;$&#123;prop.username&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;$&#123;prop.password&#125;&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置事务管理器--&gt;</span><br><span class="line">    &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cj.spring5&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置通知--&gt;</span><br><span class="line">    &lt;tx:advice id=&quot;txAdvice&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;transfer&quot; propagation=&quot;REQUIRED&quot; isolation=&quot;DEFAULT&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--配置切入点和切面--&gt;</span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">        &lt;!--提取切入点--&gt;</span><br><span class="line">        &lt;aop:pointcut id=&quot;pt&quot; expression=&quot;execution(* com.cj.spring5.service.UserService.*(..))&quot;/&gt;</span><br><span class="line">        &lt;!--配置切面--&gt;</span><br><span class="line">        &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;pt&quot;/&gt;</span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<br>
## 5.1.4 完全注解开发
其他不变，就是将xml文件中的配置用配置类代替。通过@Bean注解将DataSource、jdbcTemplate和dataSourceTransactionManager注入到容器中。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages = &#123;&quot;com.cj.spring5&quot;&#125;)  // 扫描包路径</span><br><span class="line">@EnableTransactionManagement  // 开启事务</span><br><span class="line">@PropertySource(&quot;mysql.properties&quot;)</span><br><span class="line">public class TxConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;prop.driver&#125;&quot;)</span><br><span class="line">    public String driver;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;prop.url&#125;&quot;)</span><br><span class="line">    public String url;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;prop.username&#125;&quot;)</span><br><span class="line">    public String username;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;prop.password&#125;&quot;)</span><br><span class="line">    public String password;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public DataSource dataSource()&#123;</span><br><span class="line">        DruidDataSource dataSource = new DruidDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driver);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(username);</span><br><span class="line">        dataSource.setPassword(password);</span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public JdbcTemplate jdbcTemplate(DataSource dataSource)&#123;</span><br><span class="line">        return new JdbcTemplate(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public DataSourceTransactionManager dataSourceTransactionManager()&#123;</span><br><span class="line">        return new DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test4() &#123;</span><br><span class="line">    ApplicationContext context = new AnnotationConfigApplicationContext(TxConfig.class);</span><br><span class="line">    UserService userService = context.getBean(&quot;userService&quot;, UserService.class);</span><br><span class="line">    userService.transfer(&quot;1&quot;, &quot;2&quot;, 500L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
# 六、Spring5新特性
## 6.1 整合日志
Spring5基于jkd1.8，兼容更高的jdk版本。但是在Spring5中已经移除了Log4jConfigListener，官方建议使用Log4j2。
下面来整合Log4j2。

<p><strong>引入依赖</strong></p>
<ul>
<li>log4j-api-2.1.1.2.jar</li>
<li>log4j-core-2.1.1.2.jar</li>
<li>log4j-slf4j-impl-2.11.2.jar</li>
<li>slf4j-api-1.7.30.jar</li>
</ul>
<p><strong>创建Log4j2文件</strong><br>添加log4j2.xml文件到类路径下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!-- 日志级别以及优先级排序：OFF &gt; FATAL &gt; ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE &gt; ALL --&gt;</span><br><span class="line">&lt;!-- Configuration后面的status关于设置log4j2自身内部的信息输出，可以不设置，设为trace时，可以看到log4j2内部各种详细输出 --&gt;</span><br><span class="line">&lt;configuration status=&quot;INFO&quot;&gt;</span><br><span class="line">    &lt;!-- 先定义所有的appender --&gt;</span><br><span class="line">    &lt;appenders&gt;</span><br><span class="line">        &lt;!-- 输出日志信息到控制台 --&gt;</span><br><span class="line">        &lt;console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt;</span><br><span class="line">            &lt;!-- 控制日志输出的格式 --&gt;</span><br><span class="line">            &lt;PatternLayout pattern=&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;/&gt;</span><br><span class="line">        &lt;/console&gt;</span><br><span class="line">    &lt;/appenders&gt;</span><br><span class="line">    &lt;!-- 然后定义logger，只有定义了logger并引入的appender，appender才会生效 --&gt;</span><br><span class="line">    &lt;!-- root：用于指定项目的根目录，如果没有单独指定Logger，则会使用root作为默认的日志输出 --&gt;</span><br><span class="line">    &lt;loggers&gt;</span><br><span class="line">        &lt;root level=&quot;info&quot;&gt;</span><br><span class="line">            &lt;appender-ref ref=&quot;Console&quot;/&gt;</span><br><span class="line">        &lt;/root&gt;</span><br><span class="line">    &lt;/loggers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>可以通过如下输出自定义的日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static final Log log = LogFactory.getLog(UserService.class);</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void test5()&#123;</span><br><span class="line">    log.warn(&quot;log test......&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
## 6.2 Nullable注解
@Nullable注解可以使用在方法、属性和参数上，表示方法返回可以为空，属性可以为空，参数可以为空。 

<br>
## 6.3 向Spring容器中注入自定义对象
使用GenericApplicationContext完成自定义对象的注册和管理。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test6() &#123;</span><br><span class="line">    GenericApplicationContext context = new GenericApplicationContext();</span><br><span class="line">    context.refresh();</span><br><span class="line">    context.registerBean(&quot;user1&quot;, User.class, () -&gt; new User());</span><br><span class="line">    User user1 = context.getBean(&quot;user1&quot;, User.class);</span><br><span class="line">    System.out.println(user1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
## 6.4 JUnit5
Spring5 支持整合 JUnit5。

<p><strong>先使用JUnit4进行整合</strong><br>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.13-beta-3&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>可以将配置文件写在注解中，启动时直接创建bean对象并完成注入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(&quot;classpath:bean2.xml&quot;)</span><br><span class="line">public class JTest4 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public UserService userService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test()&#123;</span><br><span class="line">        Long balance = userService.getBalance(&quot;1&quot;);</span><br><span class="line">        System.out.println(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>下面整合Junit5</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;spring-version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.3.1&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>使用Junit5进行测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@ExtendWith(SpringExtension.class)</span><br><span class="line">@ContextConfiguration(&quot;classpath:bean2.xml&quot;)</span><br><span class="line">public class JTest5 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test()&#123;</span><br><span class="line">        Long balance = userService.getBalance(&quot;1&quot;);</span><br><span class="line">        System.out.println(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解为<code>@ExtendWith(SpringExtension.class)</code>。可以使用<code>@SpringJUnitConfig(locations = &quot;classpath:bean2.xml&quot;)</code>注解来整合@ExtendWith和@ContextConfiguration注解。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//@ExtendWith(SpringExtension.class)</span><br><span class="line">//@ContextConfiguration(&quot;classpath:bean2.xml&quot;)</span><br><span class="line">@SpringJUnitConfig(locations = &quot;classpath:bean2.xml&quot;)</span><br><span class="line">public class JTest5 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test() &#123;</span><br><span class="line">        Long balance = userService.getBalance(&quot;1&quot;);</span><br><span class="line">        System.out.println(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
# 七、SpringWebflux
## 7.1 概念
**SpringWebflux：**SpringWebflux是Spring5添加的新模块，用于web开发的，功能类似SpringMVC，webflux是使用当前一种比较流行的**响应式编程**的框架。
传统的web框架，比如SpringMVC，基于Servlet容器；Webflux是一种**异步非阻塞**的**响应式编程**框架，异步非阻塞的框架在Servlet3.1以后才支持。核心是基于Reactor的相关API实现的(Reactor是基于Java9的Flow实现的)。

<ul>
<li>SpringMVC是通过<code>同步阻塞方式</code>实现，基于<code>SpringMVC</code>+<code>Servlet</code>+<code>Tomcat</code>；</li>
<li>SpringWebflux是通过<code>同步非阻塞方式</code>实现，基于<code>SpringWebflux</code>+<code>Reactor</code>+<code>Netty</code>；</li>
</ul>
<blockquote>
<p><strong>同步和异步：</strong>针对调用者，调用者发送请求，如果一直等待对方响应才结束，就是同步；如果发送请求后不等待对方响应就执行其他任务，就是异步，被调用者通过状态、通知来通知调用者，或通过回调函数处理这个调用。<br><strong>阻塞和非阻塞：</strong>针对被调用者，被调用者收到请求后，做完请求任务后才给出反馈就是阻塞；被调用者收到请求后，马上给出反馈然后再去处理任务就是非阻塞。</p>
</blockquote>
<br>
**使用场景**
Spring WebFlux 是一个异步非阻塞式的 Web 框架，所以并不能使接口的响应时间缩短，它仅仅能够提升吞吐量和伸缩性，它特别适合应用在 IO 密集型的服务中，比如微服务网关这样的应用中。WebFlux 不是 Spring MVC 的替代方案！
> IO 密集型包括：磁盘IO密集型, 网络IO密集型，微服务网关就属于网络 IO 密集型，使用异步非阻塞式编程模型，能够显著地提升网关对下游服务转发的吞吐量。

<br>
## 7.2 Webflux特点
**非阻塞式：**在有限的资源下，提高系统的吞吐量和伸缩性，以Reactor为基础实现响应式编程；
**函数式编程：**Spring5框架基于JDK1.8，可以使用函数式编程；

<p><strong>与SpringMVC的异同：</strong></p>
<ol>
<li>都可以使用注解方式，都运行在Tomcat等容器中。</li>
<li>SpringMVC采用命令式编程；Webflux采用异步响应式编程。</li>
</ol>
<p>![image.png](Spring5框架.assets5206146017e45d8836bcc889f32adc2.png)</p>
<p><strong>应用：</strong>SpringCloud Gateway就是基于Webflux框架实现的，响应式的框架提高系统的吞吐量和伸缩性。</p>
<p>响应式和非阻塞通常来讲也不会使应用运行的更快。相反，非阻塞方式要求做更多的事情，而且还会稍微增加一些必要的处理时间。响应式和非阻塞的关键好处是，在使用很少固定数目的线程和较少的内存情况下的扩展能力。</p>
<br>
## 7.3 响应式编程
**响应式编程：**响应式编程是一种面向数据流和变化传播的编程范式。这意味着可以在编程语言中很方便的表达静态或动态的数据流，而相关计算模型会自动将变化的值通过数据流进行传播。类似excel表格中的计算式，如果变量发生变化，结果会响应为正确的结果。也类似Vue中的数据绑定。

<h3 id="7-3-1-Observer-x2F-Observable"><a href="#7-3-1-Observer-x2F-Observable" class="headerlink" title="7.3.1 Observer&#x2F;Observable"></a>7.3.1 Observer&#x2F;Observable</h3><p>响应式变成是观察者模式的一种实现，在Java8中提供了观察者模式的两个类Observer和Observable。</p>
<p>Java8及其之前的版本中，可以使用Observer和Observable两个接口类，实现响应式编程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class ObserverDemo extends Observable &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ObserverDemo observable = new ObserverDemo();</span><br><span class="line"></span><br><span class="line">        // 添加两个观察者并重写观察者的回调方法</span><br><span class="line">        observable.addObserver(new Observer() &#123;</span><br><span class="line">            public void update(Observable o, Object arg) &#123;</span><br><span class="line">                System.out.println(&quot;回调处理1&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        observable.addObserver(new Observer() &#123;</span><br><span class="line">            public void update(Observable o, Object arg) &#123;</span><br><span class="line">                System.out.println(&quot;回调处理2&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        observable.setChanged();  // 将被观察者标记为已修改</span><br><span class="line">        observable.notifyObservers();  // 如果被观察者已被修改，则通知观察者并回调观察者的update方法</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
### 7.3.2 Flow
Java9之后使用Flow实现响应式编程
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class FlowDemo &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // 发布</span><br><span class="line">        Flow.Publisher&lt;String&gt; publisher = new Flow.Publisher&lt;String&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void subscribe(Flow.Subscriber&lt;? super String&gt; subscriber) &#123;</span><br><span class="line">                // 发布内容</span><br><span class="line">                subscriber.onNext(&quot;1&quot;);</span><br><span class="line">                subscriber.onNext(&quot;2&quot;);</span><br><span class="line">                // 发布异常</span><br><span class="line">                subscriber.onError(new RuntimeException(&quot;subscribe error&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        // 订阅</span><br><span class="line">        publisher.subscribe(new Flow.Subscriber&lt;&gt;()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onSubscribe(Flow.Subscription subscription) &#123;</span><br><span class="line">                subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onNext(String item) &#123;</span><br><span class="line">                // 订阅收到内容</span><br><span class="line">                System.out.println(&quot;item: &quot; + item);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onError(Throwable throwable) &#123;</span><br><span class="line">                System.out.println(&quot;订阅收到异常&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onComplete() &#123;</span><br><span class="line">                System.out.println(&quot;publish complete&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reactor框架基于Flow响应式编程基础上进行了功能扩展，使其功能更加强大。</p>
</blockquote>
<br>
### 7.3.3 Reactor
#### 7.3.3.1 基础概念
**Reactor 有两个核心类，Mono和Flux，这两个类实现接口Publisher，提供了丰富操作符。**
- Flux对象实现发布者，返回N个元素；
- Mono实现发布者，返回0或1个元素。

<p><strong>Flux和Mono都是数据流的发布者，使用Flux和Mono都可以发出三种数据信号：</strong></p>
<ul>
<li>元素值：</li>
<li>错误信号：表示终止信号，终止数据流同时把错误信息传递给订阅者；</li>
<li>完成信号：表示终止信号，用于告诉订阅者数据流结束了。</li>
</ul>
<p><strong>信号的三个特点：</strong></p>
<ul>
<li>错误信号和完成信号都是终止信号，不能共存。；</li>
<li>如果没有发送任何元素值，而是直接发送错误或者完成信号，表示是空数据流；</li>
<li>如果没有错误信号，没有完成信号，表示无线数据流。</li>
</ul>
<p><strong>代码demo</strong><br>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.1.8.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class FluxDemo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // Subscribe会订阅并输出。</span><br><span class="line">        Flux.just(1, 2, 3, 4, 5).subscribe(System.out::print);</span><br><span class="line">        Mono.just(1).subscribe(System.out::print);</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(6, 7, 8);</span><br><span class="line">        Flux.fromIterable(list);</span><br><span class="line"></span><br><span class="line">        Flux.fromArray(list.toArray());</span><br><span class="line"></span><br><span class="line">        Flux.fromStream(list.stream());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<br>
#### 7.3.3.2 同步非阻塞IO
Reactor是基于Netty的NIO框架。

<p><strong>BIO</strong><br>每个线程都会进行一个socket连接(长连接)，线程会被一直占用直到关闭该连接，所以这是同步阻塞IO。<br><img src="/Spring5%E6%A1%86%E6%9E%B6.assets%5C1df1741b887d4961b535cde29a50add2.png" alt="image.png"></p>
<p><strong>NIO</strong><br>每个操作都是一个Channel，Channel会向Selector(多路复用器)进行注册，有4个状态(Connect&#x2F;Accept&#x2F;Read&#x2F;Write)。通过响应式方式返回结果。<br><img src="/Spring5%E6%A1%86%E6%9E%B6.assets%5C1e739bc3d83642f8b98a1cf76c521629.png" alt="image.png"></p>
<br>
### 7.3.4 SpringWebflux
#### 7.3.4.1 SpringWebflux组件与API
**SpringWebflux主要组件：**
- DispatchHandler主要负责请求的处理。
- HandlerMapping：匹配到请求的对应处理方法
- HandlerAdapter：真正负责请求处理
- HandlerResultHandler：响应结果进行处理



<p><strong>DispatchHandler的源码：</strong><br>SpringWebflux核心控制器DispatchHandler，实现接口WebHandler。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public interface WebHandler &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Handle the web server exchange.</span><br><span class="line">	 * @param exchange the current server exchange</span><br><span class="line">	 * @return &#123;@code Mono&lt;Void&gt;&#125; to indicate when request handling is complete</span><br><span class="line">	 */</span><br><span class="line">	Mono&lt;Void&gt; handle(ServerWebExchange exchange);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebHandler的目标是提供web应用中广泛使用的通用特性，如Session、表单数据和附件等等，也是为了更容易和上层代码对接。其封装了更底层的类HttpHandler，该类用于响应式HTTP请求的处理。<br>参数类型是ServerWebExchange，可以这样理解，你发一个请求，给你一个响应，相当于用请求交换了一个响应，而且是在服务器端交换的。<br>其实，整个web请求的处理过程是一个链式的，最后才是一个WebHandler，它前面可以插入多个错误处理器，WebExceptionHandler，多个过滤器，WebFilter。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;java.lang.Void&gt; handle(ServerHttpRequest request, ServerHttpResponse response);</span><br></pre></td></tr></table></figure>
<p>HttpHandler是一个通用的接口，目标是抽象出来和不同HTTP服务器对接。它是有意设计成最小化的，只有一个方法，主要唯一目的就是在不同的HTTP服务器API上面成为一个最小化的抽象。<br>WebHandler是构建于HttpHandler之上的，换句话说WebHandler的处理会通过一个适配器HttpWebHandlerAdapter最终代理给HttpHandler来执行。</p>
<p>通过对下抽象一个HttpHandler接口，抹平了不同服务器的差异。对上抽象一个接口，可以用于支撑不同的编程模型。</p>
<p>Webflux包含一个轻量级函数式编程模型，函数被用来参与处理请求，它是相对于基于注解编程模型的另一种选择，这种编程模型叫做函数式端点，functional endpoints，是构建于上面提到的WebHandler之上的。使用HandlerFunction来处理一个HTTP请求的，这是一个函数式接口，也称处理函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">public interface HandlerFunction&lt;T extends ServerResponse&gt; &#123;</span><br><span class="line">    reactor.core.publisher.Mono&lt;T&gt; handle(ServerRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>带有一个ServerRequest参数，返回一个Mono<ServerResponse>，其中request和response对象都是不可变的，HandlerFunction就等价于Controller中的@RequestMapping标记的方法。<br>实际当中，请求很多，处理函数也很多，如何知道一个请求过来后，该由哪个处理函数去处理呢？这要用到另一个函数式接口RouterFunction来搞定，称为路由函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">public interface RouterFunction&lt;T extends ServerResponse&gt; &#123;</span><br><span class="line">    reactor.core.publisher.Mono&lt;HandlerFunction&lt;T&gt;&gt; route(ServerRequest request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>带有一个ServerRequest参数，返回一个Mono<HandlerFunction>。就是它把一个请求路由到一个HandlerFunction的，当路由函数匹配时，就返回一个处理函数，否则返回一个空的Mono。RouterFunction等价于@RequestMapping注解，但主要不同的是路由函数提供的不仅是数据，还有行为。</p>
<p>下面通过一些示例，来更加直观的帮助大家认识这两个函数式接口。<br>因处理函数是函数式接口，所以可以直接用一个lambda表达式来处理请求，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HandlerFunction&lt;ServerResponse&gt; handler = request -&gt; Response.ok().body(&quot;Hello World&quot;);</span><br></pre></td></tr></table></figure>
<p>这就表示当任何一个请求过来时，都返回Hello World作为响应。</p>
<br>
#### 7.3.4.2 Webflux编程模型替代SpringMVC

<p><strong>引入依赖</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>DispatchHandler的handler实现方法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; handle(ServerWebExchange exchange) &#123;  // 放置http请求响应信息</span><br><span class="line">	if (this.handlerMappings == null) &#123;</span><br><span class="line">		return createNotFoundError();</span><br><span class="line">	&#125;</span><br><span class="line">	return Flux.fromIterable(this.handlerMappings)</span><br><span class="line">			.concatMap(mapping -&gt; mapping.getHandler(exchange))  // 根据请求地址获取对应mapping</span><br><span class="line">			.next()</span><br><span class="line">			.switchIfEmpty(createNotFoundError())</span><br><span class="line">			.flatMap(handler -&gt; invokeHandler(exchange, handler))  // 调用具体的业务方法</span><br><span class="line">			.flatMap(result -&gt; handleResult(exchange, result));  // 返回处理结果</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringWebflux实现方式有两种：注解编程模型和函数式编程模型。<br>使用注解编程模型方式和SpringMVC使用相似，只需要把相关依赖配置到项目中，SpringBoot自动配置相关运行容器，默认情况下使用Netty服务器。</p>
<br>
##### 注解式编程模型
**配置文件**
mysql.properties
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">prop.driver: com.mysql.jdbc.Driver</span><br><span class="line">prop.url: jdbc:mysql://chenjie.asia:3306/test?useUnicode=true&amp;characterEncoding=utf8</span><br><span class="line">prop.username: root</span><br><span class="line">prop.password: cj</span><br></pre></td></tr></table></figure>
bean.xml
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--    &lt;context:property-placeholder location=&quot;classpath*: mysql.properties&quot;/&gt;--&gt;</span><br><span class="line">    &lt;!--springboot 项目中，不能使用property-placeholder来引入其他配置文件，应该使用如下形式--&gt;</span><br><span class="line">    &lt;bean id=&quot;propertyPlaceholderConfigurer&quot;</span><br><span class="line">          class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;locations&quot;&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;value&gt;classpath:mysql.properties&lt;/value&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;prop.driver&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;$&#123;prop.url&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;$&#123;prop.username&#125;&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;$&#123;prop.password&#125;&quot;/&gt;</span><br><span class="line">        &lt;!--        &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;--&gt;</span><br><span class="line">        &lt;!--        &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://chenjie.asia:3306/test?useUnicode=true&amp;amp;characterEncoding=utf8&quot;/&gt;--&gt;</span><br><span class="line">        &lt;!--        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;--&gt;</span><br><span class="line">        &lt;!--        &lt;property name=&quot;password&quot; value=&quot;cj&quot;/&gt;--&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
**controller**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/getUser/&#123;id&#125;&quot;)</span><br><span class="line">    public Mono&lt;User&gt; getUser(@PathVariable(&quot;id&quot;) Integer id) &#123;</span><br><span class="line">        System.out.println(&quot;controller - getUser&quot;);</span><br><span class="line">        return userService.getUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/getAllUser&quot;)</span><br><span class="line">    public Flux&lt;User&gt; getAllUser() &#123;</span><br><span class="line">        System.out.println(&quot;controller - getAllUser&quot;);</span><br><span class="line">        return userService.getAllUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PostMapping(&quot;/saveUserInfo&quot;)</span><br><span class="line">    public void saveUserInfo(@RequestBody User user) &#123;</span><br><span class="line">        Mono&lt;User&gt; userMono = Mono.just(user);</span><br><span class="line">        userService.saveUserInfo(userMono);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
**service**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">    Mono&lt;User&gt; getUserById(int id);  // 返回0或1个，使用Mono</span><br><span class="line"></span><br><span class="line">    Flux&lt;User&gt; getAllUser();  // 返回N个元素，使用Flux</span><br><span class="line"></span><br><span class="line">    Mono&lt;Void&gt; saveUserInfo(Mono&lt;User&gt; user);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserDao userDao;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;User&gt; getUserById(int id) &#123;</span><br><span class="line">        User user = userDao.getUserById(id);</span><br><span class="line">        return Mono.justOrEmpty(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Flux&lt;User&gt; getAllUser() &#123;</span><br><span class="line">        System.out.println(&quot;service - getAllUser&quot;);</span><br><span class="line">        List&lt;User&gt; users = userDao.getAllUser();</span><br><span class="line">        return Flux.fromIterable(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; saveUserInfo(Mono&lt;User&gt; userMono) &#123;</span><br><span class="line">        return userMono.doOnNext(user -&gt; &#123;</span><br><span class="line">//            jdbcTemplate.update(sql, user.getName(), user.getGender(), user.getAge());</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;).thenEmpty(Mono.empty());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
**dao**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line">    User getUserById(int id);</span><br><span class="line">    List&lt;User&gt; getAllUser();</span><br><span class="line">    Mono&lt;Void&gt; saveUserInfo(Mono&lt;User&gt; user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class UserDaoImpl implements UserDao &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public User getUserById(int id) &#123;</span><br><span class="line">        String sql = &quot;select * from t_user where id=?&quot;;</span><br><span class="line">        User user = jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper&lt;&gt;(User.class), id);</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;User&gt; getAllUser() &#123;</span><br><span class="line">        String sql = &quot;select * from t_user&quot;;</span><br><span class="line">        List&lt;User&gt; users = jdbcTemplate.query(sql, new BeanPropertyRowMapper&lt;&gt;(User.class));</span><br><span class="line">        System.out.println(&quot;dao - getAllUser&quot;);</span><br><span class="line"></span><br><span class="line">        return users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; saveUserInfo(Mono&lt;User&gt; userMono) &#123;</span><br><span class="line">        String sql = &quot;insert into t_user(name,gender,age) values(?,?,?)&quot;;</span><br><span class="line">        return userMono.doOnNext(user -&gt; &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;).thenEmpty(Mono.empty());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
**启动类**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@ImportResource(locations = &#123;&quot;classpath:bean.xml&quot;&#125;)</span><br><span class="line">public class WebfluxApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(com.cj.WebfluxApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
##### 函数式编程模型
1. 在使用函数式编程模型操作时，需要自己初始化服务器；
2. SpringWebflux要实现函数式编程，有两个重要接口，`RouterFunction`(路由处理)和`HandlerFunction`(处理函数)；
3. SpringWebflux请求和响应不再是ServletRequest和ServletResponse，而是ServerRequest和ServerResponse。

<p><img src="/Spring5%E6%A1%86%E6%9E%B6.assets%5Cd1c15bca754643ccabc713794477db12.png" alt="image.png"></p>
<p><strong>代码实现</strong><br>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<p>Service类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import reactor.core.publisher.Flux;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">public class UserServiceImpl &#123;</span><br><span class="line"></span><br><span class="line">    public Mono&lt;User&gt; getUserById(int id) &#123;</span><br><span class="line">        User user = new User(11, &quot;11&quot;, &quot;11&quot;,11 );</span><br><span class="line">        return Mono.justOrEmpty(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Flux&lt;User&gt; getAllUser() &#123;</span><br><span class="line">        System.out.println(&quot;dao - getAllUser&quot;);</span><br><span class="line">        User user = new User(11, &quot;11&quot;, &quot;11&quot;,11 );</span><br><span class="line">        List&lt;User&gt; users = Arrays.asList(user);</span><br><span class="line">        return Flux.fromIterable(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Mono&lt;Void&gt; saveUserInfo(Mono&lt;User&gt; userMono) &#123;</span><br><span class="line">        return userMono.doOnNext(user -&gt; &#123;</span><br><span class="line">//            jdbcTemplate.update(sql, user.getName(), user.getGender(), user.getAge());</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;).thenEmpty(Mono.empty());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handler类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">import com.cj.webflux2.entity.User;</span><br><span class="line">import com.cj.webflux2.service.UserService;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.web.reactive.function.BodyInserters;</span><br><span class="line">import org.springframework.web.reactive.function.server.ServerRequest;</span><br><span class="line">import org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line">import reactor.core.publisher.Flux;</span><br><span class="line">import reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">public class UserHandler &#123;</span><br><span class="line"></span><br><span class="line">    private final UserService userService;</span><br><span class="line"></span><br><span class="line">    public UserHandler(UserService userService) &#123;</span><br><span class="line">        this.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据id查询user</span><br><span class="line">     *</span><br><span class="line">     * @param request</span><br><span class="line">     * @return Mono&lt;ServerResponse&gt;</span><br><span class="line">     */</span><br><span class="line">    public Mono&lt;ServerResponse&gt; getUserById(ServerRequest request) &#123;</span><br><span class="line">        String id = request.pathVariable(&quot;id&quot;);</span><br><span class="line">        Mono&lt;User&gt; userMono = userService.getUserById(Integer.parseInt(id));</span><br><span class="line"></span><br><span class="line">        return userMono.flatMap(user -&gt;</span><br><span class="line">                ServerResponse.ok()</span><br><span class="line">                        .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                        .body(BodyInserters.fromValue(user)))</span><br><span class="line">                .switchIfEmpty(ServerResponse.notFound().build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 查询所有</span><br><span class="line">     */</span><br><span class="line">    public Mono&lt;ServerResponse&gt; getAllUser(ServerRequest request) &#123;</span><br><span class="line">        Flux&lt;User&gt; users = userService.getAllUser();</span><br><span class="line">        return ServerResponse.ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(users,User.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 添加</span><br><span class="line">     */</span><br><span class="line">    public Mono&lt;ServerResponse&gt; saveUser(ServerRequest request) &#123;</span><br><span class="line">        Mono&lt;User&gt; userMono = request.bodyToMono(User.class);</span><br><span class="line">        return ServerResponse.ok().build(this.userService.saveUserInfo(userMono));  // build方法进行订阅，如果发生变化则触发添加方法</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由、适配器和启动服务类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">import com.cj.webflux2.handler.UserHandler;</span><br><span class="line">import com.cj.webflux2.service.impl.UserServiceImpl;</span><br><span class="line">import org.springframework.http.MediaType;</span><br><span class="line">import org.springframework.http.server.reactive.HttpHandler;</span><br><span class="line">import org.springframework.http.server.reactive.ReactorHttpHandlerAdapter;</span><br><span class="line">import org.springframework.web.reactive.function.server.*;</span><br><span class="line">import reactor.netty.http.server.HttpServer;</span><br><span class="line"></span><br><span class="line">public class Server &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        Server server = new Server();</span><br><span class="line">        server.createReactorServer();</span><br><span class="line">        System.out.println(&quot;enter to exit&quot;);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 1.创建Router路由</span><br><span class="line">    public RouterFunction&lt;ServerResponse&gt; routingFunction() &#123;</span><br><span class="line">        UserServiceImpl userService = new UserServiceImpl();</span><br><span class="line">        UserHandler handler = new UserHandler(userService);</span><br><span class="line"></span><br><span class="line">        // 配置访问路径与调用方法的映射</span><br><span class="line">        RequestPredicate getUserPredicate = RequestPredicates</span><br><span class="line">                .GET(&quot;/getUser/&#123;id&#125;&quot;)</span><br><span class="line">                .and(RequestPredicates.accept(MediaType.APPLICATION_JSON));</span><br><span class="line"></span><br><span class="line">        RequestPredicate getAllUserPredicate = RequestPredicates</span><br><span class="line">                .GET(&quot;/getAllUser&quot;)</span><br><span class="line">                .and(RequestPredicates.accept(MediaType.APPLICATION_JSON));</span><br><span class="line"></span><br><span class="line">        RequestPredicate saveUserPredicate = RequestPredicates</span><br><span class="line">                .GET(&quot;/saveUser&quot;)</span><br><span class="line">                .and(RequestPredicates.accept(MediaType.APPLICATION_JSON));</span><br><span class="line"></span><br><span class="line">        return RouterFunctions.route(getUserPredicate, handler::getUserById)</span><br><span class="line">                .andRoute(getAllUserPredicate, handler::getAllUser)</span><br><span class="line">                .andRoute(saveUserPredicate, handler::saveUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2.创建服务器，完成适配</span><br><span class="line">    public void createReactorServer() &#123;</span><br><span class="line">        // 获得路由</span><br><span class="line">        RouterFunction&lt;ServerResponse&gt; route = routingFunction();</span><br><span class="line">        // 获得handler的适配</span><br><span class="line">        HttpHandler httpHandler = RouterFunctions.toHttpHandler(route);</span><br><span class="line">        ReactorHttpHandlerAdapter adapter = new ReactorHttpHandlerAdapter(httpHandler);</span><br><span class="line">        // 创建服务器</span><br><span class="line">        HttpServer httpServer = HttpServer.create();</span><br><span class="line">        httpServer.handle(adapter).bindNow();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动后端口随机生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">18:18:35.946 [reactor-http-nio-1] DEBUG reactor.netty.tcp.TcpServer - [id: 0x189ee28e, L:/0:0:0:0:0:0:0:0:4675] Bound new server</span><br></pre></td></tr></table></figure>
<p>WebClient是客户端，可以请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class Client &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // 调用服务器地址</span><br><span class="line">        WebClient client = WebClient.create(&quot;http://127.0.0.1:9343&quot;);</span><br><span class="line"></span><br><span class="line">        String id = &quot;1&quot;;</span><br><span class="line">        // 根据di查询</span><br><span class="line">        User user = client.get().uri(&quot;/getUser/&#123;id&#125;&quot;, id)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">                .retrieve().bodyToMono(User.class)</span><br><span class="line">                .block();</span><br><span class="line"></span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        // 查询所有</span><br><span class="line">        Flux&lt;User&gt; userFlux = client.get().uri(&quot;/getAllUser&quot;)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">                .retrieve().bodyToFlux(User.class);</span><br><span class="line"></span><br><span class="line">        userFlux.map(User::getName).buffer()</span><br><span class="line">                .doOnNext(System.out::println)</span><br><span class="line">                .blockFirst();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/Spring5%E6%A1%86%E6%9E%B6/">http://example.com/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/Spring5%E6%A1%86%E6%9E%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/Netty04-%E4%BC%98%E5%8C%96%EF%BC%88%E8%BD%AC%EF%BC%89/" title="Netty04-优化（转）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Netty04-优化（转）</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E7%AE%97%E6%B3%95%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/" title="推荐系统算法相关笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">推荐系统算法相关笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1.1 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BC%98%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">1.2 优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">1.3 入门案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E5%9F%BA%E4%BA%8Exml%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.</span> <span class="toc-text">2.3.1 基于xml方式创建对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">3.1 两种情况的动态代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">3.1.1 JDK动态代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-AspectJ%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">3.3.1 AspectJ注解实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-1-%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.1.</span> <span class="toc-text">3.3.1.1 实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-2-%E4%BC%98%E5%8C%96"><span class="toc-number">4.2.2.</span> <span class="toc-text">3.3.1.2 优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">5.1 声明式事务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-Spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86API"><span class="toc-number">5.1.</span> <span class="toc-text">5.1.1 Spring事务管理API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-1-Observer-x2F-Observable"><span class="toc-number">5.2.</span> <span class="toc-text">7.3.1 Observer&#x2F;Observable</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>