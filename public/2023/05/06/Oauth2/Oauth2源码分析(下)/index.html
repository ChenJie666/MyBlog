<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Oauth2源码分析(下) | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="二、密码模式源码2.1 概述访问&#x2F;oauth&#x2F;token会经过拦截器的顺序ClientCredentialsTokenEndpointFilter和BasicAuthenticationFilter，ClientCredentialsTokenEndpointFilter从request parameters中抽取client信息**(username，password，grant_type，cl">
<meta property="og:type" content="article">
<meta property="og:title" content="Oauth2源码分析(下)">
<meta property="og:url" content="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="二、密码模式源码2.1 概述访问&#x2F;oauth&#x2F;token会经过拦截器的顺序ClientCredentialsTokenEndpointFilter和BasicAuthenticationFilter，ClientCredentialsTokenEndpointFilter从request parameters中抽取client信息**(username，password，grant_type，cl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.027Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.027Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Oauth2源码分析(下)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Oauth2源码分析(下)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.027Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.027Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Oauth2/">Oauth2</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Oauth2源码分析(下)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="二、密码模式源码"><a href="#二、密码模式源码" class="headerlink" title="二、密码模式源码"></a>二、密码模式源码</h1><h2 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h2><p>访问<code>/oauth/token</code>会经过拦截器的顺序<code>ClientCredentialsTokenEndpointFilter</code>和<code>BasicAuthenticationFilter</code>，<code>ClientCredentialsTokenEndpointFilter</code>从request parameters中抽取client信息**(username，password，grant_type，client_id，client_secret)<strong>，<code>BasicAuthenticationFilter</code>从header Authorization Basic XXXX中抽取client信息</strong>(client_id和client_secret)**。</p>
<p><strong>流程：</strong></p>
<p><code>TokenRequest</code>包含了基本信息<code>clientId,scope,requestParameters,grantType</code>等。根据<code>tokenRequest</code>获取<code>OAuth2Request</code>，初始化获得<code>OAuth2Authentication</code>，再去数据库里找<code>oauth2accesstoken</code>，如果有则直接返回，如果没有则创建新的<code>oauth2accesstoken</code>，并且和<code>OAuth2Authentication</code>一起存入数据库中。</p>
<h2 id="2-2-源码"><a href="#2-2-源码" class="headerlink" title="2.2 源码"></a>2.2 源码</h2><p><strong>摘要：</strong></p>
<ul>
<li>四大角色：ResouceServer AuthorizationServer client user</li>
<li>OAuth2AccessToken OAuth2Authentiaction</li>
<li>OAuth2Request TokenRequest AuthorizationRequest</li>
<li>TokenGranter TokenStore TokenExtractor DefaultTokenServices RemoteTokenServices</li>
<li>ResourceServerConfigurerAdapter AuthorizationServerConfigurerAdapter</li>
<li>TokenEndPoint(&#x2F;oauth&#x2F;token) AuthorizationEndPoint(&#x2F;oauth&#x2F;authorize) CheckTokenEndpoint(&#x2F;oauth&#x2F;check_token)</li>
</ul>
<p><strong>TokenEndpoint类中定义了&#x2F;oauth&#x2F;token接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FrameworkEndpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AbstractEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">OAuth2RequestValidator</span> <span class="variable">oAuth2RequestValidator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2RequestValidator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;HttpMethod&gt; allowedRequestMethods = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;HttpMethod&gt;(Arrays.asList(HttpMethod.POST));</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/oauth/token&quot;, method=RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title function_">getAccessToken</span><span class="params">(Principal principal, <span class="meta">@RequestParam</span></span></span><br><span class="line"><span class="params">    Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!allowedRequestMethods.contains(HttpMethod.GET)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpRequestMethodNotSupportedException</span>(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> postAccessToken(principal, parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/oauth/token&quot;, method=RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title function_">postAccessToken</span><span class="params">(Principal principal, <span class="meta">@RequestParam</span></span></span><br><span class="line"><span class="params">    Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">                    <span class="string">&quot;There is no client authentication. Try adding an appropriate authentication filter.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> getClientId(principal);</span><br><span class="line">        <span class="type">ClientDetails</span> <span class="variable">authenticatedClient</span> <span class="operator">=</span> getClientDetailsService().loadClientByClientId(clientId);</span><br><span class="line"></span><br><span class="line">        <span class="type">TokenRequest</span> <span class="variable">tokenRequest</span> <span class="operator">=</span> getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientId != <span class="literal">null</span> &amp;&amp; !clientId.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Only validate the client details if a client authenticated during this</span></span><br><span class="line">            <span class="comment">// request.</span></span><br><span class="line">            <span class="keyword">if</span> (!clientId.equals(tokenRequest.getClientId())) &#123;</span><br><span class="line">                <span class="comment">// double check to make sure that the client ID in the token request is the same as that in the</span></span><br><span class="line">                <span class="comment">// authenticated client</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClientException</span>(<span class="string">&quot;Given client ID does not match authenticated client&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (authenticatedClient != <span class="literal">null</span>) &#123;</span><br><span class="line">            oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(tokenRequest.getGrantType())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidRequestException</span>(<span class="string">&quot;Missing grant type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tokenRequest.getGrantType().equals(<span class="string">&quot;implicit&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(<span class="string">&quot;Implicit grant type not supported from token endpoint&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isAuthCodeRequest(parameters)) &#123;</span><br><span class="line">            <span class="comment">// The scope was requested or determined during the authorization step</span></span><br><span class="line">            <span class="keyword">if</span> (!tokenRequest.getScope().isEmpty()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Clearing scope of incoming token request&quot;</span>);</span><br><span class="line">                tokenRequest.setScope(Collections.&lt;String&gt; emptySet());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isRefreshTokenRequest(parameters)) &#123;</span><br><span class="line">            <span class="comment">// A refresh token has its own default scopes, so we should ignore any added by the factory here.</span></span><br><span class="line">            tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">OAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedGrantTypeException</span>(<span class="string">&quot;Unsupported grant type: &quot;</span> + tokenRequest.getGrantType());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getResponse(token);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RemoteTokenServices :资源服务可以把传递来的access_token递交给授权服务的&#x2F;oauth&#x2F;check_token进行验证，而资源服务自己无需去连接数据库验证access_token，这时就用到了RemoteTokenServices。</p>
<h3 id="2-2-1-Oauth的请求封装类"><a href="#2-2-1-Oauth的请求封装类" class="headerlink" title="2.2.1 Oauth的请求封装类"></a>2.2.1 Oauth的请求封装类</h3><p>OAuth2Authentication和OAuth2AccessToken是一对好基友，谁要先走谁是狗！！！</p>
<h4 id="2-2-1-1-OAuth2Authentication"><a href="#2-2-1-1-OAuth2Authentication" class="headerlink" title="2.2.1.1 OAuth2Authentication"></a>2.2.1.1 OAuth2Authentication</h4><p><strong>OAuth2Authentication</strong>顾名思义是Authentication的子类，<strong>存储用户信息和客户端信息</strong>，但多了2个属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OAuth2Request storedRequest; </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Authentication userAuthentication;</span><br></pre></td></tr></table></figure>

<p>这样<strong>OAuth2Authentication</strong>可以存储<strong>2</strong>个Authentication，一个给client(必要)，一个给user(只是有些授权方式需要)。除此之外同样有principle，credentials，authorities，details，authenticated等属性。</p>
<p><strong>OAuth2Request</strong> 用于存储request中的Authentication信息（grantType,responseType,resouceId,clientId,scope等），这里就引出了OAuth2 中的三大request。</p>
<h4 id="2-2-1-2-OAuth2AccessToken"><a href="#2-2-1-2-OAuth2AccessToken" class="headerlink" title="2.2.1.2 OAuth2AccessToken"></a>2.2.1.2 OAuth2AccessToken</h4><p><strong>OAuth2AccessToken</strong>是一个接口，提供安全令牌token的基本信息，<strong>不包含用户信息，仅包含一些静态属性（scope,tokenType,expires_in等）和getter方法。TokenGranter.grant()<strong>返回的值即</strong>OAuth2AccessToken</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.codehaus.jackson.map.annotate.JsonSerialize(using = OAuth2AccessTokenJackson1Serializer.class)</span><br><span class="line"><span class="meta">@org</span>.codehaus.jackson.map.annotate.JsonDeserialize(using = OAuth2AccessTokenJackson1Deserializer.class)</span><br><span class="line"><span class="meta">@com</span>.fasterxml.jackson.databind.annotation.JsonSerialize(using = OAuth2AccessTokenJackson2Serializer.class)</span><br><span class="line"><span class="meta">@com</span>.fasterxml.jackson.databind.annotation.JsonDeserialize(using = OAuth2AccessTokenJackson2Deserializer.class)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OAuth2AccessToken</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">BEARER_TYPE</span> <span class="operator">=</span> <span class="string">&quot;Bearer&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">OAUTH2_TYPE</span> <span class="operator">=</span> <span class="string">&quot;OAuth2&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ACCESS_TOKEN</span> <span class="operator">=</span> <span class="string">&quot;access_token&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TOKEN_TYPE</span> <span class="operator">=</span> <span class="string">&quot;token_type&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">EXPIRES_IN</span> <span class="operator">=</span> <span class="string">&quot;expires_in&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">REFRESH_TOKEN</span> <span class="operator">=</span> <span class="string">&quot;refresh_token&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SCOPE</span> <span class="operator">=</span> <span class="string">&quot;scope&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	Map&lt;String, Object&gt; <span class="title function_">getAdditionalInformation</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	Set&lt;String&gt; <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2RefreshToken <span class="title function_">getRefreshToken</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">getTokenType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	Date <span class="title function_">getExpiration</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> <span class="title function_">getExpiresIn</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	String <span class="title function_">getValue</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>TokenStore同时存储OAuth2AccessToken和OAuth2Authentication</strong>，也可根据OAuth2Authentication中的<strong>OAuth2Request</strong>信息可获取对应的<strong>OAuth2AccessToken</strong>。</p>
</blockquote>
<p><strong>DefaultTokenServices有如下方法，都可以通过一个获得另一个的值</strong> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OAuth2AccessToken <span class="title function_">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span></span><br><span class="line"></span><br><span class="line">OAuth2Authentication <span class="title function_">loadAuthentication</span><span class="params">(String accessTokenValue)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当tokenStore是jdbcTokenStore，表示从数据库中根据OAuth2Authentication获取OAuth2AccessToken<br>OAuth2AccessToken existingAccessToken &#x3D; tokenStore.getAccessToken(authentication);</p>
</blockquote>
<p><strong>DefaultOAuth2AccessToken</strong>是OAuth2AccessToken的实现类，多了构造方法，setter方法和OAuth2AccessToken  valueOf(Map&lt;String,Object&gt; tokenParams)。经过json转换后就是我们常见的access_token对象，如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1e95d081-0048-4397-a081-c76f7823fe54&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;token_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bearer&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7f6db28b-50dc-40a2-b381-3e356e30af2b&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;expires_in&quot;</span><span class="punctuation">:</span> <span class="number">1799</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="string">&quot;read write&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="2-2-1-3-BaseRequest及其继承类AuthorizationRequest、TokenRequest、OAuth2Request"><a href="#2-2-1-3-BaseRequest及其继承类AuthorizationRequest、TokenRequest、OAuth2Request" class="headerlink" title="2.2.1.3 BaseRequest及其继承类AuthorizationRequest、TokenRequest、OAuth2Request"></a>2.2.1.3 BaseRequest及其继承类AuthorizationRequest<strong>、</strong>TokenRequest<strong>、</strong>OAuth2Request</h4><p><strong>BaseRequest</strong>是抽象类，有3个属性：clienId、scope和requestParameters。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String clientId;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Set&lt;String&gt; scope = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; requestParameters = Collections</span><br><span class="line">			.unmodifiableMap(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;());</span><br><span class="line"> </span><br><span class="line">       <span class="comment">/**  setter,getter  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其继承类有<strong>AuthorizationRequest</strong>、<strong>TokenRequest</strong>、<strong>OAuth2Request</strong>。</p>
<ul>
<li><p><strong>AuthorizationRequest:<strong>向授权服务器AuthorizationEndPoint （</strong>&#x2F;oauth&#x2F;authorize</strong>）请求授权，AuthorizationRequest作为载体存储state,redirect_uri等参数，生命周期很短且不能长时间存储信息，可用OAuth2Request代替存储信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationRequest</span> <span class="keyword">extends</span> <span class="title class_">BaseRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 用户同意授权传递的参数，不可改变</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, String&gt; approvalParameters = Collections.unmodifiableMap(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;());</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 客户端发送出的状态信息，从授权服务器返回的状态应该不变才对</span></span><br><span class="line">  <span class="keyword">private</span> String state;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 返回类型集合</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; responseTypes = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// resource ids  可变</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; resourceIds = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 授权的权限</span></span><br><span class="line">  <span class="keyword">private</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;GrantedAuthority&gt;();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 终端用户是否同意该request发送</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">approved</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 重定向uri</span></span><br><span class="line">  <span class="keyword">private</span> String redirectUri;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 额外的属性</span></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Serializable&gt; extensions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Serializable&gt;();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 持久化到OAuth2Request</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2Request <span class="title function_">createOAuth2Request</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(getRequestParameters(), getClientId(), getAuthorities(), isApproved(), getScope(), getResourceIds(), getRedirectUri(), getResponseTypes(), getExtensions());</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// setter,getter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>TokenRequest:<strong>向授权服务器TokenEndPoint(</strong>&#x2F;oauth&#x2F;token</strong>)发送请求获得access_token时，tokenRequest作为载体存储请求中grantType等参数。常和tokenGranter.grant(grantType,tokenRequest)结合起来使用。<br>TokenRequest携带了新属性<strong>grantType</strong>，和方法<strong>createOAuth2Request</strong>（用于持久化）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String grantType;</span><br><span class="line"><span class="keyword">public</span> OAuth2Request <span class="title function_">createOAuth2Request</span><span class="params">(ClientDetails client)</span> &#123;</span><br><span class="line">      Map&lt;String, String&gt; requestParameters = getRequestParameters();</span><br><span class="line">      HashMap&lt;String, String&gt; modifiable = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;(requestParameters);</span><br><span class="line">      <span class="comment">// Remove password if present to prevent leaks</span></span><br><span class="line">      modifiable.remove(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">      modifiable.remove(<span class="string">&quot;client_secret&quot;</span>);</span><br><span class="line">      <span class="comment">// Add grant type so it can be retrieved from OAuth2Request</span></span><br><span class="line">      modifiable.put(<span class="string">&quot;grant_type&quot;</span>, grantType);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(modifiable, client.getClientId(), client.getAuthorities(), <span class="literal">true</span>, <span class="built_in">this</span>.getScope(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>OAuth2Request:<strong>用来存储TokenRequest或者AuthorizationRequest的信息，只有构造方法和getter方法，不提供setter方法。它作为</strong>OAuth2Authentication</strong>的一个属性(StoredRequest)，存储request中的authentication信息（authorities,grantType,approved,responseTypes）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Request</span> <span class="keyword">extends</span> <span class="title class_">BaseRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; resourceIds = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;GrantedAuthority&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">approved</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">TokenRequest</span> <span class="variable">refresh</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String redirectUri;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Set&lt;String&gt; responseTypes = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Serializable&gt; extensions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Serializable&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">OAuth2Request</span><span class="params">(Map&lt;String, String&gt; requestParameters, String clientId,Collection&lt;? extends GrantedAuthority&gt; authorities, <span class="type">boolean</span> approved, Set&lt;String&gt; scope,Set&lt;String&gt; resourceIds, String redirectUri, Set&lt;String&gt; responseTypes,Map&lt;String, Serializable&gt; extensionProperties)</span> &#123;</span><br><span class="line">      setClientId(clientId);</span><br><span class="line">      setRequestParameters(requestParameters);</span><br><span class="line">      setScope(scope);</span><br><span class="line">      <span class="keyword">if</span> (resourceIds != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="built_in">this</span>.resourceIds = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;(resourceIds);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (authorities != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="built_in">this</span>.authorities = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;GrantedAuthority&gt;(authorities);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.approved = approved;</span><br><span class="line">      <span class="keyword">if</span> (responseTypes != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="built_in">this</span>.responseTypes = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;(responseTypes);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.redirectUri = redirectUri;</span><br><span class="line">      <span class="keyword">if</span> (extensionProperties != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="built_in">this</span>.extensions = extensionProperties;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">OAuth2Request</span><span class="params">(OAuth2Request other)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>(other.getRequestParameters(), other.getClientId(), other.getAuthorities(), other.isApproved(), other</span><br><span class="line">              .getScope(), other.getResourceIds(), other.getRedirectUri(), other.getResponseTypes(), other</span><br><span class="line">              .getExtensions());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">OAuth2Request</span><span class="params">(String clientId)</span> &#123;</span><br><span class="line">      setClientId(clientId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">OAuth2Request</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getRedirectUri</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> redirectUri;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getResponseTypes</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> responseTypes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">      <span class="keyword">return</span> authorities;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isApproved</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> approved;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">getResourceIds</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> resourceIds;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Map&lt;String, Serializable&gt; <span class="title function_">getExtensions</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> extensions;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> OAuth2Request <span class="title function_">createOAuth2Request</span><span class="params">(Map&lt;String, String&gt; parameters)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(parameters, getClientId(), authorities, approved, getScope(), resourceIds,</span><br><span class="line">              redirectUri, responseTypes, extensions);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> OAuth2Request <span class="title function_">narrowScope</span><span class="params">(Set&lt;String&gt; scope)</span> &#123;</span><br><span class="line">      <span class="type">OAuth2Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(getRequestParameters(), getClientId(), authorities, approved, scope,</span><br><span class="line">              resourceIds, redirectUri, responseTypes, extensions);</span><br><span class="line">      request.refresh = <span class="built_in">this</span>.refresh;</span><br><span class="line">      <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> OAuth2Request <span class="title function_">refresh</span><span class="params">(TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">      <span class="type">OAuth2Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2Request</span>(getRequestParameters(), getClientId(), authorities, approved,</span><br><span class="line">              getScope(), resourceIds, redirectUri, responseTypes, extensions);</span><br><span class="line">      request.refresh = tokenRequest;</span><br><span class="line">      <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> refresh != <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> TokenRequest <span class="title function_">getRefreshTokenRequest</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> refresh;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getGrantType</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (getRequestParameters().containsKey(OAuth2Utils.GRANT_TYPE)) &#123;</span><br><span class="line">          <span class="keyword">return</span> getRequestParameters().get(OAuth2Utils.GRANT_TYPE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (getRequestParameters().containsKey(OAuth2Utils.RESPONSE_TYPE)) &#123;</span><br><span class="line">          <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> getRequestParameters().get(OAuth2Utils.RESPONSE_TYPE);</span><br><span class="line">          <span class="keyword">if</span> (response.contains(<span class="string">&quot;token&quot;</span>)) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&quot;implicit&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-2-1-4-OAuth2RefreshToken"><a href="#2-2-1-4-OAuth2RefreshToken" class="headerlink" title="2.2.1.4 OAuth2RefreshToken"></a>2.2.1.4 OAuth2RefreshToken</h4><p><strong>OAuth2RefreshToken</strong>是接口，只有<strong>String getValue()<strong>方法。</strong>DefaultOAuth2RefreshToken</strong>是OAuth2RefreshToken的实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OAuth2RefreshToken</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The value of the token.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The value of the token.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@JsonValue</span></span><br><span class="line">	String <span class="title function_">getValue</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-1-5-OAuth2RequestFactory接口"><a href="#2-2-1-5-OAuth2RequestFactory接口" class="headerlink" title="2.2.1.5 OAuth2RequestFactory接口"></a>2.2.1.5 OAuth2RequestFactory接口</h4><p>工厂类用于生成OAuth2Request、TokenRequest、AuthenticationRequest。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OAuth2RequestFactory</span> &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 从request请求参数中获取clientId,scope,state</span></span><br><span class="line"><span class="comment">            * clientDetailsService  loadClientByClientId(clientId) 获取clientDetails resourcesId Authorities</span></span><br><span class="line"><span class="comment">            * 根据以上信息生成AuthenticationRequest</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">	AuthorizationRequest <span class="title function_">createAuthorizationRequest</span><span class="params">(Map&lt;String, String&gt; authorizationParameters)</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *  AuthorizationRequest request  有生成OAuth2Request的方法</span></span><br><span class="line"><span class="comment">     *  request.createOAuth2Request()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	OAuth2Request <span class="title function_">createOAuth2Request</span><span class="params">(AuthorizationRequest request)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	OAuth2Request <span class="title function_">createOAuth2Request</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	TokenRequest <span class="title function_">createTokenRequest</span><span class="params">(Map&lt;String, String&gt; requestParameters, ClientDetails authenticatedClient)</span>;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	TokenRequest <span class="title function_">createTokenRequest</span><span class="params">(AuthorizationRequest authorizationRequest, String grantType)</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-2-TokenGranter、TokenStore、TokenExtractor"><a href="#2-2-2-TokenGranter、TokenStore、TokenExtractor" class="headerlink" title="2.2.2 TokenGranter、TokenStore、TokenExtractor"></a>2.2.2 TokenGranter、TokenStore、TokenExtractor</h3><h4 id="2-2-2-1-TokenGranter-x2F-oauth-x2F-token"><a href="#2-2-2-1-TokenGranter-x2F-oauth-x2F-token" class="headerlink" title="2.2.2.1 TokenGranter(&#x2F;oauth&#x2F;token)"></a>2.2.2.1 TokenGranter(&#x2F;oauth&#x2F;token)</h4><p>一般在用户请求TokenEndPoints中的路径&#x2F;oauth&#x2F;token时，根据请求参数中的grantType,username,password，client_id,client_secret等，调用TokenGranter给用户分发OAuth2AccessToken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</span><br></pre></td></tr></table></figure>

<p>根据grantType(password,authorization-code)和TokenRequest（requestParameters,clientId,grantType）授予人<strong>OAuth2AccessToken</strong>令牌。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TokenGranter</span> &#123;</span><br><span class="line">	OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>回忆下TokenRequest包含了基本信息clientId,scope,requestParameters,grantType等。根据tokenRequest获取OAuth2Request，初始化获得OAuth2Authentication，再去数据库里找Oauth2AccessToken，如果有则直接返回，如果没有则创建新的Oauth2AccessToken，并且和OAuth2Authentication一起存入数据库中。</p>
</blockquote>
<h5 id="AbstractTokenGranter-授予OAuth2AccessToken"><a href="#AbstractTokenGranter-授予OAuth2AccessToken" class="headerlink" title="AbstractTokenGranter(授予OAuth2AccessToken)"></a>AbstractTokenGranter(授予OAuth2AccessToken)</h5><p><em><strong>TokenGranter</strong></em>抽象继承类<strong>AbstractTokenGranter</strong>，实现了grant方法。</p>
<p>执行顺序为根据<strong>tokenRequest</strong>&#x3D;&#x3D;&#x3D;&#x3D;》<strong>clientId</strong> &#x3D;&#x3D;&#x3D;&#x3D;》<strong>clientDetails</strong>&#x3D;&#x3D;&#x3D;&#x3D;》<strong>OAuth2Authentication</strong>(getOAuth2Authentication(client,tokenRequest))&#x3D;&#x3D;&#x3D;&#x3D;》<strong>OAuth2AccessToken</strong>(tokenService.createAccessToken)</p>
<p>通过clientId获取ClientDetails，判断客户端是否有当前正在发起请求的授权模式，调用OAuth2RequestFactory的createOAuth2Request方法传入TokenRequest参数获得OAuth2Request，通过createAccessToken方法将获取的OAuth2Request作为参数获得OAuth2AccessToken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractTokenGranter</span> <span class="keyword">implements</span> <span class="title class_">TokenGranter</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AuthorizationServerTokenServices tokenServices;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClientDetailsService clientDetailsService;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> OAuth2RequestFactory requestFactory;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String grantType;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="title function_">AbstractTokenGranter</span><span class="params">(AuthorizationServerTokenServices tokenServices,</span></span><br><span class="line"><span class="params">			ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory, String grantType)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.clientDetailsService = clientDetailsService;</span><br><span class="line">		<span class="built_in">this</span>.grantType = grantType;</span><br><span class="line">		<span class="built_in">this</span>.tokenServices = tokenServices;</span><br><span class="line">		<span class="built_in">this</span>.requestFactory = requestFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过grant方法进行认证，获取OAuth2AccessToken</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.grantType.equals(grantType)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//通过ClientDetails获取到client进行认证</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> tokenRequest.getClientId();</span><br><span class="line">		<span class="type">ClientDetails</span> <span class="variable">client</span> <span class="operator">=</span> clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line">		validateGrantType(grantType, client);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Getting access token for: &quot;</span> + clientId);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getAccessToken(client, tokenRequest);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过OAuth2Authentication获取到OAuth2AccessToken</span></span><br><span class="line">	<span class="keyword">protected</span> OAuth2AccessToken <span class="title function_">getAccessToken</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过TokenRequest获取到OAuth2Request，通过OAuth2Request获取到OAuth2Authentication</span></span><br><span class="line">	<span class="keyword">protected</span> OAuth2Authentication <span class="title function_">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">storedOAuth2Request</span> <span class="operator">=</span> requestFactory.createOAuth2Request(client, tokenRequest);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Authentication</span>(storedOAuth2Request, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断客户端是否拥有指定的授权类型，没有则抛出异常</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">validateGrantType</span><span class="params">(String grantType, ClientDetails clientDetails)</span> &#123;</span><br><span class="line">		Collection&lt;String&gt; authorizedGrantTypes = clientDetails.getAuthorizedGrantTypes();</span><br><span class="line">		<span class="keyword">if</span> (authorizedGrantTypes != <span class="literal">null</span> &amp;&amp; !authorizedGrantTypes.isEmpty()</span><br><span class="line">				&amp;&amp; !authorizedGrantTypes.contains(grantType)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClientException</span>(<span class="string">&quot;Unauthorized grant type: &quot;</span> + grantType);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> AuthorizationServerTokenServices <span class="title function_">getTokenServices</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> tokenServices;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> OAuth2RequestFactory <span class="title function_">getRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现AbstractTokenGranter的类有5种。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5Cd3b0efb3f9b44b3cb5d4d7c1b760a342.png" alt="21580557-7e210a361f9f6ee8.png"></p>
<p>其中如果用password的方式进行验证，那么TokenGranter类型是<strong>ResourceOwnerPasswordTokenGranter</strong>，该类中重写了getOAuth2Authentication方法，里面调用了authenticationManager.manage()方法。</p>
<p><code>用户可自行定义granter类继承AbstractTokenGranter，重写**getOAuth2Authentication()**方法，并将该granter类添加至CompositeTokenGranter中。</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceOwnerPasswordTokenGranter</span> <span class="keyword">extends</span> <span class="title class_">AbstractTokenGranter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GRANT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;password&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">ResourceOwnerPasswordTokenGranter</span><span class="params">(AuthenticationManager authenticationManager,</span></span><br><span class="line"><span class="params">			AuthorizationServerTokenServices tokenServices, ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>(authenticationManager, tokenServices, clientDetailsService, requestFactory, GRANT_TYPE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="title function_">ResourceOwnerPasswordTokenGranter</span><span class="params">(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices,</span></span><br><span class="line"><span class="params">			ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory, String grantType)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(tokenServices, clientDetailsService, requestFactory, grantType);</span><br><span class="line">		<span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写了父类的方法，增加authenticate方法对账号密码进行验证。</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> OAuth2Authentication <span class="title function_">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, String&gt; parameters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;(tokenRequest.getRequestParameters());</span><br><span class="line">		<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> parameters.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> parameters.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">		<span class="comment">// Protect from downstream leaks of password</span></span><br><span class="line">		parameters.remove(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">userAuth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">		((AbstractAuthenticationToken) userAuth).setDetails(parameters);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			userAuth = authenticationManager.authenticate(userAuth);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AccountStatusException ase) &#123;</span><br><span class="line">			<span class="comment">//covers expired, locked, disabled cases (mentioned in section 5.2, draft 31)</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(ase.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (BadCredentialsException e) &#123;</span><br><span class="line">			<span class="comment">// If the username/password are wrong the spec says we should send 400/invalid grant</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (userAuth == <span class="literal">null</span> || !userAuth.isAuthenticated()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(<span class="string">&quot;Could not authenticate user: &quot;</span> + username);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">storedOAuth2Request</span> <span class="operator">=</span> getRequestFactory().createOAuth2Request(client, tokenRequest);		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Authentication</span>(storedOAuth2Request, userAuth);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="CompositeTokenGranter"><a href="#CompositeTokenGranter" class="headerlink" title="CompositeTokenGranter"></a>CompositeTokenGranter</h5><p>TokenGranter有继承类<strong>CompositeTokenGranter</strong>，包含List<TokenGranter> tokenGranters属性，grant方法是遍历tokenGranters进行逐一grant，只要有一个有返回值就返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompositeTokenGranter</span> <span class="keyword">implements</span> <span class="title class_">TokenGranter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;TokenGranter&gt; tokenGranters;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">CompositeTokenGranter</span><span class="params">(List&lt;TokenGranter&gt; tokenGranters)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.tokenGranters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TokenGranter&gt;(tokenGranters);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//对所有tokenGranters继承类进行遍历</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (TokenGranter granter : tokenGranters) &#123;</span><br><span class="line">			<span class="type">OAuth2AccessToken</span> <span class="variable">grant</span> <span class="operator">=</span> granter.grant(grantType, tokenRequest);</span><br><span class="line">			<span class="keyword">if</span> (grant!=<span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> grant;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTokenGranter</span><span class="params">(TokenGranter tokenGranter)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (tokenGranter == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Token granter is null&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		tokenGranters.add(tokenGranter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-2-TokenStore"><a href="#2-2-2-2-TokenStore" class="headerlink" title="2.2.2.2 TokenStore"></a>2.2.2.2 TokenStore</h4><p>一般在TokenGranter执行grant方法完毕后，TokenStore将OAuth2AccessToken和OAuth2Authentication存储起来，方便以后根据其中一个查询另外一个（如根据access_token查询获得OAuth2Authentication）。</p>
<p>存储<strong>OAuth2AccessToken</strong>和<strong>OAuth2Authentication</strong>（比Authentication多了两个属性storedRequest，userAuthentication），存储方法如下。还有各种read，remove方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TokenStore</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">storeAccessToken</span><span class="params">(OAuth2AccessToken token, OAuth2Authentication authentication)</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2Authentication <span class="title function_">readAuthentication</span><span class="params">(OAuth2AccessToken token)</span>;</span><br><span class="line">	</span><br><span class="line">	OAuth2Authentication <span class="title function_">readAuthentication</span><span class="params">(String token)</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2AccessToken <span class="title function_">readAccessToken</span><span class="params">(String tokenValue)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">removeAccessToken</span><span class="params">(OAuth2AccessToken token)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">storeRefreshToken</span><span class="params">(OAuth2RefreshToken refreshToken, OAuth2Authentication authentication)</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2RefreshToken <span class="title function_">readRefreshToken</span><span class="params">(String tokenValue)</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2Authentication <span class="title function_">readAuthenticationForRefreshToken</span><span class="params">(OAuth2RefreshToken token)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">removeRefreshToken</span><span class="params">(OAuth2RefreshToken token)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">removeAccessTokenUsingRefreshToken</span><span class="params">(OAuth2RefreshToken refreshToken)</span>;</span><br><span class="line"></span><br><span class="line">	OAuth2AccessToken <span class="title function_">getAccessToken</span><span class="params">(OAuth2Authentication authentication)</span>;</span><br><span class="line"></span><br><span class="line">	Collection&lt;OAuth2AccessToken&gt; <span class="title function_">findTokensByClientIdAndUserName</span><span class="params">(String clientId, String userName)</span>;</span><br><span class="line"></span><br><span class="line">	Collection&lt;OAuth2AccessToken&gt; <span class="title function_">findTokensByClientId</span><span class="params">(String clientId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>TokenStore</strong>的实现类有5类，其中<strong>JdbcTokenStore</strong>是通过连接数据库来存储OAuth2AccessToken的，这也是我们一般存储token的方法。条件是数据库里的表结构必须按照标准建立。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B" alt="21580557-4ce2c9dbee0ea3bb.png">.assetse09a6181d4e47b89abba3b986046588.png)</p>
<p><strong>JdbcTokenStore：</strong>oauth_access_token表结构如下，可见表里存储了OAuth2AccessToken和OAuth2Authentication两个对象，值得注意的是token_id并不等于OAuth2AccessToken.getValue()，value经过MD5加密后才是token_id。同理authentication_id 和 refresh_token也是经过加密转换存储的。第一次获得token，直接存入数据库表里。如果重复post请求&#x2F;oauth&#x2F;token，  JdbcTokenStore会先判断表中是否已有该用户的token，如果有先删除，再添加。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5C59801cbd325845bdba457ab9ddf05ee6.png" alt="21580557-20289ba5cc4ca997.png"></p>
<p><strong>JwtTokenStore：</strong>不存储token和authentication,直接根据token解析获得authentication。</p>
<h4 id="2-2-2-3-TokenExtractor-OAuth2AuthenticationProcessingFilter"><a href="#2-2-2-3-TokenExtractor-OAuth2AuthenticationProcessingFilter" class="headerlink" title="2.2.2.3 TokenExtractor (OAuth2AuthenticationProcessingFilter)"></a>2.2.2.3 TokenExtractor (OAuth2AuthenticationProcessingFilter)</h4><p>用户携带token访问资源，过滤器进行到<strong>OAuth2AuthenticationProcessingFilter</strong>时，从HttpServletRequest中获取Authorization或access_token(可以从header或者params中获取)，拼接成PreAuthenticatedAuthenticationToken**(Authentication子类)**</p>
<p><strong>BearerTokenExtractor</strong>是它的实现类，实现了从request中获取Authentication的方法。</p>
<ol>
<li>header中  Authentication:Bearer xxxxxxxx–xxx</li>
<li>request parameters中  access_token&#x3D;xxxx-xxxx-xxxx</li>
</ol>
<p>如果都不存在，则不是Oauth2的认证方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BearerTokenExtractor</span> <span class="keyword">implements</span> <span class="title class_">TokenExtractor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(BearerTokenExtractor.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从HttpServletRequest中获取access_token</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Authentication <span class="title function_">extract</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">tokenValue</span> <span class="operator">=</span> extractToken(request);</span><br><span class="line">		<span class="keyword">if</span> (tokenValue != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">PreAuthenticatedAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreAuthenticatedAuthenticationToken</span>(tokenValue, <span class="string">&quot;&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> authentication;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从请求参数中获取access_token=xxxx-xxxx-xxxx，并在请求头中添加token类型；</span></span><br><span class="line">	<span class="keyword">protected</span> String <span class="title function_">extractToken</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">		<span class="comment">// first check the header...</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> extractHeaderToken(request);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// bearer type allows a request parameter as well</span></span><br><span class="line">		<span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Token not found in headers. Trying request parameters.&quot;</span>);</span><br><span class="line">			token = request.getParameter(OAuth2AccessToken.ACCESS_TOKEN);</span><br><span class="line">			<span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Token not found in request parameters.  Not an OAuth2 request.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				request.setAttribute(OAuth2AuthenticationDetails.ACCESS_TOKEN_TYPE, OAuth2AccessToken.BEARER_TYPE);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> token;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//从请求头中获取Authentication:Bearer xxxxxxxx--xxx，并在请求头中添加token类型。</span></span><br><span class="line">	<span class="keyword">protected</span> String <span class="title function_">extractHeaderToken</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">		Enumeration&lt;String&gt; headers = request.getHeaders(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">		<span class="keyword">while</span> (headers.hasMoreElements()) &#123; <span class="comment">// typically there is only one (most servers enforce that)</span></span><br><span class="line">			<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> headers.nextElement();</span><br><span class="line">			<span class="keyword">if</span> ((value.toLowerCase().startsWith(OAuth2AccessToken.BEARER_TYPE.toLowerCase()))) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">authHeaderValue</span> <span class="operator">=</span> value.substring(OAuth2AccessToken.BEARER_TYPE.length()).trim();</span><br><span class="line">				<span class="comment">// Add this here for the auth details later. Would be better to change the signature of this method.</span></span><br><span class="line">				request.setAttribute(OAuth2AuthenticationDetails.ACCESS_TOKEN_TYPE,</span><br><span class="line">						value.substring(<span class="number">0</span>, OAuth2AccessToken.BEARER_TYPE.length()).trim());</span><br><span class="line">				<span class="type">int</span> <span class="variable">commaIndex</span> <span class="operator">=</span> authHeaderValue.indexOf(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">				<span class="keyword">if</span> (commaIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">					authHeaderValue = authHeaderValue.substring(<span class="number">0</span>, commaIndex);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> authHeaderValue;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2-4-ResourceServerTokenServices"><a href="#2-2-2-4-ResourceServerTokenServices" class="headerlink" title="2.2.2.4 ResourceServerTokenServices"></a>2.2.2.4 ResourceServerTokenServices</h4><p>两个方法。用户携access_token访问资源服务器时，资源服务器会将该字符串进行解析，获得OAuth2Authentication和OAuth2AccessToken。</p>
<p>loadAuthentication根据字符串accessToken获得OAuth2Authentication;</p>
<p>readAccessToken根据字符串accessToken获得OAuth2AccessToken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResourceServerTokenServices</span> &#123;</span><br><span class="line">	<span class="comment">//根据字符串accessToken获得OAuth2Authentication</span></span><br><span class="line">	OAuth2Authentication <span class="title function_">loadAuthentication</span><span class="params">(String accessToken)</span> <span class="keyword">throws</span> AuthenticationException, InvalidTokenException;</span><br><span class="line">	<span class="comment">//根据字符串accessToken获得OAuth2AccessToken</span></span><br><span class="line">	OAuth2AccessToken <span class="title function_">readAccessToken</span><span class="params">(String accessToken)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="DefaultTokenServices"><a href="#DefaultTokenServices" class="headerlink" title="DefaultTokenServices"></a>DefaultTokenServices</h5><p>实现了两个接口AuthorizationServerTokenServices和ResourceServerTokenServices。常在granter().grant()方法中调用tokenServices.createAccessToken()方法获得oauth2accesstoken。</p>
<p><strong>OAuth2AccessToken</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthorizationServerTokenServices</span> &#123;</span><br><span class="line"></span><br><span class="line">	OAuth2AccessToken <span class="title function_">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line"></span><br><span class="line">	OAuth2AccessToken <span class="title function_">refreshAccessToken</span><span class="params">(String refreshToken, TokenRequest tokenRequest)</span></span><br><span class="line">			<span class="keyword">throws</span> AuthenticationException;</span><br><span class="line"></span><br><span class="line">	OAuth2AccessToken <span class="title function_">getAccessToken</span><span class="params">(OAuth2Authentication authentication)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5Cdda8280a9e824d86a4b479d1d4c4a8f4.png" alt="21580557-e10ad7024f80873a.png"></p>
<p>其中重要方法createAccessToken(OAuth2Authentication oauth2)源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> OAuth2AccessToken <span class="title function_">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">OAuth2AccessToken</span> <span class="variable">existingAccessToken</span> <span class="operator">=</span> tokenStore.getAccessToken(authentication);</span><br><span class="line">	<span class="type">OAuth2RefreshToken</span> <span class="variable">refreshToken</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (existingAccessToken != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (existingAccessToken.isExpired()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="literal">null</span>) &#123;</span><br><span class="line">				refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">				<span class="comment">// The token store could remove the refresh token when the</span></span><br><span class="line">				<span class="comment">// access token is removed, but we want to</span></span><br><span class="line">				<span class="comment">// be sure...</span></span><br><span class="line">				tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">			&#125;</span><br><span class="line">			tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Re-store the access token in case the authentication has changed</span></span><br><span class="line">			tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">			<span class="keyword">return</span> existingAccessToken;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在access_token没有关联的refresh_token的情况下才能创建refresh_token，如果有的话会重复利用</span></span><br><span class="line">	<span class="keyword">if</span> (refreshToken == <span class="literal">null</span>) &#123;</span><br><span class="line">		refreshToken = createRefreshToken(authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果refresh_token过期了需要重新发布</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">		<span class="type">ExpiringOAuth2RefreshToken</span> <span class="variable">expiring</span> <span class="operator">=</span> (ExpiringOAuth2RefreshToken) refreshToken;</span><br><span class="line">		<span class="keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">			refreshToken = createRefreshToken(authentication);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="type">OAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> createAccessToken(authentication, refreshToken);</span><br><span class="line">	tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">	<span class="comment">// In case it was modified</span></span><br><span class="line">	refreshToken = accessToken.getRefreshToken();</span><br><span class="line">	<span class="keyword">if</span> (refreshToken != <span class="literal">null</span>) &#123;</span><br><span class="line">		tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> accessToken;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="RemoteTokenServices"><a href="#RemoteTokenServices" class="headerlink" title="RemoteTokenServices"></a>RemoteTokenServices</h5><p>当授权服务和资源服务不在一个应用程序的时候，资源服务可以把传递来的access_token递交给授权服务的**&#x2F;oauth&#x2F;check_token**进行验证，而资源服务自己无需去连接数据库验证access_token，这时就用到了RemoteTokenServices。</p>
<p>loadAuthentication方法，设置head表头Authorization 存储clientId和clientSecret信息，请求参数包含access_token字符串，向AuthServer的<strong>CheckTokenEndpoint</strong> (&#x2F;oauth&#x2F;check_token)发送请求，返回验证结果map（包含clientId,grantType,scope,username等信息），拼接成OAuth2Authentication。</p>
<p><code>AuthServer需要配置checkTokenAccess，否则默认为“denyAll()”，请求访问/oauth/check_token会提示没权限。</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer oauthServer)</span> &#123;</span><br><span class="line">    oauthServer.realm(QQ_RESOURCE_ID).allowFormAuthenticationForClients();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 访问/oauth/check_token 需要client验证</span></span><br><span class="line">    oauthServer.checkTokenAccess(<span class="string">&quot;isAuthenticated()&quot;</span>);、</span><br><span class="line">    <span class="comment">// 也可配置访问/oauth/check_token无需验证</span></span><br><span class="line">    <span class="comment">// oauthServer.checkTokenAccess(&quot;permitAll()&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不支持readAccessToken方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteTokenServices</span> <span class="keyword">implements</span> <span class="title class_">ResourceServerTokenServices</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(getClass());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> RestOperations restTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String checkTokenEndpointUrl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String clientId;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">tokenName</span> <span class="operator">=</span> <span class="string">&quot;token&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">AccessTokenConverter</span> <span class="variable">tokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAccessTokenConverter</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RemoteTokenServices</span><span class="params">()</span> &#123;</span><br><span class="line">		restTemplate = <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">		((RestTemplate) restTemplate).setErrorHandler(<span class="keyword">new</span> <span class="title class_">DefaultResponseErrorHandler</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="comment">// Ignore 400</span></span><br><span class="line">			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">				<span class="keyword">if</span> (response.getRawStatusCode() != <span class="number">400</span>) &#123;</span><br><span class="line">					<span class="built_in">super</span>.handleError(response);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRestTemplate</span><span class="params">(RestOperations restTemplate)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.restTemplate = restTemplate;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCheckTokenEndpointUrl</span><span class="params">(String checkTokenEndpointUrl)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.checkTokenEndpointUrl = checkTokenEndpointUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setClientId</span><span class="params">(String clientId)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.clientId = clientId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setClientSecret</span><span class="params">(String clientSecret)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.clientSecret = clientSecret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccessTokenConverter</span><span class="params">(AccessTokenConverter accessTokenConverter)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.tokenConverter = accessTokenConverter;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTokenName</span><span class="params">(String tokenName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tokenName = tokenName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">loadAuthentication</span><span class="params">(String accessToken)</span> <span class="keyword">throws</span> AuthenticationException, InvalidTokenException &#123;</span><br><span class="line"></span><br><span class="line">		MultiValueMap&lt;String, String&gt; formData = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;String, String&gt;();</span><br><span class="line">		formData.add(tokenName, accessToken);</span><br><span class="line">		<span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">		headers.set(<span class="string">&quot;Authorization&quot;</span>, getAuthorizationHeader(clientId, clientSecret));</span><br><span class="line">		Map&lt;String, Object&gt; map = postForMap(checkTokenEndpointUrl, formData, headers);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (map.containsKey(<span class="string">&quot;error&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;check_token returned error: &quot;</span> + map.get(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTokenException</span>(accessToken);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// gh-838</span></span><br><span class="line">		<span class="keyword">if</span> (!Boolean.TRUE.equals(map.get(<span class="string">&quot;active&quot;</span>))) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;check_token returned active attribute: &quot;</span> + map.get(<span class="string">&quot;active&quot;</span>));</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTokenException</span>(accessToken);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> tokenConverter.extractAuthentication(map);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">readAccessToken</span><span class="params">(String accessToken)</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not supported: read access token&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getAuthorizationHeader</span><span class="params">(String clientId, String clientSecret)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(clientId == <span class="literal">null</span> || clientSecret == <span class="literal">null</span>) &#123;</span><br><span class="line">			logger.warn(<span class="string">&quot;Null Client ID or Client Secret detected. Endpoint that requires authentication will reject request with 401 error.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">creds</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s:%s&quot;</span>, clientId, clientSecret);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;Basic &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(Base64.encode(creds.getBytes(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Could not convert String&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">postForMap</span><span class="params">(String path, MultiValueMap&lt;String, String&gt; formData, HttpHeaders headers)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (headers.getContentType() == <span class="literal">null</span>) &#123;</span><br><span class="line">			headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> restTemplate.exchange(path, HttpMethod.POST,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;MultiValueMap&lt;String, String&gt;&gt;(formData, headers), Map.class).getBody();</span><br><span class="line">		<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">		Map&lt;String, Object&gt; result = map;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-3-Client客户端相关类-ClientDetails-ClientDetailsService"><a href="#2-2-3-Client客户端相关类-ClientDetails-ClientDetailsService" class="headerlink" title="2.2.3 Client客户端相关类  ClientDetails   ClientDetailsService"></a>2.2.3 Client客户端相关类  ClientDetails   ClientDetailsService</h3><p>就是UserDetails和UserDetailsService的翻版。一个是对应user，一个是对应client。</p>
<p>client需要<strong>事先注册</strong>到授权服务器，这样授权服务器会根据client的授权请求获取clientId，secret等信息，进行验证后返回token。</p>
<h4 id="2-2-3-1-ClientDetails"><a href="#2-2-3-1-ClientDetails" class="headerlink" title="2.2.3.1 ClientDetails"></a>2.2.3.1 ClientDetails</h4><p>client的信息，<strong>存于授权服务器端</strong>，这样只需要知道客户端的clientId，就可以获取到客户端能访问哪些资源，是否需要密码，是否限制了scope，拥有的权限等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientDetails</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"> </span><br><span class="line">	String <span class="title function_">getClientId</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// client能访问的资源id</span></span><br><span class="line">	Set&lt;String&gt; <span class="title function_">getResourceIds</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// 验证client是否需要密码</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isSecretRequired</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	</span><br><span class="line">	String <span class="title function_">getClientSecret</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// client是否限制了scope</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isScoped</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// scope集合</span></span><br><span class="line">	Set&lt;String&gt; <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// 根据哪些grantType验证通过client</span></span><br><span class="line">	Set&lt;String&gt; <span class="title function_">getAuthorizedGrantTypes</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// 注册成功后跳转的uri</span></span><br><span class="line">	Set&lt;String&gt; <span class="title function_">getRegisteredRedirectUri</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// client拥有的权限</span></span><br><span class="line">	Collection&lt;GrantedAuthority&gt; <span class="title function_">getAuthorities</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// client的token时效</span></span><br><span class="line">	Integer <span class="title function_">getAccessTokenValiditySeconds</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// client的refreshToken时效</span></span><br><span class="line">	Integer <span class="title function_">getRefreshTokenValiditySeconds</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// true:默认自动授权；false:需要用户确定才能授权</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isAutoApprove</span><span class="params">(String scope)</span>;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">// 额外的信息</span></span><br><span class="line">	Map&lt;String, Object&gt; <span class="title function_">getAdditionalInformation</span><span class="params">()</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-3-2-ClientDetailsService"><a href="#2-2-3-2-ClientDetailsService" class="headerlink" title="2.2.3.2 ClientDetailsService"></a>2.2.3.2 ClientDetailsService</h4><p>只有一个loadClientByClientId方法，根据clientId获取clientDetails对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Load a client by the client id. This method must not return null.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> clientId The client id.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> The client details (never null).</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> ClientRegistrationException If the client account is locked, expired, disabled, or invalid for any other reason.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ClientDetails <span class="title function_">loadClientByClientId</span><span class="params">(String clientId)</span> <span class="keyword">throws</span> ClientRegistrationException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>有两个子类</strong></p>
<ul>
<li><strong>InMemoryClientDetailsService（内存）</strong>：把ClientDetails存内存</li>
<li><strong>JdbcClientDetailsService</strong>：存数据库里（oauth_client_details表）</li>
</ul>
<p>在AuthorizationServerConfigurerAdapter类中的configure方法中配置客户端信息存储方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储在数据库中：</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.withClientDetails(clientDetails());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//或存储在内存中：</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// @formatter:off</span></span><br><span class="line">        clients.inMemory().withClient(<span class="string">&quot;aiqiyi&quot;</span>)</span><br><span class="line">              .resourceIds(QQ_RESOURCE_ID)</span><br><span class="line">              .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>, <span class="string">&quot;implicit&quot;</span>)</span><br><span class="line">              .authorities(<span class="string">&quot;ROLE_CLIENT&quot;</span>)</span><br><span class="line">              <span class="comment">// , &quot;get_fanslist&quot;</span></span><br><span class="line">              .scopes(<span class="string">&quot;get_fanslist&quot;</span>)</span><br><span class="line">              .secret(<span class="string">&quot;secret&quot;</span>)</span><br><span class="line">              .redirectUris(<span class="string">&quot;http://localhost:8081/aiqiyi/qq/redirect&quot;</span>)</span><br><span class="line">              .autoApprove(<span class="literal">true</span>)</span><br><span class="line">              .autoApprove(<span class="string">&quot;get_user_info&quot;</span>)</span><br><span class="line">              .and()</span><br><span class="line">              .withClient(<span class="string">&quot;youku&quot;</span>)</span><br><span class="line">              .resourceIds(QQ_RESOURCE_ID)</span><br><span class="line">              .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>, <span class="string">&quot;implicit&quot;</span>)</span><br><span class="line">              .authorities(<span class="string">&quot;ROLE_CLIENT&quot;</span>)</span><br><span class="line">              .scopes(<span class="string">&quot;get_user_info&quot;</span>, <span class="string">&quot;get_fanslist&quot;</span>)</span><br><span class="line">              .secret(<span class="string">&quot;secret&quot;</span>)</span><br><span class="line">              .redirectUris(<span class="string">&quot;http://localhost:8082/youku/qq/redirect&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-3-3-ClientDetailsServiceBuilder"><a href="#2-2-3-3-ClientDetailsServiceBuilder" class="headerlink" title="2.2.3.3 ClientDetailsServiceBuilder"></a>2.2.3.3 ClientDetailsServiceBuilder</h4><p>创建<strong>InMemoryClientDetailsService</strong>或者<strong>JdbcClientDetailsService</strong>，有内部类ClientDetailsServiceBuilder。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientDetailsServiceBuilder</span>&lt;B <span class="keyword">extends</span> <span class="title class_">ClientDetailsServiceBuilder</span>&lt;B&gt;&gt; <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">SecurityConfigurerAdapter</span>&lt;ClientDetailsService, B&gt; <span class="keyword">implements</span> <span class="title class_">SecurityBuilder</span>&lt;ClientDetailsService&gt; &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> List&lt;ClientBuilder&gt; clientBuilders = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ClientBuilder&gt;();</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> InMemoryClientDetailsServiceBuilder <span class="title function_">inMemory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryClientDetailsServiceBuilder</span>();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> JdbcClientDetailsServiceBuilder <span class="title function_">jdbc</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsServiceBuilder</span>();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ClientDetailsServiceBuilder&lt;?&gt; clients(<span class="keyword">final</span> ClientDetailsService clientDetailsService) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClientDetailsServiceBuilder</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> ClientDetailsService <span class="title function_">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">				<span class="keyword">return</span> clientDetailsService;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// clients.inMemory().withClient(&quot;clientId&quot;).scopes().secret()...</span></span><br><span class="line">	<span class="keyword">public</span> ClientBuilder <span class="title function_">withClient</span><span class="params">(String clientId)</span> &#123;</span><br><span class="line">		<span class="type">ClientBuilder</span> <span class="variable">clientBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientBuilder</span>(clientId);</span><br><span class="line">		<span class="built_in">this</span>.clientBuilders.add(clientBuilder);</span><br><span class="line">		<span class="keyword">return</span> clientBuilder;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ClientDetailsService <span class="title function_">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">for</span> (ClientBuilder clientDetailsBldr : clientBuilders) &#123;</span><br><span class="line">			addClient(clientDetailsBldr.clientId, clientDetailsBldr.build());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> performBuild();</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addClient</span><span class="params">(String clientId, ClientDetails build)</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">protected</span> ClientDetailsService <span class="title function_">performBuild</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Cannot build client services (maybe use inMemory() or jdbc()).&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ClientBuilder</span> &#123;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">         <span class="keyword">public</span> ClientDetailsServiceBuilder&lt;B&gt; <span class="title function_">and</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ClientDetailsServiceBuilder.<span class="built_in">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-4-资源服务器配置-ResourceServerConfigurerAdapter"><a href="#2-2-4-资源服务器配置-ResourceServerConfigurerAdapter" class="headerlink" title="2.2.4 资源服务器配置  ResourceServerConfigurerAdapter"></a>2.2.4 资源服务器配置  ResourceServerConfigurerAdapter</h4><p>配置哪些路径需要认证后才能访问，哪些不需要。自然就联想到了<strong>HttpSecurity</strong>（配置HttpSecurity就相当于配置了不同uri对应的filters）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span></span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()<span class="comment">//所有请求必须登陆后访问</span></span><br><span class="line">                .and().httpBasic()</span><br><span class="line">                .and()</span><br><span class="line">                    .formLogin()</span><br><span class="line">                    .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                    .defaultSuccessUrl(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">                    .failureUrl(<span class="string">&quot;/login?error&quot;</span>)</span><br><span class="line">                    .permitAll()<span class="comment">//登录界面，错误界面可以直接访问</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout().logoutUrl(<span class="string">&quot;/logout&quot;</span>).logoutSuccessUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .permitAll().and().rememberMe();<span class="comment">//注销请求可直接访问</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.inMemoryAuthentication().withUser(<span class="string">&quot;user&quot;</span>).password(<span class="string">&quot;password&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).and()</span><br><span class="line">                .withUser(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;password&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;ADMIN&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>作为资源服务器<strong>ResourceServerConfigurerAdapter</strong>，需要和@EnableResourceServer搭配，然后和上面一样需配置HttpSecurity就好了。还能配置ResourceServerSecurityConfigurer，设置tokenService等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置资源服务器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfiguration</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomAuthenticationEntryPoint customAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomLogoutSuccessHandler customLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    	http</span><br><span class="line">            .exceptionHandling()</span><br><span class="line">            .authenticationEntryPoint(customAuthenticationEntryPoint)</span><br><span class="line">            .and()</span><br><span class="line">            .logout()</span><br><span class="line">            .logoutUrl(<span class="string">&quot;/oauth/logout&quot;</span>)</span><br><span class="line">            .logoutSuccessHandler(customLogoutSuccessHandler)</span><br><span class="line">            .and()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// hello路径允许直接访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/hello/&quot;</span>).permitAll()</span><br><span class="line">            <span class="comment">// secure路径需要验证后才能访问</span></span><br><span class="line">            .antMatchers(<span class="string">&quot;/secure/**&quot;</span>).authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 远程连接authServer服务</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> RemoteTokenServices remoteTokenServices;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		resources.tokenServices(remoteTokenServices);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-5-授权服务器配置-AuthorizationServerConfigurerAdapter"><a href="#2-2-5-授权服务器配置-AuthorizationServerConfigurerAdapter" class="headerlink" title="2.2.5 授权服务器配置    AuthorizationServerConfigurerAdapter"></a>2.2.5 授权服务器配置    AuthorizationServerConfigurerAdapter</h3><p>注册client信息，可以同时配置多个不同类型的client。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationServer</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//token存储方式</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line">    <span class="comment">//JWT令牌配置</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter accessTokenConverter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//客户端详情服务</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClientDetailsService clientDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证管理器</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将客户端信息存储到数据库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ClientDetailsService <span class="title function_">clientDetailsService</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="type">ClientDetailsService</span> <span class="variable">clientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">        ((JdbcClientDetailsService)clientDetailsService).setPasswordEncoder(bCryptPasswordEncoder);</span><br><span class="line">        <span class="keyword">return</span> clientDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clients</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.withClientDetails(clientDetailsService);</span><br><span class="line"><span class="comment">//        clients.inMemory()//使用内存存储</span></span><br><span class="line"><span class="comment">//                .withClient(&quot;c1&quot;) //客户端id</span></span><br><span class="line"><span class="comment">//                .secret(bCryptPasswordEncoder.encode(&quot;abc123&quot;))//设置密码</span></span><br><span class="line"><span class="comment">//                .resourceIds(&quot;res1&quot;)//可访问的资源列表</span></span><br><span class="line"><span class="comment">//                .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;password&quot;, &quot;client_credentials&quot;, &quot;implicit&quot;, &quot;refresh_token&quot;)//该client允许的授权类型</span></span><br><span class="line"><span class="comment">//                .scopes(&quot;all&quot;)//允许的授权范围</span></span><br><span class="line"><span class="comment">//                .autoApprove(false)//false跳转到授权页面，true不跳转</span></span><br><span class="line"><span class="comment">//                .redirectUris(&quot;http://www.baidu.com&quot;);//设置回调地址</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 令牌管理服务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenServices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">        services.setClientDetailsService(clientDetailsService); <span class="comment">//客户端详情服务</span></span><br><span class="line">        services.setSupportRefreshToken(<span class="literal">true</span>); <span class="comment">//支持刷新令牌</span></span><br><span class="line">        services.setTokenStore(tokenStore); <span class="comment">//令牌的存储策略</span></span><br><span class="line">        <span class="comment">//令牌增强,设置JWT令牌</span></span><br><span class="line">        <span class="type">TokenEnhancerChain</span> <span class="variable">tokenEnhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));</span><br><span class="line">        services.setTokenEnhancer(tokenEnhancerChain);</span><br><span class="line"></span><br><span class="line">        services.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">//令牌默认有效时间2小时</span></span><br><span class="line">        services.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">//刷新令牌默认有效期3天</span></span><br><span class="line">        <span class="keyword">return</span> services;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置授权码模式的授权码如何存取，暂时采用内存方式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public AuthorizationCodeServices authorizationCodeServices()&#123;</span></span><br><span class="line"><span class="comment">//        return new InMemoryAuthorizationCodeServices();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationCodeServices authorizationCodeServices;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权码存储到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationCodeServices <span class="title function_">authorizationCodeServices</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcAuthorizationCodeServices</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 令牌访问端点配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints</span><br><span class="line">                .authenticationManager(authenticationManager)<span class="comment">//认证管理器</span></span><br><span class="line">                .authorizationCodeServices(authorizationCodeServices)<span class="comment">//授权码服务</span></span><br><span class="line">                .tokenServices(tokenServices()) <span class="comment">//令牌管理服务（设置令牌存储方式和令牌类型JWT）</span></span><br><span class="line">                .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对授权端点接口的安全约束</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> security</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        security</span><br><span class="line">                .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>) <span class="comment">// /auth/token_key是公开的</span></span><br><span class="line">                .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>) <span class="comment">// /auth/check_token是公开的</span></span><br><span class="line">                .allowFormAuthenticationForClients(); <span class="comment">//允许表单认证（申请令牌）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-6-TokenEndPoint，AuthorizationEndPoint，CheckTokenEndPoint"><a href="#2-2-6-TokenEndPoint，AuthorizationEndPoint，CheckTokenEndPoint" class="headerlink" title="2.2.6 TokenEndPoint，AuthorizationEndPoint，CheckTokenEndPoint"></a>2.2.6 TokenEndPoint，AuthorizationEndPoint，CheckTokenEndPoint</h3><h4 id="2-2-6-1-TokenEndPoint"><a href="#2-2-6-1-TokenEndPoint" class="headerlink" title="2.2.6.1 TokenEndPoint"></a>2.2.6.1 TokenEndPoint</h4><p>客户端post请求”&#x2F;oauth&#x2F;token”，验证用户信息并获取OAuth2AccessToken，必须先经过client验证。这一步的最终目的是存储OAuth2AccessToken+OAuth2Authentication并返回OAuth2AccessToken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/oauth/token&quot;, method=RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt;	 <span class="title function_">postAccessToken</span><span class="params">(Principal principal, 	<span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">				<span class="string">&quot;There is no client authentication. Try adding an appropriate authentication filter.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> getClientId(principal);</span><br><span class="line">	<span class="type">ClientDetails</span> <span class="variable">authenticatedClient</span> <span class="operator">=</span> getClientDetailsService().loadClientByClientId(clientId);</span><br><span class="line"></span><br><span class="line">	<span class="type">TokenRequest</span> <span class="variable">tokenRequest</span> <span class="operator">=</span> getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">       <span class="comment">// AuthorizationServerEndpointsConfigurer</span></span><br><span class="line">	<span class="type">OAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</span><br><span class="line">	<span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedGrantTypeException</span>(<span class="string">&quot;Unsupported grant type: &quot;</span> + tokenRequest.getGrantType());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getResponse(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-6-2-AuthorizationEndPoint"><a href="#2-2-6-2-AuthorizationEndPoint" class="headerlink" title="2.2.6.2 AuthorizationEndPoint"></a>2.2.6.2 AuthorizationEndPoint</h4><p>这个一般只适用于authorization code模式，客户端请求authorization server中的&#x2F;oauth&#x2F;authorize（请求前先得登录oauth server获得authentication），验证client信息后根据redirect_uri请求重定向回client，同时带上code值。client附带code值再次向&#x2F;oauth&#x2F;token请求，返回accesstoken。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@RequestMapping(value = &quot;/oauth/authorize&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">authorize</span><span class="params">(Map&lt;String, Object&gt; model, <span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters,</span></span><br><span class="line"><span class="params">		SessionStatus sessionStatus, Principal principal)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pull out the authorization request first, using the OAuth2RequestFactory. All further logic should</span></span><br><span class="line">	<span class="comment">// query off of the authorization request instead of referring back to the parameters map. The contents of the</span></span><br><span class="line">	<span class="comment">// parameters map will be stored without change in the AuthorizationRequest object once it is created.</span></span><br><span class="line">	<span class="type">AuthorizationRequest</span> <span class="variable">authorizationRequest</span> <span class="operator">=</span> getOAuth2RequestFactory().createAuthorizationRequest(parameters);</span><br><span class="line"></span><br><span class="line">	Set&lt;String&gt; responseTypes = authorizationRequest.getResponseTypes();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!responseTypes.contains(<span class="string">&quot;token&quot;</span>) &amp;&amp; !responseTypes.contains(<span class="string">&quot;code&quot;</span>)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedResponseTypeException</span>(<span class="string">&quot;Unsupported response types: &quot;</span> + responseTypes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (authorizationRequest.getClientId() == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClientException</span>(<span class="string">&quot;A client id must be provided&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication) || !((Authentication) principal).isAuthenticated()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">					<span class="string">&quot;User must be authenticated with Spring Security before authorization can be completed.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">ClientDetails</span> <span class="variable">client</span> <span class="operator">=</span> getClientDetailsService().loadClientByClientId(authorizationRequest.getClientId());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// The resolved redirect URI is either the redirect_uri from the parameters or the one from</span></span><br><span class="line">		<span class="comment">// clientDetails. Either way we need to store it on the AuthorizationRequest.</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">redirectUriParameter</span> <span class="operator">=</span> authorizationRequest.getRequestParameters().get(OAuth2Utils.REDIRECT_URI);</span><br><span class="line">		<span class="type">String</span> <span class="variable">resolvedRedirect</span> <span class="operator">=</span> redirectResolver.resolveRedirect(redirectUriParameter, client);</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(resolvedRedirect)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RedirectMismatchException</span>(</span><br><span class="line">					<span class="string">&quot;A redirectUri must be either supplied or preconfigured in the ClientDetails&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		authorizationRequest.setRedirectUri(resolvedRedirect);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span></span><br><span class="line">		<span class="comment">// been added to the request by the manager).</span></span><br><span class="line">		oauth2RequestValidator.validateScope(authorizationRequest, client);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Some systems may allow for approval decisions to be remembered or approved by default. Check for</span></span><br><span class="line">		<span class="comment">// such logic here, and set the approved flag on the authorization request accordingly.</span></span><br><span class="line">		authorizationRequest = userApprovalHandler.checkForPreApproval(authorizationRequest,</span><br><span class="line">				(Authentication) principal);</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> is this call necessary?</span></span><br><span class="line">		<span class="type">boolean</span> <span class="variable">approved</span> <span class="operator">=</span> userApprovalHandler.isApproved(authorizationRequest, (Authentication) principal);</span><br><span class="line">		authorizationRequest.setApproved(approved);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Validation is all done, so we can check for auto approval...</span></span><br><span class="line">		<span class="keyword">if</span> (authorizationRequest.isApproved()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (responseTypes.contains(<span class="string">&quot;token&quot;</span>)) &#123;</span><br><span class="line">				<span class="keyword">return</span> getImplicitGrantResponse(authorizationRequest);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (responseTypes.contains(<span class="string">&quot;code&quot;</span>)) &#123;</span><br><span class="line">                                <span class="comment">// 生成code值并返回</span></span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(getAuthorizationCodeResponse(authorizationRequest,</span><br><span class="line">						(Authentication) principal));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Place auth request into the model so that it is stored in the session</span></span><br><span class="line">		<span class="comment">// for approveOrDeny to use. That way we make sure that auth request comes from the session,</span></span><br><span class="line">		<span class="comment">// so any auth request parameters passed to approveOrDeny will be ignored and retrieved from the session.</span></span><br><span class="line">		model.put(<span class="string">&quot;authorizationRequest&quot;</span>, authorizationRequest);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">		sessionStatus.setComplete();</span><br><span class="line">		<span class="keyword">throw</span> e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-2-6-3-CheckTokenEndpoint"><a href="#2-2-6-3-CheckTokenEndpoint" class="headerlink" title="2.2.6.3 CheckTokenEndpoint"></a>2.2.6.3 CheckTokenEndpoint</h4><p>当采用RemoteTokenServices时，resouceServer无法自行验证access_token字符串是否正确，遂递交给另一个应用程序中的authserver里CheckTokenEndpoint(&#x2F;oauth&#x2F;check_token)进行检验，检验结果返回给resourceServer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/oauth/check_token&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, ?&gt; checkToken(<span class="meta">@RequestParam(&quot;token&quot;)</span> String value) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">OAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> resourceServerTokenServices.readAccessToken(value);</span><br><span class="line">	<span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTokenException</span>(<span class="string">&quot;Token was not recognised&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (token.isExpired()) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidTokenException</span>(<span class="string">&quot;Token has expired&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">OAuth2Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> resourceServerTokenServices.loadAuthentication(token.getValue());</span><br><span class="line"></span><br><span class="line">	Map&lt;String, ?&gt; response = accessTokenConverter.convertAccessToken(token, authentication);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h1 id="三、异常处理源码"><a href="#三、异常处理源码" class="headerlink" title="三、异常处理源码"></a>三、异常处理源码</h1><h2 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h2><p><strong>异常处理规则：</strong></p>
<ul>
<li>规则1. 如果异常是 AuthenticationException，使用 AuthenticationEntryPoint 处理</li>
<li>规则2. 如果异常是 AccessDeniedException 且用户是匿名用户，使用 AuthenticationEntryPoint 处理</li>
<li>规则3. 如果异常是 AccessDeniedException 且用户不是匿名用户，如果否则交给 AccessDeniedHandler 处理。</li>
</ul>
<h2 id="3-2-源码"><a href="#3-2-源码" class="headerlink" title="3.2 源码"></a>3.2 源码</h2><h3 id="3-2-1-ExceptionTranslationFilter"><a href="#3-2-1-ExceptionTranslationFilter" class="headerlink" title="3.2.1 ExceptionTranslationFilter"></a>3.2.1 ExceptionTranslationFilter</h3><h4 id="ExceptionTranslationFilter的doFilter"><a href="#ExceptionTranslationFilter的doFilter" class="headerlink" title="ExceptionTranslationFilter的doFilter"></a>ExceptionTranslationFilter的doFilter</h4><p>ExceptionTranslationFilter是个异常过滤器，用来处理在认证授权过程中抛出的异常，在过滤器链中处于倒数第三的位置（这个filter后面分为是FilterSecurityInterceptor、SwitchUserFilter），所以ExceptionTranslationFilter只能捕获到后面两个过滤器所抛出的异常。 </p>
<p>ExceptionTranslationFilter后面的过滤器是FilterSecurityInterceptor。先上一张图，如下图1所示：</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B" alt="21580557-0fd084a033d2b022.png">.assetsc60a0cb6ccf4fa2b67a8907acdf60dc.png)</p>
<ul>
<li>红框1中的，是调用Filter链中的后续Filter。</li>
<li>如果图1中的操作抛出异常，就会来到红框2处，判断抛出的异常是否是AuthenticationException。</li>
<li>如果抛出的异常不是AuthenticationException，即红框2的结果为null，那么就到红框3处，判断是否是AccessDeniedException。</li>
<li>如果抛出的异常是AuthenticationException或者时AccessDeniedException，那么执行红框4处的代码。</li>
</ul>
<h4 id="ExceptionTranslationFilter的handleSpringSecurityException方法"><a href="#ExceptionTranslationFilter的handleSpringSecurityException方法" class="headerlink" title="ExceptionTranslationFilter的handleSpringSecurityException方法"></a>ExceptionTranslationFilter的handleSpringSecurityException方法</h4><p>下面来看handleSpringSecurityException的方法体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionTranslationFilter</span> <span class="keyword">extends</span> <span class="title class_">GenericFilterBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">            logger.debug(<span class="string">&quot;Chain processed normally&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// Try to extract a SpringSecurityException from the stacktrace</span></span><br><span class="line">            Throwable[] causeChain = throwableAnalyzer.determineCauseChain(ex);</span><br><span class="line">            <span class="type">RuntimeException</span> <span class="variable">ase</span> <span class="operator">=</span> (AuthenticationException) throwableAnalyzer</span><br><span class="line">                    .getFirstThrowableOfType(AuthenticationException.class, causeChain);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ase == <span class="literal">null</span>) &#123;</span><br><span class="line">                ase = (AccessDeniedException) throwableAnalyzer.getFirstThrowableOfType(</span><br><span class="line">                        AccessDeniedException.class, causeChain);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ase != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Unable to handle the Spring Security Exception because the response is already committed.&quot;</span>, ex);</span><br><span class="line">                &#125;</span><br><span class="line">                handleSpringSecurityException(request, response, chain, ase);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Rethrow ServletExceptions and RuntimeExceptions as-is</span></span><br><span class="line">                <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (ServletException) ex;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (RuntimeException) ex;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Wrap other Exceptions. This shouldn&#x27;t actually happen</span></span><br><span class="line">                <span class="comment">// as we&#x27;ve already covered all the possibilities for doFilter</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleSpringSecurityException</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response, FilterChain chain, RuntimeException exception)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">            logger.debug(</span><br><span class="line">                    <span class="string">&quot;Authentication exception occurred; redirecting to authentication entry point&quot;</span>,</span><br><span class="line">                    exception);</span><br><span class="line"></span><br><span class="line">            sendStartAuthentication(request, response, chain,</span><br><span class="line">                    (AuthenticationException) exception);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AccessDeniedException) &#123;</span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">            <span class="keyword">if</span> (authenticationTrustResolver.isAnonymous(authentication) || authenticationTrustResolver.isRememberMe(authentication)) &#123;</span><br><span class="line">                logger.debug(</span><br><span class="line">                        <span class="string">&quot;Access is denied (user is &quot;</span> + (authenticationTrustResolver.isAnonymous(authentication) ? <span class="string">&quot;anonymous&quot;</span> : <span class="string">&quot;not fully authenticated&quot;</span>) + <span class="string">&quot;); redirecting to authentication entry point&quot;</span>,</span><br><span class="line">                        exception);</span><br><span class="line"></span><br><span class="line">                sendStartAuthentication(</span><br><span class="line">                        request,</span><br><span class="line">                        response,</span><br><span class="line">                        chain,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">                            messages.getMessage(</span><br><span class="line">                                <span class="string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;Full authentication is required to access this resource&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(</span><br><span class="line">                        <span class="string">&quot;Access is denied (user is not anonymous); delegating to AccessDeniedHandler&quot;</span>,</span><br><span class="line">                        exception);</span><br><span class="line"></span><br><span class="line">                accessDeniedHandler.handle(request, response,</span><br><span class="line">                        (AccessDeniedException) exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendStartAuthentication</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">            HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">            AuthenticationException reason)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// SEC-112: Clear the SecurityContextHolder&#x27;s Authentication, as the</span></span><br><span class="line">        <span class="comment">// existing Authentication is no longer considered valid</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(<span class="literal">null</span>);</span><br><span class="line">        requestCache.saveRequest(request, response);   <span class="comment">//保存当前请求</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Calling Authentication entry point.&quot;</span>);</span><br><span class="line">        authenticationEntryPoint.commence(request, response, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果抛出的异常是AuthenticationException，则执行方法sendStartAuthentication</li>
<li>如果抛出的异常是AccessDeniedException，且从SecurityContextHolder.getContext().getAuthentication()得到的是AnonymousAuthenticationToken或者RememberMeAuthenticationToken，那么执行sendStartAuthentication</li>
<li>如果上面的第二点不满足，则执行accessDeniedHandler的handle方法</li>
</ol>
<p>在HttpSessionRequestCache 中会将本次请求的信息保存到session中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpSessionRequestCache</span> <span class="keyword">implements</span> <span class="title class_">RequestCache</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Stores the current request, provided the configuration properties allow it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestMatcher.matches(request)) &#123;</span><br><span class="line">            <span class="type">DefaultSavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSavedRequest</span>(request,</span><br><span class="line">                    portResolver);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (createSessionAllowed || request.getSession(<span class="literal">false</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Store the HTTP request itself. Used by</span></span><br><span class="line">                <span class="comment">// AbstractAuthenticationProcessingFilter</span></span><br><span class="line">                <span class="comment">// for redirection after successful authentication (SEC-29)</span></span><br><span class="line">                request.getSession().setAttribute(<span class="built_in">this</span>.sessionAttrName, savedRequest);</span><br><span class="line">                logger.debug(<span class="string">&quot;DefaultSavedRequest added to Session: &quot;</span> + savedRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Request not saved as configured RequestMatcher did not match&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccessDeniedHandler</span><span class="params">(AccessDeniedHandler accessDeniedHandler)</span> &#123;</span><br><span class="line">    Assert.notNull(accessDeniedHandler, <span class="string">&quot;AccessDeniedHandler required&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.accessDeniedHandler = accessDeniedHandler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="ExceptionTranslationFilter的sendStartAuthentication方法"><a href="#ExceptionTranslationFilter的sendStartAuthentication方法" class="headerlink" title="ExceptionTranslationFilter的sendStartAuthentication方法"></a>ExceptionTranslationFilter的sendStartAuthentication方法</h4><p>调用sendStartAuthentication方法实现对request的缓存和重定向</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendStartAuthentication</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">        HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">        AuthenticationException reason)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="comment">// SEC-112: Clear the SecurityContextHolder&#x27;s Authentication, as the</span></span><br><span class="line">    <span class="comment">// existing Authentication is no longer considered valid</span></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(<span class="literal">null</span>);</span><br><span class="line">    requestCache.saveRequest(request, response);</span><br><span class="line">    logger.debug(<span class="string">&quot;Calling Authentication entry point.&quot;</span>);</span><br><span class="line">    authenticationEntryPoint.commence(request, response, reason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在commence方法中完成对请求的重定向</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">        AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">redirectUrl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useForward) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceHttps &amp;&amp; <span class="string">&quot;http&quot;</span>.equals(request.getScheme())) &#123;</span><br><span class="line">            <span class="comment">// First redirect the current request to HTTPS.</span></span><br><span class="line">            <span class="comment">// When that request is received, the forward to the login page will be</span></span><br><span class="line">            <span class="comment">// used.</span></span><br><span class="line">            redirectUrl = buildHttpsRedirectUrlForRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (redirectUrl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">loginForm</span> <span class="operator">=</span> determineUrlToUseForThisRequest(request, response,</span><br><span class="line">                    authException);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Server side forward to: &quot;</span> + loginForm);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">RequestDispatcher</span> <span class="variable">dispatcher</span> <span class="operator">=</span> request.getRequestDispatcher(loginForm);</span><br><span class="line"></span><br><span class="line">            dispatcher.forward(request, response);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// redirect to login page. Use https if forceHttps true</span></span><br><span class="line"></span><br><span class="line">        redirectUrl = buildRedirectUrlToLoginPage(request, response, authException);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    redirectStrategy.sendRedirect(request, response, redirectUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="自定义未登录异常"><a href="#自定义未登录异常" class="headerlink" title="自定义未登录异常"></a>自定义未登录异常</h4><p>如果未登录，不希望跳转到&#x2F;login而是直接抛异常或跳转到指定路径，可以通过以下两步来实现：</p>
<ol>
<li><p>自定义类实现AuthenticationEntryPoint接口，重写commence方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!response.isCommitted()) &#123;</span><br><span class="line"><span class="comment">//            response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED,&quot;未认证的用户:&quot; + authException.getMessage());</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultRedirectStrategy</span>().sendRedirect(request, response, <span class="string">&quot;http://www.jd.com&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在WebSecurityConfigurerAdapter继承类中指定异常处理类为自定义类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//跨域请求伪造防御失效</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/r/r1&quot;</span>).hasAnyAuthority(<span class="string">&quot;p1&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/uaa/publicKey&quot;</span>, <span class="string">&quot;/login**&quot;</span>, <span class="string">&quot;/isExpired**&quot;</span>, <span class="string">&quot;/mobile/**&quot;</span>, <span class="string">&quot;/check/**&quot;</span>, <span class="string">&quot;/user/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint(<span class="keyword">new</span> <span class="title class_">MyAuthenticationEntryPoint</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.configure(auth);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.configure(web);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-2-2-FilterSecurityInterceptor"><a href="#3-2-2-FilterSecurityInterceptor" class="headerlink" title="3.2.2 FilterSecurityInterceptor"></a>3.2.2 FilterSecurityInterceptor</h3><p>在web应用中，spring security是一个filter。而在filter内部，它又自建了一个filter chain（如果不用命名空间，也可以自定义）。spring security按顺序对每个filter进行处理。各filter之间有较大的差异性。与权限验证关系最密切的是FilterSecurityInterceptor。</p>
<p>FilterSecurityInterceptor认证及验权流程：</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5C61a5d8d960e547a89ec8415e198af5ac.png" alt="21580557-91f104e63676e03d.png"></p>
<p>FilterSecurityInterceptor的类关系图如下。它使用AuthenticationManager做认证（用户是否已登录），使用AccessDecisionManager做验证（用户是否有权限）。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5C53e9f10e648e4cb7b4513d1522934e9b.png" alt="21580557-c3d28217250cf5ee.png"></p>
<p>ProviderManager是默认的AuthenticationManager实现类，它不直接进行认证。而是采用组合模式，将认证工作委托给AuthenticationProvider。一般情况下，一组AuthenticationProvider有一个认证成功，就被视为认证成功。ProviderManager关系图如下：</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B" alt="21580557-18e1a04bf1e402e4.png">.assets7bc55b20113484989a206c341025ac3.png)</p>
<p>AccessDecisionManager负责验证用户是否有操作权限，它也是采用组合模式。security自带的AccessDecisionManager实现类有三种：AffirmativeBased只要有一个认证处理器认证通过就表示成功；ConsensusBased采用的是多数原则；UnanimousBased采用一票否决制。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B).assets%5C4116d007debb4d829dda25d862ac885e.png" alt="21580557-eb6101754772e091.png"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B)/">http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%8B)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/Python/Python%E7%88%AC%E5%8F%96%E7%99%BE%E5%BA%A6%E5%9B%BE%E5%BA%93%E5%92%8C%E4%B8%8A%E4%BC%A0%E7%99%BE%E5%BA%A6%E5%9B%BE%E5%BA%93/" title="Python爬取百度图库和上传百度图库"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python爬取百度图库和上传百度图库</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/Oauth2/Oauth2%EF%BC%88%E4%B8%8B%EF%BC%89/" title="Oauth2（下）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Oauth2（下）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">二、密码模式源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">2.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%BA%90%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">2.2 源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-Oauth%E7%9A%84%E8%AF%B7%E6%B1%82%E5%B0%81%E8%A3%85%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.2.1 Oauth的请求封装类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-OAuth2Authentication"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">2.2.1.1 OAuth2Authentication</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-2-OAuth2AccessToken"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">2.2.1.2 OAuth2AccessToken</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-3-BaseRequest%E5%8F%8A%E5%85%B6%E7%BB%A7%E6%89%BF%E7%B1%BBAuthorizationRequest%E3%80%81TokenRequest%E3%80%81OAuth2Request"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">2.2.1.3 BaseRequest及其继承类AuthorizationRequest、TokenRequest、OAuth2Request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-4-OAuth2RefreshToken"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">2.2.1.4 OAuth2RefreshToken</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-5-OAuth2RequestFactory%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">2.2.1.5 OAuth2RequestFactory接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-TokenGranter%E3%80%81TokenStore%E3%80%81TokenExtractor"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2.2 TokenGranter、TokenStore、TokenExtractor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-1-TokenGranter-x2F-oauth-x2F-token"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.2.2.1 TokenGranter(&#x2F;oauth&#x2F;token)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractTokenGranter-%E6%8E%88%E4%BA%88OAuth2AccessToken"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text">AbstractTokenGranter(授予OAuth2AccessToken)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CompositeTokenGranter"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text">CompositeTokenGranter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-2-TokenStore"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2.2.2.2 TokenStore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-3-TokenExtractor-OAuth2AuthenticationProcessingFilter"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">2.2.2.3 TokenExtractor (OAuth2AuthenticationProcessingFilter)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-4-ResourceServerTokenServices"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">2.2.2.4 ResourceServerTokenServices</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DefaultTokenServices"><span class="toc-number">1.2.2.4.1.</span> <span class="toc-text">DefaultTokenServices</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RemoteTokenServices"><span class="toc-number">1.2.2.4.2.</span> <span class="toc-text">RemoteTokenServices</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-Client%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9B%B8%E5%85%B3%E7%B1%BB-ClientDetails-ClientDetailsService"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.2.3 Client客户端相关类  ClientDetails   ClientDetailsService</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-1-ClientDetails"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.2.3.1 ClientDetails</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-2-ClientDetailsService"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.2.3.2 ClientDetailsService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-3-ClientDetailsServiceBuilder"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">2.2.3.3 ClientDetailsServiceBuilder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE-ResourceServerConfigurerAdapter"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">2.2.4 资源服务器配置  ResourceServerConfigurerAdapter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE-AuthorizationServerConfigurerAdapter"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.2.5 授权服务器配置    AuthorizationServerConfigurerAdapter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-TokenEndPoint%EF%BC%8CAuthorizationEndPoint%EF%BC%8CCheckTokenEndPoint"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.2.6 TokenEndPoint，AuthorizationEndPoint，CheckTokenEndPoint</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-1-TokenEndPoint"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">2.2.6.1 TokenEndPoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-2-AuthorizationEndPoint"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">2.2.6.2 AuthorizationEndPoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6-3-CheckTokenEndpoint"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">2.2.6.3 CheckTokenEndpoint</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%BA%90%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">三、异常处理源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">3.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">3.2 源码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-ExceptionTranslationFilter"><span class="toc-number">2.2.1.</span> <span class="toc-text">3.2.1 ExceptionTranslationFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ExceptionTranslationFilter%E7%9A%84doFilter"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">ExceptionTranslationFilter的doFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExceptionTranslationFilter%E7%9A%84handleSpringSecurityException%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">ExceptionTranslationFilter的handleSpringSecurityException方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ExceptionTranslationFilter%E7%9A%84sendStartAuthentication%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">ExceptionTranslationFilter的sendStartAuthentication方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%AA%E7%99%BB%E5%BD%95%E5%BC%82%E5%B8%B8"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">自定义未登录异常</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-FilterSecurityInterceptor"><span class="toc-number">2.2.2.</span> <span class="toc-text">3.2.2 FilterSecurityInterceptor</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>