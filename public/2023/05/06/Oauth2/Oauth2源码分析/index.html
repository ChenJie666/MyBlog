<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Oauth2源码分析 | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="二、授权码模式源码分析2.1 第一次请求&#x2F;oauth&#x2F;authorize请求的完整url如下，有参数client_id,response_type,redirect_uri。 1http:&#x2F;&#x2F;localhost:9500&#x2F;oauth&#x2F;authorize?client_id&#x3D;c1&amp;response_type&#x3D;code&amp;scope&#x3D;ROLE_ADMIN&amp;re">
<meta property="og:type" content="article">
<meta property="og:title" content="Oauth2源码分析">
<meta property="og:url" content="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="二、授权码模式源码分析2.1 第一次请求&#x2F;oauth&#x2F;authorize请求的完整url如下，有参数client_id,response_type,redirect_uri。 1http:&#x2F;&#x2F;localhost:9500&#x2F;oauth&#x2F;authorize?client_id&#x3D;c1&amp;response_type&#x3D;code&amp;scope&#x3D;ROLE_ADMIN&amp;re">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.027Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.027Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Oauth2源码分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Oauth2源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.027Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.027Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Oauth2/">Oauth2</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Oauth2源码分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="二、授权码模式源码分析"><a href="#二、授权码模式源码分析" class="headerlink" title="二、授权码模式源码分析"></a>二、授权码模式源码分析</h1><h3 id="2-1-第一次请求-x2F-oauth-x2F-authorize"><a href="#2-1-第一次请求-x2F-oauth-x2F-authorize" class="headerlink" title="2.1 第一次请求&#x2F;oauth&#x2F;authorize"></a>2.1 第一次请求&#x2F;oauth&#x2F;authorize</h3><p>请求的完整url如下，有参数client_id,response_type,redirect_uri。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9500/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=ROLE_ADMIN&amp;redirect_uri=http://www.taobao.com</span><br></pre></td></tr></table></figure>
<p>这一步时已经完成了用户认证并获取到了UserDetails。<br>访问<strong>AuthorizationEndPoint</strong>中的&#x2F;oauth&#x2F;authorize，里面会判断client信息和用户信息，如果user没有Authentication，则会报错，跳转到ExceptionTranslationFilter类中，请求转发到&#x2F;login路径，并将现请求路径存储到session的saverequest中。</p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C44b2b8419f6a4bbf99f5bf4a12622170.png" alt="1599553678755.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/oauth/authorize&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ModelAndView <span class="title function_">authorize</span><span class="params">(Map&lt;String, Object&gt; model, <span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters,SessionStatus sessionStatus,Principal principal)</span> &#123;</span><br><span class="line"> </span><br><span class="line">    	<span class="comment">//通过参数client_id,response_type,redirect_uri和scope创建AuthorizationRequest</span></span><br><span class="line">		<span class="type">AuthorizationRequest</span> <span class="variable">authorizationRequest</span> <span class="operator">=</span> getOAuth2RequestFactory().createAuthorizationRequest(parameters);</span><br><span class="line"> </span><br><span class="line">		Set&lt;String&gt; responseTypes = authorizationRequest.getResponseTypes();</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> (!responseTypes.contains(<span class="string">&quot;token&quot;</span>) &amp;&amp; !responseTypes.contains(<span class="string">&quot;code&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedResponseTypeException</span>(<span class="string">&quot;Unsupported response types: &quot;</span> + responseTypes);</span><br><span class="line">		&#125;</span><br><span class="line">                <span class="comment">// 判断clientId是否为空</span></span><br><span class="line">		<span class="keyword">if</span> (authorizationRequest.getClientId() == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClientException</span>(<span class="string">&quot;A client id must be provided&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="comment">// 判断user是否认证，认证失败则跳转到/login路径</span></span><br><span class="line">			<span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication) || !((Authentication) principal).isAuthenticated()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">						<span class="string">&quot;User must be authenticated with Spring Security before authorization can be completed.&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">                <span class="comment">// 验证client信息</span></span><br><span class="line">			<span class="type">ClientDetails</span> <span class="variable">client</span> <span class="operator">=</span> getClientDetailsService().loadClientByClientId(authorizationRequest.getClientId());</span><br><span class="line"> </span><br><span class="line">           ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2-2-ExceptionTranslationFilter"><a href="#2-2-ExceptionTranslationFilter" class="headerlink" title="2.2 ExceptionTranslationFilter"></a>2.2 ExceptionTranslationFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		<span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">		<span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			chain.doFilter(request, response);</span><br><span class="line"> </span><br><span class="line">			logger.debug(<span class="string">&quot;Chain processed normally&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="comment">// Try to extract a SpringSecurityException from the stacktrace</span></span><br><span class="line">			Throwable[] causeChain = throwableAnalyzer.determineCauseChain(ex);</span><br><span class="line">			<span class="type">RuntimeException</span> <span class="variable">ase</span> <span class="operator">=</span> (AuthenticationException) throwableAnalyzer</span><br><span class="line">					.getFirstThrowableOfType(AuthenticationException.class, causeChain);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (ase == <span class="literal">null</span>) &#123;</span><br><span class="line">				ase = (AccessDeniedException) throwableAnalyzer.getFirstThrowableOfType(</span><br><span class="line">						AccessDeniedException.class, causeChain);</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (ase != <span class="literal">null</span>) &#123;</span><br><span class="line">                 <span class="comment">// 进入到此方法中</span></span><br><span class="line">				handleSpringSecurityException(request, response, chain, ase);</span><br><span class="line">			&#125;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleSpringSecurityException</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">			HttpServletResponse response, FilterChain chain, RuntimeException exception)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		<span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AuthenticationException) &#123;</span><br><span class="line">			logger.debug(</span><br><span class="line">					<span class="string">&quot;Authentication exception occurred; redirecting to authentication entry point&quot;</span>,</span><br><span class="line">					exception);</span><br><span class="line">             <span class="comment">// 没有验证身份信息，跳转到/login界面</span></span><br><span class="line">			sendStartAuthentication(request, response, chain,</span><br><span class="line">					(AuthenticationException) exception);</span><br><span class="line">		&#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendStartAuthentication</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">			HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">			AuthenticationException reason)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        </span><br><span class="line">		SecurityContextHolder.getContext().setAuthentication(<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">// 将saveRequest存到session中，方便身份验证成功后调用</span></span><br><span class="line">		requestCache.saveRequest(request, response);</span><br><span class="line">		logger.debug(<span class="string">&quot;Calling Authentication entry point.&quot;</span>);</span><br><span class="line">                <span class="comment">// 请求重定向到/login</span></span><br><span class="line">		authenticationEntryPoint.commence(request, response, reason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-requestCache-saveRequest-request-response"><a href="#2-3-requestCache-saveRequest-request-response" class="headerlink" title="2.3 requestCache.saveRequest(request,response)"></a>2.3 requestCache.saveRequest(request,response)</h3><pre><code>requestCache的常用的实现类是HttpSessionRequestCache，一般是访问url时系统判断用户未获得授权，ExceptionTranslationFilter会存储savedRequest到session中，名为“SPRING_SECURITY_SAVED_REQUEST”。

SavedRequest里面包含原先访问的url地址、cookie、header、parameter等信息，一旦Authentication认证成功，successHandler.onAuthenticationSuccess(SavedRequestAwareAuthenticationSuccessHandler)会从session中抽取savedRequest，继续访问原先的url。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpSessionRequestCache</span> <span class="keyword">implements</span> <span class="title class_">RequestCache</span> &#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SAVED_REQUEST</span> <span class="operator">=</span> <span class="string">&quot;SPRING_SECURITY_SAVED_REQUEST&quot;</span>;  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * HttpSessionRequestCache Stores the current request, provided the configuration properties allow it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (requestMatcher.matches(request)) &#123;</span><br><span class="line">			<span class="type">DefaultSavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSavedRequest</span>(request,</span><br><span class="line">					portResolver);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">if</span> (createSessionAllowed || request.getSession(<span class="literal">false</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="comment">// Store the HTTP request itself. Used by</span></span><br><span class="line">				<span class="comment">// AbstractAuthenticationProcessingFilter</span></span><br><span class="line">				<span class="comment">// for redirection after successful authentication (SEC-29)</span></span><br><span class="line">				request.getSession().setAttribute(<span class="built_in">this</span>.sessionAttrName, savedRequest);</span><br><span class="line">				logger.debug(<span class="string">&quot;DefaultSavedRequest added to Session: &quot;</span> + savedRequest);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Request not saved as configured RequestMatcher did not match&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-重定向到-x2F-login"><a href="#2-4-重定向到-x2F-login" class="headerlink" title="2.4 重定向到&#x2F;login"></a>2.4 重定向到&#x2F;login</h3><pre><code>由于是第一次访问qq认证服务器，所以需要用户登录校验身份。在WebSecurityConfigurerAdapter的继承类中，找到存储在缓存中的用户名密码，填写完毕。
</code></pre>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C3a9ecd9b6bee42c2a2c42bff6613ec19.png" alt="1599553813790.png"></p>
<pre><code>点击“Sign In”按钮后，post请求/login路径，按照FilterChainProxy的filter链运行到UsernamePasswordAuthenticationFilter，验证通过后执行successHandler.onAuthenticationSuccess(request, response, authResult)，获取session中的savedrequest，重定向到原先的地址/oauth/authorize，并附带完整请求参数。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="keyword">extends</span></span><br><span class="line">		<span class="title class_">SimpleUrlAuthenticationSuccessHandler</span> &#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(<span class="built_in">this</span>.getClass());</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> <span class="type">RequestCache</span> <span class="variable">requestCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpSessionRequestCache</span>();</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">			HttpServletResponse response, Authentication authentication)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">             <span class="comment">// HttpSessionRequestCache.getRequest ,找名为SPRING_SECURITY_SAVED_REQUEST的session</span></span><br><span class="line">		<span class="type">SavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> requestCache.getRequest(request, response);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> (savedRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">targetUrlParameter</span> <span class="operator">=</span> getTargetUrlParameter();</span><br><span class="line">		<span class="keyword">if</span> (isAlwaysUseDefaultTargetUrl()</span><br><span class="line">				|| (targetUrlParameter != <span class="literal">null</span> &amp;&amp; StringUtils.hasText(request</span><br><span class="line">						.getParameter(targetUrlParameter)))) &#123;</span><br><span class="line">			requestCache.removeRequest(request, response);</span><br><span class="line">			<span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line"> </span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">		clearAuthenticationAttributes(request);</span><br><span class="line"> </span><br><span class="line">		<span class="comment">// Use the DefaultSavedRequest URL</span></span><br><span class="line">           <span class="comment">// 获得原先存储在SavedRequest中的redirectUrl,即/oauth/authorize</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">targetUrl</span> <span class="operator">=</span> savedRequest.getRedirectUrl();</span><br><span class="line">		logger.debug(<span class="string">&quot;Redirecting to DefaultSavedRequest Url: &quot;</span> + targetUrl);</span><br><span class="line">		getRedirectStrategy().sendRedirect(request, response, targetUrl);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestCache</span><span class="params">(RequestCache requestCache)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestCache = requestCache;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-第二次请求-x2F-oauth-x2F-authorize"><a href="#2-5-第二次请求-x2F-oauth-x2F-authorize" class="headerlink" title="2.5 第二次请求&#x2F;oauth&#x2F;authorize"></a>2.5 第二次请求&#x2F;oauth&#x2F;authorize</h3><pre><code>这次请求就硬气多了，请求中携带了Authentication的session，系统验证通过，生成授权码，存储在InMemoryAuthorizationCodeServices中的concurrenthashmap中，且返回给请求参数中的redirect_uri，即http://localhost:8081/aiqiyi/qq/redirect。
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/oauth/authorize?client_id=aiqiyi&amp;response_type=code&amp;redirect_uri=http://localhost:8081/aiqiyi/qq/redirect</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/oauth/authorize&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ModelAndView <span class="title function_">authorize</span><span class="params">(Map&lt;String, Object&gt; model, <span class="meta">@RequestParam</span> Map&lt;String, String&gt; parameters,</span></span><br><span class="line"><span class="params">			SessionStatus sessionStatus, Principal principal)</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">            <span class="keyword">if</span> (authorizationRequest.isApproved()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (responseTypes.contains(<span class="string">&quot;token&quot;</span>)) &#123;</span><br><span class="line">					<span class="keyword">return</span> getImplicitGrantResponse(authorizationRequest);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (responseTypes.contains(<span class="string">&quot;code&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 返回code给redirect_uri</span></span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ModelAndView</span>(getAuthorizationCodeResponse(authorizationRequest,</span><br><span class="line">							(Authentication) principal));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">                ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InMemoryAuthorizationCodeServices</span> <span class="keyword">extends</span> <span class="title class_">RandomValueAuthorizationCodeServices</span> &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, OAuth2Authentication&gt; authorizationCodeStore = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, OAuth2Authentication&gt;();</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">store</span><span class="params">(String code, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.authorizationCodeStore.put(code, authentication);</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2Authentication <span class="title function_">remove</span><span class="params">(String code)</span> &#123;</span><br><span class="line">		<span class="type">OAuth2Authentication</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="built_in">this</span>.authorizationCodeStore.remove(code);</span><br><span class="line">		<span class="keyword">return</span> auth;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>到了这里我们总结下刚才都发生了什么。首先aiqiyi向qq发出&#x2F;oauth&#x2F;authorize的请求，qq服务器的AuthorizationEndPoint判断用户是否登录，如果没有登录则先跳转到&#x2F;login界面，同时存储首次request的信息，保存在session中。用户登录并授权后，程序自动获取刚存储在session中的savedrequest，再次访问&#x2F;oauth&#x2F;authorize。验证client信息和user信息成功后，重定向到redirect_uri，并传参数code。</p>
</blockquote>
<h3 id="2-6-client接收code并向oauth-server请求-x2F-oauth-x2F-token"><a href="#2-6-client接收code并向oauth-server请求-x2F-oauth-x2F-token" class="headerlink" title="2.6 client接收code并向oauth server请求&#x2F;oauth&#x2F;token"></a>2.6 client接收code并向oauth server请求&#x2F;oauth&#x2F;token</h3><pre><code>以下代码自行写在client的controller里，用于接收qq服务端传递来的code，并请求/oauth/token。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/aiqiyi/qq/redirect&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span>&#123;</span><br><span class="line">       log.info(<span class="string">&quot;receive code &#123;&#125;&quot;</span>,code);</span><br><span class="line">       <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">       headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">       MultiValueMap&lt;String, String&gt; params= <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">       params.add(<span class="string">&quot;grant_type&quot;</span>,<span class="string">&quot;authorization_code&quot;</span>);</span><br><span class="line">       params.add(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">       params.add(<span class="string">&quot;client_id&quot;</span>,<span class="string">&quot;aiqiyi&quot;</span>);</span><br><span class="line">       params.add(<span class="string">&quot;client_secret&quot;</span>,<span class="string">&quot;secret&quot;</span>);</span><br><span class="line">       params.add(<span class="string">&quot;redirect_uri&quot;</span>,<span class="string">&quot;http://localhost:8081/aiqiyi/qq/redirect&quot;</span>);</span><br><span class="line">       HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(params, headers);</span><br><span class="line">       ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(<span class="string">&quot;http://localhost:8080/oauth/token&quot;</span>, requestEntity, String.class);</span><br><span class="line">       <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">       log.info(<span class="string">&quot;token =&gt; &#123;&#125;&quot;</span>,token);</span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-7-TokenEndPoint生成access-token"><a href="#2-7-TokenEndPoint生成access-token" class="headerlink" title="2.7 TokenEndPoint生成access_token"></a>2.7 TokenEndPoint生成access_token</h3><p>具体代码在上一章已介绍，这里不做详述。注意的是会从InMemoryAuthorizationCodeServices中提取hashmap验证code是否正确。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h2><p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C9777fc32f9ec44128ad1e618fc89d222.png" alt="Snipaste_2020-09-08_16-34-58.jpg"></p>
<br>
<br>
# 三、密码模式源码分析

<h2 id="1-访问-x2F-oauth-x2F-token"><a href="#1-访问-x2F-oauth-x2F-token" class="headerlink" title="1.访问&#x2F;oauth&#x2F;token"></a>1.访问&#x2F;oauth&#x2F;token</h2><pre><code>此时FilterChainProxy的filter顺序如下。重要的Filter有**ClientCredentialsTokenEndpointFilter**和**BasicAuthenticationFilter**，前者从request parameters中抽取client信息，后者从header Authorization Basic XXXX中抽取client信息。
</code></pre>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C703038b7d682492ea024073b4ea6cc05.png" alt="image.png"></p>
<pre><code>启动项目，程序自动会启动几个endpoints，如/oauth/token,/oauth/authorize等。
</code></pre>
<h3 id="1-1-parameters"><a href="#1-1-parameters" class="headerlink" title="1.1 parameters"></a>1.1 parameters</h3><p><strong>ClientCredentialsTokenEndpointFilter</strong>会从parameter中抽取client_id,client_secret信息，并进行client的身份验证。</p>
<blockquote>
<p>localhost:8080&#x2F;oauth&#x2F;token?username&#x3D;250577914&amp;password&#x3D;123456&amp;grant_type&#x3D;password&amp;client_id&#x3D;aiqiyi&amp;client_secret&#x3D;secret</p>
</blockquote>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5Cd921821306c2401a91ca156f2335b3d9.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 验证请求方式，</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException, IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (allowOnlyPost &amp;&amp; !<span class="string">&quot;POST&quot;</span>.equalsIgnoreCase(request.getMethod())) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpRequestMethodNotSupportedException</span>(request.getMethod(), <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;POST&quot;</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;client_id&quot;</span>);</span><br><span class="line">	<span class="type">String</span> <span class="variable">clientSecret</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;client_secret&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果用户已经完成认证，那么不需要再执行该过滤器。否则对客户端信息进行认证。</span></span><br><span class="line">	<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">	<span class="keyword">if</span> (authentication != <span class="literal">null</span> &amp;&amp; authentication.isAuthenticated()) &#123;</span><br><span class="line">		<span class="keyword">return</span> authentication;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (clientId == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;No client credentials presented&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (clientSecret == <span class="literal">null</span>) &#123;</span><br><span class="line">		clientSecret = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	clientId = clientId.trim();</span><br><span class="line">	<span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(clientId,clientSecret);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//如果该请求没有进行过认证，将clientId和clientSecret构建token进行认证。</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-Basic-Auth"><a href="#1-2-Basic-Auth" class="headerlink" title="1.2 Basic Auth"></a>1.2 Basic Auth</h3><pre><code>Postman发送请求如下，Basic Auth中填写client_id和client_secret信息。点击update requests后，postman会将client信息用base64加密，写在header——Authorization中。
</code></pre>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C93ad02f7390646c8bd72419abf8fe712.png" alt="img"></p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C18bf314198ce4e60bbe8a70a80c00bbc.png" alt="img"></p>
<pre><code>这样一来，**ClientCredentialsTokenEndpointFilter**会由于参数中没有client_id自动跳过。**BasicAuthenticationFilter**会获取header中的Authorization Basic，提取出客户端信息。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">		HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">				<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">debug</span> <span class="operator">=</span> <span class="built_in">this</span>.logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (header == <span class="literal">null</span> || !header.startsWith(<span class="string">&quot;Basic &quot;</span>)) &#123;</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// Base64 反解码</span></span><br><span class="line">		String[] tokens = extractAndDecodeHeader(header, request);</span><br><span class="line">		<span class="keyword">assert</span> tokens.length == <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> tokens[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (authenticationIsRequired(username)) &#123;</span><br><span class="line">			<span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(</span><br><span class="line">					username, tokens[<span class="number">1</span>]);</span><br><span class="line">			authRequest.setDetails(</span><br><span class="line">					<span class="built_in">this</span>.authenticationDetailsSource.buildDetails(request));</span><br><span class="line">			<span class="type">Authentication</span> <span class="variable">authResult</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticationManager</span><br><span class="line">					.authenticate(authRequest);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">			SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">this</span>.rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line">				<span class="comment">//空方法，可以重写该方法记录用户的登录情况</span></span><br><span class="line">			onSuccessfulAuthentication(request, response, authResult);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (AuthenticationException failed) &#123;</span><br><span class="line">		 ...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>无论是哪一种方式访问/oauth/token，都事先验证了client信息，并作为authentication存储在SecurityContextHolder中。传递到TokenEndPoint的principal是client，paramters包含了user的信息和grantType。
</code></pre>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C77e29aa06c1b403b8d6e2e53ab9ecbad.png"></p>
<br>
## 2. 携带Access_token访问api

<h3 id="2-1-access-token放在parameter中"><a href="#2-1-access-token放在parameter中" class="headerlink" title="2.1 access_token放在parameter中"></a>2.1 access_token放在parameter中</h3><pre><code>OAuth2AuthenticationProcessingFilter，从request中提取access_token，构建PreAuthenticatedAuthenticationToken并验证。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException,ServletException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">debug</span> <span class="operator">=</span> logger.isDebugEnabled();</span><br><span class="line">	<span class="keyword">final</span> <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//extract方法从request中提取access_token并构建PreAuthenticatedAuthenticationToken</span></span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> tokenExtractor.extract(request);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (authentication == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (stateless &amp;&amp; isAuthenticated()) &#123;</span><br><span class="line">				SecurityContextHolder.clearContext();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			request.setAttribute(OAuth2AuthenticationDetails.ACCESS_TOKEN_VALUE, authentication.getPrincipal());</span><br><span class="line">			<span class="keyword">if</span> (authentication <span class="keyword">instanceof</span> AbstractAuthenticationToken) &#123;</span><br><span class="line">				<span class="type">AbstractAuthenticationToken</span> <span class="variable">needsDetails</span> <span class="operator">=</span> (AbstractAuthenticationToken) authentication;</span><br><span class="line">				needsDetails.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// OAuth2AuthenticationManager验证PreAuthenticatedAuthenticationToken</span></span><br><span class="line">			<span class="type">Authentication</span> <span class="variable">authResult</span> <span class="operator">=</span> authenticationManager.authenticate(authentication);</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">			eventPublisher.publishAuthenticationSuccess(authResult);</span><br><span class="line">			SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (OAuth2Exception failed) &#123;</span><br><span class="line">		SecurityContextHolder.clearContext();</span><br><span class="line"></span><br><span class="line">		eventPublisher.publishAuthenticationFailure(<span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(failed.getMessage(), failed),</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">PreAuthenticatedAuthenticationToken</span>(<span class="string">&quot;access-token&quot;</span>, <span class="string">&quot;N/A&quot;</span>));</span><br><span class="line"></span><br><span class="line">		authenticationEntryPoint.commence(request, response,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(failed.getMessage(), failed));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>tokenExtractor.extract(request)实际调用的是**BearTokenExtractor**里的extract方法，从Authorization header   “Bearer  xxxx”中抽取token，或者从request parameters抽取名为“access_token”的参数值。
</code></pre>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">extract</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">tokenValue</span> <span class="operator">=</span> extractToken(request);</span><br><span class="line">	<span class="keyword">if</span> (tokenValue != <span class="literal">null</span>) &#123;</span><br><span class="line">                         <span class="comment">// 记为PreAuthenticatedAuthenticationToken</span></span><br><span class="line">		<span class="type">PreAuthenticatedAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreAuthenticatedAuthenticationToken</span>(tokenValue, <span class="string">&quot;&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> authentication;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code> 构建后的authentication参数如
</code></pre>
<p>下，tokenType&#x3D;”Bearer”，principal&#x3D;token值。再根据<strong>OAuth2AuthenticationManager</strong>验证该authentication的合法性。</p>
<p>![Snipaste_2020-09-08_16-14-32.jpg](Oauth2源码分析.assets9f944ac8104457b83054d79eb913937.png)</p>
<br>
### 2.2 access_token存于header中

<pre><code>postman发送如下请求，将access_token写在Authorization的header里，前缀是Bearer。
</code></pre>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C9b58dd3ded114e2c9b733a32f4a4d314.png" alt="Snipaste_2020-09-08_16-15-06.jpg"></p>
<pre><code>同样是OAuth2AuthenticationProcessingFilter拦截，从request header中提取token，记为PreAuthenticatedAuthenticationToken，用OAuth2AuthenticationManager进行验证。
</code></pre>
<h2 id="3-访问-x2F-oauth-x2F-check-token"><a href="#3-访问-x2F-oauth-x2F-check-token" class="headerlink" title="3. 访问&#x2F;oauth&#x2F;check_token"></a>3. 访问&#x2F;oauth&#x2F;check_token</h2><pre><code>当oauthserver和resourceserver不在一个应用程序时，访问resource，会自动转交到oauthserver的/oauth/check_token，获得access_token的验证结果。
</code></pre>
<h3 id="3-1-配置ResouceServer"><a href="#3-1-配置ResouceServer" class="headerlink" title="3.1 配置ResouceServer"></a>3.1 配置ResouceServer</h3><p>配置application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">aiqiyi</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">secret</span></span><br><span class="line">      <span class="attr">access-token-uri:</span> <span class="string">http://localhost:8080/oauth/token</span></span><br><span class="line">      <span class="attr">user-authorization-uri:</span> <span class="string">http://localhost:8080/oauth/authorize</span></span><br><span class="line">      <span class="attr">user-logout-uri:</span> <span class="string">http://localhost:8080/oauth/logout</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">id:</span> <span class="string">qq</span></span><br><span class="line">      <span class="attr">token-info-uri:</span> <span class="string">http://localhost:8080/oauth/check_token</span></span><br><span class="line">      <span class="attr">prefer-token-info:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">filter-order:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">basic:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<p>配置ResouceServerConfigurerAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="meta">@Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;security.oauth2.resource.id&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String RESOURCE_ID;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> RemoteTokenServices remoteTokenServices;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 存入resource_id，到时候与oauthserver中client对应的resourceid进行比对</span></span><br><span class="line">		resources.resourceId(RESOURCE_ID).stateless(<span class="literal">true</span>);</span><br><span class="line">		resources.tokenServices(remoteTokenServices);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<br>
## /oauth/token流程

<h3 id="TokenEndpoint"><a href="#TokenEndpoint" class="headerlink" title="TokenEndpoint"></a>TokenEndpoint</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/oauth/token&quot;, method=RequestMethod.POST)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title function_">postAccessToken</span><span class="params">(Principal principal, <span class="meta">@RequestParam</span></span></span><br><span class="line"><span class="params">	Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientAuthenticationException</span>(</span><br><span class="line">					<span class="string">&quot;There is no client authentication. Try adding an appropriate authentication filter.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> getClientId(principal);</span><br><span class="line">		<span class="type">ClientDetails</span> <span class="variable">authenticatedClient</span> <span class="operator">=</span> getClientDetailsService().loadClientByClientId(clientId);</span><br><span class="line"></span><br><span class="line">		<span class="type">TokenRequest</span> <span class="variable">tokenRequest</span> <span class="operator">=</span> getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (clientId != <span class="literal">null</span> &amp;&amp; !clientId.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">			<span class="comment">// Only validate the client details if a client authenticated during this</span></span><br><span class="line">			<span class="comment">// request.</span></span><br><span class="line">			<span class="keyword">if</span> (!clientId.equals(tokenRequest.getClientId())) &#123;</span><br><span class="line">				<span class="comment">// double check to make sure that the client ID in the token request is the same as that in the</span></span><br><span class="line">				<span class="comment">// authenticated client</span></span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClientException</span>(<span class="string">&quot;Given client ID does not match authenticated client&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (authenticatedClient != <span class="literal">null</span>) &#123;</span><br><span class="line">			oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(tokenRequest.getGrantType())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidRequestException</span>(<span class="string">&quot;Missing grant type&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (tokenRequest.getGrantType().equals(<span class="string">&quot;implicit&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(<span class="string">&quot;Implicit grant type not supported from token endpoint&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isAuthCodeRequest(parameters)) &#123;</span><br><span class="line">			<span class="comment">// The scope was requested or determined during the authorization step</span></span><br><span class="line">			<span class="keyword">if</span> (!tokenRequest.getScope().isEmpty()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Clearing scope of incoming token request&quot;</span>);</span><br><span class="line">				tokenRequest.setScope(Collections.&lt;String&gt; emptySet());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (isRefreshTokenRequest(parameters)) &#123;</span><br><span class="line">			<span class="comment">// A refresh token has its own default scopes, so we should ignore any added by the factory here.</span></span><br><span class="line">			tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取token</span></span><br><span class="line">		<span class="type">OAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</span><br><span class="line">		<span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedGrantTypeException</span>(<span class="string">&quot;Unsupported grant type: &quot;</span> + tokenRequest.getGrantType());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getResponse(token);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C7fdbe11b09b748529f8ddb5b01d4f96f.png" alt="image.png"></p>
<ol>
<li>请求TokenEndpoint类的&#x2F;oauth&#x2F;token接口，参数为Map(存储grant_type、username、password)和Principal(已认证的Authentication对象)</li>
<li>接口从参数Principal中获取clientId</li>
<li>根据clientId调用loadClientByClientId方法从数据库中获取客户端对象</li>
<li>根据获取的客户端对象构建TokenRequest对象(如果parameter中没有scope，则将数据库中查询到的scope；将parameter、clientId、scopes和grantType作为参数构建TokenRequest)</li>
<li>遍历TokenRequest中的scope(从数据库查询得到)与从数据获取的scopes进行对比，判断当前请求是否有scope权限。？？？</li>
<li>通过getTokenGranter方法创建TokenGranter并重写了其中的grant方法。代码如下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AuthorizationServerEndpointsConfigurer类的getTokenStore和TokenGranter方法</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">getTokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> tokenStore();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> TokenGranter <span class="title function_">tokenGranter</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (tokenGranter == <span class="literal">null</span>) &#123;</span><br><span class="line">			tokenGranter = <span class="keyword">new</span> <span class="title class_">TokenGranter</span>() &#123;</span><br><span class="line">				<span class="keyword">private</span> CompositeTokenGranter delegate;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (delegate == <span class="literal">null</span>) &#123;</span><br><span class="line">						delegate = <span class="keyword">new</span> <span class="title class_">CompositeTokenGranter</span>(getDefaultTokenGranters());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> delegate.grant(grantType, tokenRequest);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> tokenGranter;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
调用grant方法会对tokenGranters列表(存储了5种TokenGranter)进行遍历，如果不符合grantType参数会返回null，直到找到符合grantType参数的TokenGranter(grantType为<strong>password</strong>，对应<strong>ResourceOwnerPasswordTokenGranter</strong>)，并调用grant方法生成并返回OAuth2AccessToken。代码如下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CompositeTokenGranter类的grant方法</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (TokenGranter granter : tokenGranters) &#123;</span><br><span class="line">			<span class="type">OAuth2AccessToken</span> <span class="variable">grant</span> <span class="operator">=</span> granter.grant(grantType, tokenRequest);</span><br><span class="line">			<span class="keyword">if</span> (grant!=<span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> grant;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
在grant方法中对client的信息进行校验，然后调用getAccessToken方法获取token。代码如下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractTokenGranter的grant和getAccessToken方法</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">this</span>.grantType.equals(grantType)) &#123; <span class="comment">//this.grantType: &quot;authorization_code&quot;，grantType: &quot;password&quot;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> tokenRequest.getClientId();</span><br><span class="line">		<span class="type">ClientDetails</span> <span class="variable">client</span> <span class="operator">=</span> clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line">		validateGrantType(grantType, client);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(<span class="string">&quot;Getting access token for: &quot;</span> + clientId);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> getAccessToken(client, tokenRequest);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> OAuth2AccessToken <span class="title function_">getAccessToken</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
在getAccessToken方法中调用了DefaultTokenServices(ResourceOwnerPasswordTokenGranter中的属性)的createAccessToken方法。其中参数为getOAuth2Authentication方法返回的OAuth2Authentication对象。首先来看getOAuth2Authentication方法，ResourceOwnerPasswordTokenGranter重写了父类的方法(这就是需要选择合适的TokenGranter类的原因)。代码如下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ResourceOwnerPasswordTokenGranter类的getOAuth2Authentication方法</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> OAuth2Authentication <span class="title function_">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> &#123;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, String&gt; parameters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;(tokenRequest.getRequestParameters());</span><br><span class="line">		<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> parameters.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> parameters.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">		<span class="comment">// Protect from downstream leaks of password</span></span><br><span class="line">		parameters.remove(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">userAuth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">		((AbstractAuthenticationToken) userAuth).setDetails(parameters);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			userAuth = authenticationManager.authenticate(userAuth);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AccountStatusException ase) &#123;</span><br><span class="line">			<span class="comment">//covers expired, locked, disabled cases (mentioned in section 5.2, draft 31)</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(ase.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (BadCredentialsException e) &#123;</span><br><span class="line">			<span class="comment">// If the username/password are wrong the spec says we should send 400/invalid grant</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (userAuth == <span class="literal">null</span> || !userAuth.isAuthenticated()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidGrantException</span>(<span class="string">&quot;Could not authenticate user: &quot;</span> + username);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="type">OAuth2Request</span> <span class="variable">storedOAuth2Request</span> <span class="operator">=</span> getRequestFactory().createOAuth2Request(client, tokenRequest);		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2Authentication</span>(storedOAuth2Request, userAuth);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
createAccessToken方法以OAuth2Authentication 作为参数，先从tokenStore中获取AccessToken，如果为null，则创建OAuth2RefreshToken，然后创建DefaultOAuth2AccessToken，并放入OAuth2RefreshToken和scope。然后将OAuth2AccessToken和OAuth2RefreshToken存储到TokenStore中。最终返回通过TokenEnhancer的enhance方法加强后的OAuth2AccessToken。<br>代码如下。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DefaultTokenServices类的createAccessToken方法</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">OAuth2AccessToken</span> <span class="variable">existingAccessToken</span> <span class="operator">=</span> tokenStore.getAccessToken(authentication);</span><br><span class="line">		<span class="type">OAuth2RefreshToken</span> <span class="variable">refreshToken</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (existingAccessToken != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (existingAccessToken.isExpired()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="literal">null</span>) &#123;</span><br><span class="line">					refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">					<span class="comment">// The token store could remove the refresh token when the</span></span><br><span class="line">					<span class="comment">// access token is removed, but we want to</span></span><br><span class="line">					<span class="comment">// be sure...</span></span><br><span class="line">					tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">				&#125;</span><br><span class="line">				tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// Re-store the access token in case the authentication has changed</span></span><br><span class="line">				tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">				<span class="keyword">return</span> existingAccessToken;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Only create a new refresh token if there wasn&#x27;t an existing one</span></span><br><span class="line">		<span class="comment">// associated with an expired access token.</span></span><br><span class="line">		<span class="comment">// Clients might be holding existing refresh tokens, so we re-use it in</span></span><br><span class="line">		<span class="comment">// the case that the old access token</span></span><br><span class="line">		<span class="comment">// expired.</span></span><br><span class="line">		<span class="keyword">if</span> (refreshToken == <span class="literal">null</span>) &#123;</span><br><span class="line">			refreshToken = createRefreshToken(authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// But the refresh token itself might need to be re-issued if it has</span></span><br><span class="line">		<span class="comment">// expired.</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">			<span class="type">ExpiringOAuth2RefreshToken</span> <span class="variable">expiring</span> <span class="operator">=</span> (ExpiringOAuth2RefreshToken) refreshToken;</span><br><span class="line">			<span class="keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">				refreshToken = createRefreshToken(authentication);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">OAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> createAccessToken(authentication, refreshToken);</span><br><span class="line">		tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">		<span class="comment">// In case it was modified</span></span><br><span class="line">		refreshToken = accessToken.getRefreshToken();</span><br><span class="line">		<span class="keyword">if</span> (refreshToken != <span class="literal">null</span>) &#123;</span><br><span class="line">			tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> accessToken;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Transactional(noRollbackFor=&#123;InvalidTokenException.class, InvalidGrantException.class&#125;)</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">refreshAccessToken</span><span class="params">(String refreshTokenValue, TokenRequest tokenRequest)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        ......</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> OAuth2AccessToken <span class="title function_">createAccessToken</span><span class="params">(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken)</span> &#123;</span><br><span class="line">		<span class="type">DefaultOAuth2AccessToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2AccessToken</span>(UUID.randomUUID().toString());</span><br><span class="line">		<span class="type">int</span> <span class="variable">validitySeconds</span> <span class="operator">=</span> getAccessTokenValiditySeconds(authentication.getOAuth2Request());</span><br><span class="line">		<span class="keyword">if</span> (validitySeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			token.setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + (validitySeconds * <span class="number">1000L</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		token.setRefreshToken(refreshToken);</span><br><span class="line">		token.setScope(authentication.getOAuth2Request().getScope());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果存在TokenEnhancer，那么对token进行加强</span></span><br><span class="line">		<span class="keyword">return</span> accessTokenEnhancer != <span class="literal">null</span> ? accessTokenEnhancer.enhance(token, authentication) : token;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> OAuth2RefreshToken <span class="title function_">createRefreshToken</span><span class="params">(OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isSupportRefreshToken(authentication.getOAuth2Request())) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">int</span> <span class="variable">validitySeconds</span> <span class="operator">=</span> getRefreshTokenValiditySeconds(authentication.getOAuth2Request());</span><br><span class="line">		<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">		<span class="keyword">if</span> (validitySeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultExpiringOAuth2RefreshToken</span>(value, <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()</span><br><span class="line">					+ (validitySeconds * <span class="number">1000L</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2RefreshToken</span>(value);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
如果TokenEnhancer存在，那么对OAuth2AccessToken进行加强。<strong>可以通过对TokenStore进行配置来实现OAuth2AccessToken的加强。如下。</strong><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(accessTokenConverter());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">accessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">      <span class="keyword">return</span> converter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> AuthorizationServerTokenServices <span class="title function_">tokenServices</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">      services.setClientDetailsService(clientDetailsService); <span class="comment">//客户端详情服务</span></span><br><span class="line">      services.setSupportRefreshToken(<span class="literal">true</span>); <span class="comment">//支持刷新令牌</span></span><br><span class="line">      services.setTokenStore(tokenStore); <span class="comment">//令牌的存储策略</span></span><br><span class="line">      <span class="comment">//令牌增强,设置JWT令牌</span></span><br><span class="line">      <span class="type">TokenEnhancerChain</span> <span class="variable">tokenEnhancerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenEnhancerChain</span>();</span><br><span class="line">      tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));</span><br><span class="line">      services.setTokenEnhancer(tokenEnhancerChain);</span><br><span class="line"></span><br><span class="line">      services.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">//令牌默认有效时间2小时</span></span><br><span class="line">      services.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">//刷新令牌默认有效期3天</span></span><br><span class="line">      <span class="keyword">return</span> services;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
上述代码配置了JwtAccessTokenConverter，所以使用该类中的enhance方法对OAuth2AccessToken进行加强，返回的还是OAuth2AccessToken对象。<br>加强后的OAuth2AccessToken 将原始的accessToken作为JTI，<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JwtAccessTokenConverter中的enhance方法</span></span><br><span class="line">	<span class="keyword">public</span> OAuth2AccessToken <span class="title function_">enhance</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">		<span class="type">DefaultOAuth2AccessToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2AccessToken</span>(accessToken);</span><br><span class="line">		Map&lt;String, Object&gt; info = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, Object&gt;(accessToken.getAdditionalInformation());</span><br><span class="line">		<span class="type">String</span> <span class="variable">tokenId</span> <span class="operator">=</span> result.getValue();</span><br><span class="line">		<span class="keyword">if</span> (!info.containsKey(TOKEN_ID)) &#123;</span><br><span class="line">			info.put(TOKEN_ID, tokenId);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			tokenId = (String) info.get(TOKEN_ID);</span><br><span class="line">		&#125;</span><br><span class="line">		result.setAdditionalInformation(info);</span><br><span class="line">		result.setValue(encode(result, authentication));</span><br><span class="line">		<span class="type">OAuth2RefreshToken</span> <span class="variable">refreshToken</span> <span class="operator">=</span> result.getRefreshToken();</span><br><span class="line">		<span class="keyword">if</span> (refreshToken != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">DefaultOAuth2AccessToken</span> <span class="variable">encodedRefreshToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2AccessToken</span>(accessToken);</span><br><span class="line">			encodedRefreshToken.setValue(refreshToken.getValue());</span><br><span class="line">			<span class="comment">// Refresh tokens do not expire unless explicitly of the right type</span></span><br><span class="line">			encodedRefreshToken.setExpiration(<span class="literal">null</span>);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Map&lt;String, Object&gt; claims = objectMapper</span><br><span class="line">						.parseMap(JwtHelper.decode(refreshToken.getValue()).getClaims());</span><br><span class="line">				<span class="keyword">if</span> (claims.containsKey(TOKEN_ID)) &#123;</span><br><span class="line">					encodedRefreshToken.setValue(claims.get(TOKEN_ID).toString());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">			Map&lt;String, Object&gt; refreshTokenInfo = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, Object&gt;(</span><br><span class="line">					accessToken.getAdditionalInformation());</span><br><span class="line">			refreshTokenInfo.put(TOKEN_ID, encodedRefreshToken.getValue());</span><br><span class="line">			refreshTokenInfo.put(ACCESS_TOKEN_ID, tokenId);</span><br><span class="line">			encodedRefreshToken.setAdditionalInformation(refreshTokenInfo);</span><br><span class="line">			<span class="type">DefaultOAuth2RefreshToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultOAuth2RefreshToken</span>(</span><br><span class="line">					encode(encodedRefreshToken, authentication));</span><br><span class="line">			<span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">				<span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> ((ExpiringOAuth2RefreshToken) refreshToken).getExpiration();</span><br><span class="line">				encodedRefreshToken.setExpiration(expiration);</span><br><span class="line">				token = <span class="keyword">new</span> <span class="title class_">DefaultExpiringOAuth2RefreshToken</span>(encode(encodedRefreshToken, authentication), expiration);</span><br><span class="line">			&#125;</span><br><span class="line">			result.setRefreshToken(token);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> String <span class="title function_">encode</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> &#123;</span><br><span class="line">		String content;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			content = objectMapper.formatMap(tokenConverter.convertAccessToken(accessToken, authentication));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot convert access token to JSON&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtHelper.encode(content, signer).getEncoded();</span><br><span class="line">		<span class="keyword">return</span> token;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>原始token和加强token对比</strong><br><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C12328b3e22ac4b76b25776a3a1258752.png" alt="原始token"></p>
<p><img src="/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.assets%5C1608721ffb724fb2a4412d70c909fa4d.png" alt="加强token"></p>
<p><strong>最终得到token</strong></p>
<blockquote>
<p>{<br>    “access_token”: “eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ7XCJwaG9uZVwiOlwiMTU4ODg4ODg4ODhcIixcImlkXCI6MzcsXCJlbWFpbFwiOlwibGVlLmx1c2lmZXJAZ21haWwuY29tXCIsXCJ1c2VybmFtZVwiOlwiYWRtaW5cIn0iLCJzY29wZSI6WyJST0xFX0FETUlOIl0sImV4cCI6MTU5OTYzNDUzNiwiYXV0aG9yaXRpZXMiOlsiL2NvbnRlbnRzLyIsIi9jb250ZW50cy92aWV3LyoqIiwiL3VzZXJzLyIsIi91c2Vycy91cGRhdGUvKioiLCIvY29udGVudHMvdXBkYXRlLyoqIiwiUk9MRV9hZG1pbiIsIi91c2Vycy92aWV3LyoqIiwiL3VzZXJzL2luc2VydC8qKiIsIi9jb250ZW50cy9kZWxldGUvKioiLCIvY29udGVudHMvaW5zZXJ0LyoqIiwiL3VzZXJzL2RlbGV0ZS8qKiIsIi8iXSwianRpIjoiOGM3MDExMmYtYWVlZS00MzU5LTljMGMtNTc0NWZkZDcyZmZmIiwiY2xpZW50X2lkIjoiYzEifQ.VpI5o3U2Qk80HktHuDjXdvFDIvskSiUxV0kQmJgYF_k”,<br>    “token_type”: “bearer”,<br>    “refresh_token”: “eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ7XCJwaG9uZVwiOlwiMTU4ODg4ODg4ODhcIixcImlkXCI6MzcsXCJlbWFpbFwiOlwibGVlLmx1c2lmZXJAZ21haWwuY29tXCIsXCJ1c2VybmFtZVwiOlwiYWRtaW5cIn0iLCJzY29wZSI6WyJST0xFX0FETUlOIl0sImF0aSI6IjhjNzAxMTJmLWFlZWUtNDM1OS05YzBjLTU3NDVmZGQ3MmZmZiIsImV4cCI6MTU5OTY0ODkzNiwiYXV0aG9yaXRpZXMiOlsiL2NvbnRlbnRzLyIsIi9jb250ZW50cy92aWV3LyoqIiwiL3VzZXJzLyIsIi91c2Vycy91cGRhdGUvKioiLCIvY29udGVudHMvdXBkYXRlLyoqIiwiUk9MRV9hZG1pbiIsIi91c2Vycy92aWV3LyoqIiwiL3VzZXJzL2luc2VydC8qKiIsIi9jb250ZW50cy9kZWxldGUvKioiLCIvY29udGVudHMvaW5zZXJ0LyoqIiwiL3VzZXJzL2RlbGV0ZS8qKiIsIi8iXSwianRpIjoiNDA0MmM3YzMtMDFiMi00ZjE2LWJlODktNTA2YWRhMDIwODM0IiwiY2xpZW50X2lkIjoiYzEifQ.myCOpcWbLmxE_jVEzKDwVLFpK8OizCet56lqCMSCIW8”,<br>    “expires_in”: 3044,<br>    “scope”: “ROLE_ADMIN”,<br>    “jti”: “8c70112f-aeee-4359-9c0c-5745fdd72fff”<br>}</p>
</blockquote>
<br>
密码模式最终是在DefaultTokenServices类的createAccessToken方法中生成token和refreshToken，最终返回OAuth2AccessToken对象。
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">http://example.com/2023/05/06/Oauth2/Oauth2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/Python/Python%E7%88%AC%E8%99%ABSelenium(encode%E5%92%8Cdecode%E6%B2%A1%E6%90%9E%E6%87%82)/" title="Python爬虫Selenium(encode和decode没搞懂)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python爬虫Selenium(encode和decode没搞懂)</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/Python/Python%E7%88%AC%E5%8F%96%E7%99%BE%E5%BA%A6%E5%9B%BE%E5%BA%93%E5%92%8C%E4%B8%8A%E4%BC%A0%E7%99%BE%E5%BA%A6%E5%9B%BE%E5%BA%93/" title="Python爬取百度图库和上传百度图库"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python爬取百度图库和上传百度图库</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">二、授权码模式源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82-x2F-oauth-x2F-authorize"><span class="toc-number">1.0.1.</span> <span class="toc-text">2.1 第一次请求&#x2F;oauth&#x2F;authorize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-ExceptionTranslationFilter"><span class="toc-number">1.0.2.</span> <span class="toc-text">2.2 ExceptionTranslationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-requestCache-saveRequest-request-response"><span class="toc-number">1.0.3.</span> <span class="toc-text">2.3 requestCache.saveRequest(request,response)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0-x2F-login"><span class="toc-number">1.0.4.</span> <span class="toc-text">2.4 重定向到&#x2F;login</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AF%B7%E6%B1%82-x2F-oauth-x2F-authorize"><span class="toc-number">1.0.5.</span> <span class="toc-text">2.5 第二次请求&#x2F;oauth&#x2F;authorize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-client%E6%8E%A5%E6%94%B6code%E5%B9%B6%E5%90%91oauth-server%E8%AF%B7%E6%B1%82-x2F-oauth-x2F-token"><span class="toc-number">1.0.6.</span> <span class="toc-text">2.6 client接收code并向oauth server请求&#x2F;oauth&#x2F;token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-TokenEndPoint%E7%94%9F%E6%88%90access-token"><span class="toc-number">1.0.7.</span> <span class="toc-text">2.7 TokenEndPoint生成access_token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.</span> <span class="toc-text">3 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%AE%BF%E9%97%AE-x2F-oauth-x2F-token"><span class="toc-number">1.2.</span> <span class="toc-text">1.访问&#x2F;oauth&#x2F;token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-parameters"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 parameters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Basic-Auth"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 Basic Auth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-access-token%E6%94%BE%E5%9C%A8parameter%E4%B8%AD"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.1 access_token放在parameter中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AE%BF%E9%97%AE-x2F-oauth-x2F-check-token"><span class="toc-number">1.3.</span> <span class="toc-text">3. 访问&#x2F;oauth&#x2F;check_token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AEResouceServer"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 配置ResouceServer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TokenEndpoint"><span class="toc-number">1.3.2.</span> <span class="toc-text">TokenEndpoint</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>