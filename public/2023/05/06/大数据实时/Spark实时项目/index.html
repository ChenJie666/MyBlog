<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Spark实时项目 | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="离线处理：有界的批处理实时处理：无界的流处理  从kafka到hdfs中的flume的作业：可以直接从kafka中读取数据导入到hdfs中，不用自己写消费者然后将消费的数据上传到hdfs中。  从mysql导入到hdfs中一般使用sqoop，但是sqoop底层基于MR，速度较慢；因此可以用spark&#x2F;flink自己写代码进行导入导出。  web app微服务：将数据库中的数据查询出来，写一个web">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark实时项目">
<meta property="og:url" content="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Spark%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="离线处理：有界的批处理实时处理：无界的流处理  从kafka到hdfs中的flume的作业：可以直接从kafka中读取数据导入到hdfs中，不用自己写消费者然后将消费的数据上传到hdfs中。  从mysql导入到hdfs中一般使用sqoop，但是sqoop底层基于MR，速度较慢；因此可以用spark&#x2F;flink自己写代码进行导入导出。  web app微服务：将数据库中的数据查询出来，写一个web">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.051Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.051Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Spark%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spark实时项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spark实时项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.051Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.051Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/">大数据实时</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spark实时项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>离线处理：有界的批处理<br>实时处理：无界的流处理</p>
<p><img src="F:/Typora/图片/1565573300066.png" alt="1565573300066"></p>
<pre><code>从kafka到hdfs中的flume的作业：可以直接从kafka中读取数据导入到hdfs中，不用自己写消费者然后将消费的数据上传到hdfs中。

从mysql导入到hdfs中一般使用sqoop，但是sqoop底层基于MR，速度较慢；因此可以用spark/flink自己写代码进行导入导出。

web app微服务：将数据库中的数据查询出来，写一个web app，可以通过web请求来调用数据库中的数据。请求为http://url , 查询结果以json数组返回。
</code></pre>
<p><img src="F:/Typora/图片/1565573307329.png" alt="1565573307329"></p>
<pre><code>sparkStreaming用于清洗、转换、计算、聚合，转化之后的数据量比较大，一般存储到redis、es和hbase中。

phoenix为hbase提供sql语言可查询的功能；会写springmvc；

canal可以从mysql中实时读取数据（模拟mysql的从机发送dump请求）
</code></pre>
<p>实时：1.模拟日志2.1搭建日志采集集群2.2利用canal采集mysql中的数据发送到kafka中3.消费kafka中的数据4.把数据保存到对应的存储容器5.查询存储容器中的数据发布成web接口。</p>
<p>maven的三种关系：<br>①依赖关系：依赖于模块的jar<br>②继承关系：继承pom.xml<br>③聚合关系：有相同的生命周期，module中填写的就是有聚合关系的模块；如果该模块进行打包，其他也会打包<img src="F:/Typora/图片/1565604998324-1566143759939.png" alt="1565604998324"></p>
<p><strong>Spring</strong><br>　　Spring就像是整个项目中装配bean的大工厂，在配置文件中可以指定使用特定的参数去调用实体类的构造方法来实例化对象。也可以称之为项目中的粘合剂。<br>　　Spring的核心思想是IoC（控制反转），即不再需要程序员去显式地<code>new</code>一个对象，而是让Spring框架帮你来完成这一切。<br><strong>SpringMVC</strong><br>　　SpringMVC在项目中拦截用户请求，它的核心Servlet即DispatcherServlet承担中介或是前台这样的职责，将用户请求通过HandlerMapping去匹配Controller，Controller就是具体对应请求所执行的操作。SpringMVC相当于SSH框架中struts。<br><strong>mybatis</strong><br>　　mybatis是对jdbc的封装，它让数据库底层操作变的透明。mybatis的操作都是围绕一个sqlSessionFactory实例展开的。mybatis通过配置文件关联到各实体类的Mapper文件，Mapper文件中配置了每个类对数据库所需进行的sql语句映射。在每次与数据库交互时，通过sqlSessionFactory拿到一个sqlSession，再执行sql命令。</p>
<p><strong>springBoot</strong></p>
<pre><code>①将spring和springMVC整合到一起，将参数配置完成，约定大于配置大于代码；
②springBoot内部集合Tomcat；springBoot整合配置第三方软件，**spring web starter包**整合了（tomcat、mysql、redis,elasticsearch,dubbo,kafka）等第三方工具；
③只需要配置application.properties文件或application.yml文件。
</code></pre>
<p>jar  war  pom工程</p>
<p>400   （错误请求）服务器不理解请求的语法。<br>403   （禁止）服务器拒绝请求。<br>500   （服务器内部错误）  服务器遇到错误，无法完成请求。<br>503   （服务不可用）服务器目前无法使用<br>200   （成功）  服务器已成功处理了请求</p>
<p>lombok能通过注解的方式,在编译时自动为属性生成构造器、getter&#x2F;setter、equals、hashcode、toString方法</p>
<p>80端口是服务器的缺省端口，省略则为80端口。springboot中可以在配置文件中修改。</p>
<p>system.out和system.err区别是打印的颜色不同，黑和红</p>
<p>linux不允许非root用户使用1024一下的端口。<br>sudo setcap cap_net_bind_service&#x3D;+eip &#x2F;bigdata&#x2F;nginx&#x2F;sbin&#x2F;nginx  可以使nginx绕过端口的限制</p>
<p>项目中的注释<br>①@ResponseBody<br>②@Controller		@Controller+@ResponseBody简写为@RestController<br>③@SpringBootApplication	@Configuration（标识这个类可以使用Spring IoC容器作为bean定义的来源）+@EnableAutoConfiguration（能够自动配置spring的上下文，试图猜测和配置你想要的bean类）+@ComponentScan（会自动扫描指定包下的全部标有@Component的类，并注册成bean）也可以指定扫描的类<br>④@postMapping(“log”) 和 @RequestMapping(name&#x3D;”&#x2F;log”,method&#x3D;RequestMethod.POST) 效果相同，即接收post请求；如果url文件名为log，则调用方法并返回方法的返回值。<br>⑤@ResponseBody	不将方法的返回值当作url，而是当作一个字符串。一般和@postMapping(“log”)一起使用。<br>⑥@Slf4j	（Simple Logging Facade for Java）SLF4J，即简单日志门面，只服务于各种各样的日志系统。如果采用lombok的@Slf4j注释，可以直接写log，会自动生成Slf4j对象–log。log.info(“…”)会根据resourses中的配置信息进行打印输出（可以在任意多个地方输出，如文件中或控制台中）。<br>⑦@RequestParam 用于将指定的请求参数赋值给方法中的形参。即将请求头或请求体中的k对应的v赋值给方法中的形参。<br>⑧@Autowired 注释,它可以对类成员变量、方法及构造函数进行标注,完成自动装配的工作</p>
<p>log4j<br>logback<br>logging：springboot内置的log工具，如果想要使用log4j中的配置进行打印，需要将logging禁用（pom文件中exclusion属性中加入logging）<br>日志级别：trace、debug、info、warn、error、fatal、</p>
<p>lombok注释：<br>①@Data	&#x2F;&#x2F;生成Getter 和 ToString<br>②@AllArgsConstructor  &#x2F;&#x2F;生成构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">通过url向服务器发送请求：</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogUploader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendLogStream</span><span class="params">(String log)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//不同的日志类型对应不同的URL</span></span><br><span class="line"></span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span>  <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://logserver:8080/log&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">            <span class="comment">//设置请求方式为post</span></span><br><span class="line">            conn.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//时间头用来供server进行时钟校对的</span></span><br><span class="line">            conn.setRequestProperty(<span class="string">&quot;clientTime&quot;</span>,System.currentTimeMillis() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">//允许上传数据</span></span><br><span class="line">            conn.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//设置请求的头信息,设置内容类型为JSON</span></span><br><span class="line">            conn.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;upload&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//输出流</span></span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> conn.getOutputStream();</span><br><span class="line">            out.write((<span class="string">&quot;logString=&quot;</span>+log).getBytes());</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">            <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> conn.getResponseCode();<span class="comment">//返回的状态码</span></span><br><span class="line">            System.out.println(code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*向kafka发送数据，用到springboot框架，springboot整合kafka，直接通过kafkaTemplate类发送，信息在application.properties中配置*/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    KafkaTemplate&lt;String,String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @ResponseBody</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;log&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">dolog</span><span class="params">(<span class="meta">@RequestParam(&quot;logString&quot;)</span> String json)</span>&#123;</span><br><span class="line">        <span class="comment">//1.补充时间戳</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;ts&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        <span class="comment">//2.写日志（用于离线采集）</span></span><br><span class="line">        log.info(jsonObject.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.发往kafka</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;startup&quot;</span>.equals(jsonObject.get(<span class="string">&quot;type&quot;</span>))) &#123;</span><br><span class="line">            kafkaTemplate.send(GmallConstants.KAFKA_TOPIC_STARTUP, jsonObject.toJSONString());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            kafkaTemplate.send(GmallConstants.KAFKA_TOPIC_EVENT, jsonObject.toJSONString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加log4j.properties</span></span><br><span class="line">log4j.appender.atguigu.MyConsole=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.atguigu.MyConsole.target=System.err</span><br><span class="line">log4j.appender.atguigu.MyConsole.layout=org.apache.log4j.PatternLayout    </span><br><span class="line">log4j.appender.atguigu.MyConsole.layout.ConversionPattern=%d&#123;yyyy-MM-dd HH:mm:ss&#125; %10p (%c:%M) - %m%n </span><br><span class="line"></span><br><span class="line">log4j.appender.atguigu.File=org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.atguigu.File.file=d:/applog/gmall2019/log/app.log</span><br><span class="line">log4j.appender.atguigu.File.DatePattern=<span class="string">&#x27;.&#x27;</span>yyyy-MM-dd</span><br><span class="line">log4j.appender.atguigu.File.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.atguigu.File.layout.ConversionPattern=%m%n</span><br><span class="line"></span><br><span class="line">log4j.logger.com.atguigu.xxxxxx.XXXXcontroller=info,atguigu.File,atguigu.MyConsole</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取.properties中的值</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PropertiesUtil</span> </span>&#123; 	</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> properties: <span class="type">Properties</span> = <span class="type">PropertiesUtil</span>.load(<span class="string">&quot;config.properties&quot;</span>)</span><br><span class="line">    println(properties.get(<span class="string">&quot;kafka.broker.list&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">load</span></span>(propertieName:<span class="type">String</span>): <span class="type">Properties</span> =&#123;</span><br><span class="line">    <span class="keyword">val</span> properties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    <span class="keyword">val</span> reader = <span class="keyword">new</span> <span class="type">InputStreamReader</span>(<span class="type">Thread</span>.currentThread().getContextClassLoader.getResourceAsStream(propertieName), <span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line">    properties.load(reader)</span><br><span class="line">    properties</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取kafka的DStream</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MykafkaUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> properties: <span class="type">Properties</span> = <span class="type">PropertiesUtil</span>.load(<span class="string">&quot;config.properties&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> kafka_list: <span class="type">String</span> = properties.getProperty(<span class="string">&quot;kafka.broker.list&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> kafkaParam = <span class="type">Map</span>(</span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">BOOTSTRAP_SERVERS_CONFIG</span> -&gt; kafka_list,</span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">KEY_DESERIALIZER_CLASS_CONFIG</span> -&gt; classOf[org.apache.kafka.common.serialization.<span class="type">StringDeserializer</span>],</span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">VALUE_DESERIALIZER_CLASS_CONFIG</span> -&gt; classOf[org.apache.kafka.common.serialization.<span class="type">StringDeserializer</span>],</span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">GROUP_ID_CONFIG</span> -&gt; <span class="string">&quot;Spark_kafka&quot;</span>,</span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">ENABLE_AUTO_COMMIT_CONFIG</span> -&gt; (<span class="literal">true</span>:java.lang.<span class="type">Boolean</span>), <span class="comment">//scala中的true默认为AnyVal类型的，而下面需要填入object类型的，所以要指定java类型的true</span></span><br><span class="line">    <span class="type">ConsumerConfig</span>.<span class="type">AUTO_OFFSET_RESET_CONFIG</span> -&gt; <span class="string">&quot;latest&quot;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getKafkaStream</span></span>(topic: <span class="type">String</span>, ssc: <span class="type">StreamingContext</span>): <span class="type">InputDStream</span>[<span class="type">ConsumerRecord</span>[<span class="type">String</span>, <span class="type">String</span>]] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputDS: <span class="type">InputDStream</span>[<span class="type">ConsumerRecord</span>[<span class="type">String</span>, <span class="type">String</span>]] = <span class="type">KafkaUtils</span>.createDirectStream[<span class="type">String</span>, <span class="type">String</span>](ssc, <span class="type">LocationStrategies</span>.<span class="type">PreferConsistent</span>, <span class="type">ConsumerStrategies</span>.<span class="type">Subscribe</span>[<span class="type">String</span>, <span class="type">String</span>](<span class="type">Array</span>(topic), kafkaParam))</span><br><span class="line">    inputDS</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//求日活，对mid进行去重，然后写入到hbase中（phoenix）</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DauApp</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;kafka&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf,<span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputDS: <span class="type">InputDStream</span>[<span class="type">ConsumerRecord</span>[<span class="type">String</span>, <span class="type">String</span>]] = <span class="type">MykafkaUtil</span>.getKafkaStream(<span class="type">GmallConstants</span>.<span class="type">KAFKA_TOPIC_STARTUP</span>,ssc)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> valueDS: <span class="type">DStream</span>[<span class="type">String</span>] = inputDS.map(cr =&gt; cr.value())</span><br><span class="line"><span class="comment">//    value.print()</span></span><br><span class="line">    <span class="comment">//转换为样例类</span></span><br><span class="line">    <span class="keyword">val</span> objDS: <span class="type">DStream</span>[<span class="type">StartupLog</span>] = valueDS.map &#123;</span><br><span class="line">      json =&gt;</span><br><span class="line">        <span class="keyword">val</span> startupLog = <span class="type">JSON</span>.parseObject(json, classOf[<span class="type">StartupLog</span>])</span><br><span class="line">        <span class="keyword">val</span> str: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH&quot;</span>).format(startupLog.ts)</span><br><span class="line">        <span class="keyword">val</span> split: <span class="type">Array</span>[<span class="type">String</span>] = str.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        startupLog.logDate = split(<span class="number">0</span>)</span><br><span class="line">        startupLog.logHour = split(<span class="number">1</span>)</span><br><span class="line">        startupLog</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    objDS.cache() <span class="comment">//防止本次处理未完成，下次数据到达，导致的线程安全问题</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//对批次中的数据进行过滤</span></span><br><span class="line">    <span class="keyword">val</span> groupDS: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Iterable</span>[<span class="type">StartupLog</span>])] = objDS.map &#123;</span><br><span class="line">      obj =&gt; (obj.mid, obj)</span><br><span class="line">    &#125;.groupByKey()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> takeDS: <span class="type">DStream</span>[<span class="type">StartupLog</span>] = groupDS.flatMap &#123;</span><br><span class="line">      <span class="keyword">case</span> (mid, iter) =&gt; iter.take(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//对批次间的数据进行过滤</span></span><br><span class="line">    <span class="keyword">val</span> filterDS: <span class="type">DStream</span>[<span class="type">StartupLog</span>] = takeDS.transform &#123;</span><br><span class="line">      rdd =&gt;</span><br><span class="line">        println(<span class="string">&quot;批次间过滤前数量为&quot;</span> + rdd.count())</span><br><span class="line">        <span class="keyword">val</span> jedis = <span class="keyword">new</span> <span class="type">Jedis</span>(<span class="string">&quot;hadoop102&quot;</span>, <span class="number">6379</span>)</span><br><span class="line">        <span class="keyword">val</span> date: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>).format(<span class="keyword">new</span> <span class="type">Date</span>())</span><br><span class="line">        <span class="keyword">val</span> set: util.<span class="type">Set</span>[<span class="type">String</span>] = jedis.smembers(date)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> broadcast: <span class="type">Broadcast</span>[util.<span class="type">Set</span>[<span class="type">String</span>]] = ssc.sparkContext.broadcast(set)</span><br><span class="line">        <span class="keyword">val</span> filterRDD: <span class="type">RDD</span>[<span class="type">StartupLog</span>] = rdd.filter &#123;</span><br><span class="line">          obj =&gt; !broadcast.value.contains(obj.mid)</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;批次间过滤后数量为&quot;</span> + filterRDD.count())</span><br><span class="line">        filterRDD</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新redis上的数据</span></span><br><span class="line">    filterDS.foreachRDD&#123;</span><br><span class="line">      rdd =&gt; rdd.foreachPartition&#123;</span><br><span class="line">        iter =&gt;</span><br><span class="line">          <span class="keyword">val</span> list: <span class="type">List</span>[<span class="type">StartupLog</span>] = iter.toList</span><br><span class="line">          <span class="keyword">val</span> jedis = <span class="keyword">new</span> <span class="type">Jedis</span>(<span class="string">&quot;hadoop102&quot;</span>, <span class="number">6379</span>)</span><br><span class="line">          list.foreach&#123;obj =&gt;</span><br><span class="line">            jedis.sadd(obj.logDate,obj.mid)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filterDS.print()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> org.apache.phoenix.spark._</span><br><span class="line"></span><br><span class="line">    filterDS.foreachRDD&#123;</span><br><span class="line">      rdd =&gt; rdd.saveToPhoenix(</span><br><span class="line">        <span class="string">&quot;gmall0311_dau&quot;</span>,</span><br><span class="line">        <span class="type">Seq</span>(<span class="string">&quot;MID&quot;</span>, <span class="string">&quot;UID&quot;</span>, <span class="string">&quot;APPID&quot;</span>, <span class="string">&quot;AREA&quot;</span>, <span class="string">&quot;OS&quot;</span>, <span class="string">&quot;CH&quot;</span>, <span class="string">&quot;TYPE&quot;</span>, <span class="string">&quot;VS&quot;</span>, <span class="string">&quot;LOGDATE&quot;</span>, <span class="string">&quot;LOGHOUR&quot;</span>, <span class="string">&quot;TS&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="type">Configuration</span>,</span><br><span class="line">        <span class="type">Some</span>(<span class="string">&quot;hadoop102,hadoop103,hadoop104:2181&quot;</span>)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ssc.start()</span><br><span class="line">    println(<span class="string">&quot;启动流程&quot;</span>)</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>enable.auto.commit : kafka的offset自动提交，可能会导致数据？？？；可以自己维护一个offset的存储。</p>
<p>log4j.properties中的类名替换为rootLogger，表示所有的类都打印。</p>
<p>hbase、mysql、es和redis集群用于存储数据。</p>
<p>ls &#x2F;brokers&#x2F;ids 如果zk不正常关闭导致无法启动kafka，删除zk客户端中的ids</p>
<p>cache  多线程安全  </p>
<p>es	①数据量相对小一点，1T一下②支持单表复杂查询，不建议进行join③全文检索④kibana  bi工具<br>hbase   ①数据量大，1T以上用（hdfs支持）②原生的hbase不利于分析，查询手段单一（get和scan），所以整合phoenix框架，phoenix好处 1.支持sql，复杂查询（过滤、聚合、join）2.二级索引 ？？。</p>
<p>phoenix的索引相当于一列rowkey</p>
<p>全局索引   查询语句中的select设计的字段 必须包含在索引中   或者在 索引的include中</p>
<p>全局索引和本地索引：全局索引管理所有表的索引信息，当索引需要更新时，可能会有网络传输 ；<br>本地索引存储在表中，当表进行更新时，索引更新不需要网络传输。<br>所以全局索引适合多读少些（面向事务），本地索引适合少读多写（面向分析）；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> &quot;TABLE_03111&quot;</span><br><span class="line">upsert <span class="keyword">into</span> &quot;TABLE_03111&quot; <span class="keyword">values</span>(<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;lisi&#x27;</span>,<span class="string">&#x27;19&#x27;</span>)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>创建主键索引</span><br><span class="line"><span class="keyword">create</span> index my_index1 <span class="keyword">on</span> TABLE_03111(&quot;id&quot;)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>创建全局索引</span><br><span class="line"><span class="keyword">create</span> index my_index2 <span class="keyword">on</span> TABLE_03111(&quot;info&quot;.&quot;name&quot;)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>删除索引</span><br><span class="line"><span class="keyword">drop</span> index my_index2 <span class="keyword">on</span> &quot;TABLE_03111&quot;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>创建全局索引</span><br><span class="line"><span class="keyword">create</span> index my_index3 <span class="keyword">on</span> &quot;TABLE_03111&quot;(&quot;info&quot;.&quot;name&quot;) include(&quot;info&quot;.&quot;age&quot;)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>查看执行是是否用到索引</span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> &quot;TABLE_03111&quot; <span class="keyword">where</span> &quot;id&quot;<span class="operator">=</span><span class="string">&#x27;2&#x27;</span></span><br><span class="line">explain <span class="keyword">select</span> &quot;age&quot; <span class="keyword">FROM</span>  &quot;TABLE_03111&quot; <span class="keyword">where</span> &quot;name&quot;<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>创建本地索引</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">local</span> index my_index4 <span class="keyword">on</span> &quot;TABLE_03111&quot;(&quot;info&quot;.&quot;name&quot;) </span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> &quot;TABLE_03111&quot; <span class="keyword">where</span> &quot;name&quot;<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span></span><br></pre></td></tr></table></figure>



<p>controller  控制 发布web接口或页面<br>service 业务 处理业务逻辑<br>dao 数据 查询后台数据</p>
<p>mapper（即dao层）  mybatis查询数据库 映射成java对象 </p>
<p>guava是google工具包；org.apache.common.lang3是apache的工具包（里面有好用的DateUtils类处理时间）DateUtils.addDays(date, -1)</p>
<p>查看mysql是否开启binlog。mysql配置文件中&#x2F;etc&#x2F;my.conf中log-bin&#x3D;mysql-bin , mysql的数据目录在&#x2F;var&#x2F;lib&#x2F;mysql中的mysql-bin文件就是binlog文件。每次mysql服务的开启都会产生一个binlog文件。</p>
<p>模版在 &#x2F;usr&#x2F;share&#x2F;mysql</p>
<p>binlog_format：</p>
<pre><code>statement  语句级	记录执行的语句，但可能会造成数据不一致。
row 行级	记录变化后的数据，但是会造成数据的冗余。canal用row，因为只关心改变的数据。
mixed 混合	一些内定的特殊情况使用row，其他情况使用statement。主从复制用mixed。
</code></pre>
<p>老师提供的脚本文件生成数据指令：<br>CALL init_data(‘2019-08-14’，100 , 2 , true)  参数为日期、订单数、用户数、是否覆盖<br>CALL insert_user(“2019-08-18”,5,TRUE)	插入用户</p>
<p>(视频day03_4 )canal基本结构:<img src="F:/Typora/图片/canal.PNG" alt="canal"></p>
<pre><code>canal分为客户端和服务端，服务端有一个总的配置文件和多个instance配置文件；每个instance配置文件对应一个mysql集群，所以一个canal可以监控多个mysql集群。每个instance将读取的数据放置在相互独立的队列中，客户端可以随时进行消费。
canal的客户端是一个jar包，可以在java端调用API启动，client会主动从canal中拉取数据。
</code></pre>
<p>练习：增加一个额外的字段，是否是首次消费</p>
<p>14:35</p>
<p>DStream如果是（k，v）结构，可以使用groupByKey。</p>
<p>kibana</p>
<p><a target="_blank" rel="noopener" href="http://hadoop102:9200/_cat/health?v">http://hadoop102:9200/_cat/health?v</a> 查看集群的健康状况，“？v”可以规范输出格式</p>
<h2 id="灵活查询：ES数据的读取"><a href="#灵活查询：ES数据的读取" class="headerlink" title="灵活查询：ES数据的读取"></a>灵活查询：ES数据的读取</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">GET		</span><br><span class="line">POST	相当于insert update		和幂等性有关</span><br><span class="line">PUT		相当于create</span><br><span class="line">DELETE	</span><br><span class="line">Head</span><br><span class="line"></span><br><span class="line">GET _cat/nodes?v</span><br><span class="line">GET _cat/indices?v	查所有的索引</span><br><span class="line"></span><br><span class="line">mysql			elasticsearch</span><br><span class="line">datebase		index			相当于一个db对应一个table			</span><br><span class="line">table			type			index（type=&#x27;_doc&#x27;）</span><br><span class="line">row				document		</span><br><span class="line">column			field		</span><br><span class="line"></span><br><span class="line">es中把定义index中描述每个字段的信息（字段名，字段类型。。） 称为mapping</span><br><span class="line"></span><br><span class="line">没有先建索引，而是直接插入数据，则会自动进行类型推断。整数推断为long，浮点数推断为float，字符串推断为TEXT类型，同时自动生成该字段的子字段keyword，类型为keyword，主字段和子字段都可以存储数据。</span><br><span class="line">PUT customer0311/doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;zhangsan&quot;,</span><br><span class="line">    &quot;age&quot;:22</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">在ES 上建索引</span><br><span class="line">PUT gmall_coupon_alert</span><br><span class="line">&#123;</span><br><span class="line">   &quot;mappings&quot;: &#123;</span><br><span class="line">     &quot;_doc&quot;:&#123;</span><br><span class="line">       &quot;properties&quot;:&#123;</span><br><span class="line">         &quot;mid&quot;:&#123;</span><br><span class="line">           &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;uids&quot;:&#123;</span><br><span class="line">           &quot;type&quot;:&quot;keyword&quot;	//HashSet存入后，会转化为字符串形式</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;itemIds&quot;:&#123;</span><br><span class="line">           &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;events&quot;:&#123;</span><br><span class="line">           &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">        &quot;ts&quot;:&#123;</span><br><span class="line">           &quot;type&quot;:&quot;date&quot;</span><br><span class="line">         &#125; </span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">查看创建的表的表结构</span><br><span class="line">get gmall_coupon_alert/_mapping</span><br><span class="line"></span><br><span class="line">#字符串类型  text\ keyword</span><br><span class="line">text：会进行分词，每个分词建索引消耗大量空间</span><br><span class="line">keyword：不会进行分词，只建一个索引</span><br><span class="line"></span><br><span class="line">对表进行检索，会对字段分词，只要zhang或san匹配上，就命中</span><br><span class="line">GET customer0311/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;customer_name&quot;:&quot;zhang san&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">也是全文检索，加上keyword后不分词，必须”zhang san“完全匹配上才命中</span><br><span class="line">GET customer0311/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;customer_name.keyword&quot;:&quot;zhang san&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">检查分词器：</span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;我是中国人&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询条件中既有匹配又有过滤时用bool；</span><br><span class="line">term表示按照字段进行搜索；</span><br><span class="line">&quot;operator&quot;:&quot;and&quot;表示字段之间时并且关系，即都要匹配上；</span><br><span class="line">aggs用于将属性进行聚合，AGG_TYPE表示聚合的方法，如sum、avg、max、terms等等，terms就是groupby，以field进行聚合，分为size组；</span><br><span class="line">from是行码，从零开始计算，size是从指定行开始显示的数据数；假设用户给的页码为n，(n-1)*size即是该页的起始行号。</span><br><span class="line"></span><br><span class="line">//es的过滤、查找，分组聚合，分页输出</span><br><span class="line">GET gmall0311_sale_detail/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;bool&quot;:&#123;</span><br><span class="line">      &quot;filter&quot;:&#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;dt&quot;:&quot;2019-08-20&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">          &quot;sku_name&quot;: &#123;</span><br><span class="line">            &quot;query&quot;:&quot;小米wifi&quot;,</span><br><span class="line">            &quot;operator&quot;:&quot;and&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  , </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;groupbygender&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;user_gender&quot;,</span><br><span class="line">        &quot;size&quot;: 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ,</span><br><span class="line">    &quot;groupbyage&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;user_age&quot;,</span><br><span class="line">        &quot;size&quot;:100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  &quot;from&quot;: 3,	##这是第二页的第一行</span><br><span class="line">  &quot;size&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>ES和spark不像phoenix和spark有一个整合包，需要我们自己编写逻辑写入到ES中。导入jest依赖，jest--&gt;elasticsearch  类似  jedis--&gt;redis。

indexName、type、id、source；即表名、type（_doc）、id（主键）、数据
</code></pre>
<p>fastjson解析不了样例类：<br>val orderJson: String &#x3D; JSON.toJSONString(orderOpt.get)会报错<br>用json4s包中的方法，导入json4s包和隐式转换：<br>import org.json4s.jackson.Serialization<br>implicit val formats &#x3D; org.json4s.DefaultFormats<br>val orderSer: String &#x3D; Serialization.write(orderOpt.get) 获得json字符串</p>
<p><strong>import</strong> collection.JavaConversions._	将java的集合隐式转换为scala的集合</p>
<p>kibana的dashboard表可以进行share-embodycode-saved object，确认copy iFrame code（可以在html代码中的一个内嵌的区域引用第三方app）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;iframe src=......&gt;&lt;iframe&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">用网页打开该html格式的文件即可</span><br></pre></td></tr></table></figure>





<h1 id="项目流程："><a href="#项目流程：" class="headerlink" title="项目流程："></a>项目流程：</h1><p>sparkstreaming 可以用于清洗、转换、计算、聚合。</p>
<p>数据源：</p>
<h3 id="需求一-日活（dau）："><a href="#需求一-日活（dau）：" class="headerlink" title="需求一   日活（dau）："></a>需求一   日活（dau）：</h3><p>本框架中没有使用flume，从日志服务器直接将数据发给kafka；分为type：startup和type：event两种类型发给不同的topic。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">工具类准备：</span><br><span class="line">创建从配置文件中读取数据的工具类，用于kafka和redis的配置参数获取。</span><br><span class="line">创建从kafka读取数据的工具类，用于spark读取kafka中的数据。</span><br><span class="line">创建获取redis连接池的工具类，用于获取redis客户端jedis对象。</span><br><span class="line"></span><br><span class="line">样例类准备：</span><br><span class="line">创建样例类用于将kafka中读取到的数据进行封装。</span><br></pre></td></tr></table></figure>

<p><strong>objDS.cache() &#x2F;&#x2F;防止本次处理未完成，下次数据到达，导致的线程安全问题</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">日活（dau）——需求实现：</span><br><span class="line"><span class="number">1.</span>通过工具类从kafka中读取数据</span><br><span class="line"><span class="number">2.</span>对相同的mid进行去重   </span><br><span class="line">要点：通过redis进行去重。如果存为string类型（日期和mid拼成key），不会造成数据倾斜，如果存为set类型（日期作为key，mid为value），可能造成数据倾斜，但是管理方便（设置过期等）。</span><br><span class="line">去重过程：通过transform算子（每个流都会执行一次）获取redis中的当天用户的set集合，广播给各个executor，再利用filter算子过滤set集合中存在的mid，返回过滤后的rdd；然后再对该批次内的数据进行去重（以mid进行分组获取每组第一个数据的mid）。</span><br><span class="line"><span class="number">3.</span>将该批次的新增的数据写入到redis中。</span><br><span class="line"><span class="number">4.</span>也需要将该批次的数据写入hbase+phoenix中。(实时不用hive进行数据处理，用到高效的<span class="type">HBase</span>或<span class="type">ES</span>框架进行处理)</span><br><span class="line">要点：<span class="type">HBase</span>通过<span class="type">Phoenix</span>框架进行交互</span><br><span class="line"><span class="keyword">import</span> org.apache.phoenix.spark._</span><br><span class="line">distictDstream.foreachRDD&#123;rdd=&gt;</span><br><span class="line">  rdd.saveToPhoenix(<span class="string">&quot;GMALL2019_DAU&quot;</span>,<span class="type">Seq</span>(<span class="string">&quot;MID&quot;</span>, <span class="string">&quot;UID&quot;</span>, <span class="string">&quot;APPID&quot;</span>, <span class="string">&quot;AREA&quot;</span>, <span class="string">&quot;OS&quot;</span>, <span class="string">&quot;CH&quot;</span>, <span class="string">&quot;TYPE&quot;</span>, <span class="string">&quot;VS&quot;</span>, <span class="string">&quot;LOGDATE&quot;</span>, <span class="string">&quot;LOGHOUR&quot;</span>, <span class="string">&quot;TS&quot;</span>) ,<span class="keyword">new</span> <span class="type">Configuration</span>,<span class="type">Some</span>(<span class="string">&quot;hadoop1,hadoop2,hadoop3:2181&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>需要自己写一个微服务框架springboot(<span class="number">1.5</span>)，供可视化组进行数据拉取并实时展示。</span><br><span class="line">用到<span class="type">Spring</span> <span class="type">Web</span> <span class="type">Starter</span>（springboot框架）、lombok（自动生成get/set、toString、构造器等方法）、<span class="type">JDBC</span> <span class="type">API</span>、用到<span class="type">MyBatis</span> <span class="type">Framework</span>（在配置文件中写sql，查询结果自动放到集合中）</span><br><span class="line">分层：</span><br><span class="line">controller	 控制 发布web接口或页面</span><br><span class="line">service 	业务 处理业务逻辑</span><br><span class="line">dao			数据 查询后台数据</span><br><span class="line"></span><br><span class="line">mapper		mybatis查询数据库 映射成java的对象</span><br><span class="line"></span><br><span class="line">返回的是json格式，可以先放入map集合中，然后通过<span class="type">FastJson</span>的toJsonString方法转为json字符串。</span><br></pre></td></tr></table></figure>

<p><img src="F:/Typora/图片/1568454136288.png" alt="1568454136288"></p>
<h3 id="需求二-交易额（gmv）："><a href="#需求二-交易额（gmv）：" class="headerlink" title="需求二   交易额（gmv）："></a>需求二   交易额（gmv）：</h3><p>canal：用于监控mysql中的表的变化，将变化的数据放到临时表中。进行实时统计。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">工具类准备：</span><br><span class="line"><span class="number">1.</span>canal处理类：包括构造方法，canal数据的解析方法，解析后数据发送给kafka的方法</span><br><span class="line">要点：canal得到的数据是entry对象，相当于一条sql；反序列化后得到<span class="type">RowChange</span> -&gt; 多个<span class="type">RowDataList</span>组成 -&gt; 多个<span class="type">RowData</span>组成 -&gt; <span class="type">ColumnList</span> -&gt; <span class="type">Column</span> -&gt; <span class="type">Column_Name</span>,<span class="type">Column_Value</span></span><br><span class="line"><span class="number">2.</span>kafka发送工具类：将数据发送给kafka，在canal处理类中调用。</span><br><span class="line"><span class="number">3.</span>client客户端：</span><br><span class="line"><span class="type">CanalConnector</span> canalConnector = <span class="type">CanalConnectors</span>.newSingleConnector(<span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">&quot;hadoop102&quot;</span>,<span class="number">11111</span>), <span class="string">&quot;example&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">canalConnector.connect();</span><br><span class="line">canalConnector.subscribe(<span class="string">&quot;sparkgmall.*&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">   <span class="type">Message</span> message = canalConnector.get(<span class="number">100</span>);</span><br><span class="line">   <span class="type">List</span>&lt;<span class="type">CanalEntry</span>.<span class="type">Entry</span>&gt; entries = message.getEntries();</span><br><span class="line">&#125;</span><br><span class="line">获取canal中的数据，然后解析entries后，发送给kafka。</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">交易额（gmv）--需求实现：</span><br><span class="line">1.通过canal获取业务系统mysql中的数据，通过工具类进行解析并发送给kafka。</span><br><span class="line">2.sparkstreaming消费kafka并保持到Hbase中。</span><br><span class="line">要点：在封装为样例类时需要进行脱敏。然后通过rdd.saveToPhoenix 保存到HBase中。</span><br><span class="line">3.利用springboot框架编写微服务框架，根据请求信息返回对应格式的数据。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="F:/Typora/图片/1568524911898.png" alt="1568524911898"></p>
<h3 id="需求三-预警"><a href="#需求三-预警" class="headerlink" title="需求三   预警"></a>需求三   预警</h3><p>筛选条件分析</p>
<p>Ø 同一设备</p>
<p>Ø 5分钟内</p>
<p>Ø 三次不同账号登录</p>
<p>Ø 领取优惠券</p>
<p>Ø 没有浏览商品</p>
<p>Ø 同一设备每分钟只记录一次预警</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">工具类准备：</span><br><span class="line"><span class="type">Es</span>连接工具类：创建客户端连接池方法，从连接池中获取jest客户端方法和批量插入es的方法。</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> <span class="type">ES_HOST</span> = <span class="string">&quot;http://hadoop102&quot;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> <span class="type">ES_HTTP_PORT</span> = <span class="number">9200</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> factory: <span class="type">JestClientFactory</span> = <span class="literal">null</span></span><br><span class="line">  <span class="comment">//获取一个客户端对象</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">getClient</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">      build()</span><br><span class="line">    &#125;</span><br><span class="line">    factory.getObject</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">//创建jest的连接池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">build</span></span>() = &#123;</span><br><span class="line">    factory = <span class="keyword">new</span> <span class="type">JestClientFactory</span></span><br><span class="line">    factory.setHttpClientConfig(<span class="keyword">new</span> <span class="type">HttpClientConfig</span>.<span class="type">Builder</span>(<span class="type">ES_HOST</span> + <span class="string">&quot;:&quot;</span> + <span class="type">ES_HTTP_PORT</span>).multiThreaded(<span class="literal">true</span>)</span><br><span class="line">      .maxTotalConnection(<span class="number">20</span>)</span><br><span class="line">      .connTimeout(<span class="number">10000</span>).readTimeout(<span class="number">10000</span>).build())</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="comment">//向ES中批量插入数据,参数为表名，主键和数据</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">indexBulk</span></span>(indexName: <span class="type">String</span>, dataList: <span class="type">List</span>[(<span class="type">String</span>, <span class="type">Any</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//如果dataList是空的话就不用进行插入了</span></span><br><span class="line">    <span class="keyword">if</span>(dataList.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> client: <span class="type">JestClient</span> = getClient</span><br><span class="line">      <span class="keyword">val</span> bulkbuilder = <span class="keyword">new</span> <span class="type">Bulk</span>.<span class="type">Builder</span>()</span><br><span class="line">      <span class="keyword">for</span> ((id, source) &lt;- dataList) &#123;</span><br><span class="line">        <span class="keyword">val</span> index: <span class="type">Index</span> = <span class="keyword">new</span> <span class="type">Index</span>.<span class="type">Builder</span>(source).index(indexName).`<span class="class"><span class="keyword">type</span>`(<span class="params">&quot;_doc&quot;</span>).<span class="title">id</span>(<span class="params">id</span>).<span class="title">build</span>(<span class="params"></span>)</span></span><br><span class="line">        bulkbuilder.addAction(index)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> bulk: <span class="type">Bulk</span> = bulkbuilder.build()</span><br><span class="line">      <span class="keyword">val</span> items: util.<span class="type">List</span>[<span class="type">BulkResult</span>#<span class="type">BulkResultItem</span>] = client.execute(bulk).getItems <span class="comment">//TODO 获取插入的条数</span></span><br><span class="line"></span><br><span class="line">      println(<span class="string">&quot;插入了&quot;</span> + items.size() + <span class="string">&quot;条报警信息&quot;</span>)</span><br><span class="line">      close(client)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<pre><code>**可能会出先mutil-thread异常，因为window窗口的数据有重叠，如果前面的线程没有处理完该批次数据，下一批数据就到了，就会出现批数据被多个线程引用，所以在批数据进行开窗前，先对其进行cache缓存。**
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">预警 --需求实现：</span><br><span class="line">1.将从kafka读取的event日志转换为样例类，然后进行开窗，窗口大小为300s，步长为5s（批次时间为5s）。</span><br><span class="line">2.然后根据mid进行聚合。</span><br><span class="line">1）在每个group中，对时间进行遍历，如果事件id为coupon，则将uid加入到set集合中；</span><br><span class="line">2）同时需要判断用户是否点击了商品，设置flag=false，如果点击，则设为true，跳出循环；</span><br><span class="line">3）返回最终的结果为tuple2类型，第一个元素是是否报警，第二个元素是预警样例类。</span><br><span class="line">3.需要报警的信息过滤出来，然后批量插入到es已经创建的表中。注意需要拼接mid+分钟形成主键，相同主键后面的会覆盖前面的，实现去重，同一设备每分钟只记录一次预警。</span><br><span class="line">4.通过springboot框架创建微服务框架，根据请求信息返回相应格式的json字符串。也可以直接通过Kibana进行展示。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="F:/Typora/图片/1568524902467.png" alt="1568524902467"></p>
<h3 id="需求四-灵活分析"><a href="#需求四-灵活分析" class="headerlink" title="需求四  灵活分析"></a>需求四  灵活分析</h3><p>需求：通过日期关键字，查询出对应的数据。并计算出男女比例、年龄比例、购买数据明细。</p>
<p>思路：最终结果需要将多张表进行join，ES中不能进行join，所以需要在存入ES前完成join。</p>
<p>①T+1方式：通过sqoop将表导入hive中进行join，第二天展示结果。</p>
<p><img src="F:/Typora/图片/1568531267771.png" alt="1568531267771"></p>
<p>②T+0方式：通过canal将数据导入到kafka中，用sparkstreaming对表进行join，实时展示结果。</p>
<p><img src="F:/Typora/图片/1568531261534.png" alt="1568531261534"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">灵活分析 --T+0 需求实现：</span><br><span class="line">1.从kafka中读取数据，分别读取order_info，order_detail和user_info表。</span><br><span class="line"></span><br><span class="line">2.在spark中完成对表order_info和order_detail的join。</span><br><span class="line">要点：</span><br><span class="line">由于延迟等因素，表中的批数据不是同步到达的，所以需要对数据进行缓存然后join。（双流join）</span><br><span class="line">先完成order_info.fullOutJoin(order_detail)得到joinedStream，然后再对joinedStream进行遍历。</span><br><span class="line">1）如果order_info，order_detail都匹配上，那么加入到resultList中。并将orderId作为key、order_info作为value，缓存到redis的set集合中（因为可能后续还有相同orderId的order_detail需要进行匹配，同时可以进行去重）</span><br><span class="line">2）如果只有order_info，那么将orderId作为key、order_info作为vlaue缓存到redis的set集合中。并读取redis中的相同orderId的order_detail数据，得到set集合，进行遍历，组合成tuple放入到resultList中。</span><br><span class="line">3）如果只有order_detail，那么将order_detail缓存到redis中。并读取redis中的相同orderId的order_info的数据，得到set集合，进行遍历，组合成tuple放入到resultList中。</span><br><span class="line">4）最后将resultList返回，得到本批次匹配后的数据，并将需要的数据缓存到redis中。</span><br><span class="line"></span><br><span class="line">3.将上面的tuple数据转化为样例类，然后和user_info进行关联。</span><br><span class="line">要点：</span><br><span class="line">1）因为用户信息是需要随时查全表的进行关联的，所以将每批次的user_info全放入到redis中（也可以直接在mysql中查询，数据量太大，可以放到HBase中）。</span><br><span class="line">2）因为是一对一的关系，所以可以使用string和hash方式保存到redis。string不能统一管理（如不能取出所有的value值），在集群中hash会造成数据倾斜。我们采用string方式，userid作为key，user_info作为value。</span><br><span class="line">3）遍历resultList，从redis中取出向同userid的user_info，然后组合成tuple。放入到saleList中。</span><br><span class="line">4）最后将saleList存入到ES中创建的表中。</span><br><span class="line"></span><br><span class="line">4.通过springboot框架创建微服务框架，根据请求信息返回相应格式的json字符串。也可以直接通过Kibana进行展示。（ES需要配置ik分词器插件）</span><br><span class="line">要点：</span><br><span class="line">ES的请求语句可以写为算子的形式</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>对ES中的表格进行检索：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">public <span class="type">Map</span> getSaleDetail(<span class="type">String</span> date,int startpage,int size,<span class="type">String</span> key) &#123;</span><br><span class="line"><span class="comment">//        String sql = &quot;GET gmall0311_sale_detail/_search</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>&#123;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  \<span class="string">&quot;query\&quot;:&#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;    \&quot;bool\&quot;:&#123;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>      \<span class="string">&quot;filter\&quot;:&#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;        \&quot;term\&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>          \<span class="string">&quot;dt\&quot;:\&quot;2019-08-20\&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;        &#125;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>      &#125;,</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>      \<span class="string">&quot;must\&quot;:&#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;        \&quot;match\&quot;:&#123;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>          \<span class="string">&quot;sku_name\&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;            \&quot;query\&quot;:\&quot;小米wifi\&quot;,</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>            \<span class="string">&quot;operator\&quot;:\&quot;and\&quot;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;          &#125;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>        &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>      &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>    &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  , </span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  \<span class="string">&quot;aggs\&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;    \&quot;groupbygender\&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>      \<span class="string">&quot;terms\&quot;: &#123;</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;        \&quot;field\&quot;: \&quot;user_gender\&quot;,</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>        \<span class="string">&quot;size\&quot;: 2</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;      &#125;</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>    &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  &#125;</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  ,</span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>  \<span class="string">&quot;from\&quot;: 3,</span></span><br><span class="line"><span class="string">&quot;</span> +</span><br><span class="line"><span class="comment">//                &quot;  \&quot;size\&quot;: 3</span></span><br><span class="line"><span class="string">&quot; +</span></span><br><span class="line"><span class="string">//                &quot;</span>&#125;<span class="string">&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        //查询语句</span></span><br><span class="line"><span class="string">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span></span><br><span class="line"><span class="string">        BoolQueryBuilder boolQueryBuilder = new BoolQueryBuilder();</span></span><br><span class="line"><span class="string">        boolQueryBuilder.filter(new TermQueryBuilder(&quot;</span><span class="string">dt&quot;,date));</span></span><br><span class="line"><span class="string">        boolQueryBuilder.must(new MatchQueryBuilder(&quot;</span>sku_<span class="string">name&quot;,key).operator(MatchQueryBuilder.Operator.AND));</span></span><br><span class="line"><span class="string">        searchSourceBuilder.query(boolQueryBuilder);</span></span><br><span class="line"><span class="string">        //聚合</span></span><br><span class="line"><span class="string">        TermsBuilder groupby_gender = AggregationBuilders.terms(&quot;</span>groupby_<span class="string">gender&quot;).field(&quot;</span>user_<span class="string">gender&quot;).size(2);</span></span><br><span class="line"><span class="string">        TermsBuilder groupby_age = AggregationBuilders.terms(&quot;</span>groupby_<span class="string">age&quot;).field(&quot;</span>user_<span class="string">age&quot;).size(100);</span></span><br><span class="line"><span class="string">        searchSourceBuilder.aggregation(groupby_gender);</span></span><br><span class="line"><span class="string">        searchSourceBuilder.aggregation(groupby_age);</span></span><br><span class="line"><span class="string">        //分页</span></span><br><span class="line"><span class="string">        searchSourceBuilder.from((startpage-1)*size);</span></span><br><span class="line"><span class="string">        searchSourceBuilder.size(size);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        System.out.println(searchSourceBuilder.toString());</span></span><br><span class="line"><span class="string">        Search search = new Search.Builder(searchSourceBuilder.toString()).addIndex(/*GmallConstants.ES_PRODUCT_DETAIL*/&quot;</span>gmall_product_<span class="string">detail&quot;).addType(&quot;</span>_<span class="string">doc&quot;).build();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        HashMap map = new HashMap();</span></span><br><span class="line"><span class="string">        HashMap&lt;String, Long&gt; genderMap = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="string">        HashMap&lt;Object, Object&gt; ageMap = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="string">        try &#123;</span></span><br><span class="line"><span class="string">            SearchResult searchResult = jestClient.execute(search);</span></span><br><span class="line"><span class="string">            Long total = searchResult.getTotal();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            List&lt;SearchResult.Hit&lt;Map, Void&gt;&gt; hits = searchResult.getHits(Map.class);</span></span><br><span class="line"><span class="string">            ArrayList&lt;Map&gt; hitList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="string">            for (SearchResult.Hit&lt;Map, Void&gt; hit : hits) &#123;</span></span><br><span class="line"><span class="string">                hitList.add(hit.source);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            //获取gender的聚合后的kv值</span></span><br><span class="line"><span class="string">            List&lt;TermsAggregation.Entry&gt; groupbygender = searchResult.getAggregations().getTermsAggregation(&quot;</span>groupby_<span class="string">gender&quot;).getBuckets();</span></span><br><span class="line"><span class="string">            for (TermsAggregation.Entry entry : groupbygender) &#123;</span></span><br><span class="line"><span class="string">                genderMap.put(entry.getKey(),entry.getCount());</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            //获取age的集合后的kv值</span></span><br><span class="line"><span class="string">            List&lt;TermsAggregation.Entry&gt; groupbyage = searchResult.getAggregations().getTermsAggregation(&quot;</span>groupby_<span class="string">age&quot;).getBuckets();</span></span><br><span class="line"><span class="string">            for (TermsAggregation.Entry entry : groupbyage) &#123;</span></span><br><span class="line"><span class="string">                ageMap.put(entry.getKey(),entry.getCount());</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            map.put(&quot;</span><span class="string">total&quot;,total);</span></span><br><span class="line"><span class="string">            map.put(&quot;</span><span class="string">source&quot;,hitList);</span></span><br><span class="line"><span class="string">            map.put(&quot;</span>groupby_<span class="string">gender&quot;,genderMap);</span></span><br><span class="line"><span class="string">            map.put(&quot;</span>groupby_<span class="string">age&quot;,ageMap);</span></span><br><span class="line"><span class="string">        &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="string">            e.printStackTrace();</span></span><br><span class="line"><span class="string">        &#125;finally &#123;</span></span><br><span class="line"><span class="string">            try &#123;</span></span><br><span class="line"><span class="string">                jestClient.close();</span></span><br><span class="line"><span class="string">            &#125; catch (IOException e) &#123;</span></span><br><span class="line"><span class="string">                e.printStackTrace();</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return map;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Spark%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/">http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Spark%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Spark%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%90/" title="Spark内核解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spark内核解析</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/%E5%AE%9E%E6%97%B6%E6%95%B0%E4%BB%93%E6%A1%86%E6%9E%B6-1-13-0/" title="实时数仓框架-1-13-0"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">实时数仓框架-1-13-0</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%81%B5%E6%B4%BB%E6%9F%A5%E8%AF%A2%EF%BC%9AES%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="toc-number">1.</span> <span class="toc-text">灵活查询：ES数据的读取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">项目流程：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%B8%80-%E6%97%A5%E6%B4%BB%EF%BC%88dau%EF%BC%89%EF%BC%9A"><span class="toc-number">0.1.</span> <span class="toc-text">需求一   日活（dau）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%BA%8C-%E4%BA%A4%E6%98%93%E9%A2%9D%EF%BC%88gmv%EF%BC%89%EF%BC%9A"><span class="toc-number">0.2.</span> <span class="toc-text">需求二   交易额（gmv）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%B8%89-%E9%A2%84%E8%AD%A6"><span class="toc-number">0.3.</span> <span class="toc-text">需求三   预警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%9B%9B-%E7%81%B5%E6%B4%BB%E5%88%86%E6%9E%90"><span class="toc-number">0.4.</span> <span class="toc-text">需求四  灵活分析</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>