<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>HXR大数据架构和业务(上) | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、架构1.1 架构图 1.2 数据流向图 1.3 前端展示页面 二、业务2.1 BI指标 蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode 集成灶故障类型发生频率统计 errorcode 烟机使用频段统计 hoodspeed 灶具使用统计 stovestatus 右灶定时器使用统计 RStoveTimingState 闹钟使用统计 TimingState  2.2 分层 O">
<meta property="og:type" content="article">
<meta property="og:title" content="HXR大数据架构和业务(上)">
<meta property="og:url" content="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A)/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、架构1.1 架构图 1.2 数据流向图 1.3 前端展示页面 二、业务2.1 BI指标 蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode 集成灶故障类型发生频率统计 errorcode 烟机使用频段统计 hoodspeed 灶具使用统计 stovestatus 右灶定时器使用统计 RStoveTimingState 闹钟使用统计 TimingState  2.2 分层 O">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.055Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.055Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HXR大数据架构和业务(上)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">HXR大数据架构和业务(上)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.055Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.055Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/">大数据火星人业务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="HXR大数据架构和业务(上)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、架构"><a href="#一、架构" class="headerlink" title="一、架构"></a>一、架构</h1><h2 id="1-1-架构图"><a href="#1-1-架构图" class="headerlink" title="1.1 架构图"></a>1.1 架构图</h2><p><img src="/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A).assets%5C75b0b4d81e24495b81f4b149f303a647.png" alt="1620700859180.png"></p>
<h2 id="1-2-数据流向图"><a href="#1-2-数据流向图" class="headerlink" title="1.2 数据流向图"></a>1.2 数据流向图</h2><p><img src="/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A).assets%5Cdcd1a08f5b524a7eb481a72f3bbf8507.png" alt="1620702778841.png"></p>
<h2 id="1-3-前端展示页面"><a href="#1-3-前端展示页面" class="headerlink" title="1.3 前端展示页面"></a>1.3 前端展示页面</h2><p><img src="/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A).assets%5C321553d94dd54d9aa122f01e6ef20389.png" alt="1620701050023.png"></p>
<h1 id="二、业务"><a href="#二、业务" class="headerlink" title="二、业务"></a>二、业务</h1><h3 id="2-1-BI指标"><a href="#2-1-BI指标" class="headerlink" title="2.1 BI指标"></a>2.1 BI指标</h3><ol>
<li>蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode</li>
<li>集成灶故障类型发生频率统计 errorcode</li>
<li>烟机使用频段统计 hoodspeed</li>
<li>灶具使用统计 stovestatus</li>
<li>右灶定时器使用统计 RStoveTimingState</li>
<li>闹钟使用统计 TimingState</li>
</ol>
<h3 id="2-2-分层"><a href="#2-2-分层" class="headerlink" title="2.2 分层"></a>2.2 分层</h3><ul>
<li>ODS（operation data store）：存放原始数据。保持数据原貌不变；创建分区表，防止后续的全表扫描；<code>时间分区</code>，采用<code>LZO压缩，需要建索引</code>，<code>指定输入输出格式</code>；创建外部表；</li>
<li>DWD（data warehouse detail）：结构粒度与ODS层保持一致，对ODS层数据进行清洗（去除无效数据、脏数据，数据脱敏，<code>维度退化</code>，<code>数据转换</code>等）。ETL数据清洗，用hive sql、MR、Python、Kettle、SparkSQL；<code>时间分区</code>，采用<code>LZO压缩，不需要建索引</code>，采用<code>parquet格式</code>存储；创建外部表；</li>
<li>DWS（data warehouse service）：在DWD基础上，按天进行轻度汇总。<code>时间分区</code>，采用<code>parquet格式</code>存储；创建外部表；</li>
<li>DWT（data warehouse topic）：在DWS基础上，按主题进行汇总。采用<code>parquet格式</code>存储；创建外部表，时间分区；</li>
<li>ADS（Application Data Store）：为统计报表提供数据。<code>明确字段分割符</code>，与sqoop对应；创建外部表，时间分区。</li>
</ul>
<p>在ODS层对原始数据进行存储，需要采用压缩（一般lzo为10倍压缩），创建分区表，防止后续的全表扫描。lzop需要建索引才能进行分片，如果时parquet格式+lzo压缩，则不需要切片，因为parquet支持切片。</p>
<h1 id="三、数据采集和存储"><a href="#三、数据采集和存储" class="headerlink" title="三、数据采集和存储"></a>三、数据采集和存储</h1><h2 id="3-1-从飞燕获取数据保存到本地"><a href="#3-1-从飞燕获取数据保存到本地" class="headerlink" title="3.1 从飞燕获取数据保存到本地"></a>3.1 从飞燕获取数据保存到本地</h2><p><strong>pom文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.iotmars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hxr-logclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.openservices<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>iot-client-message<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.iotmars.ClientApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>业务代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.iotmars;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.openservices.iot.api.Profile;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.openservices.iot.api.message.MessageClientFactory;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.openservices.iot.api.message.api.MessageClient;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.openservices.iot.api.message.callback.MessageCallback;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.openservices.iot.api.message.entity.MessageToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: CJ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Data</span>: 2020/11/9 10:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/tmp/logs/q6&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">endPoint</span> <span class="operator">=</span> <span class="string">&quot;https://ilop.iot-as-http2.cn-shanghai.aliyuncs.com:443&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">appKey</span> <span class="operator">=</span> <span class="string">&quot;27698993&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">appSecret</span> <span class="operator">=</span> <span class="string">&quot;2d13de8dfdb4284f6e1e5e1ecc21a6d9&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Profile</span> <span class="variable">profile</span> <span class="operator">=</span> Profile.getAppKeyProfile(endPoint, appKey, appSecret);</span><br><span class="line"></span><br><span class="line">        <span class="type">MessageCallback</span> <span class="variable">messageCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageCallback</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(MessageToken messageToken)</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] payload = messageToken.getMessage().getPayload();</span><br><span class="line"><span class="comment">//                String data = new String(payload);</span></span><br><span class="line"><span class="comment">//                System.out.println(&quot;receive : &quot; + data);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取当前时间</span></span><br><span class="line">                <span class="type">ZoneId</span> <span class="variable">Shanghai</span> <span class="operator">=</span> ZoneId.of(<span class="string">&quot;Asia/Shanghai&quot;</span>);</span><br><span class="line">                <span class="type">ZonedDateTime</span> <span class="variable">now</span> <span class="operator">=</span> ZonedDateTime.now(Shanghai);</span><br><span class="line">                <span class="type">DateTimeFormatter</span> <span class="variable">df</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">strDate</span> <span class="operator">=</span> now.format(df);</span><br><span class="line">                <span class="comment">// 获取路径</span></span><br><span class="line"><span class="comment">//        String filename = &quot;C:/Users/Administrator/Desktop/log&quot; + File.separator + &quot;q6_&quot; + strDate + &quot;.log&quot;;</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> path + File.separator + <span class="string">&quot;q6_&quot;</span> + strDate + <span class="string">&quot;.log&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    filename = args[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 输出到文件中</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filename);</span><br><span class="line">                <span class="keyword">if</span> (!file.getParentFile().exists()) &#123;</span><br><span class="line">                    file.getParentFile().mkdirs();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                FileOutputStream fos;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filename, <span class="literal">true</span>);</span><br><span class="line">                    <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos);</span><br><span class="line">                    bos.write(payload);</span><br><span class="line">                    bos.write(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>.getBytes());</span><br><span class="line">                    bos.flush();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Action.CommitSuccess;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">MessageClient</span> <span class="variable">messageClient</span> <span class="operator">=</span> MessageClientFactory.messageClient(profile);</span><br><span class="line">        messageClient.setMessageListener(messageCallback);</span><br><span class="line">        messageClient.connect(messageCallback);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-2-Flume"><a href="#3-2-Flume" class="headerlink" title="3.2 Flume"></a>3.2 Flume</h2><h3 id="3-2-1-集群启动脚本"><a href="#3-2-1-集群启动脚本" class="headerlink" title="3.2.1 集群启动脚本"></a>3.2.1 集群启动脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;start&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> host <span class="keyword">in</span> bigdata1 <span class="comment">#bigdata2</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line"><span class="comment">#		ssh $&#123;host&#125; &quot;source /etc/profile ; nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a1 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/file-kafka-hdfs.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">		<span class="comment">#ssh $&#123;host&#125; &quot;source /etc/profile ; nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a1 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/log-kafka.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">		ssh bigdata1 <span class="string">&quot;source /etc/profile ; nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a1 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/log-kafka.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">		<span class="comment">#ssh $&#123;host&#125; &quot;source /etc/profile ; nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a2 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/kafka-hdfs.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">		ssh bigdata2 <span class="string">&quot;source /etc/profile ; nohup /opt/module/flume-1.7.0/bin/flume-ng agent -n a2 -c /opt/module/flume-1.7.0/conf -f /opt/module/flume-1.7.0/job/kafka-hdfs.conf 1&gt;/dev/null 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">		<span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> ----- <span class="variable">$&#123;host&#125;</span> flume启动成功 -----</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> host <span class="keyword">in</span> bigdata1 <span class="comment">#bigdata2</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		ssh <span class="variable">$&#123;host&#125;</span> <span class="string">&quot;source /etc/profile ; ps -ef | awk -F \&quot; \&quot; &#x27;/log-kafka.conf/ &amp;&amp; !/awk/&#123;print \$2&#125;&#x27; | xargs kill &quot;</span></span><br><span class="line">		ssh <span class="variable">$&#123;host&#125;</span> <span class="string">&quot;source /etc/profile ; ps -ef | awk -F \&quot; \&quot; &#x27;/kafka-hdfs.conf/ &amp;&amp; !/awk/&#123;print \$2&#125;&#x27; | xargs kill &quot;</span></span><br><span class="line">		<span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> ----- <span class="variable">$&#123;host&#125;</span> flume关闭成功 -----</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-JobFile"><a href="#3-2-2-JobFile" class="headerlink" title="3.2.2 JobFile"></a>3.2.2 JobFile</h3><p><strong>log-kafka.conf</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define</span></span><br><span class="line"><span class="attr">a1.sources</span>= <span class="string">r1</span></span><br><span class="line"><span class="attr">a1.channels</span>= <span class="string">c1 c2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#source</span></span><br><span class="line"><span class="attr">a1.sources.r1.type</span> = <span class="string">TAILDIR</span></span><br><span class="line"><span class="attr">a1.sources.r1.positionFile</span> = <span class="string">/opt/module/flume-1.7.0/taildir_position.json</span></span><br><span class="line"><span class="attr">a1.sources.r1.filegroups</span> = <span class="string">f1</span></span><br><span class="line"><span class="attr">a1.sources.r1.filegroups.f1</span> = <span class="string">/tmp/logs/q6/.*log</span></span><br><span class="line"><span class="attr">a1.sources.r1.fileHeader</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">a1.sources.ri.maxBatchCount</span> = <span class="string">1000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#interceptors</span></span><br><span class="line"><span class="comment">#a1.sources.r1.interceptors = i1 i2</span></span><br><span class="line"><span class="comment">#a1.sources.r1.interceptors.i1.type = com.hxr.flume.LogETLInterceptor$Builder</span></span><br><span class="line"><span class="attr">a1.sources.r1.interceptors</span> = <span class="string">i2</span></span><br><span class="line"><span class="attr">a1.sources.r1.interceptors.i2.type</span> = <span class="string">com.hxr.flume.LogTypeInterceptor$Builder</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#selector</span></span><br><span class="line"><span class="attr">a1.sources.r1.selector.type</span> = <span class="string">multiplexing</span></span><br><span class="line"><span class="attr">a1.sources.r1.selector.header</span> = <span class="string">topic</span></span><br><span class="line"><span class="attr">a1.sources.r1.selector.mapping.Log_Q6</span> = <span class="string">c1</span></span><br><span class="line"><span class="attr">a1.sources.r1.selector.mapping.Log_E5</span> = <span class="string">c2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#channel</span></span><br><span class="line"><span class="attr">a1.channels.c1.type</span> = <span class="string">org.apache.flume.channel.kafka.KafkaChannel</span></span><br><span class="line"><span class="attr">a1.channels.c1.kafka.bootstrap.servers</span> = <span class="string">BigData1:9092,BigData2:9092,BigData3:9092</span></span><br><span class="line"><span class="attr">a1.channels.c1.kafka.topic</span> = <span class="string">ModelLog_Q6</span></span><br><span class="line"><span class="attr">a1.channels.c1.parseAsFlumeEvent</span> = <span class="string">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a1.channels.c2.type</span> = <span class="string">org.apache.flume.channel.kafka.KafkaChannel</span></span><br><span class="line"><span class="attr">a1.channels.c2.kafka.bootstrap.servers</span> = <span class="string">BigData1:9092,BigData2:9092,BigData3:9092</span></span><br><span class="line"><span class="attr">a1.channels.c2.kafka.topic</span> = <span class="string">ModelLog_E5</span></span><br><span class="line"><span class="attr">a1.channels.c2.parseAsFlumeEvent</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#combine</span></span><br><span class="line"><span class="attr">a1.sources.r1.channels</span> = <span class="string">c1 c2</span></span><br></pre></td></tr></table></figure>

<p><strong>kafka-hdfs.conf</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define</span></span><br><span class="line"><span class="attr">a2.sources</span>= <span class="string">r1 r2</span></span><br><span class="line"><span class="attr">a2.channels</span>= <span class="string">c1 c2</span></span><br><span class="line"><span class="attr">a2.sinks</span> = <span class="string">k1 k2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#source</span></span><br><span class="line"><span class="attr">a2.sources.r1.type</span> = <span class="string">org.apache.flume.source.kafka.KafkaSource</span></span><br><span class="line"><span class="attr">a2.sources.r1.batchSize</span> = <span class="string">5000</span></span><br><span class="line"><span class="attr">a2.sources.r1.batchDurationMillis</span> = <span class="string">2000</span></span><br><span class="line"><span class="attr">a2.sources.r1.kafka.bootstrap.servers</span> = <span class="string">BigData1:9092,BigData2:9092,BigData3:9092</span></span><br><span class="line"><span class="attr">a2.sources.r1.kafka.topics</span> = <span class="string">Log_Q6</span></span><br><span class="line"><span class="attr">a2.sources.r1.kafka.consumer.group.id</span> = <span class="string">custom.q6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a2.sources.r2.type</span> = <span class="string">org.apache.flume.source.kafka.KafkaSource</span></span><br><span class="line"><span class="attr">a2.sources.r2.batchSize</span> = <span class="string">5000</span></span><br><span class="line"><span class="attr">a2.sources.r2.batchDurationMillis</span> = <span class="string">2000</span></span><br><span class="line"><span class="attr">a2.sources.r2.kafka.bootstrap.servers</span> = <span class="string">BigData1:9092,BigData2:9092,BigData3:9092</span></span><br><span class="line"><span class="attr">a2.sources.r2.kafka.topics</span> = <span class="string">Log_E5</span></span><br><span class="line"><span class="attr">a2.sources.r2.kafka.consumer.group.id</span> = <span class="string">custom.e5</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#channels</span></span><br><span class="line"><span class="attr">a2.channels.c1.type</span> = <span class="string">memory</span></span><br><span class="line"><span class="attr">a2.channels.c1.capacity</span> = <span class="string">10000</span></span><br><span class="line"><span class="attr">a2.channels.c1.transactionCapacity</span> = <span class="string">10000</span></span><br><span class="line"><span class="attr">a2.channels.c1.byteCapacityBufferPercentage</span> = <span class="string">20</span></span><br><span class="line"><span class="attr">a2.channels.c1.byteCapacity</span> = <span class="string">800000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a2.channels.c2.type</span> = <span class="string">memory</span></span><br><span class="line"><span class="attr">a2.channels.c2.capacity</span> = <span class="string">10000</span></span><br><span class="line"><span class="attr">a2.channels.c2.transactionCapacity</span> = <span class="string">10000</span></span><br><span class="line"><span class="attr">a2.channels.c2.byteCapacityBufferPercentage</span> = <span class="string">20</span></span><br><span class="line"><span class="attr">a2.channels.c2.byteCapacity</span> = <span class="string">800000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#sink</span></span><br><span class="line"><span class="attr">a2.sinks.k1.type</span> = <span class="string">hdfs</span></span><br><span class="line"><span class="attr">a2.sinks.k1.channel</span> = <span class="string">c1</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.path</span> = <span class="string">/origin_data/device_model_log/logs/q6/%Y-%m-%d</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.filePrefix</span> = <span class="string">q6-</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.rollInterval</span> = <span class="string">3600</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.rollSize</span> = <span class="string">134217728</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.rollCount</span> = <span class="string">0</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.useLocalTimeStamp</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a2.sinks.k2.type</span> = <span class="string">hdfs</span></span><br><span class="line"><span class="attr">a2.sinks.k2.channel</span> = <span class="string">c2</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.path</span> = <span class="string">/origin_data/device_model_log/logs/e5/%Y-%m-%d</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.filePrefix</span> = <span class="string">e5-</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.rollInterval</span> = <span class="string">3600</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.rollSize</span> = <span class="string">134217728</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.rollCount</span> = <span class="string">0</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.useLocalTimeStamp</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#compress</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.codeC</span> = <span class="string">lzop</span></span><br><span class="line"><span class="attr">a2.sinks.k1.hdfs.fileType</span> = <span class="string">CompressedStream</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.codeC</span> = <span class="string">lzop</span></span><br><span class="line"><span class="attr">a2.sinks.k2.hdfs.fileType</span> = <span class="string">CompressedStream</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#combine</span></span><br><span class="line"><span class="attr">a2.sources.r1.channels</span> = <span class="string">c1</span></span><br><span class="line"><span class="attr">a2.sources.r2.channels</span> = <span class="string">c2</span></span><br><span class="line"><span class="attr">a2.sinks.k1.channel</span> = <span class="string">c1</span></span><br><span class="line"><span class="attr">a2.sinks.k2.channel</span> = <span class="string">c2</span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-3-拦截器"><a href="#3-2-3-拦截器" class="headerlink" title="3.2.3 拦截器"></a>3.2.3 拦截器</h3><p><strong>pom文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hxr.flume<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flume_interceptor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flume<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flume-ng-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided <span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.68<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>LogETLInterceptor.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.flume;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: CJ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Data</span>: 2020/6/3 10:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogETLInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JSONObject&gt; buffer = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(Collections.emptyMap());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Event <span class="title function_">intercept</span><span class="params">(Event event)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] body = event.getBody();</span><br><span class="line">        <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过比较同一设备的相邻的两条物模型，来判断用户进行的操作，采集改变的字段</span></span><br><span class="line">        <span class="keyword">if</span> (log.startsWith(<span class="string">&quot;&#123;\&quot;deviceType\&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(log);</span><br><span class="line">            <span class="type">String</span> <span class="variable">iotId</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;iotId&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 比较两条记录</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">newItems</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;items&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">oldItems</span> <span class="operator">=</span> buffer.get(iotId);</span><br><span class="line"></span><br><span class="line">            buffer.put(iotId, newItems);</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(iotId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Set&lt;String&gt; keySet = newItems.keySet();</span><br><span class="line">            <span class="keyword">if</span> (keySet.size() &lt; <span class="number">35</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (keySet.contains(<span class="string">&quot;ComSWVersion&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 暂时过滤掉设备启动时的mac信息</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> event; <span class="comment">// 放行音量等事件信息</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keySet.size() == <span class="number">36</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 不知道36个属性的记录是哪来的，先过滤掉</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对非事件信息进行比较，获取改变的属性并重置event的body</span></span><br><span class="line">            Map&lt;String, JSONObject&gt; changePros = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(Collections.emptyMap());</span><br><span class="line">            keySet.forEach(key -&gt; &#123;</span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">oldValue</span> <span class="operator">=</span> oldItems.getJSONObject(key);</span><br><span class="line">                <span class="type">String</span> <span class="variable">oldValueVa</span> <span class="operator">=</span> oldValue.getString(<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">newValue</span> <span class="operator">=</span> newItems.getJSONObject(key);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">newValueVa</span> <span class="operator">=</span> newValue.getString(<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!oldValueVa.equals(newValueVa)) &#123;</span><br><span class="line">                    changePros.put(key, newValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (changePros.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            jsonObject.put(<span class="string">&quot;items&quot;</span>, changePros);</span><br><span class="line">            event.setBody(jsonObject.toJSONString().getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> event;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Event&gt; <span class="title function_">intercept</span><span class="params">(List&lt;Event&gt; events)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Event&gt; iterator = events.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">            <span class="type">Event</span> <span class="variable">intercept</span> <span class="operator">=</span> intercept(event);</span><br><span class="line">            <span class="keyword">if</span> (intercept == <span class="literal">null</span>) &#123;</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> events;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span>.Builder &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Interceptor <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LogETLInterceptor</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>LogTypeInterceptor.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.flume;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.Event;</span><br><span class="line"><span class="keyword">import</span> org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: CJ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Data</span>: 2020/6/3 10:38</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogTypeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">q6ProduceKey</span> <span class="operator">=</span> <span class="string">&quot;a17JZbZVctc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">e5ProduceKey</span> <span class="operator">=</span> <span class="string">&quot;a1wJ5yI6O37&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Event <span class="title function_">intercept</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] body = event.getBody();</span><br><span class="line">        <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, StandardCharsets.UTF_8);</span><br><span class="line">        Map&lt;String, String&gt; headers = event.getHeaders();</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(log);</span><br><span class="line">        <span class="type">String</span> <span class="variable">productKey</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;productKey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (q6ProduceKey.equals(productKey)) &#123;</span><br><span class="line">            headers.put(<span class="string">&quot;topic&quot;</span>, <span class="string">&quot;Log_Q6&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e5ProduceKey.equals(productKey)) &#123;</span><br><span class="line">            headers.put(<span class="string">&quot;topic&quot;</span>, <span class="string">&quot;Log_E5&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Event&gt; <span class="title function_">intercept</span><span class="params">(List&lt;Event&gt; events)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Event event : events) &#123;</span><br><span class="line">            intercept(event);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> events;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span>.Builder&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Interceptor <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LogTypeInterceptor</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-3-Flink"><a href="#3-3-Flink" class="headerlink" title="3.3 Flink"></a>3.3 Flink</h2><p><strong>pom文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>LogBehaviorETL<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scala.binary.version</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">scala.binary.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">kafka.version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">kafka.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-api-scala-bridge_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner-blink_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;scope&gt;provided&lt;/scope&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-cep-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.68<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>业务代码</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.iotmars.mcook</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.&#123;<span class="type">JSON</span>, <span class="type">JSONObject</span>&#125;</span><br><span class="line"><span class="keyword">import</span> com.iotmars.mcook.common.<span class="type">KafkaConstant</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.&#123;<span class="type">PatternSelectFunction</span>, <span class="type">PatternTimeoutFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.<span class="type">CEP</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.pattern.<span class="type">Pattern</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.&#123;<span class="type">FlinkKafkaConsumer</span>, <span class="type">FlinkKafkaProducer</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.control.<span class="type">Breaks</span>._</span><br><span class="line"><span class="keyword">import</span> scala.collection.<span class="type">JavaConversions</span>._</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/13 14:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelLogQ6</span>(<span class="params">iotId: <span class="type">String</span>, productKey: <span class="type">String</span>, gmtCreate: <span class="type">Long</span>, data: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LogBehaviorEtl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> readProperties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    readProperties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="type">KafkaConstant</span>.<span class="type">BOOTSTRAP_SERVERS</span>)</span><br><span class="line">    readProperties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>)</span><br><span class="line">    readProperties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>)</span><br><span class="line">    readProperties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> myConsumer = <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="type">KafkaConstant</span>.<span class="type">READ_KAFKA_TOPIC</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), readProperties)</span><br><span class="line">    <span class="comment">//    myConsumer.setStartFromEarliest()</span></span><br><span class="line">    myConsumer.setStartFromLatest()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从kafka中读取</span></span><br><span class="line">    <span class="keyword">val</span> inputStream = env.addSource(myConsumer)</span><br><span class="line">    <span class="comment">// 从端口中读取</span></span><br><span class="line">    <span class="comment">//        val inputStream = env.socketTextStream(&quot;192.168.32.242&quot;, 7777)</span></span><br><span class="line">    <span class="comment">// 从文本中读取</span></span><br><span class="line">    <span class="comment">//        val resource = getClass.getResource(&quot;/DeviceModelLog&quot;)</span></span><br><span class="line">    <span class="comment">//        val inputStream = env.readTextFile(resource.getPath)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    inputStream.print(&quot;...&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(log =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> jsonObject = <span class="type">JSON</span>.parseObject(log)</span><br><span class="line">        <span class="keyword">val</span> iotId = jsonObject.getString(<span class="string">&quot;iotId&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> productKey = jsonObject.getString(<span class="string">&quot;productKey&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> gmtCreate = jsonObject.getLong(<span class="string">&quot;gmtCreate&quot;</span>)</span><br><span class="line">        <span class="comment">//        val data = jsonObject.getString(&quot;items&quot;)</span></span><br><span class="line">        <span class="type">ModelLogQ6</span>(iotId, productKey, gmtCreate, log)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">//          .assignAscendingTimestamps(_.gmtCreate)</span></span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">ModelLogQ6</span>](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">ModelLogQ6</span>): <span class="type">Long</span> = element.gmtCreate</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是WifiMac，则通过mq存储到数据库中</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> pattern = <span class="type">Pattern</span></span><br><span class="line">      .begin[<span class="type">ModelLogQ6</span>](<span class="string">&quot;start&quot;</span>).where(_.productKey.equals(<span class="string">&quot;a17JZbZVctc&quot;</span>))</span><br><span class="line">      .next(<span class="string">&quot;next&quot;</span>).where(_.productKey.equals(<span class="string">&quot;a17JZbZVctc&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> outputTag = <span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">String</span>](<span class="string">&quot;order-timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> selectStream = <span class="type">CEP</span></span><br><span class="line">      .pattern(dataStream.keyBy(_.iotId), pattern)</span><br><span class="line">      .select(outputTag, <span class="keyword">new</span> <span class="type">LogTimeoutResult</span>, <span class="keyword">new</span> <span class="type">LogCompleteResult</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将正确的数据存入Log_Q6中，将迟到的数据存入LogLate_Q6</span></span><br><span class="line">    <span class="keyword">val</span> writeProperties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    writeProperties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="type">KafkaConstant</span>.<span class="type">BOOTSTRAP_SERVERS</span>)</span><br><span class="line">    <span class="comment">//    writeProperties.setProperty(&quot;key.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;)</span></span><br><span class="line">    <span class="comment">//    writeProperties.setProperty(&quot;value.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;)</span></span><br><span class="line">    <span class="comment">// 迟到数据</span></span><br><span class="line">    <span class="keyword">val</span> lateStream = selectStream.getSideOutput(outputTag)</span><br><span class="line">    <span class="comment">//    lateStream.print(&quot;warn&quot;)</span></span><br><span class="line">    lateStream.addSink(<span class="keyword">new</span> <span class="type">FlinkKafkaProducer</span>[<span class="type">String</span>](<span class="type">KafkaConstant</span>.<span class="type">WRITE_LATE_KAFKA_TOPIC</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), writeProperties))</span><br><span class="line">    <span class="comment">// 正常数据</span></span><br><span class="line">    <span class="keyword">val</span> resultStream = selectStream.filter(_ != <span class="literal">null</span>)</span><br><span class="line">    <span class="comment">//    resultStream.print(&quot;info&quot;)</span></span><br><span class="line">    resultStream.addSink(<span class="keyword">new</span> <span class="type">FlinkKafkaProducer</span>[<span class="type">String</span>](<span class="type">KafkaConstant</span>.<span class="type">WRITE_SUCCESS_KAFKA_TOPIC</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), writeProperties))</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;Q6 Log ETL&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogTimeoutResult</span> <span class="keyword">extends</span> <span class="title">PatternTimeoutFunction</span>[<span class="type">ModelLogQ6</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">timeout</span></span>(map: util.<span class="type">Map</span>[<span class="type">String</span>, util.<span class="type">List</span>[<span class="type">ModelLogQ6</span>]], l: <span class="type">Long</span>): <span class="type">String</span> =</span><br><span class="line">    map.get(<span class="string">&quot;start&quot;</span>).get(<span class="number">0</span>).data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogCompleteResult</span> <span class="keyword">extends</span> <span class="title">PatternSelectFunction</span>[<span class="type">ModelLogQ6</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">select</span></span>(map: util.<span class="type">Map</span>[<span class="type">String</span>, util.<span class="type">List</span>[<span class="type">ModelLogQ6</span>]]): <span class="type">String</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> start: <span class="type">ModelLogQ6</span> = map.get(<span class="string">&quot;start&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> next: <span class="type">ModelLogQ6</span> = map.get(<span class="string">&quot;next&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> oldData: <span class="type">String</span> = start.data</span><br><span class="line">    <span class="keyword">val</span> newData: <span class="type">String</span> = next.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析新数据的事件</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">val</span> jsonObject: <span class="type">JSONObject</span> = <span class="type">JSON</span>.parseObject(newData)</span><br><span class="line">      <span class="keyword">val</span> newItems = jsonObject.getJSONObject(<span class="string">&quot;items&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> keySet: util.<span class="type">Set</span>[<span class="type">String</span>] = newItems.keySet()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析旧数据的事件</span></span><br><span class="line">      <span class="keyword">val</span> oldItems = <span class="type">JSON</span>.parseObject(oldData).getJSONObject(<span class="string">&quot;items&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> changePros = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">JSONObject</span>]()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (key &lt;- keySet) &#123;</span><br><span class="line">        breakable &#123;</span><br><span class="line">          <span class="comment">// 过滤掉目前无用且一直打印的字段</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">&quot;LFirewallTemp&quot;</span>.equals(key) || <span class="string">&quot;StOvRealTemp&quot;</span>.equals(key) || <span class="string">&quot;RFirewallTemp&quot;</span>.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">break</span>()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">val</span> oldValue: <span class="type">JSONObject</span> = oldItems.getJSONObject(key)</span><br><span class="line">          <span class="keyword">val</span> oldValueVa: <span class="type">String</span> = oldValue.getString(<span class="string">&quot;value&quot;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">val</span> newValue: <span class="type">JSONObject</span> = newItems.getJSONObject(key)</span><br><span class="line">          <span class="keyword">val</span> newValueVa: <span class="type">String</span> = newValue.getString(<span class="string">&quot;value&quot;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 剩余时间取最大值</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">&quot;StOvSetTimerLeft&quot;</span>.equals(key) || <span class="string">&quot;HoodOffLeftTime&quot;</span>.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newValueVa.compareTo(oldValueVa) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              changePros.put(key, newValue)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 累计运行时间取最大值</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">&quot;HoodRunningTime&quot;</span>.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newValueVa.compareTo(oldValueVa) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              changePros.put(key, newValue)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!oldValueVa.equals(newValueVa)) &#123;</span><br><span class="line">            changePros.put(key, newValue)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (changePros.nonEmpty) &#123;</span><br><span class="line">        jsonObject.put(<span class="string">&quot;items&quot;</span>, changePros)</span><br><span class="line">        jsonObject.toString()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Exception</span> =&gt; <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>枚举类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.iotmars.mcook.common;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: CJ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Data</span>: 2021/1/15 11:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">KafkaConstant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">BOOTSTRAP_SERVERS</span> <span class="operator">=</span> <span class="string">&quot;192.168.32.242:9092,192.168.32.243:9092,192.168.32.244:9092&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">READ_KAFKA_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;ModelLog_Q6&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">WRITE_SUCCESS_KAFKA_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;Log_Q6&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">WRITE_LATE_KAFKA_TOPIC</span> <span class="operator">=</span> <span class="string">&quot;LogLate_Q6&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-4-Kafka"><a href="#3-4-Kafka" class="headerlink" title="3.4 Kafka"></a>3.4 Kafka</h2><h3 id="3-4-1-创建原始数据表"><a href="#3-4-1-创建原始数据表" class="headerlink" title="3.4.1 创建原始数据表"></a>3.4.1 创建原始数据表</h3><p><strong>ModelLog_E5</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic ModelLog_E5 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>

<p><strong>ModelLog_Q6</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic ModelLog_Q6 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>

<h3 id="3-4-2-创建ETL后数据表"><a href="#3-4-2-创建ETL后数据表" class="headerlink" title="3.4.2 创建ETL后数据表"></a>3.4.2 创建ETL后数据表</h3><p><strong>Log_E5</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic Log_E5 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>

<p><strong>Log_Q6</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic Log_Q6 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>

<h3 id="3-4-3-创建迟到数据表"><a href="#3-4-3-创建迟到数据表" class="headerlink" title="3.4.3 创建迟到数据表"></a>3.4.3 创建迟到数据表</h3><p><strong>LogLate_E5</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic LogLate_E5 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>

<p><strong>LogLate_Q6</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh  --zookeeper bigdata12:2181  --create --topic LogLate_Q6 --partitions 3  --replication-factor 2</span><br></pre></td></tr></table></figure>


<br>
# 四、数据处理

<h2 id="4-1-总表"><a href="#4-1-总表" class="headerlink" title="4.1 总表"></a>4.1 总表</h2><h3 id="4-1-1-建表"><a href="#4-1-1-建表" class="headerlink" title="4.1.1 建表"></a>4.1.1 建表</h3><p><strong>ods_q6_model_log</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> device_model_log.ods_q6_model_log;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> device_model_log.ods_q6_model_log (`line` string)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span></span><br><span class="line">  INPUTFORMAT <span class="string">&#x27;com.hadoop.mapred.DeprecatedLzoTextInputFormat&#x27;</span></span><br><span class="line">  OUTPUTFORMAT <span class="string">&#x27;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&#x27;</span></span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/ods/ods_q6_model_log&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>dwd_q6_event_log</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwd_q6_event_log;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwd_q6_event_log (</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`gmt_create` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`event_name` string,</span><br><span class="line">`event_value` string,</span><br><span class="line">`event_time` string</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwd/dwd_q6_event_log&#x27;</span></span><br><span class="line">TBLPROPERTIES(<span class="string">&#x27;parquet.compression&#x27;</span><span class="operator">=</span><span class="string">&#x27;lzo&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-导入脚本"><a href="#4-1-2-导入脚本" class="headerlink" title="4.1.2 导入脚本"></a>4.1.2 导入脚本</h3><p><strong>hdfs2ods_model_log.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">LOAD DATA INPATH &#x27;/origin_data/$&#123;APP&#125;/logs/q6/$&#123;do_date&#125;&#x27; INTO TABLE $&#123;APP&#125;.ods_q6_model_log partition(dt=&#x27;$&#123;do_date&#125;&#x27;);</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>ods2dwd_model_log.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE $&#123;APP&#125;.dwd_q6_event_log</span><br><span class="line">partition(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line"> get_json_object(line,&#x27;$.deviceType&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.iotId&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.requestId&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.checkFailedData&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.productKey&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.gmtCreate&#x27;),</span><br><span class="line"> get_json_object(line,&#x27;$.deviceName&#x27;),</span><br><span class="line"> event_name,</span><br><span class="line"> split(event_value,&#x27;\\|&#x27;)[0],</span><br><span class="line"> split(event_value,&#x27;\\|&#x27;)[1]</span><br><span class="line">FROM $&#123;APP&#125;.ods_q6_model_log LATERAL VIEW flat_analizer(get_json_object(line,&#x27;$.items&#x27;)) tmp_flat AS event_name,event_value</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; AND get_json_object(line,&#x27;$.items&#x27;)&lt;&gt;&#x27;&#x27;;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="4-2-事件表"><a href="#4-2-事件表" class="headerlink" title="4.2 事件表"></a>4.2 事件表</h2><h3 id="4-2-1-蒸箱模式使用频率统计-包括时间段内使用频次和总频次-stovmode"><a href="#4-2-1-蒸箱模式使用频率统计-包括时间段内使用频次和总频次-stovmode" class="headerlink" title="4.2.1 蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode"></a>4.2.1 蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode</h3><h4 id="4-2-1-1-dwd层"><a href="#4-2-1-1-dwd层" class="headerlink" title="4.2.1.1 dwd层"></a>4.2.1.1 dwd层</h4><ul>
<li>建表</li>
</ul>
<p><strong>dwd_q6_stovmode_log</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwd_q6_stovmode_log;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwd_q6_stovmode_log (</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`gmt_create` string,</span><br><span class="line">`device_name` string,  </span><br><span class="line">`st_ov_mode` string,</span><br><span class="line">`event_time` string</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwd/dwd_q6_stovmode_log&#x27;</span></span><br><span class="line">TBLPROPERTIES(<span class="string">&#x27;parquet.compression&#x27;</span><span class="operator">=</span><span class="string">&#x27;lzo&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dwd2dwd_stovmode_log.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi    </span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE $&#123;APP&#125;.dwd_q6_stovmode_log</span><br><span class="line">partition(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">device_type,</span><br><span class="line">iot_id,</span><br><span class="line">request_id,</span><br><span class="line">check_failed_data,</span><br><span class="line">product_key,</span><br><span class="line">gmt_create,</span><br><span class="line">device_name,</span><br><span class="line">event_value,</span><br><span class="line">event_time</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_event_log </span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; AND event_name=&#x27;StOvMode&#x27;;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h4 id="4-2-1-2-dws层"><a href="#4-2-1-2-dws层" class="headerlink" title="4.2.1.2 dws层"></a>4.2.1.2 dws层</h4><h5 id="4-2-1-2-1-设备维度"><a href="#4-2-1-2-1-设备维度" class="headerlink" title="4.2.1.2.1 设备维度"></a>4.2.1.2.1 设备维度</h5><ul>
<li>建表</li>
</ul>
<p><strong>dws_q6_device_stovmode_daycount</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dws_q6_device_stovmode_daycount;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dws_q6_device_stovmode_daycount(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`st_ov_mode` string,</span><br><span class="line">`mode_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累计模式启动次数&#x27;</span>,</span><br><span class="line">`mor_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;其他时段累计模式启动次数&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dws/dws_q6_device_stovmode_daycount&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dwd2dws_device_stovmode_count.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE $&#123;APP&#125;.dws_q6_device_stovmode_daycount</span><br><span class="line">partition(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">  daycount.deviceType,</span><br><span class="line">  daycount.iotId,</span><br><span class="line">  daycount.requestId,</span><br><span class="line">  daycount.checkFailedData,</span><br><span class="line">  daycount.productKey,</span><br><span class="line">  daycount.deviceName,</span><br><span class="line">  daycount.st_ov_mode,</span><br><span class="line">  daycount.amount,</span><br><span class="line">  nvl(morcount.mor_count,0),</span><br><span class="line">  nvl(noocount.noo_count,0),</span><br><span class="line">  nvl(evecount.eve_count,0),</span><br><span class="line">  daycount.amount-nvl(morcount.mor_count,0)-nvl(noocount.noo_count,0)-nvl(evecount.eve_count,0)</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_type)) deviceType, </span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(iot_id)) iotId,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(request_id)) requestId,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(check_failed_data)) checkFailedData,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(product_key)) productKey,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_name)) deviceName,</span><br><span class="line">  st_ov_mode,</span><br><span class="line">  count(*) amount</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_stovmode_log  </span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) daycount</span><br><span class="line">LEFT JOIN </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  count(*) mor_count</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_stovmode_log</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; and from_unixtime(cast(event_time/1000 as bigint),&#x27;H&#x27;) IN (6,7,8,9)</span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) morcount ON daycount.st_ov_mode=morcount.st_ov_mode</span><br><span class="line">LEFT JOIN </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  count(*) noo_count</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_stovmode_log</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; and from_unixtime(cast(event_time/1000 as bigint),&#x27;H&#x27;) IN (10,11,12,13)</span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) noocount ON daycount.st_ov_mode=noocount.st_ov_mode</span><br><span class="line">LEFT JOIN </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  count(*) eve_count</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_stovmode_log</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; and from_unixtime(cast(event_time/1000 as bigint),&#x27;H&#x27;) IN (16,17,18,19)</span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) evecount ON daycount.st_ov_mode=evecount.st_ov_mode</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h5 id="4-2-1-2-2-用户维度"><a href="#4-2-1-2-2-用户维度" class="headerlink" title="4.2.1.2.2 用户维度"></a>4.2.1.2.2 用户维度</h5><h6 id="4-2-1-2-2-1-使用频率统计"><a href="#4-2-1-2-2-1-使用频率统计" class="headerlink" title="4.2.1.2.2.1 使用频率统计"></a>4.2.1.2.2.1 使用频率统计</h6><ul>
<li>建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dws_q6_user_stovmode_daycount;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dws_q6_user_stovmode_daycount(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`st_ov_mode` string,</span><br><span class="line">`mode_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累计模式启动次数&#x27;</span>,</span><br><span class="line">`mor_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;其他时段累计模式启动次数&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dws/dws_q6_user_stovmode_daycount&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $&#123;APP&#125;;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">with</span><br><span class="line">temp as </span><br><span class="line">(</span><br><span class="line">  SELECT </span><br><span class="line">    device_type,</span><br><span class="line">    iot_id,</span><br><span class="line">    &#x27;&#x27; request_id,</span><br><span class="line">    &#x27;&#x27; check_failed_data,</span><br><span class="line">    product_key,</span><br><span class="line">    device_name,</span><br><span class="line">    st_ov_mode,</span><br><span class="line">    lag(st_ov_mode,1,st_ov_mode) over(partition by iot_id order by event_time) st_ov_lag_mode,</span><br><span class="line">    event_time,</span><br><span class="line">    from_unixtime(cast(substr(event_time,1,10) as bigint),&#x27;H&#x27;) start_hour</span><br><span class="line">  FROM dwd_q6_stovmode_log</span><br><span class="line">  WHERE dt = &#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT OVERWRITE TABLE dws_q6_user_stovmode_daycount</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_type)) device_type,</span><br><span class="line">  iot_id,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(request_id)) request_id,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(check_failed_data)) check_failed_data,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(product_key)) product_key,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_name)) device_name,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(st_ov_mode)) st_ov_mode,</span><br><span class="line">  count(*) start_count,</span><br><span class="line">  sum(mor) mor_count,</span><br><span class="line">  sum(noo) noo_count,</span><br><span class="line">  sum(eve) eve_count,</span><br><span class="line">  sum(oth) oth_count</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">  device_type,</span><br><span class="line">  iot_id,</span><br><span class="line">  request_id,</span><br><span class="line">  check_failed_data,</span><br><span class="line">  product_key,</span><br><span class="line">  device_name,</span><br><span class="line">  st_ov_mode,</span><br><span class="line">  st_ov_lag_mode,</span><br><span class="line">  event_time,</span><br><span class="line">  start_hour,</span><br><span class="line">  from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;) end_hour,</span><br><span class="line">  if(start_hour&lt;10 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=6,1,0) mor,</span><br><span class="line">  if(start_hour&lt;14 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=10,1,0) noo,</span><br><span class="line">  if(start_hour&lt;20 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=16,1,0) eve,</span><br><span class="line">  if((start_hour&lt;6 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=0) or (start_hour&lt;16 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=14) or (start_hour&lt;24 and from_unixtime(cast(substr(event_next_time,1,10) as bigint),&#x27;H&#x27;)&gt;=20),1,0) oth</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">    SELECT</span><br><span class="line">      device_type,</span><br><span class="line">      iot_id,</span><br><span class="line">      request_id,</span><br><span class="line">      check_failed_data,</span><br><span class="line">      product_key,</span><br><span class="line">      device_name,</span><br><span class="line">      st_ov_mode,</span><br><span class="line">      st_ov_lag_mode,</span><br><span class="line">      event_time,</span><br><span class="line">      lead(event_time,1,event_time) over(partition by iot_id order by event_time) event_next_time,</span><br><span class="line">      start_hour</span><br><span class="line">    FROM  temp</span><br><span class="line">    WHERE (st_ov_mode&gt;0 and st_ov_lag_mode=0) or (st_ov_mode=0 and st_ov_lag_mode&gt;0)</span><br><span class="line">) temp1</span><br><span class="line">WHERE st_ov_mode&lt;&gt;0</span><br><span class="line">) temp2</span><br><span class="line">GROUP BY iot_id;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h6 id="4-2-1-2-2-2-使用时间统计"><a href="#4-2-1-2-2-2-使用时间统计" class="headerlink" title="4.2.1.2.2.2 使用时间统计"></a>4.2.1.2.2.2 使用时间统计</h6><ul>
<li>建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dws_q6_user_stovmode_daytime;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dws_q6_user_stovmode_daytime(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`st_ov_mode` string COMMENT <span class="string">&#x27;蒸烤模式&#x27;</span>,</span><br><span class="line">`start_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日该模式启动次数统计&#x27;</span>,</span><br><span class="line">`using_time` string COMMENT <span class="string">&#x27;当日该模式使用时间统计&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwd/dws_q6_user_stovmode_daytime&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">with</span><br><span class="line">temp as</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">  device_type,</span><br><span class="line">  iot_id,</span><br><span class="line">  &#x27;&#x27; request_id,</span><br><span class="line">  &#x27;&#x27; check_failed_data,</span><br><span class="line">  product_key,</span><br><span class="line">  gmt_create,</span><br><span class="line">  device_name,</span><br><span class="line">  st_ov_mode,</span><br><span class="line">  event_time,</span><br><span class="line">  lead(event_time,1,event_time) over(partition by iot_id order by event_time) event_next_time</span><br><span class="line">FROM dwd_q6_stovmode_log</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT OVERWRITE TABLE dws_q6_user_stovmode_daytime</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_type)) device_type,</span><br><span class="line">  iot_id,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(request_id)) request_id,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(check_failed_data)) check_failed_data,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(product_key)) product_key,</span><br><span class="line">  concat_ws(&#x27;|&#x27;,collect_set(device_name)) device_name,</span><br><span class="line">  st_ov_mode,</span><br><span class="line">  count(*),</span><br><span class="line">  cast(sum(event_next_time-event_time)/1000/3600 as decimal(38,3)) </span><br><span class="line">FROM temp</span><br><span class="line">GROUP BY iot_id,st_ov_mode;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>



<h4 id="4-2-1-3-dwt层"><a href="#4-2-1-3-dwt层" class="headerlink" title="4.2.1.3 dwt层"></a>4.2.1.3 dwt层</h4><h5 id="4-2-1-3-1-设备维度"><a href="#4-2-1-3-1-设备维度" class="headerlink" title="4.2.1.3.1 设备维度"></a>4.2.1.3.1 设备维度</h5><ul>
<li>建表</li>
</ul>
<p><strong>dwt_q6_device_stovmode_topic</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwt_q6_device_stovmode_topic;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwt_q6_device_stovmode_topic(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`st_ov_mode` string,</span><br><span class="line">`mode_date_first` string comment <span class="string">&#x27;首次使用时间&#x27;</span>,</span><br><span class="line">`mode_date_last` string comment <span class="string">&#x27;末次使用时间&#x27;</span>,</span><br><span class="line">`mode_day_count` <span class="type">bigint</span> comment <span class="string">&#x27;当日使用次数&#x27;</span>,</span><br><span class="line">`mode_count` <span class="type">bigint</span> comment <span class="string">&#x27;累积使用次数&#x27;</span>,</span><br><span class="line">`mor_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`mor_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积其他时段累计模式启动次数&#x27;</span></span><br><span class="line">)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwt/dwt_q6_device_stovmode_topic&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dws2dwt_device_stovmode_topic.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE dwt_q6_device_stovmode_topic</span><br><span class="line">SELECT</span><br><span class="line">nvl(new.device_type,old.device_type),</span><br><span class="line">nvl(new.iot_id,old.iot_id),</span><br><span class="line">nvl(new.request_id,old.request_id),</span><br><span class="line">nvl(new.check_failed_data,old.check_failed_data),</span><br><span class="line">nvl(new.product_key,old.product_key),</span><br><span class="line">nvl(new.device_name,old.device_name),</span><br><span class="line">nvl(new.st_ov_mode,old.st_ov_mode),</span><br><span class="line">if(old.mode_date_first is null,&#x27;$&#123;do_date&#125;&#x27;,old.mode_date_first),</span><br><span class="line">if(new.st_ov_mode is null,old.mode_date_last,&#x27;$&#123;do_date&#125;&#x27;),</span><br><span class="line">if(new.st_ov_mode is null,0,new.mode_count),</span><br><span class="line">nvl(new.mode_count,0) + nvl(old.mode_day_count,0),</span><br><span class="line">if(new.st_ov_mode is null,0,new.mor_count),</span><br><span class="line">nvl(new.mor_count,0) + nvl(old.mor_day_count,0),</span><br><span class="line">if(new.st_ov_mode is null,0,new.noo_count),</span><br><span class="line">nvl(new.noo_count,0) + nvl(old.noo_day_count,0),</span><br><span class="line">if(new.st_ov_mode is null,0,new.eve_count),</span><br><span class="line">nvl(new.eve_count,0) + nvl(old.eve_day_count,0),</span><br><span class="line">if(new.st_ov_mode is null,0,new.oth_count),</span><br><span class="line">nvl(new.oth_count,0) + nvl(old.oth_day_count,0)</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">    SELECT * FROM dwt_q6_device_stovmode_topic WHERE dt=date_sub(&#x27;$&#123;do_date&#125;&#x27;,1)</span><br><span class="line">) old</span><br><span class="line">FULL OUTER JOIN</span><br><span class="line">(</span><br><span class="line">    SELECT * FROM dws_q6_device_stovmode_daycount WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">) new</span><br><span class="line">ON old.st_ov_mode=new.st_ov_mode;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="4-2-1-3-2-用户维度"><a href="#4-2-1-3-2-用户维度" class="headerlink" title="4.2.1.3.2 用户维度"></a>4.2.1.3.2 用户维度</h5><ul>
<li>建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwt_q6_user_stovmode_topic;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwt_q6_user_stovmode_topic(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`mode_count`  <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日设备烟机总启动次数统计(启动次数，不是时段启动次数的和，跨时段不会多次计算)&#x27;</span>,</span><br><span class="line">`mode_amount`  <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计设备烟机总启动次数统计(启动次数，不是时段启动次数的和，跨时段不会多次计算)&#x27;</span>,</span><br><span class="line">`mor_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日6:00-10:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>, </span><br><span class="line">`mor_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计6:00-10:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`noo_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日10:00-14:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`noo_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计10:00-14:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`eve_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日16:00-20:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`eve_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计16:00-20:00烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`oth_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日其他时间段烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`oth_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计其他时间段烟机启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`mode0_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日未设定模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode0_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计未设定模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode1_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日经典蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode1_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计经典蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode2_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日快速蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode2_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计快速蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode33_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日风扇烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode33_using_alltime`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计风扇烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode34_using_time`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日强烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode34_using_alltime`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计强烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode35_using_time`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日热风烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode35_using_alltime`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计热风烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode36_using_time`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日上下加热模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode36_using_alltime`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计上下加热模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode37_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日热风烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode37_using_alltime`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计热风烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode38_using_time`   <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日立体热风模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode38_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计立体热风模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode39_using_time`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日嫩烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode39_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计嫩烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode65_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日解冻模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode65_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计解冻模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode66_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日发酵模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode66_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计发酵模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode67_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日杀菌模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode67_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计杀菌模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode68_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日保温模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode68_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计保温模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode69_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日烘干模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode69_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计烘干模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode70_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日除垢模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode70_using_alltime`  <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计除垢模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode71_using_time` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;当日延时模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode71_using_alltime` <span class="type">decimal</span>(<span class="number">38</span>,<span class="number">3</span>) COMMENT <span class="string">&#x27;总计延时模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode0_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日未设定模式次数统计&#x27;</span>,</span><br><span class="line">`mode0_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计未设定模式次数统计&#x27;</span>,</span><br><span class="line">`mode1_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日经典蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode1_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计经典蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode2_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日快速蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode2_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计快速蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode33_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日风扇烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode33_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计风扇烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode34_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日强烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode34_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计强烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode35_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日热风烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode35_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计热风烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode36_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日上下加热模式次数统计&#x27;</span>,</span><br><span class="line">`mode36_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计上下加热模式次数统计&#x27;</span>,</span><br><span class="line">`mode37_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日热风烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode37_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计热风烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode38_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日立体热风模式次数统计&#x27;</span>,</span><br><span class="line">`mode38_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计立体热风模式次数统计&#x27;</span>,</span><br><span class="line">`mode39_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日嫩烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode39_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计嫩烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode65_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日解冻模式次数统计&#x27;</span>,</span><br><span class="line">`mode65_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计解冻模式次数统计&#x27;</span>,</span><br><span class="line">`mode66_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日发酵模式次数统计&#x27;</span>,</span><br><span class="line">`mode66_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计发酵模式次数统计&#x27;</span>,</span><br><span class="line">`mode67_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日杀菌模式次数统计&#x27;</span>,</span><br><span class="line">`mode67_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计杀菌模式次数统计&#x27;</span>,</span><br><span class="line">`mode68_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日保温模式次数统计&#x27;</span>,</span><br><span class="line">`mode68_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计保温模式次数统计&#x27;</span>,</span><br><span class="line">`mode69_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日烘干模式次数统计&#x27;</span>,</span><br><span class="line">`mode69_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计烘干模式次数统计&#x27;</span>,</span><br><span class="line">`mode70_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日除垢模式次数统计&#x27;</span>,</span><br><span class="line">`mode70_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计除垢模式次数统计&#x27;</span>,</span><br><span class="line">`mode71_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日延时模式次数统计&#x27;</span>,</span><br><span class="line">`mode71_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计延时模式次数统计&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwt/dwt_q6_user_stovmode_topic&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>导入脚本</li>
</ul>
<p>首先创建自定义udf函数daytime_udf(‘0-115.581|1-83.281|33-2.448|36-5.677|38-1.358’,38)，可以传入key解析出对应的value值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line"></span><br><span class="line">with</span><br><span class="line">temp_count as</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">      nvl(new.device_type,old.device_type) device_type,</span><br><span class="line">      nvl(new.iot_id,old.iot_id) iot_id,</span><br><span class="line">      nvl(new.request_id,old.request_id) request_id,</span><br><span class="line">      nvl(new.check_failed_data,old.check_failed_data) check_failed_data,</span><br><span class="line">      nvl(new.product_key,old.product_key) product_key, </span><br><span class="line">      nvl(new.device_name,old.device_name) device_name,</span><br><span class="line">      nvl(new.mode_count,0) mode_count,</span><br><span class="line">      nvl(new.mode_count,0)+nvl(old.mode_amount,0) mode_amount,</span><br><span class="line">      nvl(new.mor_count,0) mor_count,</span><br><span class="line">      nvl(new.mor_count,0)+nvl(old.mor_amount,0) mor_amount,</span><br><span class="line">      nvl(new.noo_count,0) noo_count,</span><br><span class="line">      nvl(new.noo_count,0)+nvl(old.noo_amount,0) noo_amount,</span><br><span class="line">      nvl(new.eve_count,0) eve_count,</span><br><span class="line">      nvl(new.eve_count,0)+nvl(old.eve_amount,0) eve_amount,</span><br><span class="line">      nvl(new.oth_count,0) oth_count,</span><br><span class="line">      nvl(new.oth_count,0)+nvl(old.oth_amount,0) oth_amount</span><br><span class="line">    FROM </span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">          device_type,</span><br><span class="line">          iot_id,</span><br><span class="line">          request_id,</span><br><span class="line">          check_failed_data,</span><br><span class="line">          product_key,</span><br><span class="line">          device_name,</span><br><span class="line">          mode_amount,</span><br><span class="line">          mor_amount,</span><br><span class="line">          noo_amount,</span><br><span class="line">          eve_amount,</span><br><span class="line">          oth_amount</span><br><span class="line">        FROM dwt_q6_user_stovmode_topic</span><br><span class="line">        WHERE dt=date_sub(&#x27;$&#123;do_date&#125;&#x27;,1)</span><br><span class="line">    ) old</span><br><span class="line">    FULL OUTER JOIN</span><br><span class="line">    (</span><br><span class="line">        SELECT </span><br><span class="line">          device_type,</span><br><span class="line">          iot_id,</span><br><span class="line">          request_id,</span><br><span class="line">          check_failed_data,</span><br><span class="line">          product_key,</span><br><span class="line">          device_name,</span><br><span class="line">          mode_count,</span><br><span class="line">          mor_count,</span><br><span class="line">          noo_count,</span><br><span class="line">          eve_count,</span><br><span class="line">          oth_count</span><br><span class="line">        FROM dws_q6_user_stovmode_daycount</span><br><span class="line">        WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">    ) new ON old.iot_id=new.iot_id</span><br><span class="line">),</span><br><span class="line">temp_time as</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">      nvl(new.iot_id,old.iot_id) iot_id,</span><br><span class="line">      nvl(new.mode0_using_time,0) mode0_using_time,</span><br><span class="line">      nvl(new.mode0_using_time,0)+nvl(old.mode0_using_alltime,0) mode0_using_alltime,</span><br><span class="line">      nvl(new.mode1_using_time,0) mode1_using_time,</span><br><span class="line">      nvl(new.mode1_using_time,0)+nvl(old.mode1_using_alltime,0) mode1_using_alltime,</span><br><span class="line">      nvl(new.mode2_using_time,0) mode2_using_time,</span><br><span class="line">      nvl(new.mode2_using_time,0)+nvl(old.mode2_using_alltime,0) mode2_using_alltime,</span><br><span class="line">      nvl(new.mode33_using_time,0) mode33_using_time,</span><br><span class="line">      nvl(new.mode33_using_time,0)+nvl(old.mode33_using_alltime,0) mode33_using_alltime,</span><br><span class="line">      nvl(new.mode34_using_time,0) mode34_using_time,</span><br><span class="line">      nvl(new.mode34_using_time,0)+nvl(old.mode34_using_alltime,0) mode34_using_alltime,</span><br><span class="line">      nvl(new.mode35_using_time,0) mode35_using_time,</span><br><span class="line">      nvl(new.mode35_using_time,0)+nvl(old.mode35_using_alltime,0) mode35_using_alltime,</span><br><span class="line">      nvl(new.mode36_using_time,0) mode36_using_time,</span><br><span class="line">      nvl(new.mode36_using_time,0)+nvl(old.mode36_using_alltime,0) mode36_using_alltime,</span><br><span class="line">      nvl(new.mode37_using_time,0) mode37_using_time,</span><br><span class="line">      nvl(new.mode37_using_time,0)+nvl(old.mode37_using_alltime,0) mode37_using_alltime,</span><br><span class="line">      nvl(new.mode38_using_time,0) mode38_using_time,</span><br><span class="line">      nvl(new.mode38_using_time,0)+nvl(old.mode38_using_alltime,0) mode38_using_alltime,</span><br><span class="line">      nvl(new.mode39_using_time,0) mode39_using_time,</span><br><span class="line">      nvl(new.mode39_using_time,0)+nvl(old.mode39_using_alltime,0) mode39_using_alltime,</span><br><span class="line">      nvl(new.mode65_using_time,0) mode65_using_time,</span><br><span class="line">      nvl(new.mode65_using_time,0)+nvl(old.mode65_using_alltime,0) mode65_using_alltime,</span><br><span class="line">      nvl(new.mode66_using_time,0) mode66_using_time,</span><br><span class="line">      nvl(new.mode66_using_time,0)+nvl(old.mode66_using_alltime,0) mode66_using_alltime,</span><br><span class="line">      nvl(new.mode67_using_time,0) mode67_using_time,</span><br><span class="line">      nvl(new.mode67_using_time,0)+nvl(old.mode67_using_alltime,0) mode67_using_alltime,</span><br><span class="line">      nvl(new.mode68_using_time,0) mode68_using_time,</span><br><span class="line">      nvl(new.mode68_using_time,0)+nvl(old.mode68_using_alltime,0) mode68_using_alltime,</span><br><span class="line">      nvl(new.mode69_using_time,0) mode69_using_time,</span><br><span class="line">      nvl(new.mode69_using_time,0)+nvl(old.mode69_using_alltime,0) mode69_using_alltime,</span><br><span class="line">      nvl(new.mode70_using_time,0) mode70_using_time,</span><br><span class="line">      nvl(new.mode70_using_time,0)+nvl(old.mode70_using_alltime,0) mode70_using_alltime,</span><br><span class="line">      nvl(new.mode71_using_time,0) mode71_using_time,</span><br><span class="line">      nvl(new.mode71_using_time,0)+nvl(old.mode71_using_alltime,0) mode71_using_alltime,</span><br><span class="line">      nvl(new.mode0_count,0) mode0_count,</span><br><span class="line">      nvl(new.mode0_count,0)+nvl(old.mode0_amount,0) mode0_amount,</span><br><span class="line">      nvl(new.mode1_count,0) mode1_count,</span><br><span class="line">      nvl(new.mode1_count,0)+nvl(old.mode1_amount,0) mode1_amount,</span><br><span class="line">      nvl(new.mode2_count,0) mode2_count,</span><br><span class="line">      nvl(new.mode2_count,0)+nvl(old.mode2_amount,0) mode2_amount,</span><br><span class="line">      nvl(new.mode33_count,0) mode33_count,</span><br><span class="line">      nvl(new.mode33_count,0)+nvl(old.mode33_amount,0) mode33_amount,</span><br><span class="line">      nvl(new.mode34_count,0) mode34_count,</span><br><span class="line">      nvl(new.mode34_count,0)+nvl(old.mode34_amount,0) mode34_amount,</span><br><span class="line">      nvl(new.mode35_count,0) mode35_count,</span><br><span class="line">      nvl(new.mode35_count,0)+nvl(old.mode35_amount,0) mode35_amount,</span><br><span class="line">      nvl(new.mode36_count,0) mode36_count,</span><br><span class="line">      nvl(new.mode36_count,0)+nvl(old.mode36_amount,0) mode36_amount,</span><br><span class="line">      nvl(new.mode37_count,0) mode37_count,</span><br><span class="line">      nvl(new.mode37_count,0)+nvl(old.mode37_amount,0) mode37_amount,</span><br><span class="line">      nvl(new.mode38_count,0) mode38_count,</span><br><span class="line">      nvl(new.mode38_count,0)+nvl(old.mode38_amount,0) mode38_amount,</span><br><span class="line">      nvl(new.mode39_count,0) mode39_count,</span><br><span class="line">      nvl(new.mode39_count,0)+nvl(old.mode39_amount,0) mode39_amount,</span><br><span class="line">      nvl(new.mode65_count,0) mode65_count,</span><br><span class="line">      nvl(new.mode65_count,0)+nvl(old.mode65_amount,0) mode65_amount,</span><br><span class="line">      nvl(new.mode66_count,0) mode66_count,</span><br><span class="line">      nvl(new.mode66_count,0)+nvl(old.mode66_amount,0) mode66_amount,</span><br><span class="line">      nvl(new.mode67_count,0) mode67_count,</span><br><span class="line">      nvl(new.mode67_count,0)+nvl(old.mode67_amount,0) mode67_amount,</span><br><span class="line">      nvl(new.mode68_count,0) mode68_count,</span><br><span class="line">      nvl(new.mode68_count,0)+nvl(old.mode68_amount,0) mode68_amount,</span><br><span class="line">      nvl(new.mode69_count,0) mode69_count,</span><br><span class="line">      nvl(new.mode69_count,0)+nvl(old.mode69_amount,0) mode69_amount,</span><br><span class="line">      nvl(new.mode70_count,0) mode70_count,</span><br><span class="line">      nvl(new.mode70_count,0)+nvl(old.mode70_amount,0) mode70_amount,</span><br><span class="line">      nvl(new.mode71_count,0) mode71_count,</span><br><span class="line">      nvl(new.mode71_count,0)+nvl(old.mode71_amount,0) mode71_amount</span><br><span class="line">    FROM </span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">          iot_id,</span><br><span class="line">          mode0_using_alltime,</span><br><span class="line">          mode1_using_alltime,</span><br><span class="line">          mode2_using_alltime,</span><br><span class="line">          mode33_using_alltime,</span><br><span class="line">          mode34_using_alltime,</span><br><span class="line">          mode35_using_alltime,</span><br><span class="line">          mode36_using_alltime,</span><br><span class="line">          mode37_using_alltime,</span><br><span class="line">          mode38_using_alltime,</span><br><span class="line">          mode39_using_alltime,</span><br><span class="line">          mode65_using_alltime,</span><br><span class="line">          mode66_using_alltime,</span><br><span class="line">          mode67_using_alltime,</span><br><span class="line">          mode68_using_alltime,</span><br><span class="line">          mode69_using_alltime,</span><br><span class="line">          mode70_using_alltime,</span><br><span class="line">          mode71_using_alltime,</span><br><span class="line">          mode0_amount,</span><br><span class="line">          mode1_amount,</span><br><span class="line">          mode2_amount,</span><br><span class="line">          mode33_amount,</span><br><span class="line">          mode34_amount,</span><br><span class="line">          mode35_amount,</span><br><span class="line">          mode36_amount,</span><br><span class="line">          mode37_amount,</span><br><span class="line">          mode38_amount,</span><br><span class="line">          mode39_amount,</span><br><span class="line">          mode65_amount,</span><br><span class="line">          mode66_amount,</span><br><span class="line">          mode67_amount,</span><br><span class="line">          mode68_amount,</span><br><span class="line">          mode69_amount,</span><br><span class="line">          mode70_amount,</span><br><span class="line">          mode71_amount</span><br><span class="line">        FROM dwt_q6_user_stovmode_topic</span><br><span class="line">        WHERE dt=date_sub(&#x27;$&#123;do_date&#125;&#x27;,1)</span><br><span class="line">    ) old</span><br><span class="line">    FULL OUTER JOIN </span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">          iot_id,</span><br><span class="line">          daytime_udf(val,0) mode0_using_time,</span><br><span class="line">          daytime_udf(val,1) mode1_using_time,</span><br><span class="line">          daytime_udf(val,2) mode2_using_time,</span><br><span class="line">          daytime_udf(val,33) mode33_using_time,</span><br><span class="line">          daytime_udf(val,34) mode34_using_time,</span><br><span class="line">          daytime_udf(val,35) mode35_using_time,</span><br><span class="line">          daytime_udf(val,36) mode36_using_time,</span><br><span class="line">          daytime_udf(val,37) mode37_using_time,</span><br><span class="line">          daytime_udf(val,38) mode38_using_time,</span><br><span class="line">          daytime_udf(val,39) mode39_using_time,</span><br><span class="line">          daytime_udf(val,65) mode65_using_time,</span><br><span class="line">          daytime_udf(val,66) mode66_using_time,</span><br><span class="line">          daytime_udf(val,67) mode67_using_time,</span><br><span class="line">          daytime_udf(val,68) mode68_using_time,</span><br><span class="line">          daytime_udf(val,69) mode69_using_time,</span><br><span class="line">          daytime_udf(val,70) mode70_using_time,</span><br><span class="line">          daytime_udf(val,71) mode71_using_time,</span><br><span class="line">          daytime_udf(valc,0) mode0_count,</span><br><span class="line">          daytime_udf(valc,1) mode1_count,</span><br><span class="line">          daytime_udf(valc,2) mode2_count,</span><br><span class="line">          daytime_udf(valc,33) mode33_count,</span><br><span class="line">          daytime_udf(valc,34) mode34_count,</span><br><span class="line">          daytime_udf(valc,35) mode35_count,</span><br><span class="line">          daytime_udf(valc,36) mode36_count,</span><br><span class="line">          daytime_udf(valc,37) mode37_count,</span><br><span class="line">          daytime_udf(valc,38) mode38_count,</span><br><span class="line">          daytime_udf(valc,39) mode39_count,</span><br><span class="line">          daytime_udf(valc,65) mode65_count,</span><br><span class="line">          daytime_udf(valc,66) mode66_count,</span><br><span class="line">          daytime_udf(valc,67) mode67_count,</span><br><span class="line">          daytime_udf(valc,68) mode68_count,</span><br><span class="line">          daytime_udf(valc,69) mode69_count,</span><br><span class="line">          daytime_udf(valc,70) mode70_count,</span><br><span class="line">          daytime_udf(valc,71) mode71_count</span><br><span class="line">        FROM </span><br><span class="line">        (</span><br><span class="line">            SELECT</span><br><span class="line">              iot_id,</span><br><span class="line">              concat_ws(&#x27;|&#x27;,collect_set(concat(st_ov_mode,&#x27;-&#x27;,using_time))) val,</span><br><span class="line">              concat_ws(&#x27;|&#x27;,collect_set(concat(st_ov_mode,&#x27;-&#x27;,start_count))) valc</span><br><span class="line">            FROM dws_q6_user_stovmode_daytime</span><br><span class="line">            WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">            GROUP BY iot_id</span><br><span class="line">        ) tmp</span><br><span class="line">    ) new ON old.iot_id=new.iot_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT OVERWRITE TABLE dwt_q6_user_stovmode_topic</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT</span><br><span class="line">  device_type,</span><br><span class="line">  temp_count.iot_id,</span><br><span class="line">  request_id,</span><br><span class="line">  check_failed_data,</span><br><span class="line">  product_key,</span><br><span class="line">  device_name,</span><br><span class="line">  mode_count,</span><br><span class="line">  mode_amount,</span><br><span class="line">  mor_count, </span><br><span class="line">  mor_amount,</span><br><span class="line">  noo_count,</span><br><span class="line">  noo_amount,</span><br><span class="line">  eve_count,</span><br><span class="line">  eve_amount,</span><br><span class="line">  oth_count,</span><br><span class="line">  oth_amount,</span><br><span class="line">  mode0_using_time,</span><br><span class="line">  mode0_using_alltime,</span><br><span class="line">  mode1_using_time,</span><br><span class="line">  mode1_using_alltime,</span><br><span class="line">  mode2_using_time,</span><br><span class="line">  mode2_using_alltime,</span><br><span class="line">  mode33_using_time,</span><br><span class="line">  mode33_using_alltime,</span><br><span class="line">  mode34_using_time,</span><br><span class="line">  mode34_using_alltime,</span><br><span class="line">  mode35_using_time,</span><br><span class="line">  mode35_using_alltime,</span><br><span class="line">  mode36_using_time,</span><br><span class="line">  mode36_using_alltime,</span><br><span class="line">  mode37_using_time,</span><br><span class="line">  mode37_using_alltime,</span><br><span class="line">  mode38_using_time,</span><br><span class="line">  mode38_using_alltime,</span><br><span class="line">  mode39_using_time,</span><br><span class="line">  mode39_using_alltime,</span><br><span class="line">  mode65_using_time,</span><br><span class="line">  mode65_using_alltime,</span><br><span class="line">  mode66_using_time,</span><br><span class="line">  mode66_using_alltime,</span><br><span class="line">  mode67_using_time,</span><br><span class="line">  mode67_using_alltime,</span><br><span class="line">  mode68_using_time,</span><br><span class="line">  mode68_using_alltime,</span><br><span class="line">  mode69_using_time,</span><br><span class="line">  mode69_using_alltime,</span><br><span class="line">  mode70_using_time,</span><br><span class="line">  mode70_using_alltime,</span><br><span class="line">  mode71_using_time,</span><br><span class="line">  mode71_using_alltime,</span><br><span class="line">  mode0_count,</span><br><span class="line">  mode0_amount,</span><br><span class="line">  mode1_count,</span><br><span class="line">  mode1_amount,</span><br><span class="line">  mode2_count,</span><br><span class="line">  mode2_amount,</span><br><span class="line">  mode33_count,</span><br><span class="line">  mode33_amount,</span><br><span class="line">  mode34_count,</span><br><span class="line">  mode34_amount,</span><br><span class="line">  mode35_count,</span><br><span class="line">  mode35_amount,</span><br><span class="line">  mode36_count,</span><br><span class="line">  mode36_amount,</span><br><span class="line">  mode37_count,</span><br><span class="line">  mode37_amount,</span><br><span class="line">  mode38_count,</span><br><span class="line">  mode38_amount,</span><br><span class="line">  mode39_count,</span><br><span class="line">  mode39_amount,</span><br><span class="line">  mode65_count,</span><br><span class="line">  mode65_amount,</span><br><span class="line">  mode66_count,</span><br><span class="line">  mode66_amount,</span><br><span class="line">  mode67_count,</span><br><span class="line">  mode67_amount,</span><br><span class="line">  mode68_count,</span><br><span class="line">  mode68_amount,</span><br><span class="line">  mode69_count,</span><br><span class="line">  mode69_amount,</span><br><span class="line">  mode70_count,</span><br><span class="line">  mode70_amount,</span><br><span class="line">  mode71_count,</span><br><span class="line">  mode71_amount</span><br><span class="line">FROM temp_count</span><br><span class="line">JOIN temp_time ON temp_count.iot_id=temp_time.iot_id;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="4-2-1-4-ads层"><a href="#4-2-1-4-ads层" class="headerlink" title="4.2.1.4 ads层"></a>4.2.1.4 ads层</h4><h5 id="4-2-1-4-1-设备维度"><a href="#4-2-1-4-1-设备维度" class="headerlink" title="4.2.1.4.1 设备维度"></a>4.2.1.4.1 设备维度</h5><ul>
<li>建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> ads_q6_device_stovmode_count;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> ads_q6_device_stovmode_count(</span><br><span class="line">`<span class="type">date</span>` string COMMENT <span class="string">&#x27;统计日期&#x27;</span>,</span><br><span class="line">`product_key` string,</span><br><span class="line">`mode_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日设备烟机总启动次数统计(启动次数，不是时段启动次数的和，跨时段不会多次计算)&#x27;</span>,</span><br><span class="line">`mode_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计设备烟机总启动次数统计(启动次数，不是时段启动次数的和，跨时段不会多次计算)&#x27;</span>,</span><br><span class="line">`mor_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日6:00-10:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>, </span><br><span class="line">`mor_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计6:00-10:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`noo_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日10:00-14:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`noo_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计10:00-14:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`eve_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日16:00-20:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`eve_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计16:00-20:00蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`oth_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日其他时间段蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`oth_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计其他时间段蒸烤箱启动次数统计(跨时段会多次计算)&#x27;</span>,</span><br><span class="line">`mode0_using_time` string COMMENT <span class="string">&#x27;当日未设定模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode0_using_alltime` string COMMENT <span class="string">&#x27;总计未设定模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode1_using_time` string COMMENT <span class="string">&#x27;当日经典蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode1_using_alltime` string COMMENT <span class="string">&#x27;总计经典蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode2_using_time` string COMMENT <span class="string">&#x27;当日快速蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode2_using_alltime` string COMMENT <span class="string">&#x27;总计快速蒸模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode33_using_time` string COMMENT <span class="string">&#x27;当日风扇烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode33_using_alltime` string COMMENT <span class="string">&#x27;总计风扇烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode34_using_time` string COMMENT <span class="string">&#x27;当日强烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode34_using_alltime` string COMMENT <span class="string">&#x27;总计强烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode35_using_time` string COMMENT <span class="string">&#x27;当日热风烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode35_using_alltime` string COMMENT <span class="string">&#x27;总计热风烧烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode36_using_time` string COMMENT <span class="string">&#x27;当日上下加热模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode36_using_alltime` string COMMENT <span class="string">&#x27;总计上下加热模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode37_using_time` string COMMENT <span class="string">&#x27;当日热风烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode37_using_alltime` string COMMENT <span class="string">&#x27;总计热风烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode38_using_time` string COMMENT <span class="string">&#x27;当日立体热风模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode38_using_alltime` string COMMENT <span class="string">&#x27;总计立体热风模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode39_using_time` string COMMENT <span class="string">&#x27;当日嫩烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode39_using_alltime` string COMMENT <span class="string">&#x27;总计嫩烤模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode65_using_time` string COMMENT <span class="string">&#x27;当日解冻模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode65_using_alltime` string COMMENT <span class="string">&#x27;总计解冻模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode66_using_time` string COMMENT <span class="string">&#x27;当日发酵模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode66_using_alltime` string COMMENT <span class="string">&#x27;总计发酵模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode67_using_time` string COMMENT <span class="string">&#x27;当日杀菌模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode67_using_alltime` string COMMENT <span class="string">&#x27;总计杀菌模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode68_using_time` string COMMENT <span class="string">&#x27;当日保温模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode68_using_alltime` string COMMENT <span class="string">&#x27;总计保温模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode69_using_time` string COMMENT <span class="string">&#x27;当日烘干模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode69_using_alltime` string COMMENT <span class="string">&#x27;总计烘干模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode70_using_time` string COMMENT <span class="string">&#x27;当日除垢模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode70_using_alltime` string COMMENT <span class="string">&#x27;总计除垢模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode71_using_time` string COMMENT <span class="string">&#x27;当日延时模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode71_using_alltime` string COMMENT <span class="string">&#x27;总计延时模式使用时间统计&#x27;</span>,</span><br><span class="line">`mode0_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日未设定模式次数统计&#x27;</span>,</span><br><span class="line">`mode0_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计未设定模式次数统计&#x27;</span>,</span><br><span class="line">`mode1_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日经典蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode1_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计经典蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode2_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日快速蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode2_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计快速蒸模式次数统计&#x27;</span>,</span><br><span class="line">`mode33_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日风扇烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode33_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计风扇烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode34_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日强烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode34_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计强烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode35_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日热风烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode35_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计热风烧烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode36_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日上下加热模式次数统计&#x27;</span>,</span><br><span class="line">`mode36_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计上下加热模式次数统计&#x27;</span>,</span><br><span class="line">`mode37_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日热风烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode37_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计热风烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode38_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日立体热风模式次数统计&#x27;</span>,</span><br><span class="line">`mode38_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计立体热风模式次数统计&#x27;</span>,</span><br><span class="line">`mode39_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日嫩烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode39_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计嫩烤模式次数统计&#x27;</span>,</span><br><span class="line">`mode65_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日解冻模式次数统计&#x27;</span>,</span><br><span class="line">`mode65_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计解冻模式次数统计&#x27;</span>,</span><br><span class="line">`mode66_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日发酵模式次数统计&#x27;</span>,</span><br><span class="line">`mode66_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计发酵模式次数统计&#x27;</span>,</span><br><span class="line">`mode67_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日杀菌模式次数统计&#x27;</span>,</span><br><span class="line">`mode67_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计杀菌模式次数统计&#x27;</span>,</span><br><span class="line">`mode68_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日保温模式次数统计&#x27;</span>,</span><br><span class="line">`mode68_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计保温模式次数统计&#x27;</span>,</span><br><span class="line">`mode69_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日烘干模式次数统计&#x27;</span>,</span><br><span class="line">`mode69_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计烘干模式次数统计&#x27;</span>,</span><br><span class="line">`mode70_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日除垢模式次数统计&#x27;</span>,</span><br><span class="line">`mode70_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计除垢模式次数统计&#x27;</span>,</span><br><span class="line">`mode71_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日延时模式次数统计&#x27;</span>,</span><br><span class="line">`mode71_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;总计延时模式次数统计&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;	&#x27;</span></span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/ads/ads_q6_device_stovmode_count&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE ads_q6_device_stovmode_count</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">  &#x27;$&#123;do_date&#125;&#x27;,</span><br><span class="line">  product_key,</span><br><span class="line">  cast(sum(mode_count) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode_amount) as decimal(38,3)),</span><br><span class="line">  cast(sum(mor_count) as decimal(38,3)),</span><br><span class="line">  cast(sum(mor_amount) as decimal(38,3)),</span><br><span class="line">  cast(sum(noo_count) as decimal(38,3)),</span><br><span class="line">  cast(sum(noo_amount) as decimal(38,3)),</span><br><span class="line">  cast(sum(eve_count) as decimal(38,3)),</span><br><span class="line">  cast(sum(eve_amount) as decimal(38,3)),</span><br><span class="line">  cast(sum(oth_count) as decimal(38,3)),</span><br><span class="line">  cast(sum(oth_amount) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode0_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode0_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode1_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode1_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode2_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode2_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode33_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode33_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode34_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode34_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode35_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode35_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode36_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode36_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode37_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode37_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode38_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode38_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode39_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode39_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode65_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode65_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode66_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode66_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode67_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode67_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode68_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode68_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode69_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode69_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode70_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode70_using_alltime) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode71_using_time) as decimal(38,3)),</span><br><span class="line">  cast(sum(mode71_using_alltime) as decimal(38,3)),</span><br><span class="line">  sum(mode0_count),</span><br><span class="line">  sum(mode0_amount),</span><br><span class="line">  sum(mode1_count),</span><br><span class="line">  sum(mode1_amount),</span><br><span class="line">  sum(mode2_count),</span><br><span class="line">  sum(mode2_amount),</span><br><span class="line">  sum(mode33_count),</span><br><span class="line">  sum(mode33_amount),</span><br><span class="line">  sum(mode34_count),</span><br><span class="line">  sum(mode34_amount),</span><br><span class="line">  sum(mode35_count),</span><br><span class="line">  sum(mode35_amount),</span><br><span class="line">  sum(mode36_count),</span><br><span class="line">  sum(mode36_amount),</span><br><span class="line">  sum(mode37_count),</span><br><span class="line">  sum(mode37_amount),</span><br><span class="line">  sum(mode38_count),</span><br><span class="line">  sum(mode38_amount),</span><br><span class="line">  sum(mode39_count),</span><br><span class="line">  sum(mode39_amount),</span><br><span class="line">  sum(mode65_count),</span><br><span class="line">  sum(mode65_amount),</span><br><span class="line">  sum(mode66_count),</span><br><span class="line">  sum(mode66_amount),</span><br><span class="line">  sum(mode67_count),</span><br><span class="line">  sum(mode67_amount),</span><br><span class="line">  sum(mode68_count),</span><br><span class="line">  sum(mode68_amount),</span><br><span class="line">  sum(mode69_count),</span><br><span class="line">  sum(mode69_amount),</span><br><span class="line">  sum(mode70_count),</span><br><span class="line">  sum(mode70_amount),</span><br><span class="line">  sum(mode71_count),</span><br><span class="line">  sum(mode71_amount)</span><br><span class="line">FROM dwt_q6_user_stovmode_topic</span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">GROUP BY product_key;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>如下已废弃</strong></p>
<ul>
<li>建表</li>
</ul>
<p><strong>ads_q6_device_stovmode_count</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> ads_q6_device_stovmode_count;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> ads_q6_device_stovmode_count(</span><br><span class="line">`dt` string COMMENT <span class="string">&#x27;统计日期&#x27;</span>,</span><br><span class="line">`st_ov_mode` string COMMENT <span class="string">&#x27;模式类型&#x27;</span>,</span><br><span class="line">`mode_date_first` string COMMENT <span class="string">&#x27;首次使用时间&#x27;</span>,</span><br><span class="line">`mode_date_last` string COMMENT <span class="string">&#x27;末次使用时间&#x27;</span>,</span><br><span class="line">`day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日启动次数&#x27;</span>,</span><br><span class="line">`mor_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`week_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当周启动次数&#x27;</span>,</span><br><span class="line">`mor_week_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_week_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当周10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_week_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当周16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_week_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当周其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`month_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月启动次数&#x27;</span>,</span><br><span class="line">`mor_month_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_month_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_month_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_month_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当月其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`quarter_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当季启动次数&#x27;</span>,</span><br><span class="line">`mor_quarter_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当季6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_quarter_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当季10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_quarter_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当季16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_quarter_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当季其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累计总启动次数&#x27;</span>,</span><br><span class="line">`mor_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积6:00-10:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`noo_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积10:00-14:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`eve_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积16:00-20:00累计模式启动次数&#x27;</span>,</span><br><span class="line">`oth_amount` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积其他时段累计模式启动次数&#x27;</span>,</span><br><span class="line">`is_weekend` string COMMENT <span class="string">&#x27;Y表示当天是周末,N表示当天不是周末&#x27;</span>,</span><br><span class="line">`is_monthend` string COMMENT <span class="string">&#x27;Y表示当天是月末,N表示当天不是月末&#x27;</span>,</span><br><span class="line">`is_quarterend` string COMMENT <span class="string">&#x27;Y表示当天是季末,N表示当天不是季末&#x27;</span></span><br><span class="line">) </span><br><span class="line"><span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;	&#x27;</span></span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/ads/ads_q6_device_stovmode_count&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dwt2ads_device_stovmode_count.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT INTO TABLE ads_q6_device_stovmode_count</span><br><span class="line">SELECT </span><br><span class="line">  &#x27;$&#123;do_date&#125;&#x27;,</span><br><span class="line">  daycount.st_ov_mode,</span><br><span class="line">  daycount.mode_date_first,</span><br><span class="line">  daycount.mode_date_last,</span><br><span class="line">  daycount.day_count,</span><br><span class="line">  daycount.mor_day_count,</span><br><span class="line">  daycount.noo_day_count,</span><br><span class="line">  daycount.eve_day_count,</span><br><span class="line">  daycount.oth_day_count,</span><br><span class="line">  wkcount.week_count,</span><br><span class="line">  wkcount.mor_week_count,</span><br><span class="line">  wkcount.noo_week_count,</span><br><span class="line">  wkcount.eve_week_count,</span><br><span class="line">  wkcount.oth_week_count,</span><br><span class="line">  mncount.month_count,</span><br><span class="line">  mncount.mor_month_count,</span><br><span class="line">  mncount.noo_month_count,</span><br><span class="line">  mncount.eve_month_count,</span><br><span class="line">  mncount.oth_month_count,</span><br><span class="line">  qtcount.quarter_count,</span><br><span class="line">  qtcount.mor_quarter_count,</span><br><span class="line">  qtcount.noo_quarter_count,</span><br><span class="line">  qtcount.eve_quarter_count,</span><br><span class="line">  qtcount.oth_quarter_count,</span><br><span class="line">  daycount.amount,</span><br><span class="line">  daycount.mor_amount,</span><br><span class="line">  daycount.noo_amount,</span><br><span class="line">  daycount.eve_amount,</span><br><span class="line">  daycount.oth_amount,</span><br><span class="line">  if(date_add(next_day(&#x27;$&#123;do_date&#125;&#x27;,&#x27;MO&#x27;),-1)=&#x27;$&#123;do_date&#125;&#x27;,&#x27;Y&#x27;,&#x27;N&#x27;),</span><br><span class="line">  if(last_day(&#x27;$&#123;do_date&#125;&#x27;)=&#x27;$&#123;do_date&#125;&#x27;,&#x27;Y&#x27;,&#x27;N&#x27;),</span><br><span class="line">  if(last_day(&#x27;$&#123;do_date&#125;&#x27;)=&#x27;$&#123;do_date&#125;&#x27; and substr(&#x27;$&#123;do_date&#125;&#x27;,6,2) in (3,6,9,12),&#x27;Y&#x27;,&#x27;N&#x27;)</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  mode_date_first,</span><br><span class="line">  mode_date_last,</span><br><span class="line">  mode_day_count day_count,</span><br><span class="line">  mor_day_count,</span><br><span class="line">  noo_day_count,</span><br><span class="line">  eve_day_count,</span><br><span class="line">  oth_day_count,</span><br><span class="line">  mode_count amount,</span><br><span class="line">  mor_count mor_amount,</span><br><span class="line">  noo_count noo_amount,</span><br><span class="line">  eve_count eve_amount,</span><br><span class="line">  oth_count oth_amount</span><br><span class="line">FROM dwt_q6_device_stovmode_topic</span><br><span class="line">) daycount</span><br><span class="line">JOIN </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  sum(mode_count) week_count,</span><br><span class="line">  sum(mor_count) mor_week_count,</span><br><span class="line">  sum(noo_count) noo_week_count,</span><br><span class="line">  sum(eve_count) eve_week_count,</span><br><span class="line">  sum(oth_count) oth_week_count</span><br><span class="line">FROM dws_q6_device_stovmode_daycount</span><br><span class="line">WHERE dt&gt;=date_add(next_day(&#x27;$&#123;do_date&#125;&#x27;,&#x27;MO&#x27;),-7) </span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) wkcount ON daycount.st_ov_mode=wkcount.st_ov_mode</span><br><span class="line">JOIN </span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  sum(mode_count) month_count,</span><br><span class="line">  sum(mor_count) mor_month_count,</span><br><span class="line">  sum(noo_count) noo_month_count,</span><br><span class="line">  sum(eve_count) eve_month_count,</span><br><span class="line">  sum(oth_count) oth_month_count</span><br><span class="line">FROM dws_q6_device_stovmode_daycount</span><br><span class="line">WHERE date_format(dt,&#x27;yyyy-MM&#x27;)=date_format(&#x27;$&#123;do_date&#125;&#x27;,&#x27;yyyy-MM&#x27;)</span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) mncount ON daycount.st_ov_mode=mncount.st_ov_mode</span><br><span class="line">JOIN</span><br><span class="line">(</span><br><span class="line">SELECT </span><br><span class="line">  st_ov_mode,</span><br><span class="line">  sum(mode_count) quarter_count,</span><br><span class="line">  sum(mor_count) mor_quarter_count,</span><br><span class="line">  sum(noo_count) noo_quarter_count,</span><br><span class="line">  sum(eve_count) eve_quarter_count,</span><br><span class="line">  sum(oth_count) oth_quarter_count</span><br><span class="line">FROM dws_q6_device_stovmode_daycount</span><br><span class="line">WHERE substr(dt,6,2) between ceil(substr(&#x27;$&#123;do_date&#125;&#x27;,6,2)/3)*3-2 and ceil(substr(&#x27;$&#123;do_date&#125;&#x27;,6,2)/3)*3 </span><br><span class="line">GROUP BY st_ov_mode</span><br><span class="line">) qtcount ON daycount.st_ov_mode=qtcount.st_ov_mode</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-2-1-4-2-用户维度"><a href="#4-2-1-4-2-用户维度" class="headerlink" title="4.2.1.4.2 用户维度"></a>4.2.1.4.2 用户维度</h5><ul>
<li><p>建表</p>
</li>
<li><p>导入脚本</p>
</li>
</ul>
<h4 id="4-2-1-5-导出到mysql"><a href="#4-2-1-5-导出到mysql" class="headerlink" title="4.2.1.5 导出到mysql"></a>4.2.1.5 导出到mysql</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mysql_db_name=device_model_log</span><br><span class="line">hive_dir_name=device_model_log</span><br><span class="line"></span><br><span class="line">export_data() &#123;</span><br><span class="line">/opt/module/sqoop-1.4.6/bin/sqoop export \</span><br><span class="line">--connect &quot;jdbc:mysql://bigdata3:3306/$&#123;mysql_db_name&#125;?useUnicode=true&amp;characterEncoding=utf-8&quot; \</span><br><span class="line">--username root \</span><br><span class="line">--password hxr \</span><br><span class="line">--table $1 \</span><br><span class="line">--num-mappers 1 \</span><br><span class="line">--hive-partition-key dt \</span><br><span class="line">--hive-partition-value $3 \</span><br><span class="line">--export-dir /warehouse/$&#123;hive_dir_name&#125;/ads/$2/dt=$3 \</span><br><span class="line">--input-fields-terminated-by &quot;	&quot; \</span><br><span class="line">--update-mode allowinsert \</span><br><span class="line">--update-key $4 \</span><br><span class="line">--input-null-string &#x27;\N&#x27; \</span><br><span class="line">--input-null-non-string &#x27;\N&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export_data &quot;ads_q6_device_stovmode_count&quot; &quot;ads_q6_device_stovmode_count&quot; $do_date &quot;date,product_key&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="4-2-2-集成灶故障类型发生频率统计-errorcode"><a href="#4-2-2-集成灶故障类型发生频率统计-errorcode" class="headerlink" title="4.2.2 集成灶故障类型发生频率统计 errorcode"></a>4.2.2 集成灶故障类型发生频率统计 errorcode</h3><h4 id="4-2-2-1-dwd层"><a href="#4-2-2-1-dwd层" class="headerlink" title="4.2.2.1 dwd层"></a>4.2.2.1 dwd层</h4><ul>
<li>建表</li>
</ul>
<p><strong>dwd_q6_errorcode_log</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwd_q6_errorcode_log;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwd_q6_errorcode_log (</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`gmt_create` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`error_code` string,</span><br><span class="line">`event_time` string</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwd/dwd_q6_errorcode_log&#x27;</span></span><br><span class="line">TBLPROPERTIES(<span class="string">&#x27;parquet.compression&#x27;</span><span class="operator">=</span><span class="string">&#x27;lzo&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dwd2dwd_errorcode_log.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line">    </span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE $&#123;APP&#125;.dwd_q6_errorcode_log</span><br><span class="line">partition(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">device_type,</span><br><span class="line">iot_id,</span><br><span class="line">request_id,</span><br><span class="line">check_failed_data,</span><br><span class="line">product_key,</span><br><span class="line">gmt_create,</span><br><span class="line">device_name,</span><br><span class="line">event_code,</span><br><span class="line">event_time</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_event_log LATERAL VIEW errorcode_analizer(event_value) tmp_errorcode AS event_code </span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27; AND event_name=&#x27;ErrorCode&#x27;;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="4-2-2-2-dws层"><a href="#4-2-2-2-dws层" class="headerlink" title="4.2.2.2 dws层"></a>4.2.2.2 dws层</h4><h5 id="4-2-2-2-1-设备维度"><a href="#4-2-2-2-1-设备维度" class="headerlink" title="4.2.2.2.1 设备维度"></a>4.2.2.2.1 设备维度</h5><h6 id="4-2-2-2-1-1-发生频率统计"><a href="#4-2-2-2-1-1-发生频率统计" class="headerlink" title="4.2.2.2.1.1 发生频率统计"></a>4.2.2.2.1.1 发生频率统计</h6><ul>
<li>建表</li>
</ul>
<p><strong>dws_q6_device_errorcode_daycount</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dws_q6_device_errorcode_daycount;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> dws_q6_device_errorcode_daycount(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`error_code` string,</span><br><span class="line">`error_count` string</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dws/dws_q6_device_errorcode_daycount&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dwd2dws_device_errorcode_count.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE $&#123;APP&#125;.dws_q6_device_errorcode_daycount</span><br><span class="line">partition(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(device_type)) deviceType, </span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(iot_id)) iotId,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(request_id)) requestId,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(check_failed_data)) checkFailedData,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(product_key)) productKey,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(device_name)) deviceName,</span><br><span class="line">error_code,</span><br><span class="line">count(*)</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_errorcode_log </span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">GROUP BY error_code;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="4-2-2-2-2-用户维度"><a href="#4-2-2-2-2-用户维度" class="headerlink" title="4.2.2.2.2 用户维度"></a>4.2.2.2.2 用户维度</h5><h6 id="4-2-2-2-1-1-发生频率统计-1"><a href="#4-2-2-2-1-1-发生频率统计-1" class="headerlink" title="4.2.2.2.1.1 发生频率统计"></a>4.2.2.2.1.1 发生频率统计</h6><ul>
<li>建表</li>
</ul>
<p><strong>dws_q6_user_errorcode_daycount</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dws_q6_user_errorcode_daycount;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> dws_q6_user_errorcode_daycount(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`error_code` string,</span><br><span class="line">`error_count` string</span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dws/dws_q6_user_errorcode_daycount&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本<br><strong>dwd2dws_user_errorcode_count.sh</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line"></span><br><span class="line">INSERT OVERWRITE TABLE dws_q6_user_errorcode_daycount</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT </span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(device_type)) deviceType, </span><br><span class="line">iot_id,</span><br><span class="line">&#x27;&#x27; requestId,</span><br><span class="line">&#x27;&#x27; checkFailedData,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(product_key)) productKey,</span><br><span class="line">concat_ws(&#x27;|&#x27;,collect_set(device_name)) deviceName,</span><br><span class="line">error_code,</span><br><span class="line">count(*)</span><br><span class="line">FROM $&#123;APP&#125;.dwd_q6_errorcode_log </span><br><span class="line">WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">GROUP BY iot_id,error_code;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-3-dwt层"><a href="#4-2-2-3-dwt层" class="headerlink" title="4.2.2.3 dwt层"></a>4.2.2.3 dwt层</h4><h5 id="4-2-2-3-1-设备维度"><a href="#4-2-2-3-1-设备维度" class="headerlink" title="4.2.2.3.1 设备维度"></a>4.2.2.3.1 设备维度</h5><h6 id="4-2-2-3-1-1-发生频率统计"><a href="#4-2-2-3-1-1-发生频率统计" class="headerlink" title="4.2.2.3.1.1 发生频率统计"></a>4.2.2.3.1.1 发生频率统计</h6><ul>
<li>建表</li>
</ul>
<p><strong>dwt_q6_device_errorcode_topic</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwt_q6_device_errorcode_topic;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwt_q6_device_errorcode_topic(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`error_code` string,</span><br><span class="line">`error_date_first` string COMMENT <span class="string">&#x27;首次发生时间&#x27;</span>,</span><br><span class="line">`error_date_last` string COMMENT <span class="string">&#x27;末次发生时间&#x27;</span>,</span><br><span class="line">`error_day_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;当日发生次数&#x27;</span>,</span><br><span class="line">`error_count` <span class="type">bigint</span> COMMENT <span class="string">&#x27;累积发生次数&#x27;</span></span><br><span class="line">)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwt/dwt_q6_device_errorcode_topic&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本</li>
</ul>
<p><strong>dws2dwt_device_errorcode_topic.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line">    </span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line">INSERT OVERWRITE TABLE dwt_q6_device_errorcode_topic</span><br><span class="line">SELECT </span><br><span class="line">nvl(new.device_type,old.device_type),</span><br><span class="line">nvl(new.iot_id,old.iot_id),</span><br><span class="line">nvl(new.request_id,old.request_id),</span><br><span class="line">nvl(new.check_failed_data,old.check_failed_data),</span><br><span class="line">nvl(new.product_key,old.product_key),</span><br><span class="line">nvl(new.device_name,old.device_name),</span><br><span class="line">nvl(new.error_code,old.error_code),</span><br><span class="line">if(old.error_date_first is null,&#x27;$&#123;do_date&#125;&#x27;,old.error_date_first),</span><br><span class="line">if(new.error_code is null,old.error_date_first,&#x27;$&#123;do_date&#125;&#x27;),</span><br><span class="line">if(new.error_code is null,0,new.error_count),</span><br><span class="line">nvl(new.error_count,0) + nvl(old.error_day_count,0)</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">    SELECT * FROM dwt_q6_device_errorcode_topic</span><br><span class="line">) old</span><br><span class="line">full outer join</span><br><span class="line">(</span><br><span class="line">    SELECT * FROM dws_q6_device_errorcode_daycount WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">) new</span><br><span class="line">ON old.error_code=new.error_code</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="4-2-2-3-2-用户维度"><a href="#4-2-2-3-2-用户维度" class="headerlink" title="4.2.2.3.2 用户维度"></a>4.2.2.3.2 用户维度</h5><h6 id="4-2-2-3-2-1-发生频率统计"><a href="#4-2-2-3-2-1-发生频率统计" class="headerlink" title="4.2.2.3.2.1 发生频率统计"></a>4.2.2.3.2.1 发生频率统计</h6><ul>
<li>建表<br><strong>dwt_q6_user_errorcode_topic</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> dwt_q6_user_errorcode_topic;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> dwt_q6_user_errorcode_topic(</span><br><span class="line">`device_type` string,</span><br><span class="line">`iot_id` string,</span><br><span class="line">`request_id` string,</span><br><span class="line">`check_failed_data` string,</span><br><span class="line">`product_key` string,</span><br><span class="line">`device_name` string,</span><br><span class="line">`e1_count` <span class="type">bigint</span>,</span><br><span class="line">`e1_amount` <span class="type">bigint</span>,</span><br><span class="line">`e2_count` <span class="type">bigint</span>,</span><br><span class="line">`e2_amount` <span class="type">bigint</span>,</span><br><span class="line">`e3_count` <span class="type">bigint</span>,</span><br><span class="line">`e3_amount` <span class="type">bigint</span>,</span><br><span class="line">`e4_count` <span class="type">bigint</span>,</span><br><span class="line">`e4_amount` <span class="type">bigint</span>,</span><br><span class="line">`e5_count` <span class="type">bigint</span>,</span><br><span class="line">`e5_amount` <span class="type">bigint</span>,</span><br><span class="line">`e6_count` <span class="type">bigint</span>,</span><br><span class="line">`e6_amount` <span class="type">bigint</span>,</span><br><span class="line">`e7_count` <span class="type">bigint</span>,</span><br><span class="line">`e7_amount` <span class="type">bigint</span>,</span><br><span class="line">`e8_count` <span class="type">bigint</span>,</span><br><span class="line">`e8_amount` <span class="type">bigint</span>,</span><br><span class="line">`e9_count` <span class="type">bigint</span>,</span><br><span class="line">`e9_amount` <span class="type">bigint</span>,</span><br><span class="line">`e10_count` <span class="type">bigint</span>,</span><br><span class="line">`e10_amount` <span class="type">bigint</span>,</span><br><span class="line">`e11_count` <span class="type">bigint</span>,</span><br><span class="line">`e11_amount` <span class="type">bigint</span>,</span><br><span class="line">`e12_count` <span class="type">bigint</span>,</span><br><span class="line">`e12_amount` <span class="type">bigint</span>,</span><br><span class="line">`e13_count` <span class="type">bigint</span>,</span><br><span class="line">`e13_amount` <span class="type">bigint</span>,</span><br><span class="line">`e14_count` <span class="type">bigint</span>,</span><br><span class="line">`e14_amount` <span class="type">bigint</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (`dt` string)</span><br><span class="line">STORED <span class="keyword">AS</span> parquet</span><br><span class="line">LOCATION <span class="string">&#x27;/warehouse/device_model_log/dwt/dwt_q6_user_errorcode_topic&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>导入脚本<br><strong>dws2dwt_user_errorcode_topic.sh</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP=device_model_log</span><br><span class="line">hive=/opt/module/hive-2.3.6/bin/hive</span><br><span class="line"></span><br><span class="line">if [ -n &quot;$1&quot; ];then</span><br><span class="line">    do_date=$1</span><br><span class="line">else</span><br><span class="line">    do_date=`date -d &#x27;-1 day&#x27; +%F`</span><br><span class="line">fi</span><br><span class="line">    </span><br><span class="line">sql=&quot;</span><br><span class="line">use $APP;</span><br><span class="line">SET hive.exec.dynamic.partition.mode=nonstrict;</span><br><span class="line"></span><br><span class="line">with</span><br><span class="line">temp as</span><br><span class="line">(</span><br><span class="line">SELECT</span><br><span class="line">  device_type,</span><br><span class="line">  iot_id,</span><br><span class="line">  request_id,</span><br><span class="line">  check_failed_data,</span><br><span class="line">  product_key,</span><br><span class="line">  device_name,</span><br><span class="line">  daytime_udf(val,1) e1,</span><br><span class="line">  daytime_udf(val,2) e2,</span><br><span class="line">  daytime_udf(val,4) e3,</span><br><span class="line">  daytime_udf(val,8) e4,</span><br><span class="line">  daytime_udf(val,16) e5,</span><br><span class="line">  daytime_udf(val,32) e6,</span><br><span class="line">  daytime_udf(val,64) e7,</span><br><span class="line">  daytime_udf(val,128) e8,</span><br><span class="line">  daytime_udf(val,256) e9,</span><br><span class="line">  daytime_udf(val,512) e10,</span><br><span class="line">  daytime_udf(val,1024) e11,</span><br><span class="line">  daytime_udf(val,2048) e12,</span><br><span class="line">  daytime_udf(val,4096) e13,</span><br><span class="line">  daytime_udf(val,8192) e14</span><br><span class="line">FROM </span><br><span class="line">  (</span><br><span class="line">    SELECT </span><br><span class="line">      concat_ws(&#x27;|&#x27;,collect_set(device_type)) device_type,</span><br><span class="line">      iot_id,</span><br><span class="line">      &#x27;&#x27; request_id,</span><br><span class="line">      &#x27;&#x27; check_failed_data,</span><br><span class="line">      concat_ws(&#x27;|&#x27;,collect_set(product_key)) product_key,</span><br><span class="line">      concat_ws(&#x27;|&#x27;,collect_set(device_name)) device_name, </span><br><span class="line">      concat_ws(&#x27;|&#x27;,collect_set(concat(error_code,&#x27;-&#x27;,error_count))) val</span><br><span class="line">    FROM dws_q6_user_errorcode_daycount</span><br><span class="line">    WHERE dt=&#x27;$&#123;do_date&#125;&#x27;</span><br><span class="line">    GROUP BY iot_id</span><br><span class="line">  ) tmp</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">INSERT OVERWRITE TABLE dwt_q6_user_errorcode_topic</span><br><span class="line">PARTITION(dt=&#x27;$&#123;do_date&#125;&#x27;)</span><br><span class="line">SELECT</span><br><span class="line">  nvl(new.device_type,old.device_type) device_type,</span><br><span class="line">  nvl(new.iot_id,old.iot_id) iot_id,</span><br><span class="line">  nvl(new.request_id,old.request_id) request_id,</span><br><span class="line">  nvl(new.check_failed_data,old.check_failed_data) check_failed_data,</span><br><span class="line">  nvl(new.product_key,old.product_key) product_key,</span><br><span class="line">  nvl(new.device_name,old.device_name) device_name,</span><br><span class="line">  nvl(new.e1,0) e1_count,</span><br><span class="line">  nvl(new.e1,0)+nvl(old.e1_amount,0) e1_amount,</span><br><span class="line">  nvl(new.e2,0) e2_count,</span><br><span class="line">  nvl(new.e2,0)+nvl(old.e2_amount,0) e2_amount,</span><br><span class="line">  nvl(new.e3,0) e3_count,</span><br><span class="line">  nvl(new.e3,0)+nvl(old.e3_amount,0) e3_amount,</span><br><span class="line">  nvl(new.e4,0) e4_count,</span><br><span class="line">  nvl(new.e4,0)+nvl(old.e4_amount,0) e4_amount,</span><br><span class="line">  nvl(new.e5,0) e5_count,</span><br><span class="line">  nvl(new.e5,0)+nvl(old.e5_amount,0) e5_amount,</span><br><span class="line">  nvl(new.e6,0) e6_count,</span><br><span class="line">  nvl(new.e6,0)+nvl(old.e6_amount,0) e6_amount,</span><br><span class="line">  nvl(new.e7,0) e7_count,</span><br><span class="line">  nvl(new.e7,0)+nvl(old.e7_amount,0) e7_amount,</span><br><span class="line">  nvl(new.e8,0) e8_count,</span><br><span class="line">  nvl(new.e8,0)+nvl(old.e8_amount,0) e8_amount,</span><br><span class="line">  nvl(new.e9,0) e9_count,</span><br><span class="line">  nvl(new.e9,0)+nvl(old.e9_amount,0) e9_amount,</span><br><span class="line">  nvl(new.e10,0) e10_count,</span><br><span class="line">  nvl(new.e10,0)+nvl(old.e10_amount,0) e10_amount,</span><br><span class="line">  nvl(new.e11,0) e11_count,</span><br><span class="line">  nvl(new.e11,0)+nvl(old.e11_amount,0) e11_amount,</span><br><span class="line">  nvl(new.e12,0) e12_count,</span><br><span class="line">  nvl(new.e12,0)+nvl(old.e12_amount,0) e12_amount,</span><br><span class="line">  nvl(new.e13,0) e13_count,</span><br><span class="line">  nvl(new.e13,0)+nvl(old.e13_amount,0) e13_amount,</span><br><span class="line">  nvl(new.e14,0) e14_count,</span><br><span class="line">  nvl(new.e14,0)+nvl(old.e14_amount,0) e14_amount</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line">  SELECT</span><br><span class="line">    *</span><br><span class="line">  FROM dwt_q6_user_errorcode_topic</span><br><span class="line">  WHERE dt=date_sub(&#x27;$&#123;do_date&#125;&#x27;,1)</span><br><span class="line">) old</span><br><span class="line">FULL OUTER JOIN</span><br><span class="line">(</span><br><span class="line">  SELECT</span><br><span class="line">    *</span><br><span class="line">  FROM temp</span><br><span class="line">) new ON old.iot_id=new.iot_id;</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hive -e <span class="string">&quot;<span class="variable">$sql</span>&quot;</span></span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A)/">http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E5%9F%BA%E7%A1%80/" title="ClickHouse-21-7-基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ClickHouse-21-7-基础</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E9%AB%98%E9%98%B6/" title="ClickHouse-21-7-高阶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ClickHouse-21-7-高阶</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">一、架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 数据流向图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 前端展示页面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%9A%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">二、业务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-BI%E6%8C%87%E6%A0%87"><span class="toc-number">2.0.1.</span> <span class="toc-text">2.1 BI指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%88%86%E5%B1%82"><span class="toc-number">2.0.2.</span> <span class="toc-text">2.2 分层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%92%8C%E5%AD%98%E5%82%A8"><span class="toc-number">3.</span> <span class="toc-text">三、数据采集和存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E4%BB%8E%E9%A3%9E%E7%87%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%88%B0%E6%9C%AC%E5%9C%B0"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 从飞燕获取数据保存到本地</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Flume"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Flume</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 集群启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-JobFile"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 JobFile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 拦截器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Flink"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Flink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Kafka"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E5%88%9B%E5%BB%BA%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 创建原始数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E5%88%9B%E5%BB%BAETL%E5%90%8E%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 创建ETL后数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%88%9B%E5%BB%BA%E8%BF%9F%E5%88%B0%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 创建迟到数据表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%80%BB%E8%A1%A8"><span class="toc-number">3.5.</span> <span class="toc-text">4.1 总表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%BB%BA%E8%A1%A8"><span class="toc-number">3.5.1.</span> <span class="toc-text">4.1.1 建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%AF%BC%E5%85%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">3.5.2.</span> <span class="toc-text">4.1.2 导入脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BA%8B%E4%BB%B6%E8%A1%A8"><span class="toc-number">3.6.</span> <span class="toc-text">4.2 事件表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E8%92%B8%E7%AE%B1%E6%A8%A1%E5%BC%8F%E4%BD%BF%E7%94%A8%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1-%E5%8C%85%E6%8B%AC%E6%97%B6%E9%97%B4%E6%AE%B5%E5%86%85%E4%BD%BF%E7%94%A8%E9%A2%91%E6%AC%A1%E5%92%8C%E6%80%BB%E9%A2%91%E6%AC%A1-stovmode"><span class="toc-number">3.6.1.</span> <span class="toc-text">4.2.1 蒸箱模式使用频率统计(包括时间段内使用频次和总频次) stovmode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-dwd%E5%B1%82"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">4.2.1.1 dwd层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-2-dws%E5%B1%82"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">4.2.1.2 dws层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-2-1-%E8%AE%BE%E5%A4%87%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.2.1.</span> <span class="toc-text">4.2.1.2.1 设备维度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-2-2-%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.2.2.</span> <span class="toc-text">4.2.1.2.2 用户维度</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-1-2-2-1-%E4%BD%BF%E7%94%A8%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.6.1.2.2.1.</span> <span class="toc-text">4.2.1.2.2.1 使用频率统计</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-1-2-2-2-%E4%BD%BF%E7%94%A8%E6%97%B6%E9%97%B4%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.6.1.2.2.2.</span> <span class="toc-text">4.2.1.2.2.2 使用时间统计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-3-dwt%E5%B1%82"><span class="toc-number">3.6.1.3.</span> <span class="toc-text">4.2.1.3 dwt层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-3-1-%E8%AE%BE%E5%A4%87%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.3.1.</span> <span class="toc-text">4.2.1.3.1 设备维度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-3-2-%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.3.2.</span> <span class="toc-text">4.2.1.3.2 用户维度</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-4-ads%E5%B1%82"><span class="toc-number">3.6.1.4.</span> <span class="toc-text">4.2.1.4 ads层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-4-1-%E8%AE%BE%E5%A4%87%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.4.1.</span> <span class="toc-text">4.2.1.4.1 设备维度</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-1-4-2-%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.1.4.2.</span> <span class="toc-text">4.2.1.4.2 用户维度</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-5-%E5%AF%BC%E5%87%BA%E5%88%B0mysql"><span class="toc-number">3.6.1.5.</span> <span class="toc-text">4.2.1.5 导出到mysql</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E9%9B%86%E6%88%90%E7%81%B6%E6%95%85%E9%9A%9C%E7%B1%BB%E5%9E%8B%E5%8F%91%E7%94%9F%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1-errorcode"><span class="toc-number">3.6.2.</span> <span class="toc-text">4.2.2 集成灶故障类型发生频率统计 errorcode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-dwd%E5%B1%82"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">4.2.2.1 dwd层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2-dws%E5%B1%82"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">4.2.2.2 dws层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-1-%E8%AE%BE%E5%A4%87%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.2.2.1.</span> <span class="toc-text">4.2.2.2.1 设备维度</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-2-2-1-1-%E5%8F%91%E7%94%9F%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.6.2.2.1.1.</span> <span class="toc-text">4.2.2.2.1.1 发生频率统计</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-2-%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.2.2.2.</span> <span class="toc-text">4.2.2.2.2 用户维度</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-2-2-1-1-%E5%8F%91%E7%94%9F%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1-1"><span class="toc-number">3.6.2.2.2.1.</span> <span class="toc-text">4.2.2.2.1.1 发生频率统计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-3-dwt%E5%B1%82"><span class="toc-number">3.6.2.3.</span> <span class="toc-text">4.2.2.3 dwt层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-3-1-%E8%AE%BE%E5%A4%87%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.2.3.1.</span> <span class="toc-text">4.2.2.3.1 设备维度</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-2-3-1-1-%E5%8F%91%E7%94%9F%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.6.2.3.1.1.</span> <span class="toc-text">4.2.2.3.1.1 发生频率统计</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-3-2-%E7%94%A8%E6%88%B7%E7%BB%B4%E5%BA%A6"><span class="toc-number">3.6.2.3.2.</span> <span class="toc-text">4.2.2.3.2 用户维度</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-2-3-2-1-%E5%8F%91%E7%94%9F%E9%A2%91%E7%8E%87%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.6.2.3.2.1.</span> <span class="toc-text">4.2.2.3.2.1 发生频率统计</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>