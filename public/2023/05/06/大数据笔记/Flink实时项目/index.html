<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Flink实时项目 | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="##准备依赖 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677&lt;properties&gt;    &lt;flink.version&gt;1.12.">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink实时项目">
<meta property="og:url" content="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%94%E8%AE%B0/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="##准备依赖 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677&lt;properties&gt;    &lt;flink.version&gt;1.12.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.063Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.063Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%94%E8%AE%B0/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Flink实时项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Flink实时项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.063Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.063Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%94%E8%AE%B0/">大数据笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Flink实时项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>##准备<br><strong>依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scala.binary.version</span>&gt;</span>2.11<span class="tag">&lt;/<span class="name">scala.binary.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kafka.version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">kafka.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-api-scala-bridge_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner-blink_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-cep-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>工具类</strong><br>将文件写入到Kakfa中</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KafkaProducerUtil</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args:<span class="type">Array</span>[<span class="type">String</span>]):<span class="type">Unit</span> = &#123;</span><br><span class="line">    writeToKafka(<span class="string">&quot;hotitems&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">writeToKafka</span></span>(topic: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> properties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>,<span class="string">&quot;192.168.32.242:9092&quot;</span>)</span><br><span class="line">    properties.setProperty(<span class="string">&quot;key.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>)</span><br><span class="line">    properties.setProperty(<span class="string">&quot;value.serializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> producer = <span class="keyword">new</span> <span class="type">KafkaProducer</span>[<span class="type">String</span>, <span class="type">String</span>](properties)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件读取数据，逐行写入kafka</span></span><br><span class="line">    <span class="keyword">val</span> bufferedSource = io.<span class="type">Source</span>.fromFile(<span class="string">&quot;C:\Users\Administrator\Desktop\不常用的项目\UserBehaviorAnalysis\HotItemsAnalysis\src\main\resources\UserBehavior.csv&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (line &lt;- bufferedSource.getLines()) &#123;</span><br><span class="line">      <span class="keyword">val</span> record = <span class="keyword">new</span> <span class="type">ProducerRecord</span>[<span class="type">String</span>, <span class="type">String</span>](topic, line)</span><br><span class="line">      producer.send(record)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    producer.close()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
##需求一：每五秒钟输出最近一个小时的topN点击商品  
>步骤：1.转换为样例类，设置水位线 2.过滤点击事件，开1小时5分钟的滑动窗口对同类商品进行聚合 3.对同窗口的商品进行排序
>从Kafka中读取数据，指定时间戳为EventTime，默认为顺序数据，水位线与事件时间持平。
- 以下是通过DataStream的API实现
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.hotitems_analysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.<span class="type">Timestamp</span></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ListState</span>, <span class="type">ListStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.&#123;<span class="type">Tuple</span>, <span class="type">Tuple1</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">WindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ListBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 需求：每五秒钟输出最近一个小时的topN点击商品  (步骤：1.转换为样例类，设置水位线 2.过滤点击事件，开1小时5分钟的滑动窗口对同类商品进行聚合 3.对同窗口的商品进行排序)</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/25 16:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 定义输入数据样例类</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBehavior</span>(<span class="params">userId: <span class="type">Long</span>, itemId: <span class="type">Long</span>, catagoryId: <span class="type">Int</span>, behavior: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义窗口聚合结果样例类</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemViewCount</span>(<span class="params">itemId: <span class="type">Long</span>, windowEnd: <span class="type">Long</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Hotitems</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件中读取数据并转换成样例类,并指定当前时间戳为事件时间</span></span><br><span class="line">    <span class="comment">//    val inputStream: DataStream[String] = env.readTextFile(&quot;C:\Users\Administrator\Desktop\不常用的项目\UserBehaviorAnalysis\HotItemsAnalysis\src\main\resources\UserBehavior.csv&quot;)</span></span><br><span class="line">    <span class="comment">// 从Kafka中读取数据</span></span><br><span class="line">    <span class="keyword">val</span> properties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;192.168.32.242:9092&quot;</span>)</span><br><span class="line">    properties.setProperty(<span class="string">&quot;group.id&quot;</span>,<span class="string">&quot;consumer-group&quot;</span>)</span><br><span class="line">    properties.setProperty(<span class="string">&quot;key.deserializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>)</span><br><span class="line">    properties.setProperty(<span class="string">&quot;value.deserializer&quot;</span>,<span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> myConsumer = <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;hotitems&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), properties)</span><br><span class="line">    <span class="comment">// myConsumer.setStartFromEarliest() // 从头开始读取</span></span><br><span class="line">    myConsumer.setStartFromLatest() <span class="comment">// 从末尾开始读取</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputStream = env.addSource(myConsumer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream: <span class="type">DataStream</span>[<span class="type">UserBehavior</span>] = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> split = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">UserBehavior</span>(split(<span class="number">0</span>).toLong, split(<span class="number">1</span>).toLong, split(<span class="number">2</span>).toInt, split(<span class="number">3</span>), split(<span class="number">4</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到窗口的聚合结果</span></span><br><span class="line">    <span class="keyword">val</span> aggStream: <span class="type">DataStream</span>[<span class="type">ItemViewCount</span>] = dataStream</span><br><span class="line">      .filter(_.behavior == <span class="string">&quot;pv&quot;</span>) <span class="comment">// 过滤pv行为</span></span><br><span class="line">      .keyBy(<span class="string">&quot;itemId&quot;</span>)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.hours(<span class="number">1</span>), <span class="type">Time</span>.minutes(<span class="number">5</span>))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">CountAgg</span>(), <span class="keyword">new</span> <span class="type">ItemViewWindowResult</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">val</span> resultStream = aggStream</span><br><span class="line">      .keyBy(<span class="string">&quot;windowEnd&quot;</span>)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">TopNHotItems</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    resultStream.print()</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;hot items&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义预聚合函数Aggregate</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountAgg</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">UserBehavior</span>, <span class="type">Long</span>, <span class="type">Long</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>: <span class="type">Long</span> = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">UserBehavior</span>, acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc1: <span class="type">Long</span>, acc2: <span class="type">Long</span>): <span class="type">Long</span> = acc1 + acc2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义窗口全局函数</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemViewWindowResult</span> <span class="keyword">extends</span> <span class="title">WindowFunction</span>[<span class="type">Long</span>, <span class="type">ItemViewCount</span>, <span class="type">Tuple</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(key: <span class="type">Tuple</span>, window: <span class="type">TimeWindow</span>, input: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[<span class="type">ItemViewCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> itemId = key.asInstanceOf[<span class="type">Tuple1</span>[<span class="type">Long</span>]].f0 <span class="comment">// 因为key只有一个，所以Tuple是Tuple1类型的，转型后获取值</span></span><br><span class="line">    <span class="keyword">val</span> windowEnd = window.getEnd <span class="comment">// 获取窗口的结束时间</span></span><br><span class="line">    <span class="keyword">val</span> count = input.iterator.next() <span class="comment">// 全局窗口函数会记录所有的输入值，此处是传入的acc值，只有一个</span></span><br><span class="line"></span><br><span class="line">    out.collect(<span class="type">ItemViewCount</span>(itemId, windowEnd, count))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义的KeyedProcessFunction,进行状态编程</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopNHotItems</span>(<span class="params">topSize: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">Tuple</span>, <span class="type">ItemViewCount</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先定义状态： ListState</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> itemViewCountListState: <span class="type">ListState</span>[<span class="type">ItemViewCount</span>] = _</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// 初始化状态</span></span><br><span class="line">    itemViewCountListState = getRuntimeContext.getListState(<span class="keyword">new</span> <span class="type">ListStateDescriptor</span>[<span class="type">ItemViewCount</span>](<span class="string">&quot;itemViewCountList&quot;</span>, classOf[<span class="type">ItemViewCount</span>]))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据处理并设置定时器</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(value: <span class="type">ItemViewCount</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Tuple</span>, <span class="type">ItemViewCount</span>, <span class="type">String</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//每来一条数据，直接加入ListState</span></span><br><span class="line">    itemViewCountListState.add(value)</span><br><span class="line">    <span class="comment">//注册一个windowEnd + 1 之后出发的定时器</span></span><br><span class="line">    ctx.timerService().registerEventTimeTimer(value.windowEnd + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 出发定时器时处理</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Tuple</span>, <span class="type">ItemViewCount</span>, <span class="type">String</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> allItemViewCounts: <span class="type">ListBuffer</span>[<span class="type">ItemViewCount</span>] = <span class="type">ListBuffer</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> iter = itemViewCountListState.get().iterator()</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext) &#123;</span><br><span class="line">      allItemViewCounts += iter.next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    itemViewCountListState.clear()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取前topSize名的商品</span></span><br><span class="line">    <span class="keyword">val</span> sortedItemViewCounts = allItemViewCounts.sortBy(_.count)(<span class="type">Ordering</span>.<span class="type">Long</span>.reverse).take(topSize) <span class="comment">// 科里化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 格式化为String类型</span></span><br><span class="line">    <span class="keyword">val</span> result: <span class="type">StringBuffer</span> = <span class="keyword">new</span> <span class="type">StringBuffer</span></span><br><span class="line">    result.append(<span class="string">&quot;窗口结束时间: &quot;</span>).append(<span class="keyword">new</span> <span class="type">Timestamp</span>(timestamp - <span class="number">1</span>)).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- sortedItemViewCounts.indices) &#123;</span><br><span class="line">      <span class="keyword">val</span> currentItemViewCount = sortedItemViewCounts(i)</span><br><span class="line">      result.append(<span class="string">&quot;NO&quot;</span>).append(i + <span class="number">1</span>).append(<span class="string">&quot;: 	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;商品ID = &quot;</span>).append(currentItemViewCount.itemId).append(<span class="string">&quot;	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;热门度 = &quot;</span>).append(currentItemViewCount.count).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.append(<span class="string">&quot;====================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    out.collect(result.toString)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以下是通过Table API和SQL实现<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.networkflowanalysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.<span class="type">Socket</span></span><br><span class="line"><span class="keyword">import</span> java.sql.<span class="type">Timestamp</span></span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ListState</span>, <span class="type">ListStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">WindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ListBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 热门页面浏览量统计</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/28 15:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ApacheLogEvent</span>(<span class="params">ip: <span class="type">String</span>, userId: <span class="type">String</span>, timestamp: <span class="type">Long</span>, method: <span class="type">String</span>, url: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PageViewCount</span>(<span class="params">url: <span class="type">String</span>, windowEnd: <span class="type">Long</span>, cnt: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">HotPagesNetworkFlow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    val inputStream = env.readTextFile(&quot;C:\Users\Administrator\Desktop\不常用的项目\UserBehaviorAnalysis\NetworkFlowAnalysis\src\main\resources\apache.log&quot;)</span></span><br><span class="line">    <span class="keyword">val</span> inputStream = env.socketTextStream(<span class="string">&quot;192.168.32.242&quot;</span>, <span class="number">7777</span>)</span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream.map(data =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> arr = data.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> ts = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;dd/MM/yyyy:HH:mm:ss&quot;</span>).parse(arr(<span class="number">3</span>)).getTime</span><br><span class="line">      <span class="type">ApacheLogEvent</span>(arr(<span class="number">0</span>), arr(<span class="number">1</span>), ts, arr(<span class="number">5</span>), arr(<span class="number">6</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">ApacheLogEvent</span>](<span class="type">Time</span>.minutes(<span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">ApacheLogEvent</span>): <span class="type">Long</span> = element.timestamp</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> aggStream = dataStream</span><br><span class="line">      .filter(_.method == <span class="string">&quot;GET&quot;</span>)</span><br><span class="line">      .filter(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> pattern = <span class="string">&quot;^((?!\.(css|js)$).)*$&quot;</span>.r</span><br><span class="line">        (pattern findFirstIn data.url).nonEmpty</span><br><span class="line">      &#125;)</span><br><span class="line">      .keyBy(_.url)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.minutes(<span class="number">10</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">PageCountAgg</span>(), <span class="keyword">new</span> <span class="type">PageViewCountWindowResult</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = aggStream</span><br><span class="line">      .keyBy(_.windowEnd)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">TopNHotPages</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    dataStream.print(<span class="string">&quot;dataStream&quot;</span>)</span><br><span class="line">    aggStream.print(<span class="string">&quot;aggStream&quot;</span>)</span><br><span class="line">    resultStream.print(<span class="string">&quot;resultStream&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;hot page&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageCountAgg</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">ApacheLogEvent</span>, <span class="type">Long</span>, <span class="type">Long</span>] </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">ApacheLogEvent</span>, acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc1: <span class="type">Long</span>, acc2: <span class="type">Long</span>): <span class="type">Long</span> = acc1 + acc2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageViewCountWindowResult</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">WindowFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(key: <span class="type">String</span>, window: <span class="type">TimeWindow</span>, input: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[<span class="type">PageViewCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    out.collect(<span class="type">PageViewCount</span>(key, window.getEnd, input.iterator.next()))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopNHotPages</span>(<span class="params">topSize: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> pageViewCountListState: <span class="type">ListState</span>[<span class="type">PageViewCount</span>] = getRuntimeContext.getListState(<span class="keyword">new</span> <span class="type">ListStateDescriptor</span>[<span class="type">PageViewCount</span>](<span class="string">&quot;pageViewCount-list&quot;</span>, classOf[<span class="type">PageViewCount</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(input: <span class="type">PageViewCount</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    pageViewCountListState.add(input)</span><br><span class="line">    ctx.timerService().registerProcessingTimeTimer(input.windowEnd + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> allPageListCounts: <span class="type">ListBuffer</span>[<span class="type">PageViewCount</span>] = <span class="type">ListBuffer</span>()</span><br><span class="line">    <span class="keyword">val</span> iterator = pageViewCountListState.get().iterator()</span><br><span class="line">    <span class="keyword">while</span> (iterator.hasNext) &#123;</span><br><span class="line">      allPageListCounts += iterator.next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pageViewCountListState.clear()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="keyword">val</span> sortedPageListCounts = allPageListCounts.sortWith(_.cnt &gt; _.cnt).take(topSize)</span><br><span class="line">    <span class="comment">// 格式化为String类型</span></span><br><span class="line">    <span class="keyword">val</span> result: <span class="type">StringBuffer</span> = <span class="keyword">new</span> <span class="type">StringBuffer</span></span><br><span class="line">    result.append(<span class="string">&quot;窗口结束时间: &quot;</span>).append(<span class="keyword">new</span> <span class="type">Timestamp</span>(timestamp - <span class="number">1</span>)).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- sortedPageListCounts.indices) &#123;</span><br><span class="line">      <span class="keyword">val</span> currentPageCounts = sortedPageListCounts(i)</span><br><span class="line">      result.append(<span class="string">&quot;NO&quot;</span>).append(i + <span class="number">1</span>).append(<span class="string">&quot;: 	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;页面url = &quot;</span>).append(currentPageCounts.url).append(<span class="string">&quot;	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;热门度 = &quot;</span>).append(currentPageCounts.cnt).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.append(<span class="string">&quot;====================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    out.collect(result.toString)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>##需求二：热门页面浏览量统计</p>
<ul>
<li>以下是通过DataStream的API实现<blockquote>
<p><strong>原流程：</strong>从文件读取数据，设定为事件时间，水位线延迟时间为1m，滑动窗口大小为10m，步长为5s。先根据url和窗口进行预聚合，然后设置定时器为对同一窗口中的数据进行排序取TopN。<br><strong>改进后：</strong>为了快速处理出结果，将水位线延迟时间设为1s，<code>允许最大延迟时间</code>为1m，1m外的数据放入<code>侧输出流</code>中。滑动窗口大小还是为10m，步长为5s。<br>需要注意的是，迟到数据也会触发预聚合输出累加器的结果，定时器中需要再次进行排序，因此状态只能在该窗口关闭时进行清空。且为了防止url重复，需要保存url和count的值，因此使用MapState。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.networkflowanalysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.<span class="type">Timestamp</span></span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ListState</span>, <span class="type">ListStateDescriptor</span>, <span class="type">MapState</span>, <span class="type">MapStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">WindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ListBuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 热门页面浏览量统计</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/28 15:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ApacheLogEvent</span>(<span class="params">ip: <span class="type">String</span>, userId: <span class="type">String</span>, timestamp: <span class="type">Long</span>, method: <span class="type">String</span>, url: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PageViewCount</span>(<span class="params">url: <span class="type">String</span>, windowEnd: <span class="type">Long</span>, cnt: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">HotPagesNetworkFlow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    val inputStream = env.readTextFile(&quot;C:\Users\Administrator\Desktop\不常用的项目\UserBehaviorAnalysis\NetworkFlowAnalysis\src\main\resources\apache.log&quot;)</span></span><br><span class="line">    <span class="keyword">val</span> inputStream = env.socketTextStream(<span class="string">&quot;192.168.32.242&quot;</span>, <span class="number">7777</span>)</span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream.map(data =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> arr = data.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> ts = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;dd/MM/yyyy:HH:mm:ss&quot;</span>).parse(arr(<span class="number">3</span>)).getTime</span><br><span class="line">      <span class="type">ApacheLogEvent</span>(arr(<span class="number">0</span>), arr(<span class="number">1</span>), ts, arr(<span class="number">5</span>), arr(<span class="number">6</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">ApacheLogEvent</span>](<span class="type">Time</span>.seconds(<span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">ApacheLogEvent</span>): <span class="type">Long</span> = element.timestamp</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> aggStream = dataStream</span><br><span class="line">      .filter(_.method == <span class="string">&quot;GET&quot;</span>)</span><br><span class="line">      .filter(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> pattern = <span class="string">&quot;^((?!\.(css|js)$).)*$&quot;</span>.r</span><br><span class="line">        (pattern findFirstIn data.url).nonEmpty</span><br><span class="line">      &#125;)</span><br><span class="line">      .keyBy(_.url)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.minutes(<span class="number">10</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .allowedLateness(<span class="type">Time</span>.minutes(<span class="number">1</span>))</span><br><span class="line">      .sideOutputLateData(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">ApacheLogEvent</span>](<span class="string">&quot;late&quot;</span>))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">PageCountAgg</span>(), <span class="keyword">new</span> <span class="type">PageViewCountWindowResult</span>())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = aggStream</span><br><span class="line">      .keyBy(_.windowEnd)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">TopNHotPages</span>(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    dataStream.print(<span class="string">&quot;dataStream&quot;</span>)</span><br><span class="line">    aggStream.print(<span class="string">&quot;aggStream&quot;</span>)</span><br><span class="line">    aggStream.getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">ApacheLogEvent</span>](<span class="string">&quot;late&quot;</span>)).print(<span class="string">&quot;late&quot;</span>)</span><br><span class="line">    resultStream.print(<span class="string">&quot;resultStream&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;hot page&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageCountAgg</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">ApacheLogEvent</span>, <span class="type">Long</span>, <span class="type">Long</span>] </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">ApacheLogEvent</span>, acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc1: <span class="type">Long</span>, acc2: <span class="type">Long</span>): <span class="type">Long</span> = acc1 + acc2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageViewCountWindowResult</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">WindowFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(key: <span class="type">String</span>, window: <span class="type">TimeWindow</span>, input: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[<span class="type">PageViewCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    out.collect(<span class="type">PageViewCount</span>(key, window.getEnd, input.iterator.next()))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopNHotPages</span>(<span class="params">topSize: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  lazy val pageViewCountListState: ListState[PageViewCount] = getRuntimeContext.getListState(new ListStateDescriptor[PageViewCount](&quot;pageViewCount-list&quot;, classOf[PageViewCount]))</span></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> pageViewCountMapState: <span class="type">MapState</span>[<span class="type">String</span>, <span class="type">Long</span>] = getRuntimeContext.getMapState(<span class="keyword">new</span> <span class="type">MapStateDescriptor</span>[<span class="type">String</span>, <span class="type">Long</span>](<span class="string">&quot;pageViewCount-map&quot;</span>, classOf[<span class="type">String</span>], classOf[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(input: <span class="type">PageViewCount</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//    pageViewCountListState.add(input)</span></span><br><span class="line">    pageViewCountMapState.put(input.url, input.cnt)</span><br><span class="line">    <span class="comment">// 定义两个定时器，一个用于计算结果，一个用于清空状态</span></span><br><span class="line">    ctx.timerService().registerEventTimeTimer(input.windowEnd + <span class="number">1</span>)</span><br><span class="line">    ctx.timerService().registerEventTimeTimer(input.windowEnd + <span class="number">60000</span>L)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PageViewCount</span>, <span class="type">String</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//    val allPageListCounts: ListBuffer[PageViewCount] = ListBuffer()</span></span><br><span class="line">    <span class="comment">//    val iterator = pageViewCountListState.get().iterator()</span></span><br><span class="line">    <span class="comment">//    while (iterator.hasNext) &#123;</span></span><br><span class="line">    <span class="comment">//      allPageListCounts += iterator.next()</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> allPageListCounts: <span class="type">ListBuffer</span>[(<span class="type">String</span>,<span class="type">Long</span>)] = <span class="type">ListBuffer</span>()</span><br><span class="line">    <span class="keyword">val</span> iter = pageViewCountMapState.entries().iterator()</span><br><span class="line">    <span class="keyword">while</span>(iter.hasNext)&#123;</span><br><span class="line">      <span class="keyword">val</span> element = iter.next()</span><br><span class="line">      allPageListCounts += ((element.getKey,element.getValue))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果窗口关闭，则清空状态</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.getCurrentKey + <span class="number">60000</span>L == timestamp) &#123;</span><br><span class="line">      pageViewCountMapState.clear()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="keyword">val</span> sortedPageListCounts = allPageListCounts.sortWith(_._2 &gt; _._2).take(topSize)</span><br><span class="line">    <span class="comment">// 格式化为String类型</span></span><br><span class="line">    <span class="keyword">val</span> result: <span class="type">StringBuffer</span> = <span class="keyword">new</span> <span class="type">StringBuffer</span></span><br><span class="line">    result.append(<span class="string">&quot;窗口结束时间: &quot;</span>).append(<span class="keyword">new</span> <span class="type">Timestamp</span>(timestamp - <span class="number">1</span>)).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- sortedPageListCounts.indices) &#123;</span><br><span class="line">      <span class="keyword">val</span> currentPageCounts = sortedPageListCounts(i)</span><br><span class="line">      result.append(<span class="string">&quot;NO&quot;</span>).append(i + <span class="number">1</span>).append(<span class="string">&quot;: 	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;页面url = &quot;</span>).append(currentPageCounts._1).append(<span class="string">&quot;	&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;热门度 = &quot;</span>).append(currentPageCounts._2).append(<span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.append(<span class="string">&quot;====================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span>.sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    out.collect(result.toString)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>##网站总浏览量（PV）的统计<br>PV：PageView，用户访问页面的总次数。<br>UP：UniqueView，访问页面的用户数，每个用户只统计一次。</p>
<ul>
<li><p>PageView</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.networkflowanalysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.&#123;<span class="type">AggregateFunction</span>, <span class="type">MapFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">WindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 需求：实现一小时内网站总浏览量PV的统计</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/29 15:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBehavior</span>(<span class="params">userId: <span class="type">Long</span>, itemId: <span class="type">Long</span>, catagoryId: <span class="type">Int</span>, behavior: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PvCount</span>(<span class="params">windowEnd: <span class="type">Long</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PageView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">4</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resource = getClass.getResource(<span class="string">&quot;/UserBehavior.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(resource.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">UserBehavior</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>).toLong, arr(<span class="number">2</span>).toInt, arr(<span class="number">3</span>), arr(<span class="number">4</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> aggStream = dataStream</span><br><span class="line">      .filter(_.behavior == <span class="string">&quot;pv&quot;</span>)</span><br><span class="line">      .map(<span class="keyword">new</span> <span class="type">MyMapper</span>)</span><br><span class="line">      .keyBy(_._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.hours(<span class="number">1</span>))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">PvCountAgg</span>, <span class="keyword">new</span> <span class="type">PvCountWindowResult</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    aggStream.print(&quot;aggStream&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = aggStream</span><br><span class="line">      .keyBy(_.windowEnd)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">PvCountProcessResult</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.print(<span class="string">&quot;result&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;pv count&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">MapFunction</span>[<span class="type">UserBehavior</span>, (<span class="type">String</span>, <span class="type">Long</span>)] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(userBehavior: <span class="type">UserBehavior</span>): (<span class="type">String</span>, <span class="type">Long</span>) = &#123;</span><br><span class="line">    (<span class="type">Random</span>.nextString(<span class="number">10</span>), <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PvCountAgg</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">Long</span>, <span class="type">Long</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">Long</span> = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: (<span class="type">String</span>, <span class="type">Long</span>), acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: <span class="type">Long</span>, acc1: <span class="type">Long</span>): <span class="type">Long</span> = acc + acc1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PvCountWindowResult</span> <span class="keyword">extends</span> <span class="title">WindowFunction</span>[<span class="type">Long</span>, <span class="type">PvCount</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(key: <span class="type">String</span>, window: <span class="type">TimeWindow</span>, input: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[<span class="type">PvCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    out.collect(<span class="type">PvCount</span>(window.getEnd, input.head))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PvCountProcessResult</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PvCount</span>, <span class="type">PvCount</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> totalPvCountResultState: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>](<span class="string">&quot;ValueState&quot;</span>, classOf[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(value: <span class="type">PvCount</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PvCount</span>, <span class="type">PvCount</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">PvCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> count = totalPvCountResultState.value()</span><br><span class="line">    totalPvCountResultState.update(count + value.count)</span><br><span class="line"></span><br><span class="line">    ctx.timerService().registerEventTimeTimer(value.windowEnd + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">PvCount</span>, <span class="type">PvCount</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">PvCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> totalPvCount = totalPvCountResultState.value()</span><br><span class="line">    out.collect(<span class="type">PvCount</span>(ctx.getCurrentKey.toLong, totalPvCount))</span><br><span class="line">    totalPvCountResultState.clear()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>UniqueView</p>
<blockquote>
<p><strong>原逻辑：</strong>需要记录用户的访问次数，如果将用户存储在内存中，用户数量在千万级，那么单个任务占用的内存达到1G。<br><strong>改进：</strong>1.因为只需要知道用户id是否存在而不需要知道其值，就可以使用<code>布隆过滤器</code>，一条记录原需要8B空间，现只需要1bit空间，共计12.5MB（2^8 *1b ），为了避免哈希碰撞，可以设置为64MB。存储到Redis需要用到bitmap在哈希值对应的偏移量上置1表示该用户已存在。<br>2.为了避免窗口中数据堆积，就定义触发器，每条数据会触发一次计算操作。<br><strong>问题：</strong>1.每条数据都会连接redis导致redis压力过大 2.如何解决读取redis的bitmap公共变量时产生的并发问题。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.networkflowanalysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.format.<span class="type">DateTimeFormatter</span></span><br><span class="line"><span class="keyword">import</span> java.time.&#123;<span class="type">LocalDateTime</span>, <span class="type">ZoneId</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.triggers.&#123;<span class="type">Trigger</span>, <span class="type">TriggerResult</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.<span class="type">Jedis</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 统计UV，使用布隆过滤器保存用户信息</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/30 9:24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">UvCount</span>(<span class="params">window: <span class="type">Long</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">UniqueView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source = getClass.getResource(<span class="string">&quot;/UserBehavior.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(source.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">UserBehavior</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>).toLong, arr(<span class="number">2</span>).toInt, arr(<span class="number">3</span>), arr(<span class="number">4</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    dataStream</span><br><span class="line">      .filter(<span class="string">&quot;pv&quot;</span> == _.behavior)</span><br><span class="line">      .map(user =&gt; (<span class="string">&quot;pv&quot;</span>, user.userId))</span><br><span class="line">      .keyBy(_._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.hours(<span class="number">1</span>))</span><br><span class="line">      .trigger(<span class="keyword">new</span> <span class="type">MyTrigger</span>)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">UvCountWithBloom</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;uv count&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTrigger</span> <span class="keyword">extends</span> <span class="title">Trigger</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onElement</span></span>(element: (<span class="type">String</span>, <span class="type">Long</span>), timestamp: <span class="type">Long</span>, window: <span class="type">TimeWindow</span>, ctx: <span class="type">Trigger</span>.<span class="type">TriggerContext</span>): <span class="type">TriggerResult</span> = <span class="type">TriggerResult</span>.<span class="type">FIRE_AND_PURGE</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onProcessingTime</span></span>(time: <span class="type">Long</span>, window: <span class="type">TimeWindow</span>, ctx: <span class="type">Trigger</span>.<span class="type">TriggerContext</span>): <span class="type">TriggerResult</span> = <span class="type">TriggerResult</span>.<span class="type">CONTINUE</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onEventTime</span></span>(time: <span class="type">Long</span>, window: <span class="type">TimeWindow</span>, ctx: <span class="type">Trigger</span>.<span class="type">TriggerContext</span>): <span class="type">TriggerResult</span> = <span class="type">TriggerResult</span>.<span class="type">CONTINUE</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">clear</span></span>(window: <span class="type">TimeWindow</span>, ctx: <span class="type">Trigger</span>.<span class="type">TriggerContext</span>): <span class="type">Unit</span> = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bloom</span>(<span class="params">size: <span class="type">Long</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> cap = size</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hash</span></span>(value: <span class="type">String</span>, seed: <span class="type">Int</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="number">0</span>L</span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until value.length) &#123;</span><br><span class="line">      result = value.charAt(i) + result * seed</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结果需要在size范围内</span></span><br><span class="line">    (cap - <span class="number">1</span>) &amp; result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UvCountWithBloom</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">UvCount</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> jedis: <span class="type">Jedis</span> = <span class="keyword">new</span> <span class="type">Jedis</span>(<span class="string">&quot;116.62.148.11&quot;</span>, <span class="number">6380</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> bloom = <span class="keyword">new</span> <span class="type">Bloom</span>(<span class="number">1</span> &lt;&lt; <span class="number">29</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Long</span>)], out: <span class="type">Collector</span>[<span class="type">UvCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> now = <span class="type">LocalDateTime</span>.now(<span class="type">ZoneId</span>.of(<span class="string">&quot;Asia/Shanghai&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> date = <span class="type">DateTimeFormatter</span>.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>).format(now)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> hkey = date + <span class="string">&quot;_count&quot;</span></span><br><span class="line">    <span class="keyword">val</span> bkey = date + <span class="string">&quot;_bitmap&quot;</span></span><br><span class="line">    <span class="keyword">val</span> windowEnd = context.window.getEnd.toString</span><br><span class="line">    <span class="comment">// 使用hash结构存储统计值</span></span><br><span class="line">    <span class="keyword">val</span> result = jedis.hget(hkey, windowEnd)</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>L</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">      count = result.toLong</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断userId是否存在，如果不存在，则统计结果加一并存入bitmap中</span></span><br><span class="line">    <span class="keyword">val</span> lastEle: (<span class="type">String</span>, <span class="type">Long</span>) = elements.last</span><br><span class="line">    <span class="keyword">val</span> offset = bloom.hash(lastEle._2.toString, <span class="number">61</span>)</span><br><span class="line">    <span class="keyword">val</span> isExist: <span class="type">Boolean</span> = jedis.getbit(bkey, offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">      jedis.setbit(bkey, offset, <span class="literal">true</span>)</span><br><span class="line">      jedis.hset(hkey, windowEnd, (count+<span class="number">1</span>).toString)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>##分渠道统计用户行为（需要自定义数据源编造数据）</p>
<blockquote>
<p>主要是如何自定义数据源编造数据，然后对用户行为和渠道进行分组分窗进行统计。此处会缓存窗口中所有到达的数据并得到数据量，消耗内存较大，建议使用累加的方式（即.aggregate中使用累加器保存中间变量）。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.market_analysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">UUID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.&#123;<span class="type">RichSourceFunction</span>, <span class="type">SourceFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/30 15:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketUserBehavior</span>(<span class="params">userId: <span class="type">String</span>, behavior: <span class="type">String</span>, channel: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">MarketCount</span>(<span class="params">windowStart: <span class="type">String</span>, windowEnd: <span class="type">String</span>, channel: <span class="type">String</span>, behavior: <span class="type">String</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimulatedSource</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">RichSourceFunction</span>[<span class="type">MarketUserBehavior</span>] </span>&#123;</span><br><span class="line">  <span class="comment">// 标志位</span></span><br><span class="line">  <span class="keyword">var</span> running = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// 定义用户行为和渠道的集合</span></span><br><span class="line">  <span class="keyword">val</span> behaviorSet: <span class="type">Seq</span>[<span class="type">String</span>] = <span class="type">Seq</span>(<span class="string">&quot;view&quot;</span>, <span class="string">&quot;click&quot;</span>, <span class="string">&quot;download&quot;</span>, <span class="string">&quot;install&quot;</span>, <span class="string">&quot;uninstall&quot;</span>)</span><br><span class="line">  <span class="keyword">val</span> channelSet: <span class="type">Seq</span>[<span class="type">String</span>] = <span class="type">Seq</span>(<span class="string">&quot;appstore&quot;</span>, <span class="string">&quot;weibo&quot;</span>, <span class="string">&quot;wechat&quot;</span>, <span class="string">&quot;tieba&quot;</span>)</span><br><span class="line">  <span class="keyword">val</span> rand: <span class="type">Random</span> = <span class="type">Random</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(ctx: <span class="type">SourceFunction</span>.<span class="type">SourceContext</span>[<span class="type">MarketUserBehavior</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// 定义生成数据最大数量</span></span><br><span class="line">    <span class="keyword">val</span> maxCounts = <span class="type">Long</span>.<span class="type">MaxValue</span></span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 产生数据</span></span><br><span class="line">    <span class="keyword">while</span> (running &amp;&amp; count &lt; maxCounts) &#123;</span><br><span class="line">      <span class="keyword">val</span> id = <span class="type">UUID</span>.randomUUID().toString</span><br><span class="line">      <span class="keyword">val</span> behavior = behaviorSet(rand.nextInt(behaviorSet.size))</span><br><span class="line">      <span class="keyword">val</span> channel = channelSet(rand.nextInt(channelSet.size))</span><br><span class="line">      <span class="keyword">val</span> ts = <span class="type">System</span>.currentTimeMillis()</span><br><span class="line"></span><br><span class="line">      ctx.collect(<span class="type">MarketUserBehavior</span>(id, behavior, channel, ts))</span><br><span class="line">      count += <span class="number">1</span></span><br><span class="line">      <span class="type">Thread</span>.sleep(<span class="number">50</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">cancel</span></span>(): <span class="type">Unit</span> = running = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AppMarketByChannel</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputStream = env.addSource(<span class="keyword">new</span> <span class="type">SimulatedSource</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = dataStream</span><br><span class="line">      .filter(_.behavior != <span class="string">&quot;uninstall&quot;</span>)</span><br><span class="line">      .keyBy(data =&gt; (data.behavior, data.channel))</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.days(<span class="number">1</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">AppMarketCount</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.print(<span class="string">&quot;result&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;app market&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppMarketCount</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[<span class="type">MarketUserBehavior</span>,<span class="type">MarketCount</span>,(<span class="type">String</span>,<span class="type">String</span>),<span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: (<span class="type">String</span>, <span class="type">String</span>), context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">MarketUserBehavior</span>], out: <span class="type">Collector</span>[<span class="type">MarketCount</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> start = context.window.getStart.toString</span><br><span class="line">    <span class="keyword">val</span> end = context.window.getEnd.toString</span><br><span class="line">    <span class="keyword">val</span> behavior = key._1</span><br><span class="line">    <span class="keyword">val</span> channel = key._2</span><br><span class="line">    <span class="keyword">val</span> count = elements.size</span><br><span class="line"></span><br><span class="line">    out.collect(<span class="type">MarketCount</span>(start,end,channel,behavior,count))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##对一天内点击100次以上相同广告的用户输出为黑名单</p>
<blockquote>
<p>通过过程函数统计一天内相同用户点击相同广告的次数，如果次数大于100次，则拦截后续的该用户点击该广告的日志，并输出该用户到黑名单。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.adclick_analysis</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 对一天内点击100次以上相同广告的用户输出为黑名单</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2020/12/30 15:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">AdClickLog</span>(<span class="params">userId: <span class="type">Long</span>, adId: <span class="type">Long</span>, province: <span class="type">String</span>, city: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">AdClickCountByProvince</span>(<span class="params">windowEnd: <span class="type">String</span>, province: <span class="type">String</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterBlackListUser</span>(<span class="params">userId: <span class="type">Long</span>, adId: <span class="type">Long</span>, msg: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AdClickAnalysis</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source = getClass.getResource(<span class="string">&quot;/AdClickLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(source.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">AdClickLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>).toLong, arr(<span class="number">2</span>), arr(<span class="number">3</span>), arr(<span class="number">4</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户是否多次点击同一广告，如果是则拦截日志并输出黑名单</span></span><br><span class="line">    <span class="keyword">val</span> processStream = dataStream</span><br><span class="line">      .keyBy(data =&gt; (data.userId, data.adId))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">FliterBlackListUserResult</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计每个广告的用户点击数</span></span><br><span class="line">    <span class="keyword">val</span> resultStream = processStream</span><br><span class="line">      .keyBy(_.province)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.hours(<span class="number">1</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">AdCountAgg</span>, <span class="keyword">new</span> <span class="type">AdCountAggWindowResult</span>)</span><br><span class="line"></span><br><span class="line">    processStream.getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">FilterBlackListUser</span>](<span class="string">&quot;black-list-user&quot;</span>)).print(<span class="string">&quot;warn&quot;</span>)</span><br><span class="line">    resultStream.print(<span class="string">&quot;result&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;ad black list&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同一用户一天内点击相同广告maxClick次，将该用户输出为黑名单。并拦截该用户对该广告的点击日志。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FliterBlackListUserResult</span>(<span class="params">maxClick: <span class="type">Long</span></span>) <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[(<span class="type">Long</span>, <span class="type">Long</span>), <span class="type">AdClickLog</span>, <span class="type">AdClickLog</span>] </span>&#123;</span><br><span class="line">  <span class="comment">// 需要记录的状态有1.统计次数 2.该用户是否已经输出 3.</span></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> countState: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>](<span class="string">&quot;countState&quot;</span>, classOf[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> isContained: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;isContained&quot;</span>, classOf[<span class="type">Boolean</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(value: <span class="type">AdClickLog</span>, ctx: <span class="type">KeyedProcessFunction</span>[(<span class="type">Long</span>, <span class="type">Long</span>), <span class="type">AdClickLog</span>, <span class="type">AdClickLog</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">AdClickLog</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> curCount = countState.value()</span><br><span class="line">    <span class="comment">// 如果计数个数为0，说明第一次点击该广告，定义到当天24:00的定时器</span></span><br><span class="line">    <span class="keyword">if</span> (curCount == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> ts = (<span class="type">System</span>.currentTimeMillis() / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>) + <span class="number">1</span>) * (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)</span><br><span class="line">      ctx.timerService().registerEventTimeTimer(ts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果计数大于maxClick个，判断是否已经输出该用户，如果没有，则输出到侧输出流</span></span><br><span class="line">    <span class="keyword">if</span> (curCount &gt;= maxClick) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isContained.value()) &#123;</span><br><span class="line">        isContained.update(<span class="literal">true</span>)</span><br><span class="line">        ctx.output(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">FilterBlackListUser</span>](<span class="string">&quot;black-list-user&quot;</span>), <span class="type">FilterBlackListUser</span>(ctx.getCurrentKey._1, ctx.getCurrentKey._2, <span class="string">&quot;该用户重复点击&quot;</span> + maxClick))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果点击超过限制，该条日志不传到下游</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    countState.update(curCount + <span class="number">1</span>)</span><br><span class="line">    out.collect(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发器中，清空保存的状态</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[(<span class="type">Long</span>, <span class="type">Long</span>), <span class="type">AdClickLog</span>, <span class="type">AdClickLog</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">AdClickLog</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    isContained.update(<span class="literal">false</span>)</span><br><span class="line">    countState.update(<span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdCountAgg</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">AdClickLog</span>, <span class="type">Long</span>, <span class="type">Long</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">Long</span> = <span class="number">0</span>L</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">AdClickLog</span>, acc: <span class="type">Long</span>): <span class="type">Long</span> = acc + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: <span class="type">Long</span>): <span class="type">Long</span> = acc</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: <span class="type">Long</span>, acc1: <span class="type">Long</span>): <span class="type">Long</span> = acc + acc1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdCountAggWindowResult</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[<span class="type">Long</span>, <span class="type">AdClickCountByProvince</span>, <span class="type">String</span>,<span class="type">TimeWindow</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">Long</span>], out: <span class="type">Collector</span>[<span class="type">AdClickCountByProvince</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    out.collect(<span class="type">AdClickCountByProvince</span>(context.window.getEnd.toString,key,elements.head))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="筛选出乱序数据中的两秒内连续两次登录失败数据"><a href="#筛选出乱序数据中的两秒内连续两次登录失败数据" class="headerlink" title="筛选出乱序数据中的两秒内连续两次登录失败数据"></a>筛选出乱序数据中的两秒内连续两次登录失败数据</h2><blockquote>
<p><strong>思考</strong><br>1.如果只是timeWindow进行开窗，水位线是生效的，但是逻辑不对。不合适；<br>2.如果不使用开窗直接使用process函数，符合逻辑，但是水位线不生效，需要缓存数据自定义触发。不合适；<br>3.可以使用CEP函数，进行数据匹配，水位线是生效的。底层逻辑：如果begin匹配上数据后注册定时器，如果定时器时间内符合条件直接输出，定时器触发后清空状态，同时兼顾了时间语义和水位线。<br><strong>依赖</strong></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-cep-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.loginfaildetect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.<span class="type">PatternSelectFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.<span class="type">CEP</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.pattern.<span class="type">Pattern</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/6 14:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LoginFailCEP</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source = getClass.getResource(<span class="string">&quot;/LoginLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(source.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">LoginLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>), arr(<span class="number">2</span>), arr(<span class="number">3</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">LoginLog</span>](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">LoginLog</span>): <span class="type">Long</span> = element.timestamp * <span class="number">1000</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> pattern = <span class="type">Pattern</span></span><br><span class="line">      .begin[<span class="type">LoginLog</span>](<span class="string">&quot;firstFail&quot;</span>).where(_.eventType.equals(<span class="string">&quot;fail&quot;</span>))</span><br><span class="line">      .next(<span class="string">&quot;secondFail&quot;</span>).where(_.eventType.equals(<span class="string">&quot;fail&quot;</span>))</span><br><span class="line">      .within(<span class="type">Time</span>.seconds(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = <span class="type">CEP</span>.pattern(dataStream.keyBy(_.userId), pattern)</span><br><span class="line">      .select(<span class="keyword">new</span> <span class="type">PatternSelectResult</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.print(<span class="string">&quot;warning&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;login fail cep&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PatternSelectResult</span> <span class="keyword">extends</span> <span class="title">PatternSelectFunction</span>[<span class="type">LoginLog</span>,<span class="type">LoginFailWarning</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">select</span></span>(map: util.<span class="type">Map</span>[<span class="type">String</span>, util.<span class="type">List</span>[<span class="type">LoginLog</span>]]): <span class="type">LoginFailWarning</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> firstFailLog = map.get(<span class="string">&quot;firstFail&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> secondFailLog = map.get(<span class="string">&quot;secondFail&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="type">LoginFailWarning</span>(firstFailLog.userId,firstFailLog.timestamp,secondFailLog.timestamp,<span class="string">&quot;login fail warning&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>##订单支付实时监控</p>
<blockquote>
<p>匹配同一订单号的create行为和pay行为，分别输出支付订单和超时未支付的订单。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.orderpaydetect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.&#123;<span class="type">PatternSelectFunction</span>, <span class="type">PatternTimeoutFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.<span class="type">CEP</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.cep.scala.pattern.<span class="type">Pattern</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 订单支付实时监控(业务逻辑：匹配同一订单号的create行为和pay行为。如果超时未支付则输出报警。)</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/6 15:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderLog</span>(<span class="params">orderId: <span class="type">Long</span>, eventType: <span class="type">String</span>, txId: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderResult</span>(<span class="params">orderId: <span class="type">Long</span>, resultMsg: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">OrderTimeout</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resource = getClass.getResource(<span class="string">&quot;/OrderLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(resource.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">OrderLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>), arr(<span class="number">2</span>), arr(<span class="number">3</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> pattern = <span class="type">Pattern</span></span><br><span class="line">      .begin[<span class="type">OrderLog</span>](<span class="string">&quot;create&quot;</span>).where(_.eventType.equals(<span class="string">&quot;create&quot;</span>))</span><br><span class="line">      .next(<span class="string">&quot;pay&quot;</span>).where(_.eventType.equals(<span class="string">&quot;pay&quot;</span>))</span><br><span class="line">      .within(<span class="type">Time</span>.minutes(<span class="number">15</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> outputTag = <span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">OrderResult</span>](<span class="string">&quot;order-timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = <span class="type">CEP</span></span><br><span class="line">      .pattern(dataStream.keyBy(_.orderId), pattern)</span><br><span class="line">      .select(outputTag, <span class="keyword">new</span> <span class="type">OrderTimeoutResult</span>, <span class="keyword">new</span> <span class="type">OrderCompleteResult</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.getSideOutput(outputTag).print(<span class="string">&quot;timeout&quot;</span>)</span><br><span class="line">    resultStream.print(<span class="string">&quot;success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;order timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderTimeoutResult</span> <span class="keyword">extends</span> <span class="title">PatternTimeoutFunction</span>[<span class="type">OrderLog</span>,<span class="type">OrderResult</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">timeout</span></span>(map: util.<span class="type">Map</span>[<span class="type">String</span>, util.<span class="type">List</span>[<span class="type">OrderLog</span>]], l: <span class="type">Long</span>): <span class="type">OrderResult</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> create = map.get(<span class="string">&quot;create&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="type">OrderResult</span>(create.orderId,<span class="string">&quot;timeout:&quot;</span> + l)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderCompleteResult</span> <span class="keyword">extends</span> <span class="title">PatternSelectFunction</span>[<span class="type">OrderLog</span>,<span class="type">OrderResult</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">select</span></span>(map: util.<span class="type">Map</span>[<span class="type">String</span>, util.<span class="type">List</span>[<span class="type">OrderLog</span>]]): <span class="type">OrderResult</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> create = map.get(<span class="string">&quot;create&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> pay = map.get(<span class="string">&quot;pay&quot;</span>).get(<span class="number">0</span>)</span><br><span class="line">    <span class="type">OrderResult</span>(create.orderId,<span class="string">&quot;create:&quot;</span>+ create.timestamp + <span class="string">&quot;--pay:&quot;</span> + pay.timestamp)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>
**思路2：**
>只需要匹配create和pay两条数据即可，无需关注数据顺序，所以对于这种特殊情况，可以取巧用process函数进行处理。
>**逻辑：**不用管create和pay到达顺序，只需要时间间隔在15min内即可。如果pay到达，create没到达，则设置定时器时间为pay的时间；如果create到达，pay没到达，则设置定时器时间为create时间15分钟后；如果create到达，pay也已经到达。

<blockquote>
<p><strong>问题：</strong>create到达后会设置一个15分钟的定时器，理应只有在pay记录到达并将水位线推进到15分钟后才会打印 “支付时间超过订单有效时间，发生异常”，其他情况触发的定时器都会清空状态导致，导致不会打印 “支付时间超过订单有效时间，发生异常”。<br><strong>但是实际情况是，通过文件和通过nc端口进行处理的如下数据，会得到不同的结果。数据如下：</strong><br><img src="/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE.assets%5C57132594aee843609bdf76bfd7ebfc2e.png" alt="image.png"><br><strong>如果读取的是文件，打印如下：</strong><br><img src="/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE.assets%5C45365c1066954bb098abbcb1bb8e92ce.png" alt="image.png"><br><strong>如果读取的nc端口，打印如下：</strong><br><img src="/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE.assets%5C39a58ce56b12413ea6f664cb1d109f4b.png" alt="image.png"><br><strong>原因：</strong>因为默认的watermark生成机制是定时生成（200ms），如果直接读取文件，读取速度太快会导致watermark推进的跨度太大，导致虽然到达的记录已经过期，但是watermark没有推进并触发定时器；<br>而从端口读取，生成数据的时间慢，watermark密度大跨度小，所以更加准确。<br>总结：<code>因此还是需要比较到达的数据的时间戳判断是否是过期数据，原因有两点①避免过期数据推进watermark并触发定时器的情况，因为这样会先进入逻辑判断，然后触发定时器 ②避免数据读取过快，水位线之间数据量太大，过期数据到达但是水位线没有推进，没有触发定时器，导致将过期数据作为正常数据进行处理的情况。</code></p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.orderpaydetect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/6 16:40</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">OrderTimeoutUseProcess</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resource = getClass.getResource(<span class="string">&quot;/OrderLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> inputStream = env.readTextFile(resource.getPath)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> dataStream = inputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">OrderLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>), arr(<span class="number">2</span>), arr(<span class="number">3</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = dataStream</span><br><span class="line">      .keyBy(_.orderId)</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">OrderProcessResult</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">OrderResult</span>](<span class="string">&quot;order-timeout&quot;</span>)).print(<span class="string">&quot;warning&quot;</span>)</span><br><span class="line">    resultStream.print(<span class="string">&quot;success&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;order timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只需要匹配create和pay两条数据即可，</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderProcessResult</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">OrderLog</span>, <span class="type">OrderResult</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> createState: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;create-state&quot;</span>, classOf[<span class="type">Boolean</span>]))</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> payState: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;pay-state&quot;</span>, classOf[<span class="type">Boolean</span>]))</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> timerTsState: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>](<span class="string">&quot;timer-ts&quot;</span>, classOf[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> outputTag = <span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">OrderResult</span>](<span class="string">&quot;order-timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(value: <span class="type">OrderLog</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">OrderLog</span>, <span class="type">OrderResult</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">OrderResult</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> isCreate = createState.value()</span><br><span class="line">    <span class="keyword">val</span> isPayed = payState.value()</span><br><span class="line">    <span class="keyword">val</span> timerTs = timerTsState.value()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 当前到达的是订单创建记录</span></span><br><span class="line">    <span class="keyword">if</span> (value.eventType.equals(<span class="string">&quot;create&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isPayed) &#123;</span><br><span class="line">        <span class="comment">// 1.1 到达的订单已经支付完成，清空状态并输出支付完成记录</span></span><br><span class="line">        ctx.timerService().deleteEventTimeTimer(timerTs)</span><br><span class="line">        createState.clear()</span><br><span class="line">        payState.clear()</span><br><span class="line">        timerTsState.clear()</span><br><span class="line">        out.collect(<span class="type">OrderResult</span>(value.orderId, <span class="string">&quot;order completed!&quot;</span>))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 1.2 到达的订单未支付，需要等待支付记录达到</span></span><br><span class="line">        <span class="keyword">val</span> ts = value.timestamp * <span class="number">1000</span>L + <span class="number">15</span> * <span class="number">60000</span></span><br><span class="line">        ctx.timerService().registerEventTimeTimer(ts)</span><br><span class="line">        timerTsState.update(ts)</span><br><span class="line">        createState.update(<span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2 当前到达的是订单支付记录</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (value.eventType.equals(<span class="string">&quot;pay&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isCreate) &#123;</span><br><span class="line">        <span class="comment">// 2.1 如果已经创建订单了，则匹配成功。还要判断一下支付时间是否超过了定时器时间</span></span><br><span class="line">        <span class="keyword">if</span> (value.timestamp * <span class="number">1000</span>L &lt;= timerTs) &#123;</span><br><span class="line">          <span class="comment">// 2.1.1 如果支付时间小于定时器时间，正常输出</span></span><br><span class="line">          ctx.timerService().deleteEventTimeTimer(timerTs)</span><br><span class="line">          out.collect(<span class="type">OrderResult</span>(value.orderId, <span class="string">&quot;order completed!&quot;</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 2.1.2 如果支付时间大于定时器时间，则超时，输出到侧输出流</span></span><br><span class="line">          ctx.output(outputTag, <span class="type">OrderResult</span>(value.orderId, <span class="string">&quot;支付时间超过订单有效时间，发生异常&quot;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        createState.clear()</span><br><span class="line">        payState.clear()</span><br><span class="line">        timerTsState.clear()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 2.2 如果订单未创建，那么可能是无序数据造成的，设置定时器触发时间为支付时间，等待水位线漫过当前支付时间时触发</span></span><br><span class="line">        <span class="keyword">val</span> ts = value.timestamp * <span class="number">1000</span>L</span><br><span class="line">        ctx.timerService().registerEventTimeTimer(ts)</span><br><span class="line">        timerTsState.update(ts)</span><br><span class="line">        payState.update(<span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定时器触发有两种场景 1.订单创建但是没有支付，会注册一个定时器； 2.已支付但是没有创建订单。</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">Long</span>, <span class="type">OrderLog</span>, <span class="type">OrderResult</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">OrderResult</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// 1.订单创建但是没有支付，会注册一个定时器；</span></span><br><span class="line">    <span class="keyword">if</span> (createState.value()) &#123;</span><br><span class="line">      ctx.output(outputTag, <span class="type">OrderResult</span>(ctx.getCurrentKey, <span class="string">&quot;order timeout(not found pay log)&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.有支付数据但是没有创建数据，会注册一个定时器；</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(payState.value()) &#123;</span><br><span class="line">      ctx.output(outputTag, <span class="type">OrderResult</span>(ctx.getCurrentKey, <span class="string">&quot;order timeout(not found create log)&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    createState.clear()</span><br><span class="line">    payState.clear()</span><br><span class="line">    timerTsState.clear()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="双流join-匹配支付和流水记录"><a href="#双流join-匹配支付和流水记录" class="headerlink" title="双流join 匹配支付和流水记录"></a>双流join 匹配支付和流水记录</h2><blockquote>
<p>一条流中是平台的支付行为记录，另一条流中是第三方的流水记录，支付和流水记录有相同流水单号的进行匹配。<br><strong>双流join的API区别：</strong>connect允许数据类型不同的流进行join；union只允许数据类型相同的流进行join；window join和interval join是固定的格式，可定制化不高。<br><strong>逻辑：</strong>哪条先到达，就先存到状态中，另一条到达后再进行输出并清空状态。</p>
</blockquote>
<h3 id="方法一：使用connect"><a href="#方法一：使用connect" class="headerlink" title="方法一：使用connect"></a>方法一：使用connect</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.orderpaydetect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">CoProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/8 18:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiptEvent</span>(<span class="params">txId: <span class="type">String</span>, payChannel: <span class="type">String</span>, timestamp: <span class="type">Long</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TxMatch</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> orderResource = getClass.getResource(<span class="string">&quot;/OrderLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> orderInputStream = env.readTextFile(orderResource.getPath)</span><br><span class="line">    <span class="keyword">val</span> orderDataStream = orderInputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">OrderLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>), arr(<span class="number">2</span>), arr(<span class="number">3</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> receiptResource = getClass.getResource(<span class="string">&quot;/ReceiptLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> <span class="type">ReceiptInputStream</span> = env.readTextFile(receiptResource.getPath)</span><br><span class="line">    <span class="keyword">val</span> receiptDataStream = <span class="type">ReceiptInputStream</span></span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">ReceiptEvent</span>(arr(<span class="number">0</span>), arr(<span class="number">1</span>), arr(<span class="number">2</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = orderDataStream.filter(_.eventType.equals(<span class="string">&quot;pay&quot;</span>)).keyBy(_.txId)</span><br><span class="line">      .connect(receiptDataStream.keyBy(_.txId))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">TxPayMatchResult</span>())</span><br><span class="line"></span><br><span class="line">    resultStream.print(<span class="string">&quot;info&quot;</span>)</span><br><span class="line">    resultStream.getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">OrderLog</span>](<span class="string">&quot;unmatched-order&quot;</span>)).print(<span class="string">&quot;unmatched-order&quot;</span>)</span><br><span class="line">    resultStream.getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">ReceiptEvent</span>](<span class="string">&quot;unmatched-pay&quot;</span>)).print(<span class="string">&quot;unmatched-pay&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;tx match&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双流connect，将符合条件的信息缓存在状态中，然后进行匹配输出</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TxPayMatchResult</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">CoProcessFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)] </span>&#123;</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> payEventState: <span class="type">ValueState</span>[<span class="type">OrderLog</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">OrderLog</span>](<span class="string">&quot;pay-event&quot;</span>, classOf[<span class="type">OrderLog</span>]))</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> receiptEventState: <span class="type">ValueState</span>[<span class="type">ReceiptEvent</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">ReceiptEvent</span>](<span class="string">&quot;receipt-event&quot;</span>, classOf[<span class="type">ReceiptEvent</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement1</span></span>(value: <span class="type">OrderLog</span>, ctx: <span class="type">CoProcessFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]#<span class="type">Context</span>, out: <span class="type">Collector</span>[(<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> receiptEvent: <span class="type">ReceiptEvent</span> = receiptEventState.value()</span><br><span class="line">    <span class="keyword">if</span> (receiptEvent == <span class="literal">null</span>) &#123;</span><br><span class="line">      payEventState.update(value)</span><br><span class="line">      ctx.timerService().registerEventTimeTimer(value.timestamp*<span class="number">1000</span>L + <span class="number">5</span>*<span class="number">1000</span>L)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      out.collect((value,receiptEvent))</span><br><span class="line">      payEventState.clear()</span><br><span class="line">      receiptEventState.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement2</span></span>(value: <span class="type">ReceiptEvent</span>, ctx: <span class="type">CoProcessFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]#<span class="type">Context</span>, out: <span class="type">Collector</span>[(<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> payEvent: <span class="type">OrderLog</span> = payEventState.value()</span><br><span class="line">    <span class="keyword">if</span> (payEvent == <span class="literal">null</span>) &#123;</span><br><span class="line">      receiptEventState.update(value)</span><br><span class="line">      ctx.timerService().registerEventTimeTimer(value.timestamp*<span class="number">1000</span>L + <span class="number">3</span>*<span class="number">1000</span>L)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      out.collect((payEvent,value))</span><br><span class="line">      payEventState.clear()</span><br><span class="line">      receiptEventState.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">CoProcessFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[(<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> order = payEventState.value()</span><br><span class="line">    <span class="keyword">val</span> receipt = receiptEventState.value()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(order != <span class="literal">null</span>) &#123;</span><br><span class="line">      ctx.output(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">OrderLog</span>](<span class="string">&quot;unmatched-order&quot;</span>),order)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (receipt != <span class="literal">null</span>) &#123;</span><br><span class="line">      ctx.output(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">ReceiptEvent</span>](<span class="string">&quot;unmatched-pay&quot;</span>),receipt)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###方法二：使用 join 算子处理</p>
<blockquote>
<p><strong>join算子分为window join 和 interval join：</strong></p>
<ul>
<li><strong>窗口连接（连接该记录所在窗口中的另一条流的记录）：</strong>stream.join(otherStream).where(<KeySelector>).equalTo(<KeySelector>).window(<WindowAssigner>).apply(<JoinFunction>)</li>
<li><strong>间隔连接（连接记录前后相隔固定时间内的另一条流的记录）：</strong>stream.keyBy(…).intervalJoin( otherStream.keyBy(…) ).between( Time.milliseconds(-2) ), Time.milliseconds(1) ).process(new ProcessJoinFunction)</li>
</ul>
</blockquote>
<blockquote>
<p><strong>逻辑：</strong>通过intervalJoin，匹配流中的记录的前3s和后5s时间间隔内的数据。匹配上的数据进入ProcessJoinFunction类中进行输出。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hxr.orderpaydetect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">ProcessJoinFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Author: CJ</span></span><br><span class="line"><span class="comment"> * @Data: 2021/1/11 15:27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TxMatchUseJoin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> orderResource = getClass.getResource(<span class="string">&quot;/OrderLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> orderInputStream = env.readTextFile(orderResource.getPath)</span><br><span class="line">    <span class="keyword">val</span> orderDataStream = orderInputStream</span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">OrderLog</span>(arr(<span class="number">0</span>).toLong, arr(<span class="number">1</span>), arr(<span class="number">2</span>), arr(<span class="number">3</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> receiptResource = getClass.getResource(<span class="string">&quot;/ReceiptLog.csv&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> <span class="type">ReceiptInputStream</span> = env.readTextFile(receiptResource.getPath)</span><br><span class="line">    <span class="keyword">val</span> receiptDataStream = <span class="type">ReceiptInputStream</span></span><br><span class="line">      .map(data =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = data.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="type">ReceiptEvent</span>(arr(<span class="number">0</span>), arr(<span class="number">1</span>), arr(<span class="number">2</span>).toLong)</span><br><span class="line">      &#125;)</span><br><span class="line">      .assignAscendingTimestamps(_.timestamp * <span class="number">1000</span>L)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> resultStream = orderDataStream.filter(_.eventType.equals(<span class="string">&quot;pay&quot;</span>)).keyBy(_.txId)</span><br><span class="line">      .intervalJoin(receiptDataStream.keyBy(_.txId))</span><br><span class="line">      .between(<span class="type">Time</span>.seconds(<span class="number">-3</span>), <span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">TxMatchWithJoinResult</span>)</span><br><span class="line"></span><br><span class="line">    resultStream.print(<span class="string">&quot;success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="string">&quot;tx match join&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TxMatchWithJoinResult</span> <span class="keyword">extends</span> <span class="title">ProcessJoinFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(left: <span class="type">OrderLog</span>, right: <span class="type">ReceiptEvent</span>, ctx: <span class="type">ProcessJoinFunction</span>[<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>, (<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]#<span class="type">Context</span>, out: <span class="type">Collector</span>[(<span class="type">OrderLog</span>, <span class="type">ReceiptEvent</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    out.collect((left,right))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<br>
<br>
##总结
1. **.process(new ProcessWindowFunction(...)) 和 .aggregate(new AggregateFunction(...),new WindowFunction(...)) 的区别：**
- .process中会保存所有数据，并在窗口触发计算(即窗口关闭或触发器触发)时调用process方法进行数据处理。这样会保存所有的窗口数据导致内存消耗过大，可以通过设置触发器，以事件触发并清空窗口数据，将结果进行持久化来进行优化。
- .aggregate方法可以定义累加器，累加器以事件触发。窗口关闭后会将累加器结果给到WindowFunction函数进行处理，这样完成了窗口的数据统计，也没有缓存所有的窗口数据。

<ol start="2">
<li><p>可以通过自定义trigger类自定义触发机制，默认触发机制是来一条记录触发一次处理逻辑。</p>
</li>
<li><p>需要比较到达的数据的时间戳判断是否是过期数据，原因有两点①避免过期数据推进watermark并触发定时器的情况，因为这样会先进入逻辑判断，然后触发定时器 ②避免数据读取过快，水位线之间数据量太大，过期数据到达但是水位线没有推进，没有触发定时器，导致将过期数据作为正常数据进行处理的情况。</p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%94%E8%AE%B0/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/">http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%AC%94%E8%AE%B0/Flink%E5%AE%9E%E6%97%B6%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E9%9B%86%E7%BE%A4%E9%97%AE%E9%A2%98/" title="集群问题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">集群问题</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/Hadoop%E5%8D%87%E7%BA%A7/" title="Hadoop升级"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Hadoop升级</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E5%87%BA%E4%B9%B1%E5%BA%8F%E6%95%B0%E6%8D%AE%E4%B8%AD%E7%9A%84%E4%B8%A4%E7%A7%92%E5%86%85%E8%BF%9E%E7%BB%AD%E4%B8%A4%E6%AC%A1%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.</span> <span class="toc-text">筛选出乱序数据中的两秒内连续两次登录失败数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E6%B5%81join-%E5%8C%B9%E9%85%8D%E6%94%AF%E4%BB%98%E5%92%8C%E6%B5%81%E6%B0%B4%E8%AE%B0%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">双流join 匹配支付和流水记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8connect"><span class="toc-number">2.1.</span> <span class="toc-text">方法一：使用connect</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>