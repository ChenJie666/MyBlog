<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ClickHouse-21-7-高阶 | Hexo</title><meta name="author" content="CJ"><meta name="copyright" content="CJ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ClickHouse为什么那么快？①只需要读取要计算的列数据，而非行式的整行数据读取，降低IO cost②同列同类型，有十倍压缩提升，进一步降低IO③clickhouse根据不同存储场景，做个性化搜索算法。 1. 硬件优化基于将硬件功效最大化的目的，ClickHouse 会在内存中进行GROUP BY，并且使用 HashTable 装载数据。与此同时，他们非常在意 CPU L3级别的缓存，因为一次">
<meta property="og:type" content="article">
<meta property="og:title" content="ClickHouse-21-7-高阶">
<meta property="og:url" content="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E9%AB%98%E9%98%B6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ClickHouse为什么那么快？①只需要读取要计算的列数据，而非行式的整行数据读取，降低IO cost②同列同类型，有十倍压缩提升，进一步降低IO③clickhouse根据不同存储场景，做个性化搜索算法。 1. 硬件优化基于将硬件功效最大化的目的，ClickHouse 会在内存中进行GROUP BY，并且使用 HashTable 装载数据。与此同时，他们非常在意 CPU L3级别的缓存，因为一次">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2023-05-06T05:31:21.055Z">
<meta property="article:modified_time" content="2023-05-06T05:31:21.055Z">
<meta property="article:author" content="CJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E9%AB%98%E9%98%B6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ClickHouse-21-7-高阶',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-06 13:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><span class="site-name">Hexo</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ClickHouse-21-7-高阶</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-06T05:31:21.055Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-06T05:31:21.055Z" title="更新于 2023-05-06 13:31:21">2023-05-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/">大数据离线</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ClickHouse-21-7-高阶"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ClickHouse为什么那么快？"><a href="#ClickHouse为什么那么快？" class="headerlink" title="ClickHouse为什么那么快？"></a>ClickHouse为什么那么快？</h1><p>①只需要读取要计算的列数据，而非行式的整行数据读取，降低IO cost<br>②同列同类型，有十倍压缩提升，进一步降低IO<br>③clickhouse根据不同存储场景，做个性化搜索算法。</p>
<h2 id="1-硬件优化"><a href="#1-硬件优化" class="headerlink" title="1. 硬件优化"></a>1. 硬件优化</h2><p>基于将硬件功效最大化的目的，ClickHouse 会在内存中进行GROUP BY，并且使用 HashTable 装载数据。与此同时，他们非常在意 CPU L3级别的缓存，因为一次L3的缓存失效会带来70～100ns的延迟。这意味着在单核 CPU 上，它会浪费4000万次&#x2F;秒的运算；而在一个32线程的 CPU 上，则可能会浪费5亿次&#x2F;秒的运算。所以别小看这些细节，一点一滴地将它们累加起来，数据是非常可观的。正因为注意了这些细节，所以 ClickHouse 在基准查询中能做到1.75亿次&#x2F;秒的数据扫描性能。</p>
<h2 id="2-算法优化"><a href="#2-算法优化" class="headerlink" title="2. 算法优化"></a>2. 算法优化</h2><p>算法的选择是重中之重。以字符串为例，有一本专门讲解字符串搜索的书，名为“Handbook of Exact String Matching Algorithms”，列举了35种常见的字符串搜索算法。各位猜一猜 ClickHouse 使用了其中的哪一种？答案是一种都没有。这是为什么呢？因为性能不够快。在字符串搜索方面，针对不同的场景，ClickHouse 最终选择了这些算法：对于常量，使用 Volnitsky 算法；对于非常量，使用 CPU 的向量化执行 SIMD，暴力优化；正则匹配使用 re2 和hyperscan 算法。性能是算法选择的首要考量指标。</p>
<p>除了字符串之外，其余的场景也与它类似，ClickHouse 会使用最合适、最快的算法。如果世面上出现了号称性能强大的新算法，ClickHouse 团队会立即将其纳入并进行验证。如果效果不错，就保留使用；如果性能不尽人意，就将其抛弃。</p>
<h2 id="3-特定场景，特殊优化"><a href="#3-特定场景，特殊优化" class="headerlink" title="3. 特定场景，特殊优化"></a>3. 特定场景，特殊优化</h2><p>针对同一个场景的不同状况，选择使用不同的实现方式，尽可能将性能最大化。关于这一点，其实在前面介绍字符串查询时，针对不同场景选择不同算法的思路就有体现了。类似的例子还有很多，例如去重计数 uniqCombined 函数，会根据数据量的不同选择不同的算法：当数据量较小的时候，会选择 Array 保存；当数据量中等的时候，会选择 HashSet；而当数据量很大的时候，则使用HyperLogLog 算法。</p>
<p>对于数据结构比较清晰的场景，会通过代码生成技术实现循环展开，以减少循环次数。接着就是大家熟知的大杀器—向量化执行了。SIMD 被广泛地应用于文本转换、数据过滤、数据解压和 JSON 转换等场景。相较于单纯地使用 CPU，利用寄存器暴力优化也算是一种降维打击了。</p>
<h2 id="4-快速迭代优化"><a href="#4-快速迭代优化" class="headerlink" title="4. 快速迭代优化"></a>4. 快速迭代优化</h2><p>拥有能够持续验证、持续改进的机制。<br>由于 Yandex的天然优势，ClickHouse 经常会使用真实的数据进行测试，这一点很好地保证了测试场景的真实性。与此同时，ClickHouse 也是我见过的发版速度最快的开源软件了，差不多每个月都能发布一个版本。没有一个可靠的持续集成环境，这一点是做不到的。正因为拥有这样的发版频率，ClickHouse 才能够快速迭代、快速改进。</p>
<br>
# 一、Explain查看执行计划
在 clickhouse 20.6 版本之前要查看 SQL 语句的执行计划需要设置日志级别为 trace 才能可以看到，并且只能真正执行 sql，在执行日志里面查看。在 20.6 版本引入了原生的执行计划的语法。在 20.6.3 版本成为正式版本的功能。

<h2 id="1-1-基本语法"><a href="#1-1-基本语法" class="headerlink" title="1.1 基本语法"></a>1.1 基本语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN [AST | SYNTAX | PLAN | PIPELINE] [setting = value, ...] </span><br><span class="line">SELECT ... [FORMAT ...]</span><br></pre></td></tr></table></figure>
<ul>
<li>PLAN：用于查看执行计划，默认值；<ul>
<li>header：打印计划中各个步骤的 head 说明，默认关闭，默认值 0;</li>
<li>description 打印计划中各个步骤的描述，默认开启，默认值 1；</li>
<li>actions 打印计划中各个步骤的详细信息，默认关闭，默认值 0。</li>
</ul>
</li>
<li>AST：用于查看语法树；</li>
<li>SYNTAX：用于优化语法，可以查看有优化后的语句；</li>
<li>PIPELINE：用于查看PIPELINE计划。<ul>
<li>header：打印计划中各个步骤的 head 说明，默认关闭；</li>
<li>graph：用 DOT 图形语言描述管道图，默认关闭，需要查看相关的图形需要配合graphviz 查看；</li>
<li>actions：如果开启了 graph，紧凑打印打，默认开启。<br>注：PLAN和PIPELINE还可以进行额外的显示设置，如上参数所示</li>
</ul>
</li>
</ul>
<h2 id="1-2-案例实操"><a href="#1-2-案例实操" class="headerlink" title="1.2 案例实操"></a>1.2 案例实操</h2><h3 id="1-2-1-新版本使用EXPLAIN"><a href="#1-2-1-新版本使用EXPLAIN" class="headerlink" title="1.2.1 新版本使用EXPLAIN"></a>1.2.1 新版本使用EXPLAIN</h3><p>可以再安装一个 20.6 以上版本，或者直接在官网的在线 demo，选择高版本进行测试。<br>官网在线测试链接：<a target="_blank" rel="noopener" href="https://play.clickhouse.tech/?file=welcome">https://play.clickhouse.tech/?file=welcome</a></p>
<h4 id="1）查看PLAIN"><a href="#1）查看PLAIN" class="headerlink" title="1）查看PLAIN"></a>1）查看PLAIN</h4><p><strong>简单查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain plan select arrayJoin([1,2,3,null,null]);</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌─explain───────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Expression ((Projection + Before ORDER BY))                               │</span><br><span class="line">│   SettingQuotaAndLimits (Set limits and quota after reading from storage) │</span><br><span class="line">│     ReadFromStorage (SystemOne)                                           │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
**复杂SQL执行**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select database,table,count(1) cnt from system.parts where database in (&#x27;datasets&#x27;,&#x27;system&#x27;) group by database,table order by database,cnt desc limit 2 by database;</span><br></pre></td></tr></table></figure>
执行结果如下
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Expression (Projection)                                                                     │</span><br><span class="line">│   LimitBy                                                                                   │</span><br><span class="line">│     Expression (Before LIMIT BY)                                                            │</span><br><span class="line">│       MergingSorted (Merge sorted streams for ORDER BY)                                     │</span><br><span class="line">│         MergeSorting (Merge sorted blocks for ORDER BY)                                     │</span><br><span class="line">│           PartialSorting (Sort each block for ORDER BY)                                     │</span><br><span class="line">│             Expression (Before ORDER BY)                                                    │</span><br><span class="line">│               Aggregating                                                                   │</span><br><span class="line">│                 Expression (Before GROUP BY)                                                │</span><br><span class="line">│                   Filter (WHERE)                                                            │</span><br><span class="line">│                     SettingQuotaAndLimits (Set limits and quota after reading from storage) │</span><br><span class="line">│                       ReadFromStorage (SystemParts)                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
**打开全部的参数的执行计划**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN header=1, actions=1,description=1 SELECT number from system.numbers limit 10;</span><br></pre></td></tr></table></figure>
执行结果如下
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─explain───────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Expression ((Projection + Before ORDER BY))                               │</span><br><span class="line">│ Header: number UInt64                                                     │</span><br><span class="line">│ Actions: INPUT :: 0 -&gt; number UInt64 : 0                                  │</span><br><span class="line">│ Positions: 0                                                              │</span><br><span class="line">│   SettingQuotaAndLimits (Set limits and quota after reading from storage) │</span><br><span class="line">│   Header: number UInt64                                                   │</span><br><span class="line">│     Limit (preliminary LIMIT)                                             │</span><br><span class="line">│     Header: number UInt64                                                 │</span><br><span class="line">│     Limit 10                                                              │</span><br><span class="line">│     Offset 0                                                              │</span><br><span class="line">│       ReadFromStorage (SystemNumbers)                                     │</span><br><span class="line">│       Header: number UInt64                                               │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<h4 id="2）语法树"><a href="#2）语法树" class="headerlink" title="2）语法树"></a>2）语法树</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN AST SELECT number from system.numbers limit 10;</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────┐</span><br><span class="line">│ SelectWithUnionQuery (children 1)           │</span><br><span class="line">│  ExpressionList (children 1)                │</span><br><span class="line">│   SelectQuery (children 3)                  │</span><br><span class="line">│    ExpressionList (children 1)              │</span><br><span class="line">│     Identifier number                       │</span><br><span class="line">│    TablesInSelectQuery (children 1)         │</span><br><span class="line">│     TablesInSelectQueryElement (children 1) │</span><br><span class="line">│      TableExpression (children 1)           │</span><br><span class="line">│       TableIdentifier system.numbers        │</span><br><span class="line">│    Literal UInt64_10                        │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="3）SYNTAX语法优化"><a href="#3）SYNTAX语法优化" class="headerlink" title="3）SYNTAX语法优化"></a>3）SYNTAX语法优化</h4><p>进行如下查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT number = 1 ? &#x27;hello&#x27; : (number = 2 ? &#x27;world&#x27; : &#x27;atguigu&#x27;) FROM numbers(10);</span><br></pre></td></tr></table></figure>
<p>通过如下搜索，查看语法优化后的执行语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX SELECT number = 1 ? &#x27;hello&#x27; : (number = 2 ? &#x27;world&#x27; : &#x27;atguigu&#x27;) FROM numbers(10);</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─explain────────────────────────────────────────────────────────────┐</span><br><span class="line">│ SELECT if(number = 1, &#x27;hello&#x27;, if(number = 2, &#x27;world&#x27;, &#x27;atguigu&#x27;)) │</span><br><span class="line">│ FROM numbers(10)                                                   │</span><br><span class="line">└────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>可以发现优化后执行的语句与原语句相同。</p>
<p>现在开启三元运算符优化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET optimize_if_chain_to_multiif = 1;</span><br></pre></td></tr></table></figure>
<p>再次查看语法优化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX SELECT number = 1 ? &#x27;hello&#x27; : (number = 2 ? &#x27;world&#x27; : &#x27;atguigu&#x27;) FROM numbers(10);</span><br></pre></td></tr></table></figure>
<p>返回优化后的语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ SELECT multiIf(number = 1, &#x27;hello&#x27;, number = 2, &#x27;world&#x27;, &#x27;atguigu&#x27;) │</span><br><span class="line">│ FROM numbers(10)                                                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>可以发现，开启三元运算符优化设置后，后台执行时对语句进行了优化，优化后的语法执行效率更高。</p>
<h4 id="4）查看PIPELINE"><a href="#4）查看PIPELINE" class="headerlink" title="4）查看PIPELINE"></a>4）查看PIPELINE</h4><p>PIPELINE相比较PLAN，获得的细节信息更多更详细。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN PIPELINE SELECT sum(number) FROM numbers_mt(100000) GROUP BY number % 20; </span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────┐</span><br><span class="line">│ (Expression)                    │</span><br><span class="line">│ ExpressionTransform             │</span><br><span class="line">│   (Aggregating)                 │</span><br><span class="line">│   Resize 16 → 1                 │</span><br><span class="line">│     AggregatingTransform × 16   │</span><br><span class="line">│       (Expression)              │</span><br><span class="line">│       ExpressionTransform × 16  │</span><br><span class="line">│         (SettingQuotaAndLimits) │</span><br><span class="line">│           (ReadFromStorage)     │</span><br><span class="line">│           NumbersMt × 16 0 → 1  │</span><br><span class="line">└─────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<blockquote>
<p>×16表示有16个线程运行该步骤的任务，默认为16，如果节点线程数没有16，则为节点最大线程数。</p>
</blockquote>
<p>打开显示其他参数，可以获得更加详细的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN PIPELINE header=1,graph=1 SELECT sum(number) FROM numbers_mt(10000) GROUP BY number%20;</span><br></pre></td></tr></table></figure>


<h3 id="1-2-2-老版本查看执行计划"><a href="#1-2-2-老版本查看执行计划" class="headerlink" title="1.2.2 老版本查看执行计划"></a>1.2.2 老版本查看执行计划</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client -h 主机名 --send_logs_level=trace &lt;&lt;&lt; &quot;sql&quot; &gt; /dev/null</span><br></pre></td></tr></table></figure>
<p>其中，send_logs_level 参数指定日志等级为 trace，&lt;&lt;&lt;将 SQL 语句重定向至 clickhouse-client 进行查询，&gt; &#x2F;dev&#x2F;null 将查询结果重定向到空设备吞掉，以便观察日志。</p>
<p>注意：<br>1、通过将 ClickHouse 的服务日志，设置到 DEBUG 或者 TRACE 级别，才可以变相实现EXPLAIN 查询的作用。<br>2、需要真正的执行 SQL 查询，CH 才能打印计划日志，所以如果表的数据量很大，最好借助 LIMIT 子句，减小查询返回的数据量。</p>
<br>
# 二、建表优化
## 2.1 数据类型
### 2.1.1 时间字段的类型
建表时能用数值型或日期时间型表示的字段就不要用字符串，全 String 类型在以 Hive 为中心的数仓建设中常见，但 ClickHouse 环境不应受此影响。
虽然 ClickHouse 底层将 DateTime 存储为时间戳 Long 类型，但不建议存储 Long 类型，因为 DateTime 不需要经过函数转换处理，执行效率高、可读性好。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table t_type2(</span><br><span class="line"> id UInt32,</span><br><span class="line"> sku_id String,</span><br><span class="line"> total_amount Decimal(16,2) ,</span><br><span class="line"> create_time Int32 </span><br><span class="line">) engine =ReplacingMergeTree(create_time)</span><br><span class="line"> partition by toYYYYMMDD(toDate(create_time))  --需要转换一次，否则报错</span><br><span class="line"> primary key (id)</span><br><span class="line"> order by (id, sku_id);</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-空值存储类型"><a href="#2-1-2-空值存储类型" class="headerlink" title="2.1.2 空值存储类型"></a>2.1.2 空值存储类型</h3><p>官方已经指出 Nullable 类型几乎总是会拖累性能，原因有两个</p>
<ul>
<li>存储 Nullable 列时需要创建一个额外的文件来存储 NULL 的标</li>
<li>Nullable 列无法被索引。</li>
</ul>
<p>因此除非极特殊情况，应直接使用字段默认值表示空，或者自行指定一个在业务中无意义的值（例如用-1 表示没有商品ID）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_null(x Int8, y Nullable(Int8)) ENGINE TinyLog;</span><br><span class="line">INSERT INTO t_null VALUES (1, NULL), (2, 3);</span><br><span class="line">SELECT x + y FROM t_null;</span><br></pre></td></tr></table></figure>

<p>可以查看数据文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-rw-r-----. 1 clickhouse clickhouse 91 8月  16 14:55 sizes.json</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse 28 8月  16 14:55 x.bin</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse 28 8月  16 14:55 y.bin</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse 28 8月  16 14:55 y.null.bin</span><br></pre></td></tr></table></figure>
<p>可以看到在tinylog引擎中对于null值，会另存一个数据文件。</p>
<p>但是试了MergeTree引擎，是存在同一个bin文件中的，什么原因？？？</p>
<br>
## 2.2 分区和索引
分区粒度根据业务特点决定，不宜过粗或过细。一般选择按天分区，也可以指定为 Tuple()，以单表一亿数据为例，分区大小控制在 10-30 个为最佳。

<p>必须指定索引列，ClickHouse 中的索引列即排序列，通过 order by 指定，一般在查询条件中经常被用来充当筛选条件的属性被纳入进来；可以是单一维度，也可以是组合维度的索引；通常需要满足高级列在前、查询频率大的在前原则；还有基数特别大的不适合做索引列，如用户表的 userid 字段；通常筛选后的数据满足在百万以内为最佳。（不理解，分区内的索引不应该是不同值越多越好定位吗？？？）</p>
<p>比如官方案例的 hits_v1 表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">PARTITION BY toYYYYMM(EventDate)</span><br><span class="line">ORDER BY (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<p>visits_v1 表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">PARTITION BY toYYYYMM(StartDate)</span><br><span class="line">ORDER BY (CounterID, StartDate, intHash32(UserID), VisitID)</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h2 id="2-3-表参数"><a href="#2-3-表参数" class="headerlink" title="2.3 表参数"></a>2.3 表参数</h2><p>Index_granularity 是用来控制索引粒度的，默认是 8192，如非必须不建议调整。</p>
<p>如果表中不是必须保留全量历史数据，建议指定 TTL（生存时间值），可以免去手动过期历史数据的麻烦，TTL 也可以通过 alter table 语句随时修改。（参考基础文档 4.4.5 数据 TTL）</p>
<h2 id="2-4-写入和删除优化"><a href="#2-4-写入和删除优化" class="headerlink" title="2.4 写入和删除优化"></a>2.4 写入和删除优化</h2><p>（1）尽量不要执行单条或小批量删除和插入操作，这样会产生小分区文件，给后台Merge 任务带来巨大压力<br>（2）不要一次写入太多分区，或数据写入太快，数据写入太快会导致 Merge 速度跟不上而报错，一般建议每秒钟发起 2-3 次写入操作，每次操作写入 2w~5w 条数据（依服务器性能而定）</p>
<p><strong>写入过快报错，报错信息：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. Code: 252, e.displayText() = DB::Exception: Too many parts(304). </span><br><span class="line">Merges are processing significantly slower than inserts</span><br><span class="line">2. Code: 241, e.displayText() = DB::Exception: Memory limit (for query) </span><br><span class="line">exceeded:would use 9.37 GiB (attempt to allocate chunk of 301989888 </span><br><span class="line">bytes), maximum: 9.31 GiB</span><br></pre></td></tr></table></figure>

<br>
**“ Too many parts 处理 ” ：**
- 使用 WAL 预写日志，提高写入性能。in_memory_parts_enable_wal 默认为 true。
- 降低写入频率

<p><strong>Memory limit 处理</strong></p>
<ul>
<li>在服务器内存充裕的情况下增加内存配额，一般通过 max_memory_usage 来实现</li>
<li>在服务器内存不充裕的情况下，建议将超出部分内容分配到系统硬盘上，但会降低执行速度，一般通过 max_bytes_before_external_group_by、max_bytes_before_external_sort 参数来实现。</li>
</ul>
<h2 id="2-5-常见配置"><a href="#2-5-常见配置" class="headerlink" title="2.5 常见配置"></a>2.5 常见配置</h2><p>配置项主要在 config.xml 或 users.xml 中， 基本上都在 users.xml 里。</p>
<ul>
<li>config.xml 的配置项<br><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/">https://clickhouse.tech/docs/en/operations/server-configuration-parameters/settings/</a></li>
<li>users.xml 的配置项<br><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/operations/settings/settings/">https://clickhouse.tech/docs/en/operations/settings/settings/</a></li>
</ul>
<h3 id="2-5-1-CPU资源"><a href="#2-5-1-CPU资源" class="headerlink" title="2.5.1 CPU资源"></a>2.5.1 CPU资源</h3><table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>background_pool_size</td>
<td>后台线程池的大小，merge 线程就是在该线程池中执行，该线程池不仅仅是给 merge 线程用的，默认值 16，允许的前提下建议改成 <code>cpu 个数的 2 倍（线程数）</code>。</td>
</tr>
<tr>
<td>background_schedule_pool_size</td>
<td>执行后台任务（复制表、Kafka 流、DNS 缓存更新）的线程数。默 认 128，建议改成 cpu 个数的 2 倍（线程数）。</td>
</tr>
<tr>
<td>background_distributed_schedule_pool_size</td>
<td>设置为分布式发送执行后台任务的线程数，默认 16，建议改成 <code>cpu个数的 2 倍（线程数）</code>。</td>
</tr>
<tr>
<td>max_concurrent_queries</td>
<td>最大并发处理的请求数(包含 select,insert 等)，默认值 100，推荐 <code>150(不够再加)~300</code>。</td>
</tr>
<tr>
<td>max_threads</td>
<td>设置单个查询所能使用的最大 cpu 个数，默认是 cpu 核数</td>
</tr>
</tbody></table>
<h3 id="2-5-2-内存资源"><a href="#2-5-2-内存资源" class="headerlink" title="2.5.2 内存资源"></a>2.5.2 内存资源</h3><table>
<thead>
<tr>
<th>配置</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>max_memory_usage</td>
<td>此参数在 users.xml 中,表示单次 Query 占用内存最大值，该值可以设置的比较大，这样可以提升集群查询的上限。保留一点给 OS，比如 <code>128G 内存的机器，设置为 100GB</code>。</td>
</tr>
<tr>
<td>max_bytes_before_external_group_by</td>
<td>一般按照 max_memory_usage 的一半设置内存，当 group 使用内存超过阈值后会刷新到磁盘进行。因为 clickhouse 聚合分两个阶段：查询并及建立中间数据、合并中间数据，<code>结合上一项，建议 50GB</code>。</td>
</tr>
<tr>
<td>max_bytes_before_external_sort</td>
<td>当 order by 已使用 max_bytes_before_external_sort 内存就进行溢写磁盘(基于磁盘排序)，如果不设置该值，那么当内存不够时直接抛错，设置了该值 order by 可以正常完成，但是速度相对存内存来说肯定要慢点(实测慢的非常多，无法接受)。</td>
</tr>
<tr>
<td>max_table_size_to_drop</td>
<td>此参数在 config.xml 中，应用于需要删除表或分区的情况，默认是50GB，意思是如果删除 50GB 以上的分区表会失败。<code>建议修改为 0</code>，这样不管多大的分区表都可以删除。</td>
</tr>
</tbody></table>
<h3 id="2-5-3-存储"><a href="#2-5-3-存储" class="headerlink" title="2.5.3 存储"></a>2.5.3 存储</h3><p>ClickHouse 不支持设置多数据目录，为了提升数据 io 性能，可以挂载虚拟券组，一个券组绑定多块物理磁盘提升读写性能，多数据查询场景 SSD 会比普通机械硬盘快 2-3 倍。</p>
<br>
# 三、ClickHouse语法优化规则
ClickHouse 的 SQL 优化规则是基于 RBO(基于规则的优化器，Rule-Based Optimization)，Hive的SQL优化规则是基于CBO(基于代价的优化器，Cost-Based Optimization)，下面是一些RBO的优化规则。

<p><a target="_blank" rel="noopener" href="https://clickhouse.tech/docs/en/getting-started/tutorial/">测试教程官网地址</a></p>
<h2 id="3-1-准备测试用表"><a href="#3-1-准备测试用表" class="headerlink" title="3.1 准备测试用表"></a>3.1 准备测试用表</h2><p>1）下载官方的数据集，分别为7.3G和2.5G</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://datasets.clickhouse.tech/hits/tsv/hits_v1.tsv.xz | unxz --threads=`nproc` &gt; /tmp/ck_test/hits_v1.tsv</span><br><span class="line">curl https://datasets.clickhouse.tech/visits/tsv/visits_v1.tsv.xz | unxz --threads=`nproc` &gt; /tmp/ck_test/visits_v1.tsv</span><br></pre></td></tr></table></figure>
<p>2）创建数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --password bigdata123 --query &quot;CREATE DATABASE IF NOT EXISTS tutorial&quot;</span><br></pre></td></tr></table></figure>
<p>建表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tutorial.hits_v1</span><br><span class="line">(</span><br><span class="line">    `WatchID` UInt64,</span><br><span class="line">    `JavaEnable` UInt8,</span><br><span class="line">    `Title` String,</span><br><span class="line">    `GoodEvent` Int16,</span><br><span class="line">    `EventTime` DateTime,</span><br><span class="line">    `EventDate` Date,</span><br><span class="line">    `CounterID` UInt32,</span><br><span class="line">    `ClientIP` UInt32,</span><br><span class="line">    `ClientIP6` FixedString(16),</span><br><span class="line">    `RegionID` UInt32,</span><br><span class="line">    `UserID` UInt64,</span><br><span class="line">    `CounterClass` Int8,</span><br><span class="line">    `OS` UInt8,</span><br><span class="line">    `UserAgent` UInt8,</span><br><span class="line">    `URL` String,</span><br><span class="line">    `Referer` String,</span><br><span class="line">    `URLDomain` String,</span><br><span class="line">    `RefererDomain` String,</span><br><span class="line">    `Refresh` UInt8,</span><br><span class="line">    `IsRobot` UInt8,</span><br><span class="line">    `RefererCategories` Array(UInt16),</span><br><span class="line">    `URLCategories` Array(UInt16),</span><br><span class="line">    `URLRegions` Array(UInt32),</span><br><span class="line">    `RefererRegions` Array(UInt32),</span><br><span class="line">    `ResolutionWidth` UInt16,</span><br><span class="line">    `ResolutionHeight` UInt16,</span><br><span class="line">    `ResolutionDepth` UInt8,</span><br><span class="line">    `FlashMajor` UInt8,</span><br><span class="line">    `FlashMinor` UInt8,</span><br><span class="line">    `FlashMinor2` String,</span><br><span class="line">    `NetMajor` UInt8,</span><br><span class="line">    `NetMinor` UInt8,</span><br><span class="line">    `UserAgentMajor` UInt16,</span><br><span class="line">    `UserAgentMinor` FixedString(2),</span><br><span class="line">    `CookieEnable` UInt8,</span><br><span class="line">    `JavascriptEnable` UInt8,</span><br><span class="line">    `IsMobile` UInt8,</span><br><span class="line">    `MobilePhone` UInt8,</span><br><span class="line">    `MobilePhoneModel` String,</span><br><span class="line">    `Params` String,</span><br><span class="line">    `IPNetworkID` UInt32,</span><br><span class="line">    `TraficSourceID` Int8,</span><br><span class="line">    `SearchEngineID` UInt16,</span><br><span class="line">    `SearchPhrase` String,</span><br><span class="line">    `AdvEngineID` UInt8,</span><br><span class="line">    `IsArtifical` UInt8,</span><br><span class="line">    `WindowClientWidth` UInt16,</span><br><span class="line">    `WindowClientHeight` UInt16,</span><br><span class="line">    `ClientTimeZone` Int16,</span><br><span class="line">    `ClientEventTime` DateTime,</span><br><span class="line">    `SilverlightVersion1` UInt8,</span><br><span class="line">    `SilverlightVersion2` UInt8,</span><br><span class="line">    `SilverlightVersion3` UInt32,</span><br><span class="line">    `SilverlightVersion4` UInt16,</span><br><span class="line">    `PageCharset` String,</span><br><span class="line">    `CodeVersion` UInt32,</span><br><span class="line">    `IsLink` UInt8,</span><br><span class="line">    `IsDownload` UInt8,</span><br><span class="line">    `IsNotBounce` UInt8,</span><br><span class="line">    `FUniqID` UInt64,</span><br><span class="line">    `HID` UInt32,</span><br><span class="line">    `IsOldCounter` UInt8,</span><br><span class="line">    `IsEvent` UInt8,</span><br><span class="line">    `IsParameter` UInt8,</span><br><span class="line">    `DontCountHits` UInt8,</span><br><span class="line">    `WithHash` UInt8,</span><br><span class="line">    `HitColor` FixedString(1),</span><br><span class="line">    `UTCEventTime` DateTime,</span><br><span class="line">    `Age` UInt8,</span><br><span class="line">    `Sex` UInt8,</span><br><span class="line">    `Income` UInt8,</span><br><span class="line">    `Interests` UInt16,</span><br><span class="line">    `Robotness` UInt8,</span><br><span class="line">    `GeneralInterests` Array(UInt16),</span><br><span class="line">    `RemoteIP` UInt32,</span><br><span class="line">    `RemoteIP6` FixedString(16),</span><br><span class="line">    `WindowName` Int32,</span><br><span class="line">    `OpenerName` Int32,</span><br><span class="line">    `HistoryLength` Int16,</span><br><span class="line">    `BrowserLanguage` FixedString(2),</span><br><span class="line">    `BrowserCountry` FixedString(2),</span><br><span class="line">    `SocialNetwork` String,</span><br><span class="line">    `SocialAction` String,</span><br><span class="line">    `HTTPError` UInt16,</span><br><span class="line">    `SendTiming` Int32,</span><br><span class="line">    `DNSTiming` Int32,</span><br><span class="line">    `ConnectTiming` Int32,</span><br><span class="line">    `ResponseStartTiming` Int32,</span><br><span class="line">    `ResponseEndTiming` Int32,</span><br><span class="line">    `FetchTiming` Int32,</span><br><span class="line">    `RedirectTiming` Int32,</span><br><span class="line">    `DOMInteractiveTiming` Int32,</span><br><span class="line">    `DOMContentLoadedTiming` Int32,</span><br><span class="line">    `DOMCompleteTiming` Int32,</span><br><span class="line">    `LoadEventStartTiming` Int32,</span><br><span class="line">    `LoadEventEndTiming` Int32,</span><br><span class="line">    `NSToDOMContentLoadedTiming` Int32,</span><br><span class="line">    `FirstPaintTiming` Int32,</span><br><span class="line">    `RedirectCount` Int8,</span><br><span class="line">    `SocialSourceNetworkID` UInt8,</span><br><span class="line">    `SocialSourcePage` String,</span><br><span class="line">    `ParamPrice` Int64,</span><br><span class="line">    `ParamOrderID` String,</span><br><span class="line">    `ParamCurrency` FixedString(3),</span><br><span class="line">    `ParamCurrencyID` UInt16,</span><br><span class="line">    `GoalsReached` Array(UInt32),</span><br><span class="line">    `OpenstatServiceName` String,</span><br><span class="line">    `OpenstatCampaignID` String,</span><br><span class="line">    `OpenstatAdID` String,</span><br><span class="line">    `OpenstatSourceID` String,</span><br><span class="line">    `UTMSource` String,</span><br><span class="line">    `UTMMedium` String,</span><br><span class="line">    `UTMCampaign` String,</span><br><span class="line">    `UTMContent` String,</span><br><span class="line">    `UTMTerm` String,</span><br><span class="line">    `FromTag` String,</span><br><span class="line">    `HasGCLID` UInt8,</span><br><span class="line">    `RefererHash` UInt64,</span><br><span class="line">    `URLHash` UInt64,</span><br><span class="line">    `CLID` UInt32,</span><br><span class="line">    `YCLID` UInt64,</span><br><span class="line">    `ShareService` String,</span><br><span class="line">    `ShareURL` String,</span><br><span class="line">    `ShareTitle` String,</span><br><span class="line">    `ParsedParams` Nested(</span><br><span class="line">        Key1 String,</span><br><span class="line">        Key2 String,</span><br><span class="line">        Key3 String,</span><br><span class="line">        Key4 String,</span><br><span class="line">        Key5 String,</span><br><span class="line">        ValueDouble Float64),</span><br><span class="line">    `IslandID` FixedString(16),</span><br><span class="line">    `RequestNum` UInt32,</span><br><span class="line">    `RequestTry` UInt8</span><br><span class="line">)</span><br><span class="line">ENGINE = MergeTree()</span><br><span class="line">PARTITION BY toYYYYMM(EventDate)</span><br><span class="line">ORDER BY (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE BY intHash32(UserID);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tutorial.visits_v1</span><br><span class="line">(</span><br><span class="line">    `CounterID` UInt32,</span><br><span class="line">    `StartDate` Date,</span><br><span class="line">    `Sign` Int8,</span><br><span class="line">    `IsNew` UInt8,</span><br><span class="line">    `VisitID` UInt64,</span><br><span class="line">    `UserID` UInt64,</span><br><span class="line">    `StartTime` DateTime,</span><br><span class="line">    `Duration` UInt32,</span><br><span class="line">    `UTCStartTime` DateTime,</span><br><span class="line">    `PageViews` Int32,</span><br><span class="line">    `Hits` Int32,</span><br><span class="line">    `IsBounce` UInt8,</span><br><span class="line">    `Referer` String,</span><br><span class="line">    `StartURL` String,</span><br><span class="line">    `RefererDomain` String,</span><br><span class="line">    `StartURLDomain` String,</span><br><span class="line">    `EndURL` String,</span><br><span class="line">    `LinkURL` String,</span><br><span class="line">    `IsDownload` UInt8,</span><br><span class="line">    `TraficSourceID` Int8,</span><br><span class="line">    `SearchEngineID` UInt16,</span><br><span class="line">    `SearchPhrase` String,</span><br><span class="line">    `AdvEngineID` UInt8,</span><br><span class="line">    `PlaceID` Int32,</span><br><span class="line">    `RefererCategories` Array(UInt16),</span><br><span class="line">    `URLCategories` Array(UInt16),</span><br><span class="line">    `URLRegions` Array(UInt32),</span><br><span class="line">    `RefererRegions` Array(UInt32),</span><br><span class="line">    `IsYandex` UInt8,</span><br><span class="line">    `GoalReachesDepth` Int32,</span><br><span class="line">    `GoalReachesURL` Int32,</span><br><span class="line">    `GoalReachesAny` Int32,</span><br><span class="line">    `SocialSourceNetworkID` UInt8,</span><br><span class="line">    `SocialSourcePage` String,</span><br><span class="line">    `MobilePhoneModel` String,</span><br><span class="line">    `ClientEventTime` DateTime,</span><br><span class="line">    `RegionID` UInt32,</span><br><span class="line">    `ClientIP` UInt32,</span><br><span class="line">    `ClientIP6` FixedString(16),</span><br><span class="line">    `RemoteIP` UInt32,</span><br><span class="line">    `RemoteIP6` FixedString(16),</span><br><span class="line">    `IPNetworkID` UInt32,</span><br><span class="line">    `SilverlightVersion3` UInt32,</span><br><span class="line">    `CodeVersion` UInt32,</span><br><span class="line">    `ResolutionWidth` UInt16,</span><br><span class="line">    `ResolutionHeight` UInt16,</span><br><span class="line">    `UserAgentMajor` UInt16,</span><br><span class="line">    `UserAgentMinor` UInt16,</span><br><span class="line">    `WindowClientWidth` UInt16,</span><br><span class="line">    `WindowClientHeight` UInt16,</span><br><span class="line">    `SilverlightVersion2` UInt8,</span><br><span class="line">    `SilverlightVersion4` UInt16,</span><br><span class="line">    `FlashVersion3` UInt16,</span><br><span class="line">    `FlashVersion4` UInt16,</span><br><span class="line">    `ClientTimeZone` Int16,</span><br><span class="line">    `OS` UInt8,</span><br><span class="line">    `UserAgent` UInt8,</span><br><span class="line">    `ResolutionDepth` UInt8,</span><br><span class="line">    `FlashMajor` UInt8,</span><br><span class="line">    `FlashMinor` UInt8,</span><br><span class="line">    `NetMajor` UInt8,</span><br><span class="line">    `NetMinor` UInt8,</span><br><span class="line">    `MobilePhone` UInt8,</span><br><span class="line">    `SilverlightVersion1` UInt8,</span><br><span class="line">    `Age` UInt8,</span><br><span class="line">    `Sex` UInt8,</span><br><span class="line">    `Income` UInt8,</span><br><span class="line">    `JavaEnable` UInt8,</span><br><span class="line">    `CookieEnable` UInt8,</span><br><span class="line">    `JavascriptEnable` UInt8,</span><br><span class="line">    `IsMobile` UInt8,</span><br><span class="line">    `BrowserLanguage` UInt16,</span><br><span class="line">    `BrowserCountry` UInt16,</span><br><span class="line">    `Interests` UInt16,</span><br><span class="line">    `Robotness` UInt8,</span><br><span class="line">    `GeneralInterests` Array(UInt16),</span><br><span class="line">    `Params` Array(String),</span><br><span class="line">    `Goals` Nested(</span><br><span class="line">        ID UInt32,</span><br><span class="line">        Serial UInt32,</span><br><span class="line">        EventTime DateTime,</span><br><span class="line">        Price Int64,</span><br><span class="line">        OrderID String,</span><br><span class="line">        CurrencyID UInt32),</span><br><span class="line">    `WatchIDs` Array(UInt64),</span><br><span class="line">    `ParamSumPrice` Int64,</span><br><span class="line">    `ParamCurrency` FixedString(3),</span><br><span class="line">    `ParamCurrencyID` UInt16,</span><br><span class="line">    `ClickLogID` UInt64,</span><br><span class="line">    `ClickEventID` Int32,</span><br><span class="line">    `ClickGoodEvent` Int32,</span><br><span class="line">    `ClickEventTime` DateTime,</span><br><span class="line">    `ClickPriorityID` Int32,</span><br><span class="line">    `ClickPhraseID` Int32,</span><br><span class="line">    `ClickPageID` Int32,</span><br><span class="line">    `ClickPlaceID` Int32,</span><br><span class="line">    `ClickTypeID` Int32,</span><br><span class="line">    `ClickResourceID` Int32,</span><br><span class="line">    `ClickCost` UInt32,</span><br><span class="line">    `ClickClientIP` UInt32,</span><br><span class="line">    `ClickDomainID` UInt32,</span><br><span class="line">    `ClickURL` String,</span><br><span class="line">    `ClickAttempt` UInt8,</span><br><span class="line">    `ClickOrderID` UInt32,</span><br><span class="line">    `ClickBannerID` UInt32,</span><br><span class="line">    `ClickMarketCategoryID` UInt32,</span><br><span class="line">    `ClickMarketPP` UInt32,</span><br><span class="line">    `ClickMarketCategoryName` String,</span><br><span class="line">    `ClickMarketPPName` String,</span><br><span class="line">    `ClickAWAPSCampaignName` String,</span><br><span class="line">    `ClickPageName` String,</span><br><span class="line">    `ClickTargetType` UInt16,</span><br><span class="line">    `ClickTargetPhraseID` UInt64,</span><br><span class="line">    `ClickContextType` UInt8,</span><br><span class="line">    `ClickSelectType` Int8,</span><br><span class="line">    `ClickOptions` String,</span><br><span class="line">    `ClickGroupBannerID` Int32,</span><br><span class="line">    `OpenstatServiceName` String,</span><br><span class="line">    `OpenstatCampaignID` String,</span><br><span class="line">    `OpenstatAdID` String,</span><br><span class="line">    `OpenstatSourceID` String,</span><br><span class="line">    `UTMSource` String,</span><br><span class="line">    `UTMMedium` String,</span><br><span class="line">    `UTMCampaign` String,</span><br><span class="line">    `UTMContent` String,</span><br><span class="line">    `UTMTerm` String,</span><br><span class="line">    `FromTag` String,</span><br><span class="line">    `HasGCLID` UInt8,</span><br><span class="line">    `FirstVisit` DateTime,</span><br><span class="line">    `PredLastVisit` Date,</span><br><span class="line">    `LastVisit` Date,</span><br><span class="line">    `TotalVisits` UInt32,</span><br><span class="line">    `TraficSource` Nested(</span><br><span class="line">        ID Int8,</span><br><span class="line">        SearchEngineID UInt16,</span><br><span class="line">        AdvEngineID UInt8,</span><br><span class="line">        PlaceID UInt16,</span><br><span class="line">        SocialSourceNetworkID UInt8,</span><br><span class="line">        Domain String,</span><br><span class="line">        SearchPhrase String,</span><br><span class="line">        SocialSourcePage String),</span><br><span class="line">    `Attendance` FixedString(16),</span><br><span class="line">    `CLID` UInt32,</span><br><span class="line">    `YCLID` UInt64,</span><br><span class="line">    `NormalizedRefererHash` UInt64,</span><br><span class="line">    `SearchPhraseHash` UInt64,</span><br><span class="line">    `RefererDomainHash` UInt64,</span><br><span class="line">    `NormalizedStartURLHash` UInt64,</span><br><span class="line">    `StartURLDomainHash` UInt64,</span><br><span class="line">    `NormalizedEndURLHash` UInt64,</span><br><span class="line">    `TopLevelDomain` UInt64,</span><br><span class="line">    `URLScheme` UInt64,</span><br><span class="line">    `OpenstatServiceNameHash` UInt64,</span><br><span class="line">    `OpenstatCampaignIDHash` UInt64,</span><br><span class="line">    `OpenstatAdIDHash` UInt64,</span><br><span class="line">    `OpenstatSourceIDHash` UInt64,</span><br><span class="line">    `UTMSourceHash` UInt64,</span><br><span class="line">    `UTMMediumHash` UInt64,</span><br><span class="line">    `UTMCampaignHash` UInt64,</span><br><span class="line">    `UTMContentHash` UInt64,</span><br><span class="line">    `UTMTermHash` UInt64,</span><br><span class="line">    `FromHash` UInt64,</span><br><span class="line">    `WebVisorEnabled` UInt8,</span><br><span class="line">    `WebVisorActivity` UInt32,</span><br><span class="line">    `ParsedParams` Nested(</span><br><span class="line">        Key1 String,</span><br><span class="line">        Key2 String,</span><br><span class="line">        Key3 String,</span><br><span class="line">        Key4 String,</span><br><span class="line">        Key5 String,</span><br><span class="line">        ValueDouble Float64),</span><br><span class="line">    `Market` Nested(</span><br><span class="line">        Type UInt8,</span><br><span class="line">        GoalID UInt32,</span><br><span class="line">        OrderID String,</span><br><span class="line">        OrderPrice Int64,</span><br><span class="line">        PP UInt32,</span><br><span class="line">        DirectPlaceID UInt32,</span><br><span class="line">        DirectOrderID UInt32,</span><br><span class="line">        DirectBannerID UInt32,</span><br><span class="line">        GoodID String,</span><br><span class="line">        GoodName String,</span><br><span class="line">        GoodQuantity Int32,</span><br><span class="line">        GoodPrice Int64),</span><br><span class="line">    `IslandID` FixedString(16)</span><br><span class="line">)</span><br><span class="line">ENGINE = CollapsingMergeTree(Sign)</span><br><span class="line">PARTITION BY toYYYYMM(StartDate)</span><br><span class="line">ORDER BY (CounterID, StartDate, intHash32(UserID), VisitID)</span><br><span class="line">SAMPLE BY intHash32(UserID);</span><br></pre></td></tr></table></figure>

<p>3）数据导入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --password bigdata123 --query &quot;INSERT INTO tutorial.hits_v1 FORMAT TSV&quot; --max_insert_block_size=100000 &lt; /tmp/ck_test/hits_v1.tsv</span><br><span class="line">clickhouse-client --password bigdata123 --query &quot;INSERT INTO tutorial.visits_v1 FORMAT TSV&quot; --max_insert_block_size=100000 &lt; /tmp/ck_test/visits_v1.tsv</span><br></pre></td></tr></table></figure>

<p>4）执行查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --password bigdata123 --query &quot;SELECT COUNT(*) FROM tutorial.hits_v1&quot;</span><br><span class="line"></span><br><span class="line">clickhouse-client --password bigdata123 --query &quot;SELECT COUNT(*) FROM tutorial.visits_v1&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hits_v1 表有 130 多个字段，1000 多万条数据； visits_v1 表有 180 多个字段，160 多万条数据</p>
</blockquote>
<br>
## 3.2 COUNT 优化
在调用 count 函数时，如果使用的是 count() 或者 count(*)，且没有 where 条件，则会直接使用 system.tables 的 total_rows，例如:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT count() FROM tutorial.hits_v1;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────────────────────────────────────┐</span><br><span class="line">│ Expression ((Projection + Before ORDER BY))          │</span><br><span class="line">│   MergingAggregated                                  │</span><br><span class="line">│     ReadFromPreparedSource (Optimized trivial count) │</span><br><span class="line">└──────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>注意 Optimized trivial count ，这是对 count 的优化。</p>
<p>如果 count 具体的列字段，则不会使用此项优化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT count(CounterID) FROM tutorial.hits_v1;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─explain───────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ Expression ((Projection + Before ORDER BY))                                   │</span><br><span class="line">│   Aggregating                                                                 │</span><br><span class="line">│     Expression (Before GROUP BY)                                              │</span><br><span class="line">│       SettingQuotaAndLimits (Set limits and quota after reading from storage) │</span><br><span class="line">│         ReadFromMergeTree                                                     │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.3 消除子查询重复字段
下面语句子查询中有两个重复的 id 字段，会被去重:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX SELECT </span><br><span class="line"> a.UserID,</span><br><span class="line"> b.VisitID,</span><br><span class="line"> a.URL,</span><br><span class="line"> b.UserID</span><br><span class="line"> FROM</span><br><span class="line"> tutorial.hits_v1 AS a </span><br><span class="line"> LEFT JOIN ( </span><br><span class="line"> SELECT </span><br><span class="line"> UserID, </span><br><span class="line"> UserID as HaHa, </span><br><span class="line"> VisitID </span><br><span class="line"> FROM tutorial.visits_v1) AS b </span><br><span class="line"> USING (UserID)</span><br><span class="line"> limit 3;</span><br></pre></td></tr></table></figure>
//返回优化语句：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────┐</span><br><span class="line">│ SELECT                      │</span><br><span class="line">│     UserID,                 │</span><br><span class="line">│     VisitID,                │</span><br><span class="line">│     URL,                    │</span><br><span class="line">│     b.UserID                │</span><br><span class="line">│ FROM tutorial.hits_v1 AS a  │</span><br><span class="line">│ ALL LEFT JOIN               │</span><br><span class="line">│ (                           │</span><br><span class="line">│     SELECT                  │</span><br><span class="line">│         UserID,             │</span><br><span class="line">│         VisitID             │</span><br><span class="line">│     FROM tutorial.visits_v1 │</span><br><span class="line">│ ) AS b USING (UserID)       │</span><br><span class="line">│ LIMIT 3                     │</span><br><span class="line">└─────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.4 谓词下推
当 group by 有 having 子句，但是没有 with cube、with rollup 或者 with totals 修饰的时候，having 过滤会下推到 where 提前过滤。例如下面的查询，HAVING name 变成了 WHERE name，在 group by 之前过滤：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX SELECT UserID FROM hits_v1 GROUP BY UserID HAVING UserID = </span><br><span class="line">&#x27;8585742290196126178&#x27;;</span><br></pre></td></tr></table></figure>
返回优化语句
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────────────────────┐</span><br><span class="line">│ SELECT UserID                        │</span><br><span class="line">│ FROM hits_v1                         │</span><br><span class="line">│ WHERE UserID = &#x27;8585742290196126178&#x27; │</span><br><span class="line">│ GROUP BY UserID                      │</span><br><span class="line">└──────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>子查询也支持谓词下推：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT *</span><br><span class="line">FROM </span><br><span class="line">(</span><br><span class="line"> SELECT UserID</span><br><span class="line"> FROM visits_v1</span><br><span class="line">)</span><br><span class="line">WHERE UserID = &#x27;8585742290196126178&#x27;;</span><br></pre></td></tr></table></figure>
<p>返回优化后的语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────────────────────────┐</span><br><span class="line">│ SELECT UserID                            │</span><br><span class="line">│ FROM                                     │</span><br><span class="line">│ (                                        │</span><br><span class="line">│     SELECT UserID                        │</span><br><span class="line">│     FROM visits_v1                       │</span><br><span class="line">│     WHERE UserID = &#x27;8585742290196126178&#x27; │</span><br><span class="line">│ )                                        │</span><br><span class="line">│ WHERE UserID = &#x27;8585742290196126178&#x27;     │</span><br><span class="line">└──────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>再来一个复杂例子：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX </span><br><span class="line">SELECT * FROM (</span><br><span class="line"> SELECT </span><br><span class="line"> * </span><br><span class="line"> FROM </span><br><span class="line"> (</span><br><span class="line"> SELECT </span><br><span class="line"> UserID </span><br><span class="line"> FROM visits_v1) </span><br><span class="line"> UNION ALL </span><br><span class="line"> SELECT </span><br><span class="line"> *</span><br><span class="line"> FROM </span><br><span class="line"> (</span><br><span class="line"> SELECT </span><br><span class="line"> UserID </span><br><span class="line"> FROM visits_v1)</span><br><span class="line">)</span><br><span class="line">WHERE UserID = &#x27;8585742290196126178&#x27;;</span><br></pre></td></tr></table></figure>
<p>返回优化后的语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────────────────────────────┐</span><br><span class="line">│ SELECT UserID                                │</span><br><span class="line">│ FROM                                         │</span><br><span class="line">│ (                                            │</span><br><span class="line">│     SELECT UserID                            │</span><br><span class="line">│     FROM                                     │</span><br><span class="line">│     (                                        │</span><br><span class="line">│         SELECT UserID                        │</span><br><span class="line">│         FROM visits_v1                       │</span><br><span class="line">│         WHERE UserID = &#x27;8585742290196126178&#x27; │</span><br><span class="line">│     )                                        │</span><br><span class="line">│     WHERE UserID = &#x27;8585742290196126178&#x27;     │</span><br><span class="line">│     UNION ALL                                │</span><br><span class="line">│     SELECT UserID                            │</span><br><span class="line">│     FROM                                     │</span><br><span class="line">│     (                                        │</span><br><span class="line">│         SELECT UserID                        │</span><br><span class="line">│         FROM visits_v1                       │</span><br><span class="line">│         WHERE UserID = &#x27;8585742290196126178&#x27; │</span><br><span class="line">│     )                                        │</span><br><span class="line">│     WHERE UserID = &#x27;8585742290196126178&#x27;     │</span><br><span class="line">│ )                                            │</span><br><span class="line">│ WHERE UserID = &#x27;8585742290196126178&#x27;         │</span><br><span class="line">└──────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.5 聚合计算外推
聚合函数内的计算，会外推，例如：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT sum(UserID * 2)</span><br><span class="line">FROM visits_v1;</span><br></pre></td></tr></table></figure>
返回优化后的语句
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─explain────────────────┐</span><br><span class="line">│ SELECT sum(UserID) * 2 │</span><br><span class="line">│ FROM visits_v1         │</span><br><span class="line">└────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.6 聚合函数消除
如果对聚合键，也就是 group by key 使用 min、max、any 聚合函数，则将函数消除，
例如：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT</span><br><span class="line"> sum(UserID * 2),</span><br><span class="line"> max(VisitID),</span><br><span class="line"> max(UserID)</span><br><span class="line">FROM visits_v1</span><br><span class="line">GROUP BY UserID;</span><br></pre></td></tr></table></figure>
返回优化后的语句
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────┐</span><br><span class="line">│ SELECT               │</span><br><span class="line">│     sum(UserID) * 2, │</span><br><span class="line">│     max(VisitID),    │</span><br><span class="line">│     UserID           │</span><br><span class="line">│ FROM visits_v1       │</span><br><span class="line">│ GROUP BY UserID      │</span><br><span class="line">└──────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.7 删除重复的 order by key
例如下面的语句，重复的聚合键 id 字段会被去重:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT *</span><br><span class="line">FROM visits_v1</span><br><span class="line">ORDER BY</span><br><span class="line"> UserID ASC,</span><br><span class="line"> UserID ASC,</span><br><span class="line"> VisitID ASC,</span><br><span class="line">VisitID ASC;</span><br></pre></td></tr></table></figure>
返回优化后的语句
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─explain───────────────────────────────────┐</span><br><span class="line">│ SELECT                                    │</span><br><span class="line">│     CounterID,                            │</span><br><span class="line">│     .........,                            │</span><br><span class="line">│     IslandID                              │</span><br><span class="line">│ FROM visits_v1                            │</span><br><span class="line">│ ORDER BY                                  │</span><br><span class="line">│     UserID ASC,                           │</span><br><span class="line">│     VisitID ASC                           │</span><br><span class="line">└───────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.8 删除重复的 limit by key
例如下面的语句，重复声明的 name 字段会被去重：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT *</span><br><span class="line">FROM visits_v1</span><br><span class="line">LIMIT 3 BY</span><br><span class="line"> VisitID,</span><br><span class="line"> VisitID</span><br><span class="line">LIMIT 10;</span><br></pre></td></tr></table></figure>
//返回优化后的语句：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─explain───────────────────────────────────┐</span><br><span class="line">│ SELECT                                    │</span><br><span class="line">│     CounterID,                            │</span><br><span class="line">│     .........,                            │</span><br><span class="line">│     IslandID                              │</span><br><span class="line">│ FROM visits_v1                            │</span><br><span class="line">│ LIMIT 3 BY VisitID                        │</span><br><span class="line">│ LIMIT 10                                  │</span><br><span class="line">└───────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.9 删除重复的 USING Key
例如下面的语句，重复的关联键 id 字段会被去重：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">SELECT</span><br><span class="line"> a.UserID,</span><br><span class="line"> a.UserID,</span><br><span class="line"> b.VisitID,</span><br><span class="line"> a.URL,</span><br><span class="line"> b.UserID</span><br><span class="line">FROM hits_v1 AS a</span><br><span class="line">LEFT JOIN visits_v1 AS b USING (UserID, UserID);</span><br></pre></td></tr></table></figure>
返回优化后的语句：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────┐</span><br><span class="line">│ SELECT                                      │</span><br><span class="line">│     UserID,                                 │</span><br><span class="line">│     UserID,                                 │</span><br><span class="line">│     VisitID,                                │</span><br><span class="line">│     URL,                                    │</span><br><span class="line">│     b.UserID                                │</span><br><span class="line">│ FROM hits_v1 AS a                           │</span><br><span class="line">│ ALL LEFT JOIN visits_v1 AS b USING (UserID) │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<br>
## 3.10 标量替换
如果子查询只返回一行数据，在被引用的时候用标量替换，例如下面语句中的total_disk_usage 字段：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX</span><br><span class="line">WITH </span><br><span class="line"> (</span><br><span class="line"> SELECT sum(bytes)</span><br><span class="line"> FROM system.parts</span><br><span class="line"> WHERE active</span><br><span class="line"> ) AS total_disk_usage</span><br><span class="line">SELECT</span><br><span class="line"> (sum(bytes) / total_disk_usage) * 100 AS table_disk_usage,</span><br><span class="line"> table</span><br><span class="line">FROM system.parts</span><br><span class="line">GROUP BY table</span><br><span class="line">ORDER BY table_disk_usage DESC</span><br><span class="line">LIMIT 10; </span><br></pre></td></tr></table></figure>
返回优化后的语句：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│ WITH identity(CAST(0, &#x27;UInt64&#x27;)) AS total_disk_usage                            │</span><br><span class="line">│ SELECT                                                                          │</span><br><span class="line">│     (sum(bytes_on_disk AS bytes) / total_disk_usage) * 100 AS table_disk_usage, │</span><br><span class="line">│     table                                                                       │</span><br><span class="line">│ FROM system.parts                                                               │</span><br><span class="line">│ GROUP BY table                                                                  │</span><br><span class="line">│ ORDER BY table_disk_usage DESC                                                  │</span><br><span class="line">│ LIMIT 10                                                                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
>这个优化本意是，查询出如果是固定值，就用标量值进行替换。但这个例子中的因为没有执行查询，所以该标量值直接用0表示，实际查询中会替换为查询到的值。

<br>
## 3.11 三元运算优化
如果开启了 optimize_if_chain_to_multiif 参数，三元运算符会被替换成 multiIf 函数，
例如：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SYNTAX </span><br><span class="line">SELECT number = 1 ? &#x27;hello&#x27; : (number = 2 ? &#x27;world&#x27; : &#x27;atguigu&#x27;) </span><br><span class="line">FROM numbers(10) </span><br><span class="line">settings optimize_if_chain_to_multiif = 1;</span><br></pre></td></tr></table></figure>
>Clickhouse中可以在SQL语句结尾写上settings来设置参数，对本次查询有效。

<p>返回优化后的语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ SELECT multiIf(number = 1, &#x27;hello&#x27;, number = 2, &#x27;world&#x27;, &#x27;atguigu&#x27;) │</span><br><span class="line">│ FROM numbers(10)                                                    │</span><br><span class="line">│ SETTINGS optimize_if_chain_to_multiif = 1                           │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<br>
# 四、查询优化
## 4.1 单表查询
### 4.1.1 Prewhere 替代 where
Prewhere 和 where 语句的作用相同，用来过滤数据。不同之处在于 prewhere 只支持**MergeTree**族系列引擎的表，首先会读取指定的列数据，来判断数据过滤，等待数据过滤之后再读取 select 声明的列字段来补全其余属性，不需要扫描无用字段。
当查询列明显多于筛选列时使用 Prewhere 可十倍提升查询性能，Prewhere 会自动优化执行过滤阶段的数据读取方式，降低 io 操作。
在某些场合下，prewhere 语句比 where 语句处理的数据量更少性能更高。

<p>默认情况下， where 条件会自动优化成 prewhere，为了测试先关闭该功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set optimize_move_to_prewhere=0;</span><br></pre></td></tr></table></figure>
<p>使用where</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">select WatchID, </span><br><span class="line"> JavaEnable, </span><br><span class="line"> Title, </span><br><span class="line"> GoodEvent, </span><br><span class="line"> EventTime, </span><br><span class="line"> EventDate, </span><br><span class="line"> CounterID, </span><br><span class="line"> ClientIP, </span><br><span class="line"> ClientIP6, </span><br><span class="line"> RegionID, </span><br><span class="line"> UserID, </span><br><span class="line"> CounterClass, </span><br><span class="line"> OS, </span><br><span class="line"> UserAgent, </span><br><span class="line"> URL, </span><br><span class="line"> Referer, </span><br><span class="line"> URLDomain, </span><br><span class="line"> RefererDomain, </span><br><span class="line"> Refresh, </span><br><span class="line"> IsRobot, </span><br><span class="line"> RefererCategories, </span><br><span class="line"> URLCategories, </span><br><span class="line"> URLRegions, </span><br><span class="line"> RefererRegions, </span><br><span class="line"> ResolutionWidth, </span><br><span class="line"> ResolutionHeight, </span><br><span class="line"> ResolutionDepth, </span><br><span class="line"> FlashMajor, </span><br><span class="line"> FlashMinor, </span><br><span class="line"> FlashMinor2</span><br><span class="line">from hits_v1 where UserID=&#x27;3198390223272470366&#x27;;</span><br></pre></td></tr></table></figure>
<p>耗时如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">156 rows in set. Elapsed: 0.450 sec. Processed 10.88 million rows, 124.97 MB (24.17 million rows/s., 277.71 MB/s.)</span><br></pre></td></tr></table></figure>

<p>使用prewhere</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">select WatchID, </span><br><span class="line"> JavaEnable, </span><br><span class="line"> Title, </span><br><span class="line"> GoodEvent, </span><br><span class="line"> EventTime, </span><br><span class="line"> EventDate, </span><br><span class="line"> CounterID, </span><br><span class="line"> ClientIP, </span><br><span class="line"> ClientIP6, </span><br><span class="line"> RegionID, </span><br><span class="line"> UserID, </span><br><span class="line"> CounterClass, </span><br><span class="line"> OS, </span><br><span class="line"> UserAgent, </span><br><span class="line"> URL, </span><br><span class="line"> Referer, </span><br><span class="line"> URLDomain, </span><br><span class="line"> RefererDomain, </span><br><span class="line"> Refresh, </span><br><span class="line"> IsRobot, </span><br><span class="line"> RefererCategories, </span><br><span class="line"> URLCategories, </span><br><span class="line"> URLRegions, </span><br><span class="line"> RefererRegions, </span><br><span class="line"> ResolutionWidth, </span><br><span class="line"> ResolutionHeight, </span><br><span class="line"> ResolutionDepth, </span><br><span class="line"> FlashMajor, </span><br><span class="line"> FlashMinor, </span><br><span class="line"> FlashMinor2</span><br><span class="line">from hits_v1 prewhere UserID=&#x27;3198390223272470366&#x27;;</span><br></pre></td></tr></table></figure>
<p>耗时如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">156 rows in set. Elapsed: 0.192 sec. Processed 10.88 million rows, 124.97 MB (56.78 million rows/s., 652.38 MB/s.)</span><br></pre></td></tr></table></figure>

<br>
**默认情况，我们肯定不会关闭 where 自动优化成 prewhere，但是某些场景即使开启优化，也不会自动转换成 prewhere，需要手动指定 prewhere：**
- 使用常量表达式
- 使用默认值为 alias 类型的字段
- 包含了 arrayJOIN，globalIn，globalNotIn 或者 indexHint 的查询
- select 查询的列字段和 where 的谓词相同
- 使用了主键字段

<br>
### 4.1.2 数据采样
通过采样运算可极大提升数据分析的性能
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT Title,count(*) AS PageViews </span><br><span class="line">FROM hits_v1</span><br><span class="line">SAMPLE 0.1 #代表采样 10%的数据,也可以是具体的条数</span><br><span class="line">WHERE CounterID =57</span><br><span class="line">GROUP BY Title</span><br><span class="line">ORDER BY PageViews DESC LIMIT 1000</span><br></pre></td></tr></table></figure>
采样修饰符只有在 MergeTree engine 表中才有效，且在创建表时需要指定采样策略。

<br>
### 4.1.3 列裁剪与分区裁剪
如前所述，where一般会优化为prewhere，会根据where的列进行搜索。所以数据量太大时应避免使用 select * 操作，查询的性能会与查询的字段大小和数量成线性表换，字段越少，消耗的 io 资源越少，性能就会越高。
反例：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from datasets.hits_v1;</span><br></pre></td></tr></table></figure>
正例：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">select WatchID, </span><br><span class="line"> JavaEnable, </span><br><span class="line"> Title, </span><br><span class="line"> GoodEvent, </span><br><span class="line"> EventTime, </span><br><span class="line"> EventDate, </span><br><span class="line"> CounterID, </span><br><span class="line"> ClientIP, </span><br><span class="line"> ClientIP6, </span><br><span class="line"> RegionID, </span><br><span class="line"> UserID</span><br><span class="line">from datasets.hits_v1;</span><br></pre></td></tr></table></figure>
分区裁剪就是只读取需要的分区，在过滤条件中指定。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">select WatchID, </span><br><span class="line"> JavaEnable, </span><br><span class="line"> Title, </span><br><span class="line"> GoodEvent, </span><br><span class="line"> EventTime, </span><br><span class="line"> EventDate, </span><br><span class="line"> CounterID, </span><br><span class="line"> ClientIP, </span><br><span class="line"> ClientIP6, </span><br><span class="line"> RegionID, </span><br><span class="line"> UserID</span><br><span class="line">from datasets.hits_v1</span><br><span class="line">where EventDate=&#x27;2014-03-23&#x27;;</span><br></pre></td></tr></table></figure>

<br>
### 4.1.4 orderby 结合 where、limit
千万以上数据集进行 order by 查询时需要搭配 where 条件和 limit 语句一起使用。
#正例：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT UserID,Age</span><br><span class="line">FROM hits_v1 </span><br><span class="line">WHERE CounterID=57</span><br><span class="line">ORDER BY Age DESC LIMIT 1000</span><br></pre></td></tr></table></figure>
#反例：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT UserID,Age</span><br><span class="line">FROM hits_v1 </span><br><span class="line">ORDER BY Age DESC</span><br></pre></td></tr></table></figure>

<br>
### 4.1.5 避免构建虚拟列
如非必须，不要在结果集上构建虚拟列，虚拟列非常消耗资源浪费性能，可以考虑在前端进行处理，或者在表中构造实际字段进行额外存储。
反例：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT Income,Age,Income/Age as IncRate FROM hits_v1;</span><br></pre></td></tr></table></figure>
正例：拿到 Income 和 Age 后，考虑在前端进行处理，或者在表中构造实际字段进行额外存储
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT Income,Age FROM hits_v1;</span><br></pre></td></tr></table></figure>

<br>
### 4.1.6 uniqCombined 替代 distinct
性能可提升 10 倍以上，uniqCombined 底层采用类似 HyperLogLog 算法实现，能接收 2%左右的数据误差，可直接使用这种去重方式提升查询性能。Count(distinct )会使用 uniqExact精确去重。
我们可以查看distinct的最终执行语句如下
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">┌─explain──────────────────┐</span><br><span class="line">│ SELECT uniqExact(rand()) │</span><br><span class="line">│ FROM hits_v1             │</span><br><span class="line">└──────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>不建议在千万级不同数据上执行 distinct 去重查询，改为近似去重 uniqCombined。<br>反例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct rand()) from hits_v1;</span><br></pre></td></tr></table></figure>
<p>正例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT uniqCombined(rand()) from hits_v1</span><br></pre></td></tr></table></figure>

<br>
### 4.1.7 使用物化视图
参考第 6 章。

<br>
### 4.1.8 其他注意事项
**（1）查询熔断**
为了避免因个别慢查询引起的服务雪崩的问题，除了可以为单个查询设置超时以外，还可以配置周期熔断，在一个查询周期内，如果用户频繁进行慢查询操作超出规定阈值后将无法继续进行查询操作。
**（2）关闭虚拟内存**
物理内存和虚拟内存的数据交换，会导致查询变慢，资源允许的情况下关闭虚拟内存。
**（3）配置 join_use_nulls**
为每一个账户添加 join_use_nulls 配置，左表中的一条记录在右表中不存在，右表的相应字段会返回该字段相应数据类型的默认值，而不是标准 SQL 中的 Null 值。
因为Null值会另存一个数据文件且不可索引。

<p><strong>（4）批量写入时先排序</strong><br>批量写入数据时，必须控制每个批次的数据中涉及到的分区的数量，在写入之前最好对需要导入的数据进行排序。无序的数据或者涉及的分区太多，会导致 ClickHouse 无法及时对新导入的数据进行合并，从而影响查询性能。<br><strong>（5）关注 CPU</strong><br>cpu 一般在 50%左右会出现查询波动，达到 70%会出现大范围的查询超时，cpu 是最关键的指标，要非常关注。</p>
<br>
## 4.2 多表关联
### 4.2.1 准备表和数据
创建小表
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE visits_v2 </span><br><span class="line">ENGINE = CollapsingMergeTree(Sign)</span><br><span class="line">PARTITION BY toYYYYMM(StartDate)</span><br><span class="line">ORDER BY (CounterID, StartDate, intHash32(UserID), VisitID)</span><br><span class="line">SAMPLE BY intHash32(UserID)</span><br><span class="line">SETTINGS index_granularity = 8192</span><br><span class="line">as select * from visits_v1 limit 10000;</span><br></pre></td></tr></table></figure>
创建 join 结果表：避免控制台疯狂打印数据
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE hits_v2 </span><br><span class="line">ENGINE = MergeTree()</span><br><span class="line">PARTITION BY toYYYYMM(EventDate)</span><br><span class="line">ORDER BY (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE BY intHash32(UserID)</span><br><span class="line">SETTINGS index_granularity = 8192</span><br><span class="line">as select * from hits_v1 where 1=0;</span><br></pre></td></tr></table></figure>
>如上`as select * from ... `语法可以复制表结构，`where 1=0 `可以避免数据插入到新建的表中。这样就可以复制一张新表出来。

<br>
### 4.2.2 用 IN 代替 JOIN
JOIN会将右表整表读取到内存中，右表中的每条记录都会查询内存中的右表进行关联。这样可能导致内存不足而且这种实现方式效率地下，所以ClickHouse不适合JOIN操作。
当多表联查时，**查询的数据仅从其中一张表出时**，可考虑用 IN 操作而不是 JOIN。如下所示，这样只会扫描一列，效率更高。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into hits_v2</span><br><span class="line">select a.* from hits_v1 a where a. CounterID in (select CounterID from visits_v1); </span><br></pre></td></tr></table></figure>
耗时0.972sec。

<p>反例：使用 join</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into table hits_v2</span><br><span class="line">select a.* from hits_v1 a left join visits_v1 b on a.CounterID=b.CounterID;</span><br></pre></td></tr></table></figure>
<p>耗时34.934sec。</p>
<br>
### 4.2.3 大小表 JOIN
多表 join 时要满足小表在右的原则，右表关联时被加载到内存中与左表进行比较，ClickHouse 中无论是 Left join 、Right join 还是 Inner join 永远都是拿着右表中的每一条记录到左表中查找该记录是否存在，所以右表必须是小表（此处与hive相反，hive会将左表进行缓存，所以小表放在左边）。
**（1）小表在右**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into table hits_v2</span><br><span class="line">select a.* from hits_v1 a left join visits_v2 b on a.CounterID=b.CounterID;</span><br></pre></td></tr></table></figure>
耗时34.119sec。

<p><strong>（2）大表在右</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into table hits_v2</span><br><span class="line">select a.* from visits_v2 b left join hits_v1 a on a.CounterID=b.CounterID;</span><br></pre></td></tr></table></figure>
<p>抛异常Memory limit，内存超限制。可以进行设置将溢出的部分存储到磁盘。</p>
<br>
### 4.2.4 注意谓词下推（版本差异）
ClickHouse 在 **join 查询时不会主动发起谓词下推**的操作，需要每个子查询提前完成过滤操作，需要注意的是，是否执行谓词下推，对性能影响差别很大（新版本中已经不存在此问题，但是需要注意谓词的位置的不同依然有性能的差异）

<p><strong>优化如下语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Explain syntax</span><br><span class="line">select a.* from hits_v1 a left join visits_v2 b on a.CounterID=b.CounterID</span><br><span class="line">having a.EventDate = &#x27;2014-03-17&#x27;;</span><br></pre></td></tr></table></figure>
<p>得到优化结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────┐</span><br><span class="line">│ SELECT                                                  │</span><br><span class="line">│     WatchID,                                            │</span><br><span class="line">│     .........,                            │</span><br><span class="line">│     RequestTry                                          │</span><br><span class="line">│ FROM hits_v1 AS a                                       │</span><br><span class="line">│ ALL LEFT JOIN visits_v2 AS b ON CounterID = b.CounterID │</span><br><span class="line">│ PREWHERE EventDate = &#x27;2014-03-17&#x27;                       │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>优化如下语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Explain syntax</span><br><span class="line">select a.* from hits_v1 a left join visits_v2 b on a.CounterID=b.CounterID</span><br><span class="line">having b.StartDate = &#x27;2014-03-17&#x27;;</span><br></pre></td></tr></table></figure>
<p>得到优化结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─explain─────────────────────────────────────────────────┐</span><br><span class="line">│ SELECT                                                  │</span><br><span class="line">│     WatchID,                                            │</span><br><span class="line">│     .........,                            │</span><br><span class="line">│     RequestTry                                          │</span><br><span class="line">│ FROM hits_v1 AS a                                       │</span><br><span class="line">│ ALL LEFT JOIN visits_v2 AS b ON CounterID = b.CounterID │</span><br><span class="line">│ WHERE StartDate = &#x27;2014-03-17&#x27;                          │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到都进行了谓词下推，但是使用的过滤关键词不同，上面的使用了PREWHERE效率更高。</p>
</blockquote>
<br>
**测试性能**
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into hits_v2</span><br><span class="line">select a.* from hits_v1 a left join visits_v2 b on a. CounterID=b.CounterID</span><br><span class="line">where a.EventDate = &#x27;2014-03-17&#x27;;</span><br></pre></td></tr></table></figure>
测试结果为
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 rows in set. Elapsed: 5.858 sec. Processed 6.98 million rows, 6.08 GB (1.19 million rows/s., 1.04 GB/s.)</span><br></pre></td></tr></table></figure>
将过滤条件换个位置
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">insert into hits_v2</span><br><span class="line">select a.* from (</span><br><span class="line"> select * from </span><br><span class="line"> hits_v1 </span><br><span class="line"> where EventDate = &#x27;2014-03-17&#x27;</span><br><span class="line">) a left join visits_v2 b on a. CounterID=b. CounterID;</span><br></pre></td></tr></table></figure>
测试结果为
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 rows in set. Elapsed: 5.845 sec. Processed 6.98 million rows, 6.08 GB (1.19 million rows/s., 1.04 GB/s.)</span><br></pre></td></tr></table></figure>
>发现在子查询中先进行过滤和在join后再进行过滤，没有大的差别。

<br>
### 4.2.5 分布式表使用 GLOBAL
两张分布式表上的 IN 和 JOIN 之前必须加上 GLOBAL 关键字，右表只会在接收查询请求的那个节点查询一次，并将其分发到其他节点上。如果不加 GLOBAL 关键字的话，每个节点都会单独发起一次对右表的查询，而右表又是分布式表，就导致右表一共会被查询 N²次（N是该分布式表的分片数量），这就是**查询放大**，会带来很大开销。

<p>这种情况要明确的是，需要关联的记录在本节点的分片上而不在其他分片上，这样只会将右表的分片发送到本节点上，不会造成查询方法。</p>
<p>同时也侧面说明了ClickHouse不推荐经常使用关联查询，也不推荐使用分片。</p>
<br>
### 4.2.6 使用字典表
将一些需要关联分析的业务创建成字典表进行 join 操作，前提是字典表不宜太大，因为字典表会常驻内存.

<br>
### 4.2.7 提前过滤
通过增加逻辑过滤可以减少数据扫描，达到提高执行速度及降低内存消耗的目的.


<br>
# 五、数据一致性
查询 CK 手册发现，即便对数据一致性支持最好的 Mergetree，也只是保证最终一致性：
>**ReplacingMergeTree**
>该引擎和 MergeTree 的不同之处在于它会删除排序键值相同的重复项。数据的去重只会在数据合并期间进行。合并会在后台一个不确定的时间进行，因此你无法预先作出计划。有一些数据可能仍未被处理。尽管你可以调用 OPTIMIZE 语句发起计划外的合并，但请不要依靠它，因为 OPTIMIZE 语句会引发对数据的大量读写。

<p>我们在使用 ReplacingMergeTree、SummingMergeTree 这类表引擎的时候，会出现短暂数据不一致的情况。</p>
<p>对于数据不敏感，可以容忍部分数据重复的场景下可以不进行处理直接查询。<br>在某些对一致性非常敏感的场景，通常有以下几种解决方案。</p>
<h2 id="5-1-准备测试表和数据"><a href="#5-1-准备测试表和数据" class="headerlink" title="5.1 准备测试表和数据"></a>5.1 准备测试表和数据</h2><p><strong>（1）创建表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test_a(</span><br><span class="line"> user_id UInt64,</span><br><span class="line"> score String,</span><br><span class="line"> deleted UInt8 DEFAULT 0,</span><br><span class="line"> create_time DateTime DEFAULT toDateTime(0)</span><br><span class="line">)ENGINE= ReplacingMergeTree(create_time)</span><br><span class="line">ORDER BY user_id;</span><br></pre></td></tr></table></figure>
<p>其中:<br>user_id 是数据去重更新的标识;<br>create_time 是版本号字段，每组数据中 create_time 最大的一行表示最新的数据;<br>deleted 是自定的一个标记位，比如 0 代表未删除，1 代表删除数据。</p>
<p><strong>（2）写入 1000 万 测试数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TABLE test_a(user_id,score)</span><br><span class="line">WITH(</span><br><span class="line"> SELECT [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;,&#x27;D&#x27;,&#x27;E&#x27;,&#x27;F&#x27;,&#x27;G&#x27;]</span><br><span class="line">)AS dict</span><br><span class="line">SELECT number AS user_id, dict[number%7+1] FROM numbers(10000000); </span><br></pre></td></tr></table></figure>

<p><strong>（3）修改前 50 万 行数据，修改内容包括 name 字段和 create_time 版本号字段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TABLE test_a(user_id,score,create_time)</span><br><span class="line">WITH(</span><br><span class="line"> SELECT [&#x27;AA&#x27;,&#x27;BB&#x27;,&#x27;CC&#x27;,&#x27;DD&#x27;,&#x27;EE&#x27;,&#x27;FF&#x27;,&#x27;GG&#x27;]</span><br><span class="line">)AS dict</span><br><span class="line">SELECT number AS user_id, dict[number%7+1], now() AS create_time FROM </span><br><span class="line">numbers(500000);</span><br></pre></td></tr></table></figure>

<p><strong>（4）统计总数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT() FROM test_a;</span><br><span class="line">10500000</span><br></pre></td></tr></table></figure>
<p>还未触发分区合并，所以还未去重。</p>
<br>
## 5.2 手动 OPTIMIZE
在写入数据后，立刻执行 OPTIMIZE 强制触发新写入分区的合并动作。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE test_a FINAL;</span><br></pre></td></tr></table></figure>
语法：
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE TABLE [db.]name [ON CLUSTER cluster] [PARTITION partition | </span><br><span class="line">PARTITION ID &#x27;partition_id&#x27;] [FINAL] [DEDUPLICATE [BY expression]]</span><br></pre></td></tr></table></figure>

<br>
## 5.3 通过 Group by 去重
（1）执行去重的查询
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line"> user_id ,</span><br><span class="line"> argMax(score, create_time) AS score, </span><br><span class="line"> argMax(deleted, create_time) AS deleted,</span><br><span class="line"> max(create_time) AS ctime </span><br><span class="line">FROM test_a </span><br><span class="line">GROUP BY user_id</span><br><span class="line">HAVING deleted = 0;</span><br></pre></td></tr></table></figure>
函数说明： `argMax(field1，field2)` 按照 field2 的最大值取 field1 的值。
当我们更新数据时，会写入一行新的数据，例如上面语句中，通过查询最大的create_time 得到修改后的 score 字段值。 

<p><strong>（2）创建视图，方便测试</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW view_test_a AS</span><br><span class="line">SELECT</span><br><span class="line"> user_id ,</span><br><span class="line"> argMax(score, create_time) AS score, </span><br><span class="line"> argMax(deleted, create_time) AS deleted,</span><br><span class="line"> max(create_time) AS ctime </span><br><span class="line">FROM test_a </span><br><span class="line">GROUP BY user_id</span><br><span class="line">HAVING deleted = 0; </span><br></pre></td></tr></table></figure>
<blockquote>
<p>视图就相当于记录了SQL语句，查询视图就是重新执行了创建视图时的语句。</p>
</blockquote>
<p><strong>（3）插入重复数据，再次查询</strong><br>再次插入一条数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TABLE test_a(user_id,score,create_time) VALUES(0,&#x27;AAAA&#x27;,now())</span><br></pre></td></tr></table></figure>
<p>再次查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM view_test_a WHERE user_id = 0; </span><br></pre></td></tr></table></figure>
<p>从视图中查询，得到最新的数据。</p>
<p><strong>（4）删除数据测试</strong><br>删除操作就是再次插入一条标记为删除的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO TABLE test_a(user_id,score,deleted,create_time) </span><br><span class="line">VALUES(0,&#x27;AAAA&#x27;,1,now()); </span><br></pre></td></tr></table></figure>
<p>再次查询，刚才那条数据看不到了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM view_test_a WHERE user_id = 0;</span><br></pre></td></tr></table></figure>
<p>这行数据并没有被真正的删除，而是被过滤掉了。在一些合适的场景下，可以结合 表级别的 TTL 最终将物理数据删除。</p>
<br>
## 5.4 通过 FINAL 查询
在查询语句后增加 FINAL 修饰符，这样在查询的过程中将会执行 Merge 的特殊逻辑（例如数据去重，预聚合等）。但是不是进行分区合并，所以ClickHouse服务依然可用。
但是这种方法在早期版本基本没有人使用，因为在增加 FINAL 之后，我们的查询将会变成一个单线程的执行过程，查询速度非常慢。
在 v20.5.2.7-stable 版本中，FINAL 查询支持多线程执行，并且可以通过 `max_final_threads` 参数**控制单个查询的线程数**。**但是目前读取 part 部分的动作依然是串行的**，还是会影响查询效率。
FINAL 查询最终的性能和很多因素相关，列字段的大小、分区的数量等等都会影响到最终的查询时间，所以还要结合实际场景取舍。
参考链接：https://github.com/ClickHouse/ClickHouse/pull/10463

<h3 id="5-4-1-老版本测试-20-4-5-36"><a href="#5-4-1-老版本测试-20-4-5-36" class="headerlink" title="5.4.1 老版本测试(20.4.5.36)"></a>5.4.1 老版本测试(20.4.5.36)</h3><p><strong>（1）普通查询语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from visits_v1 WHERE StartDate = &#x27;2014-03-17&#x27; limit 100; </span><br></pre></td></tr></table></figure>

<p><strong>（2）FINAL 查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from visits_v1 FINAL WHERE StartDate = &#x27;2014-03-17&#x27; limit 100;</span><br></pre></td></tr></table></figure>
<p>先前的并行查询变成了单线程。</p>
<h3 id="5-4-2-新版本测试-21-7-3-14"><a href="#5-4-2-新版本测试-21-7-3-14" class="headerlink" title="5.4.2 新版本测试(21.7.3.14)"></a>5.4.2 新版本测试(21.7.3.14)</h3><p><strong>（1）普通语句查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from visits_v1 WHERE StartDate = &#x27;2014-03-17&#x27; limit 100 settings max_threads = 2;</span><br></pre></td></tr></table></figure>
<p>查看执行计划：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">explain pipeline select * from visits_v1 WHERE StartDate = &#x27;2014-03-17&#x27;</span><br><span class="line">limit 100 settings max_threads = 2;</span><br><span class="line">(Expression) </span><br><span class="line">ExpressionTransform × 2 </span><br><span class="line"> (SettingQuotaAndLimits) </span><br><span class="line"> (Limit) </span><br><span class="line"> Limit 2 → 2 </span><br><span class="line"> (ReadFromMergeTree)</span><br><span class="line"> MergeTreeThread × 2 0 → 1</span><br></pre></td></tr></table></figure>

<p>明显将由 2 个线程并行读取 part 查询。</p>
<p><strong>（2）FINAL 查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from visits_v1 final WHERE StartDate = &#x27;2014-03-17&#x27; limit 100 </span><br><span class="line">settings max_final_threads = 2;</span><br></pre></td></tr></table></figure>
<p>查询速度没有普通的查询快，但是相比之前已经有了一些提升,查看 FINAL 查询的执行计划：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">explain pipeline select * from visits_v1 final WHERE StartDate = &#x27;2014- 03-17&#x27; limit 100 settings max_final_threads = 2;</span><br><span class="line">(Expression) </span><br><span class="line">ExpressionTransform × 2 </span><br><span class="line"> (SettingQuotaAndLimits) </span><br><span class="line"> (Limit) </span><br><span class="line"> Limit 2 → 2 </span><br><span class="line"> (ReadFromMergeTree) </span><br><span class="line"> ExpressionTransform × 2 </span><br><span class="line"> CollapsingSortedTransform × 2</span><br><span class="line"> Copy 1 → 2 </span><br><span class="line"> AddingSelector </span><br><span class="line"> ExpressionTransform </span><br><span class="line"> MergeTree 0 → 1 </span><br></pre></td></tr></table></figure>
<p>从 CollapsingSortedTransform 这一步开始已经是多线程执行，但是读取 part 部分的动作还是串行。</p>
<br>
# 六、物化视图
ClickHouse 的物化视图是一种查询结果的持久化，它确实是给我们带来了查询效率的提升。用户查起来跟表没有区别，它就是一张表，它也像是一张时刻在预计算的表，创建的过程它是用了一个特殊引擎，加上后来 as select，就是 create 一个 table as select 的写法。
“查询结果集”的范围很宽泛，可以是基础表中部分数据的一份简单拷贝，也可以是多表 join 之后产生的结果或其子集，或者原始数据的聚合指标等等。所以，物化视图不会随着基础表的变化而变化，所以它也称为快照（snapshot）。

<h2 id="6-1-概述"><a href="#6-1-概述" class="headerlink" title="6.1 概述"></a>6.1 概述</h2><h3 id="6-1-1-物化视图与普通视图的区别"><a href="#6-1-1-物化视图与普通视图的区别" class="headerlink" title="6.1.1 物化视图与普通视图的区别"></a>6.1.1 物化视图与普通视图的区别</h3><p><strong>普通视图</strong>不保存数据，保存的仅仅是查询语句，查询的时候还是从原表读取数据，可以将普通视图理解为是个子查询。<br><strong>物化视图</strong>则是把查询的结果根据相应的引擎存入到了磁盘或内存中，对数据重新进行了组织，你可以理解物化视图是完全的一张新表。<br>物化视图的效果可以理解为一个触发器，在源表增量变化时会更新物化视图。</p>
<h3 id="6-1-2-优缺点"><a href="#6-1-2-优缺点" class="headerlink" title="6.1.2 优缺点"></a>6.1.2 优缺点</h3><p>优点：查询速度快，要是把物化视图这些规则全部写好，它比原数据查询快了很多，总的行数少了，因为都预计算好了。<br>缺点：它的本质是一个流式数据的使用场景，是累加式的技术，所以要用历史数据做去重、去核这样的分析，在物化视图里面是不太好用的。在某些场景的使用也是有限的。而且如果一张表加了好多物化视图，在写这张表的时候，就会消耗很多机器的资源，比如数据带宽占满、存储一下子增加了很多。</p>
<h3 id="6-1-3-基本语法"><a href="#6-1-3-基本语法" class="headerlink" title="6.1.3 基本语法"></a>6.1.3 基本语法</h3><p>也是 create 语法，会创建一个隐藏的目标表来保存视图数据。也可以 TO 表名，保存到<br>一张显式的表。没有加 TO 表名，表名默认就是 .inner.物化视图名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE [MATERIALIZED] VIEW [IF NOT EXISTS] [db.]table_name [TO[db.]name] </span><br><span class="line">[ENGINE = engine] [POPULATE] AS SELECT ...</span><br></pre></td></tr></table></figure>

<p><strong>1）创建物化视图的限制</strong><br>1.必须指定物化视图的 engine 用于数据存储<br>2.TO [db].[table]语法的时候，不得使用 POPULATE。<br>3.查询语句(select）可以包含下面的子句： DISTINCT, GROUP BY, ORDER BY, LIMIT…<br>4.物化视图的 alter 操作有些限制，操作起来不大方便。<br>5.若物化视图的定义使用了 TO [db.]name 子语句，则可以将目标表的视图 卸载 DETACH 再装载 ATTACH<br>6.如果添加POPULATE关键字，那么创建视图时会对历史数据进行计算插入；不添加POPULATE关键字，那么只对增量数据有效。</p>
<p><strong>2）物化视图的数据更新</strong><br>（1）物化视图创建好之后，若源表被写入新数据则物化视图也会同步更新</p>
<p>（2）POPULATE 关键字决定了物化视图的更新策略：</p>
<ul>
<li>若有 POPULATE 则在创建视图的过程会将源表已经存在的数据一并导入，类似于 <code>create table ... as</code></li>
<li>若无 POPULATE 则物化视图在创建之后没有数据，只会在创建只有同步之后写入源表的数据</li>
<li>clickhouse 官方并不推荐使用 POPULATE，因为在创建物化视图的过程中同时写入的数据不能被插入物化视图。</li>
</ul>
<p>（3）物化视图不支持同步删除，若源表的数据不存在（删除了）则物化视图的数据仍然保留</p>
<p>（4）物化视图是一种特殊的数据表，可以用 show tables 查看</p>
<p>（5）物化视图数据的删除：</p>
<p>（6）物化视图的删除：</p>
<br>
## 6.2 案例实操
对于一些确定的数据模型，可将统计指标通过物化视图的方式进行构建，这样可避免查询时重复计算的过程，物化视图会在有新数据插入时进行更新。

<h3 id="6-2-1-准备测试用表和数据"><a href="#6-2-1-准备测试用表和数据" class="headerlink" title="6.2.1 准备测试用表和数据"></a>6.2.1 准备测试用表和数据</h3><p><strong>1）建表</strong><br>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hits_test</span><br><span class="line">(</span><br><span class="line"> EventDate <span class="type">Date</span>, </span><br><span class="line"> CounterID UInt32, </span><br><span class="line"> UserID UInt64, </span><br><span class="line"> URL String, </span><br><span class="line"> Income UInt8</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br><span class="line">SETTINGS index_granularity <span class="operator">=</span> <span class="number">8192</span>;</span><br></pre></td></tr></table></figure>

<p><strong>2）导入一些数据</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> hits_test </span><br><span class="line"> <span class="keyword">SELECT</span> </span><br><span class="line"> EventDate,</span><br><span class="line"> CounterID,</span><br><span class="line"> UserID,</span><br><span class="line"> URL,</span><br><span class="line"> Income </span><br><span class="line"><span class="keyword">FROM</span> hits_v1 </span><br><span class="line">limit <span class="number">10000</span>; </span><br></pre></td></tr></table></figure>

<h3 id="6-2-2-创建物化视图"><a href="#6-2-2-创建物化视图" class="headerlink" title="6.2.2 创建物化视图"></a>6.2.2 创建物化视图</h3><p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> hits_mv </span><br><span class="line">ENGINE<span class="operator">=</span>SummingMergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (EventDate, intHash32(UserID)) </span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">UserID,</span><br><span class="line">EventDate,</span><br><span class="line"><span class="built_in">count</span>(URL) <span class="keyword">as</span> ClickCount,</span><br><span class="line"><span class="built_in">sum</span>(Income) <span class="keyword">AS</span> IncomeSum</span><br><span class="line"><span class="keyword">FROM</span> hits_test</span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&gt;=</span> <span class="string">&#x27;2014-03-20&#x27;</span> <span class="comment">-- 设置更新点,该时间点之前的数据可以另外通过 insert into select …… 的方式进行插入</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> UserID,EventDate;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建了一张SummingMergeTree引擎表，用于聚合数字列，在增量更新时先对数字列进行聚合再插入，就如单表查询中说的批量写入时先进行合并。<br>此时查询所有表可以发现除了创建的物化视图，还有一张 .inner_id表。</p>
</blockquote>
<p>或者可以用下列语法，表 A 可以是一张 mergetree 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> 物化视图名 <span class="keyword">TO</span> 表 A</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="keyword">FROM</span> 表 B;  <span class="comment">-- 不建议添加 populate 关键字进行全量更新</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-3-导入增量数据"><a href="#6-2-3-导入增量数据" class="headerlink" title="6.2.3 导入增量数据"></a>6.2.3 导入增量数据</h3><p>导入增量数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> hits_test </span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line"> EventDate,</span><br><span class="line"> CounterID,</span><br><span class="line"> UserID,</span><br><span class="line"> URL,</span><br><span class="line"> Income </span><br><span class="line"><span class="keyword">FROM</span> hits_v1 </span><br><span class="line"><span class="keyword">WHERE</span> EventDate <span class="operator">&gt;=</span> <span class="string">&#x27;2014-03-23&#x27;</span> </span><br><span class="line">limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>查询物化视图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM hits_mv;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-4-导入历史数据"><a href="#6-2-4-导入历史数据" class="headerlink" title="6.2.4 导入历史数据"></a>6.2.4 导入历史数据</h3><p>导入增量数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO hits_mv</span><br><span class="line">SELECT</span><br><span class="line"> UserID,</span><br><span class="line"> EventDate,</span><br><span class="line"> count(URL) as ClickCount,</span><br><span class="line"> sum(Income) AS IncomeSum</span><br><span class="line">FROM hits_test</span><br><span class="line">WHERE EventDate = &#x27;2014-03-20&#x27;</span><br><span class="line">GROUP BY UserID,EventDate</span><br></pre></td></tr></table></figure>
<p>查询物化视图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM hits_mv;</span><br></pre></td></tr></table></figure>

<br>
# 七、MaterializeMySQL 引擎
## 7.1 概述
MySQL 的用户群体很大，为了能够增强数据的实时性，很多解决方案会利用 binlog 将数据写入到 ClickHouse。为了能够监听 binlog 事件，我们需要用到类似 canal 这样的第三方中间件，这无疑增加了系统的复杂度。

<p>ClickHouse 20.8.2.3 版本新增加了 MaterializeMySQL 的 database 引擎，该 database 能映 射 到 MySQL 中 的 某 个 database ， 并 自 动 在 ClickHouse 中 创 建 对 应 的ReplacingMergeTree。ClickHouse 服务做为 MySQL 副本，读取 Binlog 并执行 DDL 和 DML 请求，实现了基于 MySQL Binlog 机制的业务数据库实时同步功能。</p>
<h3 id="7-1-1-特点"><a href="#7-1-1-特点" class="headerlink" title="7.1.1 特点"></a>7.1.1 特点</h3><p>（1）MaterializeMySQL 同时支持全量和增量同步，在 database 创建之初会全量同步MySQL 中的表和数据，之后则会通过 binlog 进行增量同步。<br>（2）MaterializeMySQL database 为其所创建的每张 ReplacingMergeTree 自动增加了_sign 和 _version 字段。其中，_version 用作 ReplacingMergeTree 的 ver 版本参数，每当监听到 insert、update 和 delete 事件时，在 databse 内全局自增。而 _sign 则用于标记是否被删除，取值 1 或 者 -1。<br>目前 MaterializeMySQL 支持如下几种 binlog 事件: </p>
<ul>
<li>MYSQL_WRITE_ROWS_EVENT: _sign &#x3D; 1，_version ++</li>
<li>MYSQL_DELETE_ROWS_EVENT: _sign &#x3D; -1，_version ++</li>
<li>MYSQL_UPDATE_ROWS_EVENT: 新数据 _sign &#x3D; 1</li>
<li>MYSQL_QUERY_EVENT: 支持 CREATE TABLE 、DROP TABLE 、RENAME TABLE 等。</li>
</ul>
<h3 id="7-1-2-使用细则"><a href="#7-1-2-使用细则" class="headerlink" title="7.1.2 使用细则"></a>7.1.2 使用细则</h3><p><strong>（1）DDL 查询</strong><br>MySQL DDL 查询被转换成相应的 ClickHouse DDL 查询（ALTER, CREATE, DROP, RENAME）。<br>如果 ClickHouse 不能解析某些 DDL 查询，该查询将被忽略。</p>
<p><strong>（2）数据复制</strong><br>MaterializeMySQL 不支持直接插入、删除和更新查询，而是将 DDL 语句进行相应转换：<br>MySQL INSERT 查询被转换为 INSERT with _sign&#x3D;1。<br>MySQL DELETE 查询被转换为 INSERT with _sign&#x3D;-1。<br>MySQL UPDATE 查询被转换成 INSERT with _sign&#x3D;1 和 INSERT with _sign&#x3D;-1。 </p>
<p><strong>（3）SELECT 查询</strong><br>如果在 SELECT 查询中没有指定_version，则使用 FINAL 修饰符，返回_version 的最大值<br>对应的数据，即最新版本的数据。<br>如果在 SELECT 查询中没有指定_sign，则默认使用 WHERE _sign&#x3D;1，即返回未删除状态<br>（_sign&#x3D;1)的数据。</p>
<p><strong>（4）索引转换</strong><br>ClickHouse 数据库表会自动将 MySQL 主键和索引子句转换为 ORDER BY 元组。<br>ClickHouse 只有一个物理顺序，由 ORDER BY 子句决定。如果需要创建新的物理顺序，请使用物化视图。</p>
<br>
## 7.2 案例实操
部署mysql 5.7
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart always --name mysql -p 3306:3306 -v /root/docker/mysql/conf:/etc/mysql -v /root/docker/mysql/log:/var/log/mysql -v /root/docker/mysql/lib:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=cj mysql:5.7</span><br></pre></td></tr></table></figure>
这里需要另起一个容器将容器中 /etc/mysql 下的文件复制到/root/docker/mysql/conf中，在根据如上命令启动容器。

<p>启动后进入客户端，查看binlog是否开启<br><code>show variables like &#39;%log_bin&#39;</code><br>得到结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin&#x27;</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | OFF   |</span><br><span class="line">| sql_log_bin   | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">2 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure>
<p>可以看到binlog未开启。</p>
<h3 id="7-2-1-MySQL-开启-binlog-和-GTID-模式"><a href="#7-2-1-MySQL-开启-binlog-和-GTID-模式" class="headerlink" title="7.2.1 MySQL 开启 binlog 和 GTID 模式"></a>7.2.1 MySQL 开启 binlog 和 GTID 模式</h3><p><strong>（1）确保 MySQL 开启了 binlog 功能，且格式为 ROW</strong><br>在docker启动的mysql5.7中，可以配置的位置有很多，我们配置在mysql.conf.d&#x2F;mysqld.cnf文件中，在[mysqld]下添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server-id=1 </span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog_format=ROW</span><br></pre></td></tr></table></figure>

<p><strong>（2）开启 GTID 模式</strong><br>如果如果 clickhouse 使用的是 20.8 prestable 之后发布的版本，那么 MySQL 还需要配置开启 GTID 模式, 这种方式在 mysql 主从模式下可以确保数据同步的一致性(主从切换时)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=1 # 设置为主从强一致性</span><br><span class="line">log-slave-updates=1 # 记录日志</span><br></pre></td></tr></table></figure>
<p>GTID 是 MySQL 复制增强版，从 MySQL 5.6 版本开始支持，目前已经是 MySQL 主流复制模式。它为每个 event 分配一个全局唯一 ID 和序号，我们可以不用关心 MySQL 集群主从拓扑结构，直接告知 MySQL 这个 GTID 即可。<br>主从切换，master变更可能会导致slave同步的操作记录丢失，GTID基本原理如下<br>1.master更新数据的时候，会在事务前产生GTID，一同记录到binlog日志中。<br>2.slave端的io线程将binlog写入到本地relay log中。<br>3.然后SQL线程从relay log中读取GTID，设置gtid_next的值为该gtid，然后对比slave端的binlog是否有记录<br>4.如果有记录的话，说明该GTID的事务已经运行，slave会忽略<br>5.如果没有记录的话，slave就会执行该GTID对应的事务，并记录到binlog中。</p>
<p><strong>（3）重启 MySQL</strong><br><code>docker restart mysql</code></p>
<p>我们再次输入查询命令<br><code>show variables like &#39;%log_bin%&#39;</code></p>
<p>得到结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON    |</span><br><span class="line">| sql_log_bin   | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">2 rows in set (0.06 sec)</span><br></pre></td></tr></table></figure>
<p>binlog已开启。</p>
<h3 id="7-2-2-准备-MySQL-表和数据"><a href="#7-2-2-准备-MySQL-表和数据" class="headerlink" title="7.2.2 准备 MySQL 表和数据"></a>7.2.2 准备 MySQL 表和数据</h3><p><strong>（1）在 MySQL 中创建数据表并写入数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE testck;</span><br><span class="line">CREATE TABLE `testck`.`t_organization` (</span><br><span class="line"> `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> `code` int NOT NULL,</span><br><span class="line"> `name` text DEFAULT NULL,</span><br><span class="line"> `updatetime` datetime DEFAULT NULL,</span><br><span class="line"> PRIMARY KEY (`id`),</span><br><span class="line"> UNIQUE KEY (`code`)</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">INSERT INTO testck.t_organization (code, name,updatetime) </span><br><span class="line">VALUES(1000,&#x27;Realinsight&#x27;,NOW());</span><br><span class="line">INSERT INTO testck.t_organization (code, name,updatetime) </span><br><span class="line">VALUES(1001, &#x27;Realindex&#x27;,NOW());</span><br><span class="line">INSERT INTO testck.t_organization (code, name,updatetime) </span><br><span class="line">VALUES(1002,&#x27;EDT&#x27;,NOW());</span><br></pre></td></tr></table></figure>

<p><strong>（2）创建第二张表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `testck`.`t_user` (</span><br><span class="line"> `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> `code` int,</span><br><span class="line"> PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">INSERT INTO testck.t_user (code) VALUES(1);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-3-开启-ClickHouse-物化引擎"><a href="#7-2-3-开启-ClickHouse-物化引擎" class="headerlink" title="7.2.3 开启 ClickHouse 物化引擎"></a>7.2.3 开启 ClickHouse 物化引擎</h3><p><code>set allow_experimental_database_materialize_mysql=1;</code></p>
<h3 id="7-2-4-创建复制管道"><a href="#7-2-4-创建复制管道" class="headerlink" title="7.2.4 创建复制管道"></a>7.2.4 创建复制管道</h3><p><strong>（1）ClickHouse 中创建 MaterializeMySQL 数据库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE test_binlog ENGINE = </span><br><span class="line">MaterializeMySQL(&#x27;chenjie.asia:3306&#x27;,&#x27;testck&#x27;,&#x27;root&#x27;,&#x27;000000&#x27;);</span><br></pre></td></tr></table></figure>
<p>其中 4 个参数分别是 MySQL 地址、databse、username 和 password。 </p>
<p><strong>（2）查看 ClickHouse 的数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use test_binlog;</span><br><span class="line">show tables;</span><br><span class="line">select * from t_organization;</span><br><span class="line">select * from t_user; </span><br></pre></td></tr></table></figure>
<p>得到查询结果为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bigdata1 :) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_organization;</span><br><span class="line">┌─id─┬─code─┬─name────────┬──────────updatetime─┐</span><br><span class="line">│  <span class="number">1</span> │ <span class="number">1000</span> │ Realinsight │ <span class="number">2021</span><span class="number">-08</span><span class="number">-19</span> <span class="number">02</span>:<span class="number">10</span>:<span class="number">25</span> │</span><br><span class="line">└────┴──────┴─────────────┴─────────────────────┘</span><br><span class="line">┌─id─┬─code─┬─name──────┬──────────updatetime─┐</span><br><span class="line">│  <span class="number">2</span> │ <span class="number">1001</span> │ Realindex │ <span class="number">2021</span><span class="number">-08</span><span class="number">-19</span> <span class="number">02</span>:<span class="number">10</span>:<span class="number">25</span> │</span><br><span class="line">└────┴──────┴───────────┴─────────────────────┘</span><br><span class="line">┌─id─┬─code─┬─name─┬──────────updatetime─┐</span><br><span class="line">│  <span class="number">3</span> │ <span class="number">1002</span> │ EDT  │ <span class="number">2021</span><span class="number">-08</span><span class="number">-19</span> <span class="number">02</span>:<span class="number">10</span>:<span class="number">25</span> │</span><br><span class="line">└────┴──────┴──────┴─────────────────────┘</span><br><span class="line"></span><br><span class="line">bigdata1 :) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user; </span><br><span class="line">┌─id─┬─code─┐</span><br><span class="line">│  <span class="number">1</span> │    <span class="number">1</span> │</span><br><span class="line">└────┴──────┘</span><br></pre></td></tr></table></figure>

<h3 id="7-2-5-修改数据"><a href="#7-2-5-修改数据" class="headerlink" title="7.2.5 修改数据"></a>7.2.5 修改数据</h3><p>（1）在 MySQL 中修改数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update t_organization set name = CONCAT(name,&#x27;-v1&#x27;) where id = 1;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MaterializeMySQL引擎不能在ClickHouse的MySQL物化模型中修改和删除数据，只能进行查询，因为该引擎只是为了增量同步。注意与ClickHouse中的MySQL引擎区分，MySQL引擎中可以对MySQL的数据表进行操作。</p>
</blockquote>
<p>（2）查看 clickhouse 日志可以看到 binlog 监听事件，查询 clickhouse</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_organization;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-6-删除数据"><a href="#7-2-6-删除数据" class="headerlink" title="7.2.6 删除数据"></a>7.2.6 删除数据</h3><p><strong>（1）MySQL 删除数据:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM t_organization where id = 2; </span><br></pre></td></tr></table></figure>

<p><strong>（2）ClicKHouse，日志有 DeleteRows 的 binlog 监听事件，查看数据：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_organization;</span><br></pre></td></tr></table></figure>
<p>可以看到ClickHouse中的数据也发生了同样的改变。</p>
<p><strong>（3）在刚才的查询中增加 _sign 和 _version 虚拟字段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *,_sign,_version from t_organization order by _sign desc,_version desc;</span><br></pre></td></tr></table></figure>

<p>在查询时，对于已经被删除的数据，_sign&#x3D;-1，ClickHouse 会自动重写 SQL，将 _sign &#x3D; -1 的数据过滤掉;<br>对于修改的数据，则自动重写 SQL，为其增加 FINAL 修饰符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_organization</span><br></pre></td></tr></table></figure>
<p>等同于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t_organization final where _sign = 1</span><br></pre></td></tr></table></figure>

<h3 id="7-2-7-删除表"><a href="#7-2-7-删除表" class="headerlink" title="7.2.7 删除表"></a>7.2.7 删除表</h3><p><strong>（1）在 mysql 执行删除表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop table t_user;</span><br></pre></td></tr></table></figure>

<p><strong>（2）此时在 clickhouse 处会同步删除对应表，如果查询会报错</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">select * from t_user;</span><br><span class="line">DB::Exception: Table scene_mms.scene doesn&#x27;t exist.. </span><br></pre></td></tr></table></figure>

<p><strong>（3）mysql 新建表，clickhouse 可以查询到</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `testck`.`t_user` (</span><br><span class="line"> `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> `code` int,</span><br><span class="line"> PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">INSERT INTO testck.t_user (code) VALUES(1);</span><br></pre></td></tr></table></figure>

<p>ClickHouse 查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">select * from t_user;</span><br></pre></td></tr></table></figure>

<br>
# 八、常见问题排查
## 8.1 分布式 DDL 某数据节点的副本不执行
（1）问题：使用分布式 ddl 执行命令 create table on cluster xxxx 某个节点上没有创建表，但是 client 返回正常，查看日志有如下报错。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Error&gt; xxx.xxx: Retrying createReplica(), because some other replicas were created at the same time</span><br></pre></td></tr></table></figure>
（2）解决办法：重启该不执行的节点。

<h2 id="8-2-数据副本表和数据不一致"><a href="#8-2-数据副本表和数据不一致" class="headerlink" title="8.2 数据副本表和数据不一致"></a>8.2 数据副本表和数据不一致</h2><p>（1）问题：由于某个数据节点副本异常，导致两数据副本表不一致，某个数据副本缺少表，需要将两个数据副本调整一致。<br>（2）解决办法：<br>在缺少表的数据副本节点上创建缺少的表，创建为本地表，表结构可以在其他数据副本通过 show crete table xxxx 获取。<br>表结构创建后，clickhouse 会自动从其他副本同步该表数据，验证数据量是否一致即可。</p>
<h2 id="8-3-副本节点全量恢复"><a href="#8-3-副本节点全量恢复" class="headerlink" title="8.3 副本节点全量恢复"></a>8.3 副本节点全量恢复</h2><p>（1）问题：某个数据副本异常无法启动，需要重新搭建副本。<br>（2）解决办法：<br>清空异常副本节点的 metadata 和 data 目录。<br>从另一个正常副本将 metadata 目录拷贝过来（这一步之后可以启动数据库，但是只有表结构没有数据）。<br>执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u clickhouse touch /data/clickhouse/flags/force_restore_data</span><br></pre></td></tr></table></figure>
<p>启动数据库。</p>
<h2 id="8-4-数据副本启动缺少-zk-表"><a href="#8-4-数据副本启动缺少-zk-表" class="headerlink" title="8.4 数据副本启动缺少 zk 表"></a>8.4 数据副本启动缺少 zk 表</h2><p>（1）问题：某个数据副本表在 zk 上丢失数据，或者不存在，但是 metadata 元数据里存在，导致启动异常，报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Can’t get data for node /clickhouse/tables/01-</span><br><span class="line">02/xxxxx/xxxxxxx/replicas/xxx/metadata: node doesn’t exist (No node): </span><br><span class="line">Cannot attach table xxxxxxx</span><br></pre></td></tr></table></figure>
<p>（2）解决办法：<br>metadata 中移除该表的结构文件，如果多个表报错都移除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv metadata/xxxxxx/xxxxxxxx.sql /tmp/</span><br></pre></td></tr></table></figure>
<p>启动数据库<br>手工创建缺少的表，表结构从其他节点 show create table 获取。<br>创建后会自动同步数据，验证数据是否一致。</p>
<h2 id="8-5-ZK-table-replicas-数据未删除，导致重建表报错"><a href="#8-5-ZK-table-replicas-数据未删除，导致重建表报错" class="headerlink" title="8.5 ZK table replicas 数据未删除，导致重建表报错"></a>8.5 ZK table replicas 数据未删除，导致重建表报错</h2><p>（1）问题：重建表过程中，先使用 drop table xxx on cluster xxx ,各节点在 clickhouse 上table 已物理删除，但是 zk 里面针对某个 clickhouse 节点的 table meta 信息未被删除（低概率事件），因 zk 里仍存在该表的 meta 信息，导致再次创建该表 create table xxx on cluster, 该节点无法创建表(其他节点创建表成功)，报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Replica /clickhouse/tables/01-03/xxxxxx/xxx/replicas/xxx already exists..</span><br></pre></td></tr></table></figure>
<p>（2）解决办法：<br>从其他数据副本 cp 该 table 的 metadata sql 过来.<br>重启节点。</p>
<h2 id="8-6-Clickhouse-节点意外关闭"><a href="#8-6-Clickhouse-节点意外关闭" class="headerlink" title="8.6 Clickhouse 节点意外关闭"></a>8.6 Clickhouse 节点意外关闭</h2><p>（1）问题：模拟其中一个节点意外宕机，在大量 insert 数据的情况下，关闭某个节点。<br>（2）现象：数据写入不受影响、数据查询不受影响、建表 DDL 执行到异常节点会卡住，<br>报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Code: 159. DB::Exception: Received from localhost:9000. DB::Exception: </span><br><span class="line">Watching task /clickhouse/task_queue/ddl/query-0000565925 is executing </span><br><span class="line">longer than distributed_ddl_task_timeout (=180) seconds. There are 1 </span><br><span class="line">unfinished hosts (0 of them are currently active), they are going to </span><br><span class="line">execute the query in background.</span><br></pre></td></tr></table></figure>
<p>（3）解决办法：启动异常节点，期间其他副本写入数据会自动同步过来，其他副本的建表 DDL 也会同步。</p>
<h2 id="8-7-其他问题参考"><a href="#8-7-其他问题参考" class="headerlink" title="8.7 其他问题参考"></a>8.7 其他问题参考</h2><p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/162815.html?spm=a2c4g.11186623.6.652.312e79bd17U8IO">https://help.aliyun.com/document_detail/162815.html?spm=a2c4g.11186623.6.652.312e79bd17U8IO</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">CJ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E9%AB%98%E9%98%B6/">http://example.com/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/ClickHouse-21-7-%E9%AB%98%E9%98%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%81%AB%E6%98%9F%E4%BA%BA%E4%B8%9A%E5%8A%A1/HXR%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%92%8C%E4%B8%9A%E5%8A%A1(%E4%B8%8A)/" title="HXR大数据架构和业务(上)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">HXR大数据架构和业务(上)</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%97%B6/Flink%E5%8F%8D%E5%8E%8B/" title="Flink反压"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Flink反压</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CJ</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">419</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">38</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ClickHouse%E4%B8%BA%E4%BB%80%E4%B9%88%E9%82%A3%E4%B9%88%E5%BF%AB%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">ClickHouse为什么那么快？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6%E4%BC%98%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">1. 硬件优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">2. 算法优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%89%B9%E5%AE%9A%E5%9C%BA%E6%99%AF%EF%BC%8C%E7%89%B9%E6%AE%8A%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">3. 特定场景，特殊优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.</span> <span class="toc-text">4. 快速迭代优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">1.1 基本语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%93%8D"><span class="toc-number">1.6.</span> <span class="toc-text">1.2 案例实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-%E6%96%B0%E7%89%88%E6%9C%AC%E4%BD%BF%E7%94%A8EXPLAIN"><span class="toc-number">1.6.1.</span> <span class="toc-text">1.2.1 新版本使用EXPLAIN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%9F%A5%E7%9C%8BPLAIN"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">1）查看PLAIN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%AF%AD%E6%B3%95%E6%A0%91"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">2）语法树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89SYNTAX%E8%AF%AD%E6%B3%95%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">3）SYNTAX语法优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E6%9F%A5%E7%9C%8BPIPELINE"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">4）查看PIPELINE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E8%80%81%E7%89%88%E6%9C%AC%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">1.6.2.</span> <span class="toc-text">1.2.2 老版本查看执行计划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E7%A9%BA%E5%80%BC%E5%AD%98%E5%82%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.3.</span> <span class="toc-text">2.1.2 空值存储类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%A1%A8%E5%8F%82%E6%95%B0"><span class="toc-number">1.7.</span> <span class="toc-text">2.3 表参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%86%99%E5%85%A5%E5%92%8C%E5%88%A0%E9%99%A4%E4%BC%98%E5%8C%96"><span class="toc-number">1.8.</span> <span class="toc-text">2.4 写入和删除优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.9.</span> <span class="toc-text">2.5 常见配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-CPU%E8%B5%84%E6%BA%90"><span class="toc-number">1.9.1.</span> <span class="toc-text">2.5.1 CPU资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-%E5%86%85%E5%AD%98%E8%B5%84%E6%BA%90"><span class="toc-number">1.9.2.</span> <span class="toc-text">2.5.2 内存资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-3-%E5%AD%98%E5%82%A8"><span class="toc-number">1.9.3.</span> <span class="toc-text">2.5.3 存储</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E7%94%A8%E8%A1%A8"><span class="toc-number">1.10.</span> <span class="toc-text">3.1 准备测试用表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E8%A1%A8%E5%92%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">1.11.</span> <span class="toc-text">5.1 准备测试表和数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-%E8%80%81%E7%89%88%E6%9C%AC%E6%B5%8B%E8%AF%95-20-4-5-36"><span class="toc-number">1.11.1.</span> <span class="toc-text">5.4.1 老版本测试(20.4.5.36)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E6%96%B0%E7%89%88%E6%9C%AC%E6%B5%8B%E8%AF%95-21-7-3-14"><span class="toc-number">1.11.2.</span> <span class="toc-text">5.4.2 新版本测试(21.7.3.14)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.12.</span> <span class="toc-text">6.1 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE%E4%B8%8E%E6%99%AE%E9%80%9A%E8%A7%86%E5%9B%BE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.12.1.</span> <span class="toc-text">6.1.1 物化视图与普通视图的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.12.2.</span> <span class="toc-text">6.1.2 优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.12.3.</span> <span class="toc-text">6.1.3 基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E7%94%A8%E8%A1%A8%E5%92%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.4.</span> <span class="toc-text">6.2.1 准备测试用表和数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E5%88%9B%E5%BB%BA%E7%89%A9%E5%8C%96%E8%A7%86%E5%9B%BE"><span class="toc-number">1.12.5.</span> <span class="toc-text">6.2.2 创建物化视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-%E5%AF%BC%E5%85%A5%E5%A2%9E%E9%87%8F%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.6.</span> <span class="toc-text">6.2.3 导入增量数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-4-%E5%AF%BC%E5%85%A5%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.7.</span> <span class="toc-text">6.2.4 导入历史数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1-%E7%89%B9%E7%82%B9"><span class="toc-number">1.12.8.</span> <span class="toc-text">7.1.1 特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2-%E4%BD%BF%E7%94%A8%E7%BB%86%E5%88%99"><span class="toc-number">1.12.9.</span> <span class="toc-text">7.1.2 使用细则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-MySQL-%E5%BC%80%E5%90%AF-binlog-%E5%92%8C-GTID-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.12.10.</span> <span class="toc-text">7.2.1 MySQL 开启 binlog 和 GTID 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2-%E5%87%86%E5%A4%87-MySQL-%E8%A1%A8%E5%92%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.11.</span> <span class="toc-text">7.2.2 准备 MySQL 表和数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-3-%E5%BC%80%E5%90%AF-ClickHouse-%E7%89%A9%E5%8C%96%E5%BC%95%E6%93%8E"><span class="toc-number">1.12.12.</span> <span class="toc-text">7.2.3 开启 ClickHouse 物化引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-4-%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%88%B6%E7%AE%A1%E9%81%93"><span class="toc-number">1.12.13.</span> <span class="toc-text">7.2.4 创建复制管道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-5-%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.14.</span> <span class="toc-text">7.2.5 修改数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-6-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">1.12.15.</span> <span class="toc-text">7.2.6 删除数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-7-%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="toc-number">1.12.16.</span> <span class="toc-text">7.2.7 删除表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E6%95%B0%E6%8D%AE%E5%89%AF%E6%9C%AC%E8%A1%A8%E5%92%8C%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="toc-number">1.13.</span> <span class="toc-text">8.2 数据副本表和数据不一致</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-%E5%89%AF%E6%9C%AC%E8%8A%82%E7%82%B9%E5%85%A8%E9%87%8F%E6%81%A2%E5%A4%8D"><span class="toc-number">1.14.</span> <span class="toc-text">8.3 副本节点全量恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-%E6%95%B0%E6%8D%AE%E5%89%AF%E6%9C%AC%E5%90%AF%E5%8A%A8%E7%BC%BA%E5%B0%91-zk-%E8%A1%A8"><span class="toc-number">1.15.</span> <span class="toc-text">8.4 数据副本启动缺少 zk 表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-ZK-table-replicas-%E6%95%B0%E6%8D%AE%E6%9C%AA%E5%88%A0%E9%99%A4%EF%BC%8C%E5%AF%BC%E8%87%B4%E9%87%8D%E5%BB%BA%E8%A1%A8%E6%8A%A5%E9%94%99"><span class="toc-number">1.16.</span> <span class="toc-text">8.5 ZK table replicas 数据未删除，导致重建表报错</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-Clickhouse-%E8%8A%82%E7%82%B9%E6%84%8F%E5%A4%96%E5%85%B3%E9%97%AD"><span class="toc-number">1.17.</span> <span class="toc-text">8.6 Clickhouse 节点意外关闭</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7-%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98%E5%8F%82%E8%80%83"><span class="toc-number">1.18.</span> <span class="toc-text">8.7 其他问题参考</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/MySQL/%E6%B3%A8%E8%A7%A3@Select%E5%92%8C@Insert/" title="注解@Select和@Insert">注解@Select和@Insert</a><time datetime="2023-05-06T05:48:28.906Z" title="发表于 2023-05-06 13:48:28">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/%E6%B3%A8%E8%A7%A3@EnableAutoConfiguration/" title="注解@EnableAutoConfiguration">注解@EnableAutoConfiguration</a><time datetime="2023-05-06T05:48:06.027Z" title="发表于 2023-05-06 13:48:06">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%A6%BB%E7%BA%BF/%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E6%A1%86%E6%9E%B6/" title="大数据集群监控框架">大数据集群监控框架</a><time datetime="2023-05-06T05:42:56.298Z" title="发表于 2023-05-06 13:42:56">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/HashMap%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E5%8F%8AConcurrentHashMap%E5%8E%9F%E7%90%86/" title="HashMap并发问题及ConcurrentHashMap原理">HashMap并发问题及ConcurrentHashMap原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/06/%E9%AB%98%E5%B9%B6%E5%8F%91/Stream%E5%8E%9F%E7%90%86/" title="Stream原理">Stream原理</a><time datetime="2023-05-06T05:31:21.103Z" title="发表于 2023-05-06 13:31:21">2023-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By CJ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>